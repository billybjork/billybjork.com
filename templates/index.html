{% extends "base.html" %}

{% block main_class %}
    home-page{% if isolation_mode %} isolation-mode{% endif %}
{% endblock %}

{% block content %}

<section id="project-list">
    {% set open_project = open_project if open_project is defined else None %}
    {% for project in projects %}
        {% set is_open = (open_project and open_project.slug == project.slug) %}
        {% include "project.html" with context %}
    {% endfor %}

    {% if not isolation_mode and has_more %}
        {% include "infinite_scroll_sentinel.html" %}
    {% endif %}
</section>

{% endblock %}

{% block additional_scripts %}
<script>
/**
 * Hero Video Debug Mode
 * Activate with ?hero_debug=1
 * Binary-search CSS clusters to isolate iOS scrubber bug
 */
(function() {
    const params = new URLSearchParams(window.location.search);
    if (!params.has('hero_debug')) return;

    const CSS_TOGGLES = [
        { id: 'parent-overflow', label: '.project-details overflow', class: 'debug-no-parent-overflow', target: 'parent' },
        { id: 'overflow', label: '.video-container overflow', class: 'debug-no-overflow' },
        { id: 'object-fit', label: 'object-fit: contain', class: 'debug-no-object-fit' },
        { id: 'aspect', label: 'aspect-ratio', class: 'debug-no-aspect' },
        { id: 'flex', label: 'flex layout', class: 'debug-no-flex' },
        { id: 'sizing', label: 'video width/height 100%', class: 'debug-no-sizing' },
        { id: 'max-height', label: 'max-height constraint', class: 'debug-no-max-height' },
        { id: 'position', label: 'position: relative', class: 'debug-no-position' },
        { id: 'webkit-controls', label: 'WebKit controls override', class: 'debug-webkit-controls' },
    ];

    const VARIANTS = [
        { id: 'production', label: 'B: Production (current)' },
        { id: 'native', label: 'A: Native baseline (minimal CSS)' },
    ];

    let activeVariant = 'production';
    let activeToggles = new Set();

    function getVideoContainer() {
        return document.querySelector('.video-container#hero');
    }

    function getProjectDetails() {
        return document.querySelector('.project-details');
    }

    function applyState() {
        const container = getVideoContainer();
        const projectDetails = getProjectDetails();
        if (!container) {
            console.warn('[hero_debug] No .video-container#hero found');
            return;
        }

        // Clear all debug classes
        container.classList.remove('debug-variant-a');
        CSS_TOGGLES.filter(t => t.target !== 'parent').forEach(t => container.classList.remove(t.class));
        if (projectDetails) {
            CSS_TOGGLES.filter(t => t.target === 'parent').forEach(t => projectDetails.classList.remove(t.class));
        }

        // Apply variant
        if (activeVariant === 'native') {
            container.classList.add('debug-variant-a');
            console.log('[hero_debug] Variant A: Native baseline applied');
        } else {
            // Apply individual toggles
            activeToggles.forEach(id => {
                const toggle = CSS_TOGGLES.find(t => t.id === id);
                if (toggle) {
                    if (toggle.target === 'parent' && projectDetails) {
                        projectDetails.classList.add(toggle.class);
                    } else {
                        container.classList.add(toggle.class);
                    }
                }
            });
            console.log('[hero_debug] Variant B with toggles:', Array.from(activeToggles));
        }

        updateDebugInfo();
    }

    function updateDebugInfo() {
        const info = document.getElementById('debug-info');
        if (!info) return;

        const container = getVideoContainer();
        if (!container) {
            info.textContent = 'No video container found';
            return;
        }

        const video = container.querySelector('video');
        const containerStyles = window.getComputedStyle(container);
        const videoStyles = video ? window.getComputedStyle(video) : null;

        const lines = [
            `Variant: ${activeVariant}`,
            `Toggles: ${activeToggles.size ? Array.from(activeToggles).join(', ') : 'none'}`,
            '',
            'Container computed:',
            `  overflow: ${containerStyles.overflow}`,
            `  position: ${containerStyles.position}`,
            `  display: ${containerStyles.display}`,
            `  aspect-ratio: ${containerStyles.aspectRatio}`,
            '',
        ];

        if (videoStyles) {
            lines.push('Video computed:');
            lines.push(`  object-fit: ${videoStyles.objectFit}`);
            lines.push(`  width: ${videoStyles.width}`);
            lines.push(`  height: ${videoStyles.height}`);
        }

        info.textContent = lines.join('\n');
    }

    function createPanel() {
        const panel = document.createElement('div');
        panel.className = 'hero-debug-panel';
        panel.innerHTML = `
            <h4>Hero Video Debug</h4>
            <select class="variant-select" id="variant-select">
                ${VARIANTS.map(v => `<option value="${v.id}">${v.label}</option>`).join('')}
            </select>
            <div id="toggles-section">
                <strong>CSS clusters (remove to test):</strong>
                ${CSS_TOGGLES.map(t => `
                    <label>
                        <input type="checkbox" data-toggle="${t.id}">
                        ${t.label}
                    </label>
                `).join('')}
            </div>
            <div class="debug-info">
                <pre id="debug-info" style="margin:0;white-space:pre-wrap;font-size:10px;">Loading...</pre>
            </div>
        `;

        document.body.appendChild(panel);

        // Variant selector
        const variantSelect = document.getElementById('variant-select');
        variantSelect.addEventListener('change', (e) => {
            activeVariant = e.target.value;
            const togglesSection = document.getElementById('toggles-section');
            togglesSection.style.display = activeVariant === 'native' ? 'none' : 'block';
            applyState();
        });

        // CSS toggles
        panel.querySelectorAll('input[data-toggle]').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const id = e.target.dataset.toggle;
                if (e.target.checked) {
                    activeToggles.add(id);
                } else {
                    activeToggles.delete(id);
                }
                applyState();
            });
        });
    }

    // Wait for DOM and video to load
    function init() {
        createPanel();
        applyState();

        // Re-apply when video container appears (SPA navigation)
        const observer = new MutationObserver(() => {
            if (getVideoContainer()) {
                applyState();
            }
        });
        observer.observe(document.body, { childList: true, subtree: true });

        console.log('[hero_debug] Debug mode active. Use panel to toggle CSS clusters.');
        console.log('[hero_debug] Test on iOS: check if scrubber thumb appears with different toggles.');
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
{% endblock %}