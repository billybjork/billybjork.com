// Auto-generated by esbuild - do not edit directly

"use strict";(()=>{function Hn(){return"block-"+Date.now()+"-"+Math.random().toString(36).substring(2,11)}function de(){return document.body?.dataset.editMode==="true"}function J(){let e="bb_show_drafts",t=new URLSearchParams(window.location.search);if(t.has("show_drafts")){let n=t.get("show_drafts")==="true";return n?sessionStorage.setItem(e,"true"):sessionStorage.removeItem(e),n}return sessionStorage.getItem(e)==="true"}function ue(e){try{let t=new URL(e,window.location.origin);return J()&&t.searchParams.set("show_drafts","true"),t.toString()}catch{return e}}var ve="data-scroll-lock-count",tt="data-scroll-lock-y";function Ae(){let e=document.body,t=Number(e.getAttribute(ve)||"0");if(t===0){let n=window.scrollY||window.pageYOffset||0;e.setAttribute(tt,String(n)),e.classList.add("modal-open"),e.style.position="fixed",e.style.top=`-${n}px`,e.style.left="0",e.style.right="0",e.style.width="100%",e.style.overflow="hidden"}e.setAttribute(ve,String(t+1))}function je(){let e=document.body,t=Number(e.getAttribute(ve)||"0");if(t<=0){e.classList.remove("modal-open");return}if(t>1){e.setAttribute(ve,String(t-1));return}let n=Number(e.getAttribute(tt)||"0");e.removeAttribute(ve),e.removeAttribute(tt),e.classList.remove("modal-open"),e.style.position="",e.style.top="",e.style.left="",e.style.right="",e.style.width="",e.style.overflow="",window.scrollTo(0,n)}function ye(e,t){let n=()=>{e.style.height="auto",e.style.height=e.scrollHeight+"px"};return e.addEventListener("input",()=>{n(),t&&t(e.value)}),setTimeout(n,0),n}function nt(e,t){let n=document.createElement("img");return n.src=e.src,n.alt=e.alt||"",e.style&&n.setAttribute("style",e.style),e.align&&ot(n,e.align),t&&n.addEventListener("click",i=>{i.stopPropagation(),t(n,e)}),n}function it(e,t){let n=document.createElement("video");return n.src=e.src,n.controls=!0,n.className="content-video",e.style&&n.setAttribute("style",e.style),e.align&&ot(n,e.align),t&&n.addEventListener("click",i=>{i.stopPropagation(),t(n,e)}),n}function ot(e,t){e.style.display="block",e.style.marginLeft="",e.style.marginRight="",t==="center"?(e.style.marginLeft="auto",e.style.marginRight="auto"):t==="right"&&(e.style.marginLeft="auto")}function xt(e){switch(e){case"center":return"margin-left: auto; margin-right: auto";case"right":return"margin-left: auto";default:return""}}function Re(e){if(!e)return"left";let t=e.includes("margin-left: auto")||e.includes("margin-left:auto"),n=e.includes("margin-right: auto")||e.includes("margin-right:auto");return t&&n?"center":t?"right":"left"}function Ne(e){let t=["display: block"];if(e.style){let i=e.style.replace(/margin-left:\s*auto;?\s*/g,"").replace(/margin-right:\s*auto;?\s*/g,"").replace(/display:\s*block;?\s*/g,"").trim();i&&t.push(i)}let n=xt(e.align??"left");return n&&t.push(n),t.join("; ")}function N(e,t){if(e.focus({preventScroll:!0}),!document.execCommand("insertText",!1,t)){let n=e.selectionStart,i=e.selectionEnd;e.setRangeText(t,n,i,"end")}}function kt(e,t,n,i){let o=e.selectionStart,r=e.selectionEnd,s=e.value.substring(o,r)||"text",a=t+s+n;e.focus({preventScroll:!0}),e.setSelectionRange(o,r),N(e,a),e.selectionStart=o+t.length,e.selectionEnd=o+t.length+s.length,i&&i()}function _n(e,t,n,i,o){let r=e.lastIndexOf(`
`,t-1)+1,s=e.indexOf(`
`,n),a=s===-1?e.length:s,l=-1;for(let m=t;m>=r;m--)if(e.substring(m,m+i.length)===i){let p=m>0?e[m-1]:"";if(i!=="**"||p!=="*"){l=m;break}}if(l===-1)return null;let d=-1,y=Math.max(l+i.length,n);for(let m=y;m<=a-o.length;m++)if(e.substring(m,m+o.length)===o){let p=m+o.length<e.length?e[m+o.length]:"";if(o!=="**"||p!=="*"){d=m;break}}if(d===-1)return null;let v=l+i.length,g=d;return t>=v&&n<=g?{formatStart:l,formatEnd:d+o.length,innerStart:v,innerEnd:g}:null}function Ie(e,t,n,i){let{value:o,selectionStart:r,selectionEnd:s}=e,a=_n(o,r,s,t,n);if(a){let{formatStart:l,formatEnd:d,innerStart:y,innerEnd:v}=a,g=o.substring(y,v);e.focus({preventScroll:!0}),e.setSelectionRange(l,d),N(e,g),e.selectionStart=l,e.selectionEnd=l+g.length}else kt(e,t,n,()=>{});i&&i()}function rt(e,t,n){if(!(e.metaKey||e.ctrlKey))return!1;switch(e.key){case"b":return e.preventDefault(),Ie(t,"**","**",n),!0;case"i":return e.preventDefault(),Ie(t,"*","*",n),!0;case"u":return e.preventDefault(),Ie(t,"<u>","</u>",n),!0;case"k":return e.preventDefault(),Ht(t,n),!0}return!1}function Mt(e){let{value:t,selectionStart:n}=e,i=-1;for(let l=n;l>=Math.max(0,n-500);l--){if(t[l]==="["){i=l;break}if(t[l]===`
`||t[l]===")")break}if(i===-1)return null;let r=t.substring(i).match(/^\[([^\]]*)\]\(([^)]*)\)/);if(!r)return null;let s=r[0],a=i+s.length;return n>a?null:{start:i,end:a,text:r[1]??"",url:r[2]??"",textStart:i+1,textEnd:i+1+(r[1]?.length??0),urlStart:i+(r[1]?.length??0)+3,urlEnd:a-1}}async function Ht(e,t){let n=Mt(e);if(n){let i=prompt("Edit link URL (leave empty to remove link):",n.url);if(i===null)return;if(i==="")e.focus({preventScroll:!0}),e.setSelectionRange(n.start,n.end),N(e,n.text);else{let o=`[${n.text}](${i})`;e.focus({preventScroll:!0}),e.setSelectionRange(n.start,n.end),N(e,o)}}else{let i=e.selectionStart,o=e.selectionEnd,r=e.value.substring(i,o)||"link text",s=prompt("Enter link URL:");if(!s)return;let a=`[${r}](${s})`;e.focus({preventScroll:!0}),e.setSelectionRange(i,o),N(e,a)}t&&t()}function $e(e){return!e||e==="left"?"":`text-align: ${e}`}function Ue(e){return e?e.match(/text-align:\s*(left|center|right)/)?.[1]??"left":"left"}function Dn(e,t){let{value:n,selectionStart:i,selectionEnd:o}=e,r="   ",s=n.lastIndexOf(`
`,i-1)+1,a=n.indexOf(`
`,o);a===-1&&(a=n.length);let l=n.substring(0,s),d=n.substring(s,a),y=n.substring(a),v=d.split(`
`).map(m=>{let p=m.match(/^(\s*)\d+\.\s(.*)$/);return p?r+(p[1]??"")+"- "+(p[2]??""):r+m}).join(`
`);e.value=l+v+y;let g=v.length-d.length;e.selectionStart=i+r.length,e.selectionEnd=o+g,e.dispatchEvent(new Event("input",{bubbles:!0})),t&&t()}function Bn(e,t){let{value:n,selectionStart:i,selectionEnd:o}=e,r=n.lastIndexOf(`
`,i-1)+1,s=n.indexOf(`
`,o);s===-1&&(s=n.length);let a=n.substring(0,r),l=n.substring(r,s),d=n.substring(s),y=0,v=0,g=l.split(`
`).map((m,p)=>{let c=m.match(/^( {1,4}|\t)/);if(c){let u=c[0].length;return p===0&&(y=u),v+=u,m.substring(u)}return m}).join(`
`);e.value=a+g+d,e.selectionStart=Math.max(r,i-y),e.selectionEnd=o-v,e.dispatchEvent(new Event("input",{bubbles:!0})),t&&t()}function Pn(e,t,n){let{value:i,selectionStart:o,selectionEnd:r}=t;if(o!==r)return!1;let s=i.lastIndexOf(`
`,o-1)+1,a=i.indexOf(`
`,o),l=i.substring(s,a===-1?i.length:a),d=l.match(/^(\s*)([-*+])\s(.*)$/);if(d){let[,v="",g="-",m=""]=d;if(m.trim()===""){e.preventDefault();let c=i.substring(0,s),u=i.substring(a===-1?i.length:a);return t.value=c+u,t.selectionStart=t.selectionEnd=s,t.dispatchEvent(new Event("input",{bubbles:!0})),n&&n(),!0}e.preventDefault();let p=`
${v}${g} `;return N(t,p),t.dispatchEvent(new Event("input",{bubbles:!0})),n&&n(),!0}let y=l.match(/^(\s*)(\d+)\.\s(.*)$/);if(y){let[,v="",g="1",m=""]=y;if(m.trim()===""){e.preventDefault();let u=i.substring(0,s),h=i.substring(a===-1?i.length:a);return t.value=u+h,t.selectionStart=t.selectionEnd=s,t.dispatchEvent(new Event("input",{bubbles:!0})),n&&n(),!0}e.preventDefault();let p=parseInt(g,10)+1,c=`
${v}${p}. `;return N(t,c),t.dispatchEvent(new Event("input",{bubbles:!0})),n&&n(),!0}return!1}function st(e,t,n){return e.key==="Tab"&&!e.shiftKey?(e.preventDefault(),Dn(t,n),!0):e.key==="Tab"&&e.shiftKey?(e.preventDefault(),Bn(t,n),!0):!!(e.key==="Enter"&&!e.shiftKey&&!e.metaKey&&!e.ctrlKey&&Pn(e,t,n))}function f(e,t="info",n=3e3){let i=document.createElement("div");i.className=`edit-notification edit-notification-${t}`,i.textContent=e,document.body.appendChild(i),requestAnimationFrame(()=>{i.classList.add("show")}),setTimeout(()=>{i.classList.remove("show"),setTimeout(()=>i.remove(),300)},n)}function Fe(e){return JSON.parse(JSON.stringify(e))}function Cn(e){let t=e.textContent?.trim()??"",n=e.innerHTML.trim();return t===""||n===""||n==="<br>"}function In(e){let t=document.createRange(),n=window.getSelection();n&&(t.selectNodeContents(e),t.collapse(!1),n.removeAllRanges(),n.addRange(t))}async function A(e,t={}){let n=await fetch(e,{...t,headers:{"Content-Type":"application/json",...t.headers}});if(!n.ok){let i="";try{i=(await n.json()).detail||""}catch{}throw new Error(i||`HTTP error! status: ${n.status}`)}return await n.json()}function An(e,t){let n;return function(...o){let r=()=>{clearTimeout(n),e(...o)};clearTimeout(n),n=setTimeout(r,t)}}var _t={generateId:Hn,isDevMode:de,isShowDraftsActive:J,withShowDrafts:ue,setupAutoResizeTextarea:ye,createImageElement:nt,createVideoElement:it,applyAlignment:ot,getAlignmentStyle:xt,parseAlignmentFromStyle:Re,buildMediaStyleString:Ne,insertTextWithUndo:N,wrapSelection:kt,toggleFormat:Ie,handleFormattingShortcuts:rt,findLinkAtCursor:Mt,insertLink:Ht,getTextAlignmentStyle:$e,parseTextAlignmentFromStyle:Ue,handleListShortcuts:st,showNotification:f,deepClone:Fe,isElementEmpty:Cn,moveCaretToEnd:In,fetchJSON:A,debounce:An};var at="<!-- block -->",Oe="<!-- row -->",Ve="<!-- /row -->",lt="<!-- col -->",we="<!-- html -->",Ee="<!-- /html -->";function he(e){return`block-${Date.now()}-${e}-${Math.random().toString(36).substring(2,7)}`}function jn(e,t){if(t.startsWith(we)&&t.endsWith(Ee)){e.type="html",e.html=t.slice(we.length,-Ee.length).trim();return}if(t.startsWith("```")){e.type="code";let n=t.match(/^```(\w*)\n?([\s\S]*?)\n?```$/);n?(e.language=n[1]||"text",e.code=n[2]||""):(e.language="text",e.code=t.replace(/^```\w*\n?/,"").replace(/\n?```$/,""));return}if(t.startsWith("<img")||/^!\[.*?\]\(.*?\)$/.test(t)){if(e.type="image",t.startsWith("<img")){let n=t.match(/src="([^"]*)"/),i=t.match(/alt="([^"]*)"/),o=t.match(/style="([^"]*)"/);e.src=n?.[1]??"",e.alt=i?.[1]??"",e.style=o?.[1]??null,e.align=Re(e.style)}else{let n=t.match(/!\[(.*?)\]\((.*?)\)/);e.src=n?.[2]??"",e.alt=n?.[1]??"",e.style=null,e.align="left"}return}if(t.startsWith("<video")){e.type="video";let n=t.match(/src="([^"]*)"/),i=t.match(/style="([^"]*)"/);e.src=n?.[1]??"",e.style=i?.[1]??null,e.align=Re(e.style);return}if(t.startsWith('<div class="callout"')){e.type="callout";let n=t.match(/<div class="callout"(?:\s+style="([^"]*)")?>([\s\S]*?)<\/div>/);n?(e.align=n[1]?Ue(n[1]):"left",e.content=n[2]?.trim()??""):(e.content="",e.align="left");return}if(/^(\*{3,}|-{3,}|_{3,})$/.test(t)){e.type="divider";return}if(t.startsWith("<!-- align:")){e.type="text";let n=t.match(/^<!-- align:(center|right) -->\n?([\s\S]*?)\n?<!-- \/align -->$/);n?(e.align=n[1],e.content=n[2]?.trim()??""):e.align="left";return}if(t.startsWith('<div style="text-align:')||t.startsWith('<div style="text-align :')){e.type="text";let n=t.match(/<div style="([^"]*)">([\s\S]*?)<\/div>/);n?(e.align=Ue(n[1]),e.content=n[2]?.trim()??""):e.align="left";return}e.type="text",e.align="left"}function qe(e,t){let n=e.trim(),i={id:he(t),content:n};switch(jn(i,n),i.type){case"text":return{id:i.id,type:"text",content:i.content??"",align:i.align??"left"};case"image":return{id:i.id,type:"image",src:i.src??"",alt:i.alt??"",style:i.style??null,align:i.align??"left"};case"video":return{id:i.id,type:"video",src:i.src??"",style:i.style??null,align:i.align??"left"};case"code":return{id:i.id,type:"code",code:i.code??"",language:i.language??"text"};case"html":return{id:i.id,type:"html",html:i.html??"",align:i.align??"left"};case"callout":return{id:i.id,type:"callout",content:i.content??"",align:i.align??"left"};case"divider":return{id:i.id,type:"divider"};default:return{id:i.id,type:"text",content:i.content??"",align:"left"}}}function Dt(e){if(!e||!e.trim())return[{id:he(0),type:"text",content:"",align:"left"}];let n=e.split(new RegExp(`\\n+${at}\\n+`)).map((i,o)=>{let r=i.trim();if(r.startsWith(Oe)&&r.endsWith(Ve)){let a=r.slice(Oe.length,-Ve.length).trim().split(new RegExp(`\\n*${lt}\\n*`));if(a.length>=2)return{id:he(o),type:"row",left:qe(a[0]??"",o*10),right:qe(a[1]??"",o*10+1)}}return qe(i,o)});return n.length?n:[{id:he(0),type:"text",content:"",align:"left"}]}function Rn(e){return Dt(e)}function Bt(e){let t=e.style&&(e.style.includes("width")||e.style.includes("max-width")),n=e.align&&e.align!=="left";if(t||n){let i=Ne(e);return`<img src="${e.src}" alt="${e.alt||""}" style="${i}">`}return`![${e.alt||""}](${e.src})`}function Pt(e){let t=e.style&&(e.style.includes("width")||e.style.includes("max-width")),n=e.align&&e.align!=="left";if(t||n){let i=Ne(e);return`<video src="${e.src}" controls style="${i}"></video>`}return`<video src="${e.src}" controls></video>`}function Ct(e){return"```"+(e.language||"")+`
`+(e.code||"")+"\n```"}function It(e){return e.align&&e.align!=="left"?`<div class="callout" style="${$e(e.align)}">${e.content}</div>`:`<div class="callout">${e.content}</div>`}function At(e){let t=e.html||"";if(e.align&&e.align!=="left"){let n=$e(e.align);return`${we}
<div style="${n}">
${t}
</div>
${Ee}`}return`${we}
${t}
${Ee}`}function We(e){switch(e.type){case"text":{let t=(e.content||"").trim();return e.align&&e.align!=="left"?`<!-- align:${e.align} -->
${t}
<!-- /align -->`:t}case"image":return Bt(e);case"video":return Pt(e);case"code":return Ct(e);case"html":return At(e);case"row":{let t=We(e.left),n=We(e.right);return`${Oe}
${t}
${lt}
${n}
${Ve}`}case"callout":return It(e);case"divider":return"---";default:return""}}function be(e){return e.map(t=>We(t)).join(`

${at}

`)}function Y(e,t={}){let n={id:he(Date.now()),type:e};switch(e){case"text":return{...n,content:"",align:"left",...t};case"image":return{...n,src:"",alt:"",style:null,align:"left",...t};case"video":return{...n,src:"",style:null,align:"left",...t};case"code":return{...n,language:"javascript",code:"",...t};case"html":return{...n,html:"",align:"left",...t};case"callout":return{...n,content:"",align:"left",...t};case"row":return{...n,left:Y("text"),right:Y("text"),...t};case"divider":return{...n,...t};default:return{...n,content:"",align:"left",...t}}}var Nn=Y,$n={BLOCK_SEPARATOR:at,ROW_START:Oe,ROW_END:Ve,COL_SEPARATOR:lt,HTML_START:we,HTML_END:Ee,parseIntoBlocks:Dt,parseMarkdown:Rn,parseSingleBlock:qe,blockToMarkdown:We,blocksToMarkdown:be,formatImageMarkdown:Bt,formatVideoMarkdown:Pt,formatCodeMarkdown:Ct,formatHtmlBlock:At,formatCalloutHtml:It,createBlock:Y,createEmptyBlock:Nn,generateBlockId:he},ze=$n;var ct=new WeakMap,jt=!1;function Un(){jt||(jt=!0,window.addEventListener("message",e=>{if(!e.source||typeof e.data!="object"||e.data?.type!=="sandbox-resize")return;let t=ct.get(e.source);t&&e.data.nonce===t.nonce&&(t.iframe.style.height=`${e.data.height}px`)}))}function Fn(){return crypto.randomUUID()}function qn(e,t){return`<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body>
${e}
<script>
(function() {
  var nonce = "${t}";
  function reportHeight() {
    var height = Math.max(
      document.body.scrollHeight,
      document.documentElement.scrollHeight
    );
    window.parent.postMessage({ type: 'sandbox-resize', nonce: nonce, height: height }, '*');
  }
  new ResizeObserver(reportHeight).observe(document.body);
  window.addEventListener('load', reportHeight);
  reportHeight();
})();
<\/script>
</body>
</html>`}function Rt(e,t={}){Un();let n=document.createElement("iframe");n.className="html-block-sandbox";let i=["allow-scripts"];t.allowFullscreen!==!1&&(i.push("allow-fullscreen"),n.setAttribute("allow","fullscreen")),t.allowPointerLock&&i.push("allow-pointer-lock"),n.setAttribute("sandbox",i.join(" "));let o=Fn();return n.srcdoc=qn(e,o),n.style.minHeight=`${t.minHeight??60}px`,n.addEventListener("load",()=>{n.contentWindow&&ct.set(n.contentWindow,{iframe:n,nonce:o})}),n}function Nt(e){e.contentWindow&&ct.delete(e.contentWindow)}var $t={MENU_WIDTH:240},Te=[{id:"text",label:"Text",icon:"T",description:"Plain text paragraph"},{id:"image",label:"Image",icon:"\u{1F5BC}",description:"Upload or select an image"},{id:"video",label:"Video",icon:"\u{1F3AC}",description:"Upload a video file"},{id:"code",label:"Code",icon:"\u{1F4BB}",description:"Code block with syntax highlighting"},{id:"html",label:"HTML",icon:"<>",description:"Raw HTML (scripts, embeds, custom)"},{id:"callout",label:"Callout",icon:"\u{1F4CC}",description:"Highlighted message box"},{id:"divider",label:"Divider",icon:"\u2042",description:"Section break"}],S=null,U=!1,Le=!1,pe="",P=0,Z=null,ee=null,$=null,Se=null,me=null;function Ke(){if(S)return S;let e=document.createElement("div");return e.className="slash-command-menu",e.style.display="none",document.body.appendChild(e),S=e,e}function dt(e){if(!S)return;S.style.display="block",S.style.width=`${$t.MENU_WIDTH}px`,S.style.left=`${Math.min(e.left,window.innerWidth-$t.MENU_WIDTH-20)}px`;let t=S.offsetHeight||200,n=window.innerHeight-e.bottom-10,i=e.top-10;n<t&&i>n?(S.style.top="auto",S.style.bottom=`${window.innerHeight-e.top+5}px`,S.style.maxHeight=`${Math.min(300,i)}px`):(S.style.top=`${e.bottom+5}px`,S.style.bottom="auto",S.style.maxHeight=`${Math.min(300,n)}px`)}function Ft(e){if(!e)return Te;let t=e.toLowerCase();return Te.filter(n=>n.label.toLowerCase().includes(t)||n.id.toLowerCase().includes(t)||n.description.toLowerCase().includes(t))}function xe(e,t=0){S||Ke(),S&&(P=Math.max(0,Math.min(t,e.length-1)),S.innerHTML=e.map((n,i)=>`
      <button
        class="slash-menu-item ${i===P?"selected":""}"
        data-command="${n.id}"
      >
        <span class="slash-menu-icon">${n.icon}</span>
        <div class="slash-menu-content">
          <span class="slash-menu-label">${n.label}</span>
          <span class="slash-menu-description">${n.description}</span>
        </div>
      </button>
    `).join(""),S.querySelectorAll(".slash-menu-item").forEach((n,i)=>{n.addEventListener("click",()=>{let o=e[i];o&&Vt(o.id)})}))}function Ut(){if(!S)return;let e=S.querySelector(".slash-menu-item.selected");e&&e.scrollIntoView({block:"nearest",behavior:"smooth"})}function qt(){ut(),Se=()=>{!U||!$||dt($.getBoundingClientRect())},window.addEventListener("scroll",Se,!0),me=e=>{!U||!S||S.contains(e.target)||$?.contains(e.target)||te()},requestAnimationFrame(()=>{me&&document.addEventListener("mousedown",me,!0)})}function ut(){Se&&(window.removeEventListener("scroll",Se,!0),Se=null),me&&(document.removeEventListener("mousedown",me,!0),me=null)}function Ot(e,t){S||Ke(),U=!0,Le=!0,pe="",P=0,ee=t,$=e,xe(Te,0),dt(e.getBoundingClientRect()),qt()}function On(e,t,n){S||Ke(),U=!0,Le=!1,pe="",P=0,ee=t,$=n??null,xe(Te,0),dt(e),qt()}function te(){ut(),S&&(S.style.display="none"),U=!1,Le=!1,pe="",P=0,$=null}function Vt(e){let t=ee??0,n=Le,i=!1;if(Le&&ee!==null){let o=$&&$.tagName==="TEXTAREA"?$:document.querySelector(`.block-wrapper[data-block-index="${ee}"] .block-textarea`);if(o){let r=o.selectionStart,s=o.value,d=s.substring(0,r).lastIndexOf(`
`)+1;if(s[d]==="/"){let y=d,v=(s.substring(0,y)+s.substring(r)).replace(/\n+$/,"");if(o.value=v,o.classList.contains("text-line-input")){let m=o.closest(".block-wrapper");if(m){let p=m.querySelectorAll(".text-line-input");i=Array.from(p).every(c=>!c.value.trim())}else i=!v.trim();o.dispatchEvent(new Event("input",{bubbles:!0}))}else i=!v.trim(),Z&&Z("updateContent",{index:ee,content:v})}}}te(),Z&&(n?Z("execute",{commandId:e,insertIndex:i?t:t+1,replaceBlockIndex:i?t:null}):Z("execute",{commandId:e,insertIndex:t,replaceBlockIndex:null}))}function Vn(e){if(!U)return!1;let t=Ft(pe);switch(e.key){case"ArrowDown":return e.preventDefault(),e.stopPropagation(),P=(P+1)%t.length,xe(t,P),Ut(),!0;case"ArrowUp":return e.preventDefault(),e.stopPropagation(),P=(P-1+t.length)%t.length,xe(t,P),Ut(),!0;case"Enter":case"Tab":if(e.preventDefault(),e.stopPropagation(),t.length>0){let n=t[P];n&&Vt(n.id)}return!0;case"Escape":return e.preventDefault(),e.stopPropagation(),te(),!0}return!1}function Wn(e,t){let n=e.selectionStart,o=e.value.substring(0,n),s=o.lastIndexOf(`
`)+1;if(o.substring(s)==="/"){Ot(e,t);return}if(U){let l=o.lastIndexOf("/");if(l!==-1){let d=o.substring(0,l);if(d===""||d.endsWith(`
`)){pe=o.substring(l+1);let v=Ft(pe);v.length===0?te():xe(v,0)}else te()}else te()}}function zn(e){Z=e,Ke()}function Kn(){ut(),S&&(S.remove(),S=null),U=!1,$=null,Z=null}function Xn(){return U}function Gn(){return U}function Jn(){return ee}var Yn={init:zn,cleanup:Kn,showFromTextarea:Ot,showFromButton:On,hide:te,handleKeydown:Vn,handleTextareaInput:Wn,isActive:Xn,isVisible:Gn,getActiveIndex:Jn,COMMANDS:Te},C=Yn;var k=null,Xe=2e3,zt=.8,Qn=["image/jpeg","image/png","image/gif","image/webp"],Zn=["video/mp4","video/quicktime","video/webm"],ke={MIN_WIDTH_PERCENT:20,MAX_WIDTH_PERCENT:100,HANDLE_POSITIONS:["nw","ne","sw","se"],FULL_WIDTH_THRESHOLD:2},T=null,Me=[],ie=!1,ne=null,mt=!1,He=null,_e=null,ht=null,Wt=null;function ei(e){k=e,ti(),Kt()}function ti(){document.addEventListener("paste",async e=>{if(!k?.isActive())return;let t=Array.from(e.clipboardData?.items??[]);for(let n of t)if(n.type.startsWith("image/")){e.preventDefault();let i=n.getAsFile();if(!i)continue;let o=document.activeElement?.closest(".block-wrapper"),r=o?parseInt(o.getAttribute("data-block-index")??"",10):null;r!==null&&!isNaN(r)&&await gt(i,r);break}})}function Kt(){mt||(He=e=>ri(e),_e=()=>Jt(),ht=()=>ft(),Wt=e=>{if(!k?.isActive()||!T||ie)return;let t=e.target,n=t.closest(".image-block-wrapper"),i=t.closest(".resize-handle");n||i||pt()},document.addEventListener("click",Wt),window.addEventListener("resize",ht),window.addEventListener("scroll",ht,!0),mt=!0)}function ni(e,t){!e||!t||(mt||Kt(),!(T&&T.element===e)&&(pt(),T={element:e,block:t},e.classList.add("media-selected"),ii(e),ft()))}function pt(){ie&&Jt(),T&&(T.element.classList.remove("media-selected"),Gt(),T=null)}function ii(e){Gt();let t=e.getBoundingClientRect();ke.HANDLE_POSITIONS.forEach(n=>{let i=document.createElement("div");i.className=`resize-handle ${n}`,i.dataset.position=n,Xt(i,n,t),i.addEventListener("mousedown",o=>oi(o,n)),document.body.appendChild(i),Me.push(i)})}function Xt(e,t,n){switch(e.style.position="fixed",t){case"nw":e.style.top=`${n.top-6}px`,e.style.left=`${n.left-6}px`;break;case"ne":e.style.top=`${n.top-6}px`,e.style.left=`${n.right-6}px`;break;case"sw":e.style.top=`${n.bottom-6}px`,e.style.left=`${n.left-6}px`;break;case"se":e.style.top=`${n.bottom-6}px`,e.style.left=`${n.right-6}px`;break}}function ft(){if(!T||Me.length===0)return;let e=T.element.getBoundingClientRect();Me.forEach(t=>{let n=t.dataset.position;Xt(t,n,e)})}function Gt(){Me.forEach(e=>e.remove()),Me=[]}function oi(e,t){if(!T)return;e.preventDefault(),e.stopPropagation();let n=T.element,i=n.getBoundingClientRect();if(!i.width)return;let o=n.closest(".row-column")||n.closest(".block-content")||n.closest(".image-block-wrapper")||n.parentElement,r=o?o.getBoundingClientRect():i,s=Math.max(80,r.width*ke.MIN_WIDTH_PERCENT/100),a=r.width*ke.MAX_WIDTH_PERCENT/100;ie=!0,n.classList.add("media-resizing"),ne={position:t,startX:e.clientX,startWidth:i.width,minWidth:s,maxWidth:a,lastWidth:i.width},He&&_e&&(document.addEventListener("mousemove",He),document.addEventListener("mouseup",_e)),document.body.style.userSelect="none"}function ri(e){if(!ie||!T||!ne)return;let{position:t,startX:n,startWidth:i,minWidth:o,maxWidth:r}=ne,s=e.clientX-n;(t==="nw"||t==="sw")&&(s=-s);let a=i+s;a=Math.max(o,Math.min(r,a)),ne.lastWidth=a;let l=T.element,d=T.block;l.style.width=`${Math.round(a)}px`,l.style.height="auto";let y=Zt(d.style,a,r),v=k?.getBlocks().findIndex(g=>g.id===d.id)??-1;v>=0&&k?.updateBlock(v,{style:y},{render:!1,markDirty:!1}),T.block={...d,style:y},ft()}function Jt(){if(ie){if(ie=!1,T){T.element.classList.remove("media-resizing");let e=ne?.lastWidth,t=ne?.maxWidth;if(e&&t){let n=Zt(T.block.style,e,t),i=k?.getBlocks().findIndex(o=>o.id===T?.block.id)??-1;i>=0&&k?.updateBlock(i,{style:n},{render:!1,markDirty:!1}),en(n)||(T.element.style.width="",T.element.style.height=""),k?.markDirty()}}He&&_e&&(document.removeEventListener("mousemove",He),document.removeEventListener("mouseup",_e)),document.body.style.userSelect="",ne=null}}function Yt(e){let t={};return e&&e.split(";").forEach(n=>{let[i,...o]=n.split(":");if(!i)return;let r=o.join(":").trim();r&&(t[i.trim().toLowerCase()]=r)}),t}function Qt(e){return Object.entries(e).filter(([,t])=>t!=null&&t!=="").map(([t,n])=>`${t}: ${n}`).join("; ")}function Zt(e,t,n){let i=Yt(e);return delete i["margin-left"],delete i["margin-right"],delete i.display,delete i.height,delete i["max-height"],delete i["max-width"],delete i["min-width"],delete i["min-height"],Math.abs(t-n)<=ke.FULL_WIDTH_THRESHOLD?delete i.width:i.width=`${Math.round(t)}px`,Qt(i)||null}function en(e){return e?/(^|;)\s*width\s*:/.test(e):!1}async function tn(e){return new Promise((t,n)=>{let i=new Image,o=document.createElement("canvas"),r=o.getContext("2d");if(!r){n(new Error("Could not get canvas context"));return}i.onload=()=>{let s=i.width,a=i.height;s>Xe&&(a=Math.round(a*Xe/s),s=Xe),o.width=s,o.height=a,r.drawImage(i,0,0,s,a),o.toBlob(l=>{l?t(l):n(new Error("Failed to create blob"))},"image/webp",zt),URL.revokeObjectURL(i.src)},i.onerror=()=>{URL.revokeObjectURL(i.src),n(new Error("Failed to load image"))},i.src=URL.createObjectURL(e)})}async function Ge(e,t){let n=new FormData;n.append("file",e);let i=t==="video"?"/api/process-content-video":"/api/upload-media";t==="image"&&n.append("type","image");let o=await fetch(i,{method:"POST",body:n});if(!o.ok){let s=await o.json().catch(()=>({}));throw new Error(s.detail||`Upload failed: ${o.status}`)}return(await o.json()).url}async function gt(e,t){f("Processing image...","info");try{let n=await tn(e),i=await Ge(n,"image");k?.updateBlock(t,{src:i,alt:e.name.replace(/\.[^/.]+$/,"")}),f("Image uploaded!","success")}catch(n){console.error("Image upload failed:",n),f(n instanceof Error?n.message:"Image upload failed","error")}}async function nn(e,t){f("Processing video...","info");try{let n=await Ge(e,"video");k?.updateBlock(t,{src:n}),f("Video processed!","success")}catch(n){console.error("Video upload failed:",n),f(n instanceof Error?n.message:"Video processing failed","error")}}async function si(e,t=null){f("Processing image...","info");try{let n=await tn(e),i=await Ge(n,"image");li(i,e.name,t),f("Image uploaded!","success")}catch(n){console.error("Image upload failed:",n),f("Image upload failed","error")}}async function ai(e,t=null){f("Processing video...","info");try{let n=await Ge(e,"video");ci(n,t),f("Video processed!","success")}catch(n){console.error("Video upload failed:",n),f(n instanceof Error?n.message:"Video processing failed","error")}}function li(e,t="",n=null){let i=t.replace(/\.[^/.]+$/,"");if(n)k?.insertBlockAfter(n,"image",{src:e,alt:i});else{let o=k?.getBlocks().length??0;k?.insertBlock(o,"image",{src:e,alt:i})}}function ci(e,t=null){if(t)k?.insertBlockAfter(t,"video",{src:e});else{let n=k?.getBlocks().length??0;k?.insertBlock(n,"video",{src:e})}}async function di(e){let t=document.createElement("input");t.type="file",t.accept="image/*",t.addEventListener("change",async()=>{let n=t.files?.[0];n&&await gt(n,e)}),t.click()}async function ui(e){let t=document.createElement("input");t.type="file",t.accept="video/*",t.addEventListener("change",async()=>{let n=t.files?.[0];n&&await nn(n,e)}),t.click()}var hi={MAX_IMAGE_WIDTH:Xe,IMAGE_QUALITY:zt,ALLOWED_IMAGE_TYPES:Qn,ALLOWED_VIDEO_TYPES:Zn,RESIZE_CONFIG:ke,get selectedMedia(){return T},get isResizing(){return ie},init:ei,select:ni,deselect:pt,handleImageUploadForBlock:gt,handleVideoUploadForBlock:nn,handleImageUpload:si,handleVideoUpload:ai,replaceImageByIndex:di,replaceVideoByIndex:ui,parseStyle:Yt,serializeStyle:Qt,styleHasWidth:en},j=hi;var oe=null,M=[],x=-1,on=50,Je=!1,vt=null,rn=500;function mi(e){oe=e,M=[],x=-1}function pi(){M=[],x=-1}function fi(){if(!oe)throw new Error("EditUndo not initialized");return{blocks:Fe(oe.getBlocks()),timestamp:Date.now()}}function sn(){let e=fi();x<M.length-1&&(M=M.slice(0,x+1)),M.push(e),x=M.length-1,M.length>on&&(M.shift(),x--)}function gi(){Je||(vt!==null&&clearTimeout(vt),vt=setTimeout(()=>{sn()},rn))}function an(e){!e||!oe||(Je=!0,oe.setBlocks(Fe(e.blocks)),oe.renderBlocks(),oe.markDirty(),Je=!1)}function vi(){if(x<=0){f("Nothing to undo","info");return}x===M.length-1&&sn(),x--,an(M[x]),f("Undo","info",1e3)}function yi(){if(x>=M.length-1){f("Nothing to redo","info");return}x++,an(M[x]),f("Redo","info",1e3)}function wi(){M=[],x=-1}function Ei(){return x>0}function bi(){return x<M.length-1}var Si={get history(){return M},get currentIndex(){return x},get maxHistory(){return on},get isUndoing(){return Je},DEBOUNCE_MS:rn,init:mi,reset:pi,saveState:gi,undo:vi,redo:yi,clear:wi,canUndo:Ei,canRedo:bi},W=Si;var L=[],fe=null,ae=null,q=!1,ge=!1,Q=null,_=null,B=null,re="unchanged",K=null,z=null,O=null,F=null,Ti=2e3,Li=5e3,xi=3e3,X=null,I={sourceIndex:null,currentDropIndex:null,isDragging:!1};async function ki(e){if(!de()){console.log("Edit mode only available on localhost");return}fe=e,B="project",ge=!0;try{let t=await A(`/api/project/${e}`);ae=t,X=t.revision??null,dn(ae);let n=new URL(window.location.href);n.searchParams.set("edit",""),window.history.replaceState({},"",n)}catch(t){console.error("Failed to load project:",t),f("Failed to load project","error")}}async function Mi(){if(!de()){console.log("Edit mode only available on localhost");return}B="about",fe=null,ge=!0;try{let e=await A("/api/about");ae=e,X=e.revision??null,dn(ae);let t=new URL(window.location.href);t.searchParams.set("edit",""),window.history.replaceState({},"",t)}catch(e){console.error("Failed to load about content:",e),f("Failed to load about content","error")}}function dn(e){let t=B==="about"?document.querySelector(".about-content"):document.querySelector(".project-content");if(!t){console.error("Content container not found");return}if(B==="project"){let o=t.closest(".project-item");o&&o.querySelectorAll("video").forEach(s=>{s.pause()});let r=o?.querySelector(".edit-buttons");r&&(r.dataset.originalHtml=r.innerHTML,r.innerHTML=`
        <span class="edit-status"></span>
        <button class="edit-btn-action edit-btn-cancel" data-action="cancel">Cancel</button>
        <button class="edit-btn-action edit-btn-save" data-action="save">Save</button>
      `,_=r,_.querySelector('[data-action="cancel"]')?.addEventListener("click",Qe),_.querySelector('[data-action="save"]')?.addEventListener("click",Ye))}let n="markdown"in e?e.markdown:"";L=ze.parseIntoBlocks(n||"");let i=document.createElement("div");i.className="edit-mode-container",B==="about"?(i.innerHTML=`
      <div class="edit-mode-toolbar">
        <div class="edit-toolbar-left">
          <span class="edit-project-name">About Page</span>
          <span class="edit-status"></span>
        </div>
        <div class="edit-toolbar-right">
          <button class="edit-btn edit-btn-secondary" data-action="cancel">Cancel</button>
          <button class="edit-btn edit-btn-primary" data-action="save">Save</button>
        </div>
      </div>
      <div class="edit-blocks-container"></div>
    `,_=i.querySelector(".edit-mode-toolbar"),_?.querySelector('[data-action="cancel"]')?.addEventListener("click",Qe),_?.querySelector('[data-action="save"]')?.addEventListener("click",Ye)):i.innerHTML=`
      <div class="edit-blocks-container"></div>
    `,t.innerHTML="",t.appendChild(i),t.classList.add("edit-mode-active"),Q=i.querySelector(".edit-blocks-container"),C.init(Yi),j.init({updateBlock:le,insertBlock:Ze,insertBlockAfter:gn,getBlocks:()=>L,renderBlocks:De,markDirty:se,isActive:()=>ge}),W.init({getBlocks:()=>L,setBlocks:o=>{L=o},renderBlocks:De,markDirty:se}),W.saveState(),document.addEventListener("keydown",yn),De(),document.body.classList.add("editing"),window.addEventListener("beforeunload",hn)}function bt(e,t={}){if(B!=="project"||!fe||!ae)throw new Error("Project data is not loaded");let n=ae,i={slug:fe,original_slug:fe,name:n.name,date:n.date,pinned:n.pinned??!1,draft:n.draft??!1,youtube:n.youtube||"",video:n.video??{},markdown:e};return t.force?i.force=!0:i.base_revision=X,i}function un(){document.querySelector(".edit-conflict-banner")?.remove();let e=document.createElement("div");e.className="edit-conflict-banner",e.innerHTML=`
    <span class="edit-conflict-message">Content was modified in another session</span>
    <button class="edit-conflict-btn edit-conflict-keep">Keep mine</button>
    <button class="edit-conflict-btn edit-conflict-reload">Load theirs</button>
  `,e.style.cssText="position:fixed;top:0;left:0;right:0;z-index:10000;display:flex;align-items:center;justify-content:center;gap:12px;padding:12px 20px;background:#7c2d12;color:#fff;font-size:14px;font-family:-apple-system,BlinkMacSystemFont,sans-serif;box-shadow:0 2px 8px rgba(0,0,0,.3)";let t=e.querySelector(".edit-conflict-keep"),n=e.querySelector(".edit-conflict-reload");[t,n].forEach(i=>{i.style.cssText="padding:6px 16px;border:1px solid rgba(255,255,255,.3);border-radius:6px;background:transparent;color:#fff;font-size:13px;cursor:pointer"}),t.addEventListener("click",async()=>{e.remove();let i=be(L);try{let o;if(B==="about")o=await fetch("/api/save-about",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({markdown:i,force:!0})});else{let r=bt(i,{force:!0});o=await fetch("/api/save-project",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})}if(o.ok){let r=await o.json();r.revision&&(X=r.revision),q=!1,D({type:"save_ok"}),f("Changes saved (overwritten)","success")}else D({type:"save_error"}),f("Force save failed","error")}catch{D({type:"save_error"}),f("Force save failed","error")}}),n.addEventListener("click",()=>{e.remove(),Be(),window.location.reload()}),document.body.appendChild(e)}function Be(){ge=!1,K&&(clearTimeout(K),K=null),z&&(clearTimeout(z),z=null),O&&(clearTimeout(O),O=null),F&&(F.abort(),F=null),D({type:"reset"}),X=null,document.querySelector(".edit-conflict-banner")?.remove(),document.removeEventListener("keydown",yn),window.removeEventListener("beforeunload",hn),C.cleanup(),j.deselect(),document.body.classList.remove("editing");let e=B==="about"?document.querySelector(".about-content"):document.querySelector(".project-content");e&&e.classList.remove("edit-mode-active"),B==="project"&&_&&_.dataset.originalHtml&&(_.innerHTML=_.dataset.originalHtml,delete _.dataset.originalHtml);let t=new URL(window.location.href);t.searchParams.delete("edit"),window.history.replaceState({},"",t),B=null}function hn(e){q&&(e.preventDefault(),e.returnValue="")}function Hi(){if(!_)return;let e=_.querySelector(".edit-status"),t=_.querySelector('[data-action="save"]');if(t?.classList.remove("has-changes","is-saving","has-error"),e)switch(re){case"unchanged":e.textContent="",e.style.color="";break;case"pending":e.textContent="(unsaved)",e.style.color="#eab308",t?.classList.add("has-changes");break;case"saving":e.textContent="Saving...",e.style.color="#3b82f6",t?.classList.add("is-saving");break;case"saved":e.textContent="Saved",e.style.color="#22c55e";break;case"error":e.textContent="Save failed",e.style.color="#ef4444",t?.classList.add("has-error");break;case"conflict":e.textContent="Conflict",e.style.color="#f97316",t?.classList.add("has-error");break}}function _i(e,t){switch(t.type){case"edit":return"pending";case"save_start":return e==="conflict"?e:"saving";case"save_ok":return"saved";case"save_error":return"error";case"conflict":return"conflict";case"fade":return e==="saved"?"unchanged":e;case"reset":return"unchanged";default:return e}}function D(e){let t=_i(re,e);re=t,Hi(),t!=="saved"&&z&&(clearTimeout(z),z=null),t==="saved"&&(z&&clearTimeout(z),z=setTimeout(()=>{D({type:"fade"})},xi))}function Pe(e,t={}){let{render:n=!0,markDirty:i=!0}=t;L=e,i&&se(),n&&De()}function Ce(e,t,n={}){let i=L[e];if(!i)return!1;let o=t(i);if(o===i)return!1;let r=L.slice();return r[e]=o,Pe(r,n),!0}function Di(e,t={}){return Y(e,t)}function Bi(){K&&clearTimeout(K),O&&(clearTimeout(O),O=null),K=setTimeout(()=>{mn()},Ti)}async function mn(){if(!(!q||re==="saving"||re==="conflict")){if(B==="project"&&!ae){console.warn("Auto-save skipped: project data not loaded");return}F&&F.abort(),F=new AbortController,D({type:"save_start"});try{let e=be(L),t;if(B==="about")t=await fetch("/api/save-about",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({markdown:e,base_revision:X}),signal:F.signal});else{let i=bt(e);t=await fetch("/api/save-project",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),signal:F.signal})}if(t.status===409){D({type:"conflict"}),un();return}if(!t.ok)throw new Error(`Save failed: ${t.status}`);let n=await t.json();n.revision&&(X=n.revision),q=!1,D({type:"save_ok"})}catch(e){if(e instanceof Error&&e.name==="AbortError")return;console.error("Auto-save error:",e),D({type:"save_error"}),O=setTimeout(()=>{re==="error"&&q&&mn()},Li)}}}function De(){if(!Q)return;j.deselect();let e=Q;e.innerHTML="",L.forEach((t,n)=>{n>0&&e.appendChild(Wi(n)),e.appendChild(Pi(t,n))}),e.appendChild(zi(L.length))}function Pi(e,t){let n=document.createElement("div");n.className="block-wrapper",n.dataset.blockIndex=String(t),n.dataset.blockId=e.id,n.dataset.blockType=e.type;let i=document.createElement("div");i.className="block-handle",i.innerHTML="\u22EE\u22EE",i.draggable=!0,i.addEventListener("dragstart",s=>Ki(s,t)),i.addEventListener("dragend",fn),n.appendChild(i);let o=document.createElement("div");o.className="block-content",o.appendChild(Et(e,t)),n.appendChild(o),e.type!=="divider"&&e.type!=="code"&&n.appendChild(Ci(e,t));let r=document.createElement("button");return r.className="block-delete-btn",r.innerHTML="\xD7",r.title="Delete block",r.addEventListener("click",()=>vn(t)),n.appendChild(r),n.addEventListener("dragover",s=>Xi(s,t)),n.addEventListener("dragleave",Gi),n.addEventListener("drop",s=>Ji(s,t)),n}function Ci(e,t){let n=document.createElement("div");n.className="block-align-toolbar";let i=("align"in e?e.align:"left")||"left";return[{value:"left",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg>',title:"Align left"},{value:"center",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/></svg>',title:"Align center"},{value:"right",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="6" y1="18" x2="21" y2="18"/></svg>',title:"Align right"}].forEach(({value:r,icon:s,title:a})=>{let l=document.createElement("button");l.className="block-align-btn"+(i===r?" active":""),l.innerHTML=s,l.title=a,l.type="button",l.addEventListener("click",d=>{d.stopPropagation(),Ii(t,r)}),n.appendChild(l)}),n}function Ii(e,t){Ce(e,n=>"align"in n?{...n,align:t}:n)}function Et(e,t){switch(e.type){case"text":return ln(e,t);case"image":return Ni(e,t);case"video":return $i(e,t);case"code":return Ui(e,t);case"html":return Vi(e,t);case"callout":return Fi(e,t);case"row":return qi(e,t);case"divider":return Oi();default:return ln(e,t)}}function ln(e,t){let n=document.createElement("div");return n.className="text-block-wrapper",n.appendChild(Ai(e,t)),n}function Ai(e,t){let n=document.createElement("div");n.className="text-block-lines",e.align&&(n.style.textAlign=e.align);let i=(e.content||"").split(`
`);i.length||(i=[""]);let o=null,r=()=>{let c=i.join(`
`);if(L[t]?.type==="text"){Ce(t,h=>h.type==="text"?{...h,content:c}:h,{render:!1});return}e.content=c,se()},s=(c=null,u=null)=>{if(n.innerHTML="",i.forEach((h,w)=>{let H=a(h,w);n.appendChild(H)}),requestAnimationFrame(()=>{n.querySelectorAll(".text-block-line").forEach(h=>{m(h)})}),c!==null){let h=n.querySelector(`.text-block-line[data-line-index="${c}"]`);h&&l(h,u)}},a=(c,u)=>{let h=document.createElement("div");h.className="text-block-line",h.dataset.lineIndex=String(u);let w=document.createElement("div");w.className="text-block-line-preview",i.length===1&&!i[0]?.trim()?(w.classList.add("text-block-line-placeholder"),w.textContent="Type something... (type / for commands)"):w.appendChild(cn(c));let E=document.createElement("textarea");return E.className="text-line-input",E.value=c,E.rows=1,E.placeholder="Type something... (type / for commands)",w.addEventListener("click",b=>{b.preventDefault(),b.stopPropagation(),l(h)}),h.addEventListener("click",b=>{h.classList.contains("is-editing")||(b.preventDefault(),b.stopPropagation(),l(h))}),E.addEventListener("input",()=>{let b=E.value;if(C.handleTextareaInput(E,t),b.includes(`
`)){let R=b.split(`
`);i.splice(u,1,...R),r();let ce=R[R.length-1]??"";s(u+R.length-1,ce.length);return}i[u]=b,r(),m(h)}),E.addEventListener("keydown",b=>{if(!(C.isActive()&&C.handleKeydown(b))){if(rt(b,E,se)){i[u]=E.value,r(),m(h);return}if(!st(b,E,se)){if(b.key==="Enter"&&!b.shiftKey&&!b.metaKey&&!b.ctrlKey){b.preventDefault(),y(E,u);return}if(b.key==="Backspace"&&E.selectionStart===0&&E.selectionEnd===0){u>0&&(b.preventDefault(),v(u));return}if(b.key==="Delete"&&E.selectionStart===E.value.length&&E.selectionEnd===E.value.length){u<i.length-1&&(b.preventDefault(),g(u));return}if(b.key==="ArrowUp"&&E.selectionStart===0&&E.selectionEnd===0){u>0&&(b.preventDefault(),s(u-1,i[u-1]?.length??0));return}b.key==="ArrowDown"&&E.selectionStart===E.value.length&&E.selectionEnd===E.value.length&&u<i.length-1&&(b.preventDefault(),s(u+1,0))}}}),E.addEventListener("blur",()=>{o===u&&d(h)}),h.appendChild(w),h.appendChild(E),h},l=(c,u=null)=>{let h=Number(c.dataset.lineIndex);if(o!==null&&o!==h){let H=n.querySelector(`.text-block-line[data-line-index="${o}"]`);H&&d(H)}o=h,c.classList.add("is-editing");let w=c.querySelector(".text-line-input");w&&(w.focus(),u&&typeof u=="object"?(w.selectionStart=u.start,w.selectionEnd=u.end??u.start):typeof u=="number"?(w.selectionStart=u,w.selectionEnd=u):w.selectionStart=w.selectionEnd=w.value.length,m(c))},d=c=>{let u=c.querySelector(".text-line-input"),h=c.querySelector(".text-block-line-preview");c.classList.remove("is-editing");let w=u?.value??"";h?.classList.remove("text-block-line-placeholder"),h&&(h.innerHTML=""),i.length===1&&!i[0]?.trim()&&!w.trim()?(h?.classList.add("text-block-line-placeholder"),h&&(h.textContent="Type something... (type / for commands)")):h&&h.appendChild(cn(w)),o=null,m(c)},y=(c,u)=>{let h=c.value,w=c.selectionStart,H=h.slice(0,w),E=h.slice(w),b=p(H);i[u]=H;let R=b?b+E.replace(/^\s+/,""):E;i.splice(u+1,0,R),r();let ce=b?b.length:0;s(u+1,ce)},v=c=>{if(c<=0)return;let u=i[c-1]??"",h=i[c]??"",w=u+h;i.splice(c-1,2,w),r(),s(c-1,u.length)},g=c=>{if(c>=i.length-1)return;let u=i[c]??"",h=i[c+1]??"",w=u+h;i.splice(c,2,w),r(),s(c,u.length)},m=c=>{let u=c.querySelector(".text-block-line-preview"),h=c.querySelector(".text-line-input");requestAnimationFrame(()=>{let w=u?.offsetHeight??0,H=h?.scrollHeight??0,E=Math.max(27,w);c.style.minHeight=`${E}px`,c.classList.contains("is-editing")?c.style.height=`${Math.max(E,H)}px`:c.style.height=""})},p=c=>{let u=c.match(/^(\s*)([-*+])\s+/);if(u)return`${u[1]??""}${u[2]??"-"} `;let h=c.match(/^(\s*)(\d+)\.\s+/);if(h){let w=parseInt(h[2]??"1",10)+1;return`${h[1]??""}${w}. `}return null};return s(),n}function cn(e){let t=e.trim();if(!t){let r=document.createElement("span");return r.innerHTML="&nbsp;",r}if(/^(\*{3,}|-{3,}|_{3,})$/.test(t)){let r=document.createElement("hr");return r.className="text-line-divider",r}let n=e.match(/^(\s*)(#{1,6})\s+(.*)$/);if(n){let r=n[2]?.length??1,s=document.createElement(`h${r}`);return s.appendChild(yt(n[3]??"")),s}let i=e.match(/^(\s*)>\s+(.*)$/);if(i){let r=document.createElement("blockquote");return r.appendChild(yt(i[2]??"")),r}let o=document.createElement("span");return o.appendChild(yt(e)),o}function yt(e){let t=document.createDocumentFragment(),n=/\[([^\]]+)\]\(([^)]+)\)/g,i=0,o;for(;(o=n.exec(e))!==null;){let r=o.index;r>i&&wt(t,e.slice(i,r));let s=Ri(o[2]??"");if(s){let a=document.createElement("a");a.href=s,a.rel="noopener",a.target="_blank",wt(a,o[1]??""),t.appendChild(a)}else t.appendChild(document.createTextNode(o[0]));i=r+o[0].length}return i<e.length&&wt(t,e.slice(i)),t}function wt(e,t){e.appendChild(ji(t))}function ji(e){let t=document.createDocumentFragment();return t.appendChild(document.createTextNode(e)),t}function Ri(e){let t=(e||"").trim();if(!t)return null;if(t.startsWith("#")||t.startsWith("/")||t.startsWith("./")||t.startsWith("../"))return t;try{let n=new URL(t,window.location.origin);if(["http:","https:","mailto:","tel:"].includes(n.protocol))return n.href}catch{return null}return null}function Ni(e,t){let n=document.createElement("div");if(n.className="image-block-wrapper",e.src){let i=nt(e,r=>{j.select(r,e)});i.className="block-image",n.appendChild(i);let o=document.createElement("input");o.type="text",o.className="image-alt-input",o.placeholder="Image description...",o.value=e.alt||"",o.addEventListener("input",()=>{le(t,{alt:o.value},{render:!1})}),n.appendChild(o)}else n.appendChild(pn(t,"image"));return n}function $i(e,t){let n=document.createElement("div");if(n.className="video-block-wrapper",e.src){let i=it(e);i.className="block-video",n.appendChild(i)}else n.appendChild(pn(t,"video"));return n}function Ui(e,t){let n=document.createElement("div");n.className="code-block-wrapper";let i=document.createElement("select");i.className="code-language-select",["javascript","python","html","css","bash","json","sql","go","rust","text"].forEach(s=>{let a=document.createElement("option");a.value=s,a.textContent=s,s===(e.language||"javascript")&&(a.selected=!0),i.appendChild(a)}),i.addEventListener("change",()=>{le(t,{language:i.value},{render:!1})}),n.appendChild(i);let r=document.createElement("textarea");return r.className="code-textarea",r.value=e.code||"",r.placeholder="Enter code...",r.spellcheck=!1,ye(r,s=>{le(t,{code:s},{render:!1})}),r.addEventListener("keydown",s=>{s.key==="Tab"&&(s.preventDefault(),N(r,"    "),r.dispatchEvent(new Event("input",{bubbles:!0})))}),n.appendChild(r),n}function Fi(e,t){let n=document.createElement("div");n.className="callout-block-wrapper";let i=document.createElement("textarea");return i.className="callout-textarea",i.value=e.content||"",i.placeholder="Callout content...",e.align&&(i.style.textAlign=e.align),ye(i,o=>{le(t,{content:o},{render:!1})}),n.appendChild(i),n}function qi(e,t){let n=document.createElement("div");n.className="row-block-wrapper";let i=document.createElement("div");i.className="row-column row-column-left",i.appendChild(Et(e.left,t));let o=document.createElement("div");return o.className="row-column row-column-right",o.appendChild(Et(e.right,t)),n.appendChild(i),n.appendChild(o),n}function Oi(){let e=document.createElement("hr");return e.className="block-divider",e}function Vi(e,t){let n=document.createElement("div");n.className="html-block-wrapper",e.align&&(n.style.textAlign=e.align);let i=document.createElement("div");i.className="html-block-preview-container",n.appendChild(i);let o=null;function r(d){if(o&&(Nt(o),o.remove(),o=null),!d.trim()){i.innerHTML='<p class="html-block-empty">Empty HTML block</p>';return}i.innerHTML="",o=Rt(d,{allowFullscreen:!0}),i.appendChild(o)}r(e.html||"");let s=document.createElement("button");s.className="html-toggle-btn",s.textContent="Edit HTML",s.type="button",n.appendChild(s);let a=document.createElement("textarea");a.className="html-textarea",a.value=e.html||"",a.placeholder="Enter raw HTML...",a.style.display="none",n.appendChild(a);let l=!1;return s.addEventListener("click",()=>{l=!l,l?(i.style.display="none",a.style.display="block",s.textContent="Preview",a.focus()):(i.style.display="block",a.style.display="none",s.textContent="Edit HTML",r(a.value))}),ye(a,d=>{le(t,{html:d},{render:!1})}),n}function Wi(e){let t=document.createElement("div");t.className="merge-divider",t.dataset.afterIndex=String(e);let n=document.createElement("button");return n.className="merge-add-btn",n.innerHTML="+",n.title="Add block",n.addEventListener("click",()=>{let i=n.getBoundingClientRect();C.showFromButton(i,e,n)}),t.appendChild(n),t}function zi(e){let t=document.createElement("div");t.className="add-block-wrapper";let n=document.createElement("button");return n.className="merge-add-btn",n.innerHTML="+",n.title="Add block",n.addEventListener("click",()=>{let i=n.getBoundingClientRect();C.showFromButton(i,e,n)}),t.appendChild(n),t}function pn(e,t){let n=document.createElement("div");n.className="upload-zone",n.innerHTML=`
    <div class="upload-icon">${t==="image"?"\u{1F5BC}":"\u{1F3AC}"}</div>
    <div class="upload-text">Drop ${t} here or click to upload</div>
    <input type="file" class="upload-input" accept="${t==="image"?"image/*":"video/*"}">
  `;let i=n.querySelector(".upload-input");return i.addEventListener("change",async()=>{let o=i.files?.[0];o&&(t==="image"?await j.handleImageUploadForBlock(o,e):await j.handleVideoUploadForBlock(o,e))}),n.addEventListener("click",o=>{o.target!==i&&i.click()}),n.addEventListener("dragover",o=>{o.preventDefault(),n.classList.add("drag-over")}),n.addEventListener("dragleave",()=>{n.classList.remove("drag-over")}),n.addEventListener("drop",async o=>{o.preventDefault(),n.classList.remove("drag-over");let r=o.dataTransfer?.files[0];r&&(t==="image"?await j.handleImageUploadForBlock(r,e):await j.handleVideoUploadForBlock(r,e))}),n}function Ki(e,t){I.sourceIndex=t,I.isDragging=!0;let n=Q?.querySelector(`[data-block-index="${t}"]`);n&&n.classList.add("dragging"),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",t.toString()))}function fn(){I.isDragging=!1,I.sourceIndex=null,I.currentDropIndex=null,Q?.querySelectorAll(".dragging, .drag-over-top, .drag-over-bottom").forEach(e=>{e.classList.remove("dragging","drag-over-top","drag-over-bottom")})}function Xi(e,t){if(e.preventDefault(),!I.isDragging)return;let n=e.currentTarget,i=n.getBoundingClientRect(),o=i.top+i.height/2;Q?.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(r=>{r.classList.remove("drag-over-top","drag-over-bottom")}),e.clientY<o?(n.classList.add("drag-over-top"),I.currentDropIndex=t):(n.classList.add("drag-over-bottom"),I.currentDropIndex=t+1)}function Gi(e){e.currentTarget.classList.remove("drag-over-top","drag-over-bottom")}function Ji(e,t){if(e.preventDefault(),!I.isDragging||I.sourceIndex===null)return;let n=I.sourceIndex,i=I.currentDropIndex;if(i!==null){if(n<i&&i--,n!==i){let o=L.slice(),[r]=o.splice(n,1);r&&(o.splice(i,0,r),Pe(o))}fn()}}function Ze(e,t,n={}){let i=Di(t,n),o=Math.max(0,Math.min(e,L.length)),r=L.slice();r.splice(o,0,i),Pe(r),(t==="text"||t==="callout")&&setTimeout(()=>{let s=Q?.querySelector(`[data-block-index="${o}"] .text-line-input, [data-block-index="${o}"] .block-textarea, [data-block-index="${o}"] .callout-textarea`);s&&s.focus()},50)}function gn(e,t,n={}){let i=L.findIndex(o=>o.id===e);i!==-1&&Ze(i+1,t,n)}function vn(e){if(L.length<=1)Pe([Y("text")]);else{let t=L.slice();t.splice(e,1),Pe(t)}}function Yi(e,t){if(e==="execute"){let n=t;if(n.replaceBlockIndex!==null){let i=n.replaceBlockIndex;Ce(i,()=>Y(n.commandId)),(n.commandId==="text"||n.commandId==="callout")&&setTimeout(()=>{let o=Q?.querySelector(`[data-block-index="${i}"] .text-line-input, [data-block-index="${i}"] .block-textarea, [data-block-index="${i}"] .callout-textarea`);o&&o.focus()},50)}else Ze(n.insertIndex,n.commandId)}else if(e==="updateContent"){let n=t;Ce(n.index,i=>"content"in i?{...i,content:n.content}:i,{render:!1,markDirty:!1})}}function yn(e){if(ge&&!(C.isActive()&&C.handleKeydown(e))){if((e.metaKey||e.ctrlKey)&&!e.altKey&&e.key.toLowerCase()==="z"){e.preventDefault(),e.shiftKey?W.redo():W.undo();return}if((e.metaKey||e.ctrlKey)&&!e.altKey&&e.key.toLowerCase()==="y"){e.preventDefault(),W.redo();return}(e.metaKey||e.ctrlKey)&&e.key==="s"&&(e.preventDefault(),Ye()),e.key==="Escape"&&(e.preventDefault(),e.stopPropagation(),Qe())}}function se(){q=!0,W.saveState(),D({type:"edit"}),Bi()}async function Ye(){if(!q&&re!=="error"){Be(),window.location.reload();return}K&&(clearTimeout(K),K=null),O&&(clearTimeout(O),O=null),F&&F.abort(),D({type:"save_start"});try{let e=be(L),t;if(B==="about")t=await fetch("/api/save-about",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({markdown:e,base_revision:X})});else{let i=bt(e);t=await fetch("/api/save-project",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})}if(t.status===409){D({type:"conflict"}),un();return}if(!t.ok)throw new Error(`Save failed: ${t.status}`);let n=await t.json();n.revision&&(X=n.revision),q=!1,D({type:"save_ok"}),Be(),window.location.reload()}catch(e){console.error("Save error:",e),D({type:"save_error"}),f("Failed to save","error")}}function Qe(){q&&!confirm("You have unsaved changes. Discard them?")||(Be(),window.location.reload())}function le(e,t,n={}){Ce(e,i=>{switch(i.type){case"text":return{...i,...t};case"image":return{...i,...t};case"video":return{...i,...t};case"code":return{...i,...t};case"html":return{...i,...t};case"callout":return{...i,...t};case"row":return{...i,...t};case"divider":default:return{...i}}},n)}var Qi={init:ki,initAbout:Mi,cleanup:Be,get blocks(){return L},get isActive(){return ge},get isDirty(){return q},get projectSlug(){return fe},get editMode(){return B},insertBlock:Ze,insertBlockAfter:gn,deleteBlock:vn,updateBlock:le,renderBlocks:De,markDirty:se,save:Ye,cancel:Qe},wn=Qi;var En="bb_show_drafts";function St(){return document.body.dataset.isolationMode==="true"}function et(e,t={}){let n=new URL(e,window.location.origin);return Object.entries(t).forEach(([i,o])=>{o!=null&&n.searchParams.set(i,o)}),J()&&n.searchParams.set("show_drafts","true"),n.toString()}function Tt(){if(document.querySelector('link[href*="edit-mode.css"]'))return;let e=document.createElement("link");e.rel="stylesheet",e.href="/static/css/edit-mode.css",document.head.appendChild(e)}function V(){return new Promise(e=>{Tt(),e()})}function bn(e){let t=e.dataset.slug;if(!t||e.querySelector(".edit-buttons"))return;let n=document.createElement("div");n.className="edit-buttons";let i=document.createElement("button");i.className="edit-btn-action",i.textContent="Edit",i.addEventListener("click",async r=>{if(r.preventDefault(),r.stopPropagation(),!St()){window.location.href=et(`/${t}`,{edit:""});return}window.EditMode||await V(),window.EditMode?.init(t)});let o=document.createElement("button");o.className="edit-btn-action edit-btn-settings",o.innerHTML="&#9881;",o.title="Project Settings",o.addEventListener("click",async r=>{r.preventDefault(),r.stopPropagation(),window.ProjectSettings||await V(),window.ProjectSettings?.show(t)}),n.appendChild(i),n.appendChild(o),e.appendChild(n)}function Zi(e){let t=e.querySelector(".edit-buttons");t&&t.remove()}function eo(){let e=document.querySelector("#main-header nav");if(!e||e.querySelector(".new-project-btn"))return;let t=window.location.pathname==="/me",n=document.createElement("button");n.className="new-project-btn",n.textContent=t?"Edit":"+ New Project",n.addEventListener("click",async i=>{i.preventDefault(),t?(window.EditMode||await V(),window.EditMode&&window.EditMode.initAbout()):(window.ProjectCreate||await V(),window.ProjectCreate?.show())}),e.insertBefore(n,e.firstChild)}function to(){if(window.location.pathname!=="/")return;let e=document.querySelector("#main-header nav");if(!e||e.querySelector(".show-drafts-toggle"))return;let t=J(),n=document.createElement("button");n.className="show-drafts-toggle"+(t?" active":""),n.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" style="width:14px;height:14px;vertical-align:-2px;margin-right:5px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Drafts',n.addEventListener("click",o=>{o.preventDefault();let r=new URL(window.location.href);t?(r.searchParams.delete("show_drafts"),sessionStorage.removeItem(En)):(r.searchParams.set("show_drafts","true"),sessionStorage.setItem(En,"true")),window.location.href=r.toString()});let i=e.querySelector(".new-project-btn");i?e.insertBefore(n,i):e.insertBefore(n,e.firstChild)}function no(){document.addEventListener("keydown",async function(e){if((e.metaKey||e.ctrlKey)&&e.key==="e"){if(document.body.classList.contains("editing"))return;let t=document.activeElement;if(t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"))return;if(e.preventDefault(),window.location.pathname==="/me"){let o=new URL(window.location.href);o.searchParams.set("edit",""),window.history.replaceState({},"",o),window.EditMode||await V(),window.EditMode&&window.EditMode.initAbout();return}let i=document.querySelector(".project-item.active");if(i){let o=i.dataset.slug;if(o){if(!St()){window.location.href=et(`/${o}`,{edit:""});return}window.EditMode||await V(),window.EditMode?.init(o)}}}})}function Sn(){if(J(),window.location.pathname==="/"&&!new URLSearchParams(window.location.search).has("show_drafts")&&J()){let t=new URL(window.location.href);t.searchParams.set("show_drafts","true"),window.location.replace(t.toString());return}if(Tt(),eo(),to(),document.querySelectorAll(".project-item.active").forEach(bn),document.body.addEventListener("project:afterSwap",e=>{let t=e,{element:n,isOpen:i}=t.detail;if(n?.classList?.contains("project-details")){let o=n.closest(".project-item");o&&(i?setTimeout(()=>bn(o),50):Zi(o))}}),St()){let e=new URLSearchParams(window.location.search),n=document.querySelector(".project-item.active")?.dataset.slug;n&&(e.has("edit")?setTimeout(async()=>{window.EditMode||await V(),window.EditMode?.init(n)},100):e.has("settings")&&(window.history.replaceState({},"",et(`/${n}`)),setTimeout(async()=>{window.ProjectSettings||await V(),window.ProjectSettings?.show(n)},100)))}window.location.pathname==="/me"&&new URLSearchParams(window.location.search).has("edit")&&setTimeout(async()=>{window.EditMode||await V(),window.EditMode&&window.EditMode.initAbout()},100),no()}function io(){de()&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Sn):Sn())}var oo={init:io,loadEditModeScripts:V,loadEditModeCSS:Tt,isShowDraftsActive:J,buildUrlWithShowDrafts:et},Tn=oo;var Lt=1,G=6,Ln=3,ro={modal:null,projectSlug:null,projectData:null,currentView:"settings",videoFile:null,videoFlowMode:"upload",spriteStart:0,spriteDuration:Ln,objectUrl:null,activeXhr:null,videoEl:null,videoDuration:0,escHandler:null,_isDraggingSprite:!1,_mouseMoveHandler:null,_mouseUpHandler:null,_keyHandler:null,_beforeUnloadHandler:null,_spriteLooping:!1,_dragTarget:null,_dragOffset:0,_wasLoopingBeforeDrag:!1,_touchMoveHandler:null,_touchEndHandler:null,_rafId:null,_cachedTrack:null,_cachedRange:null,_cachedDimLeft:null,_cachedDimRight:null,_cachedInfo:null,_tempId:null,_hlsSessionId:null,_hlsComplete:!1,_hlsPollTimer:null,_thumbnailPollTimer:null,_hlsScriptPromise:null,_hlsPreviewUrl:null,_blobPreviewFailed:!1,_previewCodecErrorShown:!1,_hlsPreviewErrorShown:!1,_renderedThumbCount:0,async show(e){this.projectSlug=e;let t=document.querySelector(`#project-${e}`);t&&t.querySelectorAll("video").forEach(n=>n.pause());try{this.projectData=await A(`/api/project/${e}`),this.createModal()}catch(n){console.error("Failed to load project:",n),f("Failed to load project settings","error")}},createModal(){this.currentView="settings",this.modal=document.createElement("div"),this.modal.className="edit-settings-modal",this.modal.innerHTML=`
      <div class="edit-settings-overlay"></div>
      <div class="edit-settings-content"></div>
    `,document.body.appendChild(this.modal),Ae(),this.renderSettingsView(),this.setupBaseListeners()},setupBaseListeners(){if(!this.modal)return;let e=this.modal.querySelector(".edit-settings-overlay");e&&e.addEventListener("click",()=>{this.currentView==="video"?this.showSettingsView():this.hide()}),this.escHandler=t=>{t.key==="Escape"&&this.modal&&(t.preventDefault(),t.stopPropagation(),this.currentView==="video"?this.cancelUpload():this.hide())},document.addEventListener("keydown",this.escHandler,!0)},renderSettingsView(){this.currentView="settings";let e=this.projectData;if(!this.modal||!e)return;let t=this.modal.querySelector(".edit-settings-content");t&&(t.classList.remove("edit-settings-content--video"),t.innerHTML=`
      <div class="edit-settings-header">
        <h2>Project Settings</h2>
        <button class="edit-settings-close">&times;</button>
      </div>
      <form class="edit-settings-form" id="settings-form">
        <div class="edit-form-group">
          <label for="settings-name">Project Name</label>
          <input type="text" id="settings-name" name="name" value="${this.escAttr(e.name||"")}" required>
        </div>
        <div class="edit-form-group">
          <label for="settings-slug">URL Slug</label>
          <input type="text" id="settings-slug" name="slug" value="${this.escAttr(e.slug||"")}" required pattern="[a-z0-9\\-]+">
        </div>
        <div class="edit-form-group">
          <label for="settings-date">Date</label>
          <input type="date" id="settings-date" name="date" value="${e.date||""}" required>
        </div>
        <div class="edit-form-group">
          <label for="settings-youtube">YouTube Link</label>
          <input type="url" id="settings-youtube" name="youtube" value="${this.escAttr(e.youtube||"")}" placeholder="https://youtube.com/watch?v=...">
        </div>
        <div class="edit-form-row">
          <div class="edit-form-group edit-form-checkbox">
            <label>
              <input type="checkbox" id="settings-draft" name="draft" ${e.draft?"checked":""}>
              Draft
            </label>
          </div>
          <div class="edit-form-group edit-form-checkbox">
            <label>
              <input type="checkbox" id="settings-pinned" name="pinned" ${e.pinned?"checked":""}>
              Pinned
            </label>
          </div>
        </div>

        <div class="edit-form-section">
          <h3>Hero Video</h3>
          <div class="edit-form-group">
            <label>Current Video</label>
            ${e.video?.hls?`<div class="edit-video-info">
                    <span>HLS: ${e.video.hls.split("/").pop()}</span>
                    <div class="edit-video-actions">
                      <button type="button" class="edit-btn-small" id="update-hero-sprite">Update Sprite</button>
                      <button type="button" class="edit-btn-small" id="upload-hero-video">Replace</button>
                    </div>
                   </div>`:'<button type="button" class="edit-btn edit-btn-secondary" id="upload-hero-video">Upload Hero Video</button>'}
            <input type="file" id="hero-video-input" accept="video/*" style="display: none;">
          </div>
        </div>

        <div class="edit-settings-actions">
          <button type="button" class="edit-btn edit-btn-danger" id="delete-project">Delete Project</button>
          <div class="edit-settings-actions-right">
            <button type="button" class="edit-btn edit-btn-secondary" id="settings-cancel">Cancel</button>
            <button type="submit" class="edit-btn edit-btn-primary">Save Settings</button>
          </div>
        </div>
      </form>
    `,this.setupSettingsListeners())},setupSettingsListeners(){if(!this.modal)return;let e=this.modal.querySelector(".edit-settings-content");if(!e)return;let t=e.querySelector(".edit-settings-close");t&&t.addEventListener("click",()=>this.hide());let n=e.querySelector("#settings-cancel");n&&n.addEventListener("click",()=>this.hide());let i=e.querySelector("#settings-form");i&&i.addEventListener("submit",async l=>{l.preventDefault(),await this.saveSettings()});let o=e.querySelector("#delete-project");o&&o.addEventListener("click",async()=>{confirm(`Are you sure you want to delete "${this.projectData?.name}"? This cannot be undone.`)&&await this.deleteProject()});let r=e.querySelector("#upload-hero-video"),s=e.querySelector("#update-hero-sprite"),a=e.querySelector("#hero-video-input");r&&a&&(r.addEventListener("click",()=>a.click()),a.addEventListener("change",l=>{let y=l.target.files?.[0];if(y){if(!y.type.startsWith("video/")){f("Please select a video file","error");return}this.showVideoView(y)}})),s&&s.addEventListener("click",()=>{if(!this.projectData?.video?.hls){f("No existing hero video found for this project.","error");return}this.showVideoView()})},showVideoView(e=null){let t=!!e;if(this.currentView="video",this.videoFile=e,this.videoFlowMode=t?"upload":"existing",this.spriteStart=0,this.spriteDuration=Ln,this.videoDuration=0,this._spriteLooping=!1,this._tempId=null,this._hlsSessionId=null,this._hlsComplete=!1,this._hlsPreviewUrl=null,this._blobPreviewFailed=!1,this._previewCodecErrorShown=!1,this._hlsPreviewErrorShown=!1,this._renderedThumbCount=0,!this.modal)return;let n=this.modal.querySelector(".edit-settings-content");if(!n)return;n.classList.add("edit-settings-content--video");let i=this.getProcessButtonText(),o=t?"Process Hero Video":"Update Hero Sprite",r=t&&e?`${this.escHtml(e.name)} (${(e.size/(1024*1024)).toFixed(1)} MB)`:"Using current hero HLS stream",s=t?"Uploading...":"Loading current video...";n.innerHTML=`
      <div class="edit-settings-header">
        <h2>${o}</h2>
        <button class="edit-settings-close">&times;</button>
      </div>
      <div class="edit-hero-video-preview">
        <video class="edit-hero-video-player" controls playsinline></video>
      </div>
      <div class="edit-hero-file-info">${r}</div>
      <div class="edit-hero-preview-status" hidden></div>
      <div class="edit-hero-timeline">
        <div class="edit-hero-timeline-track">
          <canvas class="edit-hero-timeline-thumbs"></canvas>
          <div class="edit-hero-timeline-dim-left"></div>
          <div class="edit-hero-timeline-dim-right"></div>
          <div class="edit-hero-sprite-range">
            <div class="edit-hero-sprite-handle edit-hero-sprite-handle--start" data-handle="start">
              <div class="edit-hero-sprite-handle-grip"></div>
            </div>
            <div class="edit-hero-sprite-handle edit-hero-sprite-handle--end" data-handle="end">
              <div class="edit-hero-sprite-handle-grip"></div>
            </div>
          </div>
          <div class="edit-hero-playhead"></div>
        </div>
      </div>
      <div class="edit-hero-timeline-loading" hidden>Refining timeline preview...</div>
      <div class="edit-hero-time-display">
        <span class="edit-hero-current-time">0:00</span>
        <span class="edit-hero-sprite-info">Sprite: 0:00 - 0:03 (3.0s)</span>
        <span class="edit-hero-total-time">0:00</span>
      </div>
      <div class="edit-hero-progress" style="display: none;">
        <div class="edit-hero-progress-bar">
          <div class="edit-hero-progress-fill"></div>
        </div>
        <div class="edit-hero-progress-text">${s}</div>
      </div>
      <div class="edit-hero-actions">
        <button type="button" class="edit-btn edit-btn-secondary" id="hero-video-cancel">Cancel</button>
        <button type="button" class="edit-btn edit-btn-primary" id="hero-video-process" disabled>${i}</button>
      </div>
    `,this.videoEl=n.querySelector(".edit-hero-video-player"),this.updatePreviewStatus();let a=n.querySelector(".edit-settings-close");a&&a.addEventListener("click",()=>this.cancelUpload());let l=n.querySelector("#hero-video-cancel");l&&l.addEventListener("click",()=>this.cancelUpload());let d=n.querySelector("#hero-video-process");if(d&&d.addEventListener("click",()=>this.processVideo()),t&&e){this.extractServerThumbnails(e,n);return}this.extractExistingVideoThumbnails(n)},getProcessButtonText(){return this.videoFlowMode==="existing"?"Generate New Sprite":"Confirm & Generate Sprite"},extractServerThumbnails(e,t){let n=t.querySelector("#hero-video-process"),i=t.querySelector(".edit-hero-progress"),o=t.querySelector(".edit-hero-progress-fill"),r=t.querySelector(".edit-hero-progress-text");if(!i||!o||!r)return;i.style.display="block",r.textContent="Uploading video...";let s=new FormData;s.append("file",e),this.projectSlug&&s.append("project_slug",this.projectSlug);let a=new XMLHttpRequest;this.activeXhr=a,a.upload.addEventListener("progress",l=>{if(l.lengthComputable){let d=l.loaded/l.total*50;o.style.width=`${d}%`;let y=(l.loaded/(1024*1024)).toFixed(1),v=(l.total/(1024*1024)).toFixed(1);r.textContent=`Uploading: ${y} / ${v} MB`}}),a.addEventListener("load",()=>{if(this.activeXhr=null,a.status>=200&&a.status<300)try{let l=JSON.parse(a.responseText);if(l.success){this._tempId=l.temp_id,this.videoDuration=l.duration;let d=t.querySelector(".edit-hero-total-time");d&&(d.textContent=this.formatTime(this.videoDuration)),this.updateSpriteRange(),this.renderServerThumbnails(l.frames);let y=t.querySelector(".edit-hero-timeline-loading");y&&(y.hidden=!1),this.pollRemainingThumbnails(),n&&(n.disabled=!1),l.hls_session_id?(this._hlsSessionId=l.hls_session_id,o.style.width="50%",r.textContent="Encoding HLS...",this.pollHlsProgress(o,r,i)):i.style.display="none",this.objectUrl=URL.createObjectURL(e),this.videoEl=t.querySelector(".edit-hero-video-player"),this.videoEl&&(this.videoEl.classList.remove("hls-video-preview"),this.videoEl.dataset.previewSource="blob",this.videoEl.addEventListener("error",()=>{!this.videoEl||!(this.videoEl.currentSrc||this.videoEl.src||"").startsWith("blob:")||this._previewCodecErrorShown||(this._blobPreviewFailed=!0,this._previewCodecErrorShown=!0,this.updatePreviewStatus("Preview unavailable: this upload codec is not supported by your browser yet. It will appear once HLS finishes encoding.","warning"),f("Browser cannot play this upload codec. Preview will switch to HLS when ready.","info",4500))},{once:!0}),this.videoEl.addEventListener("loadedmetadata",()=>{!this.videoEl||!(this.videoEl.currentSrc||this.videoEl.src||"").startsWith("blob:")||(this.videoEl.videoWidth===0&&!this._blobPreviewFailed?(this._blobPreviewFailed=!0,this.updatePreviewStatus("Preview unavailable: browser can only decode audio for this upload. It will appear once HLS finishes encoding.","warning")):this._blobPreviewFailed||this.updatePreviewStatus())},{once:!0}),this.objectUrl&&(this.videoEl.src=this.objectUrl),this.setupVideoListeners(t))}else throw new Error(l.detail||"Thumbnail extraction failed")}catch(l){f(`Thumbnail extraction failed: ${l.message}`,"error"),this.cancelUpload()}else{let l="Thumbnail extraction failed";try{l=JSON.parse(a.responseText).detail||l}catch{}f(l,"error"),this.cancelUpload()}}),a.addEventListener("error",()=>{this.activeXhr=null,f("Network error during thumbnail extraction","error"),this.cancelUpload()}),a.open("POST","/api/video-thumbnails"),a.send(s)},async extractExistingVideoThumbnails(e){let t=e.querySelector("#hero-video-process"),n=e.querySelector(".edit-hero-progress"),i=e.querySelector(".edit-hero-progress-fill"),o=e.querySelector(".edit-hero-progress-text");if(!(!n||!i||!o)){if(!this.projectSlug){f("Project slug missing. Please reload and try again.","error"),this.cancelUpload();return}n.style.display="block",i.style.width="15%",o.textContent="Loading current video...";try{let r=new FormData;r.append("project_slug",this.projectSlug);let s=await fetch("/api/video-thumbnails-existing",{method:"POST",body:r});if(!s.ok){let y=await s.json();throw new Error(y.detail||"Failed to load existing video")}let a=await s.json();if(!a.success)throw new Error(a.detail||"Failed to load existing video");this._tempId=a.temp_id,this.videoDuration=a.duration,this._hlsComplete=!0,this._hlsSessionId=null;let l=e.querySelector(".edit-hero-total-time");l&&(l.textContent=this.formatTime(this.videoDuration)),this.updateSpriteRange(),this.renderServerThumbnails(a.frames||[]);let d=e.querySelector(".edit-hero-timeline-loading");d&&(d.hidden=!1),this.pollRemainingThumbnails(),t&&(t.disabled=!1),this.videoEl=e.querySelector(".edit-hero-video-player"),this.updatePreviewStatus(),this.setupVideoListeners(e),i.style.width="65%",o.textContent="Loading HLS preview...",a.hls_url&&await this.switchPreviewToHls(a.hls_url),i.style.width="100%",o.textContent="Preview ready. Select sprite range and confirm.",setTimeout(()=>{this.currentView==="video"&&(n.style.display="none")},1200)}catch(r){f(`Failed to load existing hero video: ${r.message}`,"error"),this.cancelUpload()}}},pollRemainingThumbnails(){let e=async()=>{if(!(!this._tempId||this.currentView!=="video"))try{let t=await fetch(`/api/video-thumbnails/more/${this._tempId}`);if(!t.ok)return;let n=await t.json(),i=this.modal?.querySelector(".edit-hero-timeline-loading");if(n.frames&&n.frames.length>this._renderedThumbCount&&this.renderServerThumbnails(n.frames),n.complete)i&&(i.hidden=!0);else{if(i){i.hidden=!1;let o=Array.isArray(n.frames)?n.frames.length:this._renderedThumbCount;i.textContent=`Refining timeline preview... (${o} frames)`}this._thumbnailPollTimer=setTimeout(e,500)}}catch{this._thumbnailPollTimer=setTimeout(e,1e3)}};e()},pollHlsProgress(e,t,n){this._hlsSessionId&&(this._hlsPollTimer=setInterval(async()=>{if(!this._hlsSessionId||this.currentView!=="video"){this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null);return}try{let i=await fetch(`/api/hls-progress/${this._hlsSessionId}`);if(!i.ok)return;let o=await i.json();if(o.status==="complete")this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null),this._hlsComplete=!0,o.hls_url&&await this.switchPreviewToHls(o.hls_url),e.style.width="100%",t.textContent="HLS ready! Select sprite range and confirm.",setTimeout(()=>{n&&this.currentView==="video"&&(n.style.display="none")},1500);else if(o.status==="error")this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null),t.textContent="HLS encoding failed - will retry on confirm",e.style.background="#ef4444",setTimeout(()=>{n&&this.currentView==="video"&&(n.style.display="none",e.style.background="")},2e3);else{let r=o.progress||0,s=50+r*.5;e.style.width=`${s}%`,t.textContent=o.stage||`Encoding HLS... ${Math.round(r)}%`}}catch{}},1e3))},loadHlsScript(){if(window.Hls)return Promise.resolve();if(this._hlsScriptPromise)return this._hlsScriptPromise;let e=document.body.dataset.hlsJsSrc||"https://cdn.jsdelivr.net/npm/hls.js@1.5.12";return this._hlsScriptPromise=new Promise((t,n)=>{let i=document.createElement("script");i.src=e,i.async=!0,i.onload=()=>t(),i.onerror=()=>n(new Error("Failed to load HLS.js")),document.head.appendChild(i)}),this._hlsScriptPromise},async switchPreviewToHls(e){if(!e||!this.videoEl||this.currentView!=="video"||this._hlsPreviewUrl===e)return;let t=this.videoEl,n=Number.isFinite(t.currentTime)?t.currentTime:0,i=!t.paused||this._spriteLooping,o=!!t.canPlayType("application/vnd.apple.mpegurl"),r=()=>{if(n>0)try{t.currentTime=n}catch{}i&&t.play().catch(()=>{})},s=()=>{t.hlsInstance&&(t.hlsInstance.destroy(),t.hlsInstance=null)},a=()=>new Promise((y,v)=>{if(!window.Hls||!window.Hls.isSupported()){v(new Error("HLS.js not supported"));return}s();let g=new window.Hls({abrEwmaDefaultEstimate:5e6,capLevelToPlayerSize:!0});t.hlsInstance=g;let m=!1,p=(c,u)=>{m||(m=!0,c?(r(),y()):(s(),v(u||new Error("HLS.js failed to initialize"))))};g.on(window.Hls.Events.MANIFEST_PARSED,()=>p(!0)),g.on(window.Hls.Events.ERROR,(c,u)=>{let h=u;h&&h.fatal&&p(!1,new Error(h.details||"HLS.js fatal error"))}),g.loadSource(e),g.attachMedia(t)}),l=()=>new Promise((y,v)=>{if(!o){v(new Error("Native HLS not supported"));return}let g=()=>{p(),r(),y()},m=()=>{p(),v(new Error("Native HLS failed to load"))},p=()=>{t.removeEventListener("loadedmetadata",g),t.removeEventListener("error",m)};s(),t.addEventListener("loadedmetadata",g),t.addEventListener("error",m),t.src=e,t.load()}),d=!1;try{await a(),d=!0}catch{try{await this.loadHlsScript(),await a(),d=!0}catch{if(o)try{await l(),d=!0}catch{}}}if(!d){t.dataset.previewSource="blob",this._blobPreviewFailed&&!this._hlsPreviewErrorShown?(this._hlsPreviewErrorShown=!0,this.updatePreviewStatus("Preview unavailable: HLS preview could not be initialized.","error"),f("HLS preview could not be initialized. Video will still process, but live preview is unavailable.","error",5e3)):this.updatePreviewStatus();return}this._hlsPreviewUrl=e,t.classList.add("hls-video-preview"),t.dataset.previewSource="hls",this.updatePreviewStatus(),this.objectUrl&&(URL.revokeObjectURL(this.objectUrl),this.objectUrl=null)},updatePreviewStatus(e="",t="info"){if(!this.modal||this.currentView!=="video")return;let n=this.modal.querySelector(".edit-hero-preview-status");if(n){if(!e){n.hidden=!0,n.textContent="",n.classList.remove("is-info","is-warning","is-error","is-success");return}n.hidden=!1,n.textContent=e,n.classList.remove("is-info","is-warning","is-error","is-success"),n.classList.add(`is-${t}`)}},renderServerThumbnails(e){if(!this.modal)return;let t=this.modal.querySelector(".edit-hero-timeline-thumbs");if(!t||!e||e.length===0)return;this._renderedThumbCount=e.length;let n=t.parentElement;if(!n)return;let i=n.clientWidth,o=n.clientHeight,r=window.devicePixelRatio||1;t.width=i*r,t.height=o*r;let s=t.getContext("2d");if(!s)return;s.scale(r,r),s.clearRect(0,0,i,o);let a=e.length,l=new Array(a).fill(null),d=0,y=(g,m)=>{let p=Math.floor(m*i/a),c=m===a-1?i:Math.floor((m+1)*i/a),u=Math.max(1,c-p),h=g.width/g.height,w=u/o,H=0,E=0,b=g.width,R=g.height;h>w?(b=Math.max(1,Math.round(g.height*w)),H=Math.max(0,Math.floor((g.width-b)/2))):h<w&&(R=Math.max(1,Math.round(g.width/w)),E=Math.max(0,Math.floor((g.height-R)/2)));let ce=Math.max(0,p-(m>0?1:0)),Mn=Math.min(i-ce,u+(m>0?1:0));s.drawImage(g,H,E,b,R,ce,0,Mn,o)},v=()=>{if(d++,d!==a)return;s.clearRect(0,0,i,o);let g=null;for(let p=0;p<a;p++){let c=l[p]??null;c?g=c:g&&(l[p]=g)}let m=null;for(let p=a-1;p>=0;p--){let c=l[p]??null;c?m=c:m&&(l[p]=m)}for(let p=0;p<a;p++){let c=l[p];c&&y(c,p)}t.classList.add("loaded")};e.forEach((g,m)=>{let p=new Image;p.onload=()=>{l[m]=p,v()},p.onerror=v,p.src="data:image/jpeg;base64,"+g})},setupVideoListeners(e){if(!this.videoEl)return;this.videoEl.addEventListener("timeupdate",()=>{if(!this.videoEl)return;this.updatePlayhead();let i=e.querySelector(".edit-hero-current-time");i&&(i.textContent=this.formatTime(this.videoEl.currentTime)),this._spriteLooping&&this.videoEl.currentTime>=this.spriteStart+this.spriteDuration&&(this.videoEl.currentTime=this.spriteStart)});let t=e.querySelector(".edit-hero-timeline-track");t&&t.addEventListener("click",i=>{if(this._isDraggingSprite||!this.videoEl)return;let o=t.getBoundingClientRect(),s=(i.clientX-o.left)/o.width*this.videoDuration,a=this.spriteStart+this.spriteDuration;s>=this.spriteStart&&s<=a?(this._spriteLooping=!0,this.videoEl.currentTime=s,this.videoEl.play()):(this._spriteLooping=!1,this.spriteStart=Math.max(0,Math.min(s,this.videoDuration-this.spriteDuration)),this.videoEl.currentTime=this.spriteStart,this.updateSpriteRange()),this.updateSpriteLoopUI()}),this._cachedTrack=e.querySelector(".edit-hero-timeline-track"),this._cachedRange=e.querySelector(".edit-hero-sprite-range"),this._cachedDimLeft=e.querySelector(".edit-hero-timeline-dim-left"),this._cachedDimRight=e.querySelector(".edit-hero-timeline-dim-right"),this._cachedInfo=e.querySelector(".edit-hero-sprite-info");let n=this._cachedRange;if(n){let i=(s,a)=>{if(this._isDraggingSprite=!0,this._dragTarget=a,n.classList.add("is-dragging"),this._wasLoopingBeforeDrag=this._spriteLooping,this.videoEl&&!this.videoEl.paused&&this.videoEl.pause(),a==="range"&&this._cachedTrack){let l=this._cachedTrack.getBoundingClientRect(),y=(s-l.left)/l.width*this.videoDuration;this._dragOffset=y-this.spriteStart}};n.addEventListener("mousedown",s=>{s.target.closest(".edit-hero-sprite-handle")||(i(s.clientX,"range"),s.preventDefault(),s.stopPropagation())}),n.addEventListener("touchstart",s=>{if(s.target.closest(".edit-hero-sprite-handle"))return;let l=s.touches[0];l&&(i(l.clientX,"range"),s.preventDefault(),s.stopPropagation())},{passive:!1});let o=n.querySelector(".edit-hero-sprite-handle--start");o&&(o.addEventListener("mousedown",s=>{i(s.clientX,"start"),s.preventDefault(),s.stopPropagation()}),o.addEventListener("touchstart",s=>{let a=s.touches[0];a&&(i(a.clientX,"start"),s.preventDefault(),s.stopPropagation())},{passive:!1}));let r=n.querySelector(".edit-hero-sprite-handle--end");r&&(r.addEventListener("mousedown",s=>{i(s.clientX,"end"),s.preventDefault(),s.stopPropagation()}),r.addEventListener("touchstart",s=>{let a=s.touches[0];a&&(i(a.clientX,"end"),s.preventDefault(),s.stopPropagation())},{passive:!1})),n.addEventListener("dblclick",s=>{s.preventDefault(),s.stopPropagation(),this._spriteLooping=!this._spriteLooping,this._spriteLooping&&this.videoEl&&(this.videoEl.currentTime=this.spriteStart,this.videoEl.play()),this.updateSpriteLoopUI()})}this._mouseMoveHandler=i=>{this._isDraggingSprite&&this.handleDrag(i.clientX)},document.addEventListener("mousemove",this._mouseMoveHandler),this._mouseUpHandler=()=>{this._isDraggingSprite&&(this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),this._isDraggingSprite=!1,this._dragTarget=null,this._cachedRange?.classList.remove("is-dragging"),this._wasLoopingBeforeDrag&&this.videoEl&&(this.videoEl.currentTime=this.spriteStart,this.videoEl.play()),this._wasLoopingBeforeDrag=!1)},document.addEventListener("mouseup",this._mouseUpHandler),this._touchMoveHandler=i=>{if(!this._isDraggingSprite)return;let o=i.touches[0];o&&this.handleDrag(o.clientX)},document.addEventListener("touchmove",this._touchMoveHandler,{passive:!0}),this._touchEndHandler=()=>{this._isDraggingSprite&&(this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),this._isDraggingSprite=!1,this._dragTarget=null,this._cachedRange?.classList.remove("is-dragging"),this._wasLoopingBeforeDrag&&this.videoEl&&(this.videoEl.currentTime=this.spriteStart,this.videoEl.play()),this._wasLoopingBeforeDrag=!1)},document.addEventListener("touchend",this._touchEndHandler),this._keyHandler=i=>{if(!(this.currentView!=="video"||!this.modal||!this.videoEl)){if(i.key==="ArrowLeft"){if(i.preventDefault(),i.shiftKey){let o=Math.max(Lt,this.spriteDuration-.5);this.spriteDuration=o}else this.spriteStart=Math.max(0,this.spriteStart-.5);this.videoEl.currentTime=this.spriteStart,this.updateSpriteRange()}if(i.key==="ArrowRight"){if(i.preventDefault(),i.shiftKey){let o=Math.min(G,this.videoDuration-this.spriteStart),r=Math.min(o,this.spriteDuration+.5);this.spriteDuration=r,this.videoEl.currentTime=this.spriteStart+this.spriteDuration}else this.spriteStart=Math.min(this.videoDuration-this.spriteDuration,this.spriteStart+.5),this.videoEl.currentTime=this.spriteStart;this.updateSpriteRange()}}},document.addEventListener("keydown",this._keyHandler)},updateSpriteLoopUI(){if(!this.modal)return;let e=this.modal.querySelector(".edit-hero-sprite-info");e&&(this._spriteLooping?e.classList.add("looping"):e.classList.remove("looping"))},showSettingsView(){this.cleanupVideoState(),this.renderSettingsView()},cleanupVideoState(){this.videoEl&&this.videoEl.hlsInstance&&(this.videoEl.hlsInstance.destroy(),this.videoEl.hlsInstance=null),this.objectUrl&&(URL.revokeObjectURL(this.objectUrl),this.objectUrl=null),this._mouseMoveHandler&&(document.removeEventListener("mousemove",this._mouseMoveHandler),this._mouseMoveHandler=null),this._mouseUpHandler&&(document.removeEventListener("mouseup",this._mouseUpHandler),this._mouseUpHandler=null),this._keyHandler&&(document.removeEventListener("keydown",this._keyHandler),this._keyHandler=null),this._touchMoveHandler&&(document.removeEventListener("touchmove",this._touchMoveHandler),this._touchMoveHandler=null),this._touchEndHandler&&(document.removeEventListener("touchend",this._touchEndHandler),this._touchEndHandler=null),this._beforeUnloadHandler&&(window.removeEventListener("beforeunload",this._beforeUnloadHandler),this._beforeUnloadHandler=null),this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null),this._thumbnailPollTimer&&(clearTimeout(this._thumbnailPollTimer),this._thumbnailPollTimer=null),this.activeXhr&&(this.activeXhr.abort(),this.activeXhr=null),this.videoEl=null,this.videoFile=null,this.videoFlowMode="upload",this._tempId=null,this._isDraggingSprite=!1,this._spriteLooping=!1,this._hlsSessionId=null,this._hlsComplete=!1,this._hlsPreviewUrl=null,this._blobPreviewFailed=!1,this._previewCodecErrorShown=!1,this._hlsPreviewErrorShown=!1,this._renderedThumbCount=0,this._dragTarget=null,this._dragOffset=0,this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),this._cachedTrack=null,this._cachedRange=null,this._cachedDimLeft=null,this._cachedDimRight=null,this._cachedInfo=null},handleDrag(e){if(!this._dragTarget||!this._cachedTrack||!this.videoEl)return;let t=this._cachedTrack.getBoundingClientRect(),i=Math.max(0,Math.min(1,(e-t.left)/t.width))*this.videoDuration,o=this.spriteStart+this.spriteDuration;if(this._dragTarget==="start"){let r=Math.max(0,Math.min(i,o-Lt)),s=o,a=s-r;a>G&&(a=G,s=r+G,s>this.videoDuration&&(s=this.videoDuration,r=s-G)),this.spriteStart=r,this.spriteDuration=a,this.videoEl.currentTime=this.spriteStart}else if(this._dragTarget==="end"){let r=Math.max(this.spriteStart+Lt,Math.min(i,this.videoDuration)),s=this.spriteStart,a=r-s;a>G&&(a=G,s=r-G,s<0&&(s=0,r=G)),this.spriteStart=s,this.spriteDuration=a,this.videoEl.currentTime=r}else if(this._dragTarget==="range"){let r=i-this._dragOffset;r=Math.max(0,Math.min(r,this.videoDuration-this.spriteDuration)),this.spriteStart=r,this.videoEl.currentTime=this.spriteStart}this.updateSpriteRange()},updateSpriteRange(){if(!this.videoDuration)return;let e=this._cachedRange||this.modal?.querySelector(".edit-hero-sprite-range"),t=this._cachedInfo||this.modal?.querySelector(".edit-hero-sprite-info"),n=this._cachedDimLeft||this.modal?.querySelector(".edit-hero-timeline-dim-left"),i=this._cachedDimRight||this.modal?.querySelector(".edit-hero-timeline-dim-right");if(!e)return;let o=this.spriteStart/this.videoDuration*100,r=this.spriteDuration/this.videoDuration*100;if(e.style.left=`${o}%`,e.style.width=`${r}%`,n&&(n.style.width=`${o}%`),i&&(i.style.left=`${o+r}%`,i.style.width=`${100-o-r}%`),t){let s=this.spriteStart+this.spriteDuration;t.textContent=`Sprite: ${this.formatTime(this.spriteStart)} - ${this.formatTime(s)} (${this.spriteDuration.toFixed(1)}s)`}},updatePlayhead(){if(!this.modal||!this.videoEl||!this.videoDuration)return;let e=this.modal.querySelector(".edit-hero-playhead");if(!e)return;let t=this.videoEl.currentTime/this.videoDuration*100;e.style.left=`${t}%`},async processVideo(){if(!this.modal)return;let e=this.modal.querySelector("#hero-video-process"),t=this.modal.querySelector(".edit-hero-progress"),n=this.modal.querySelector(".edit-hero-progress-fill"),i=this.modal.querySelector(".edit-hero-progress-text");if(!e||!t||!n||!i)return;e.disabled=!0,e.textContent="Processing...",t.style.display="block",this._thumbnailPollTimer&&(clearTimeout(this._thumbnailPollTimer),this._thumbnailPollTimer=null),this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null),this._hlsSessionId&&!this._hlsComplete?(n.style.width="20%",i.textContent="Encoding video..."):(n.style.width="80%",i.textContent="Generating sprite sheet & thumbnail...");let o=null;this._hlsSessionId&&!this._hlsComplete&&(o=setInterval(async()=>{try{let r=await fetch(`/api/hls-progress/${this._hlsSessionId}`);if(!r.ok)return;let s=await r.json();if(s.status==="complete")o&&(clearInterval(o),o=null),this._hlsComplete=!0,s.hls_url&&await this.switchPreviewToHls(s.hls_url),n.style.width="80%",i.textContent="Generating sprite sheet & thumbnail...";else if(s.status==="error")o&&(clearInterval(o),o=null);else{let a=s.progress||0,l=20+a*.6;n.style.width=`${l}%`;let d=s.stage||`Encoding video... ${Math.round(a)}%`;i.textContent=d}}catch{}},1e3)),this._beforeUnloadHandler=r=>{r.preventDefault(),r.returnValue=""},window.addEventListener("beforeunload",this._beforeUnloadHandler);try{let r=this._tempId;this._tempId=null;let s=new FormData;r&&s.append("temp_id",r),this.projectSlug&&s.append("project_slug",this.projectSlug),s.append("sprite_start",String(this.spriteStart)),s.append("sprite_duration",String(this.spriteDuration)),this._hlsSessionId&&s.append("hls_session_id",this._hlsSessionId);let a=await fetch("/api/generate-sprite-sheet",{method:"POST",body:s});if(o&&(clearInterval(o),o=null),!a.ok){let d=await a.json();throw new Error(d.detail||"Sprite sheet generation failed")}let l=await a.json();if(l.success&&l.video){n.style.width="95%",i.textContent="Saving...",this.projectData&&(this.projectData.video=l.video),await this.saveVideoData(l.video),n.style.width="100%",i.textContent="Complete!";let d=this.videoFlowMode==="existing"?"Hero sprite updated successfully!":"Video processed successfully!";f(d,"success"),setTimeout(()=>this.showSettingsView(),800)}else throw new Error(l.detail||"Processing failed")}catch(r){o&&clearInterval(o),this.handleProcessingError(r.message,e,t)}finally{this._beforeUnloadHandler&&(window.removeEventListener("beforeunload",this._beforeUnloadHandler),this._beforeUnloadHandler=null)}},handleProcessingError(e,t,n){this._beforeUnloadHandler&&(window.removeEventListener("beforeunload",this._beforeUnloadHandler),this._beforeUnloadHandler=null),f(`Video processing failed: ${e}`,"error"),t&&(t.disabled=!1,t.textContent=this.getProcessButtonText()),n&&(n.style.display="none")},cancelUpload(){this.activeXhr&&(this.activeXhr.abort(),this.activeXhr=null),this.showSettingsView()},formatTime(e){let t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n.toString().padStart(2,"0")}`},escAttr(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},escHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},async saveSettings(){if(!this.modal)return;let e=this.modal.querySelector("#settings-form");if(!e)return;let t=new FormData(e),n={name:t.get("name"),slug:t.get("slug"),original_slug:this.projectSlug,date:t.get("date"),youtube:t.get("youtube")||null,draft:t.get("draft")==="on",pinned:t.get("pinned")==="on",video:this.projectData?.video,markdown:this.projectData?.markdown,base_revision:this.projectData?.revision};try{let i=await A("/api/save-project",{method:"POST",body:JSON.stringify(n)});i.revision&&this.projectData&&(this.projectData.revision=i.revision),f("Settings saved!","success"),n.slug!==this.projectSlug?window.location.href=ue(`/${n.slug}`):(this.hide(),window.location.reload())}catch(i){console.error("Save settings error:",i),f("Failed to save settings","error")}},async saveVideoData(e){if(!this.projectData)return;let t={...this.projectData,original_slug:this.projectSlug,video:e,base_revision:this.projectData.revision},n=await A("/api/save-project",{method:"POST",body:JSON.stringify(t)});n.revision&&(this.projectData.revision=n.revision)},async deleteProject(){if(this.projectSlug)try{await A(`/api/project/${this.projectSlug}`,{method:"DELETE"}),f("Project deleted","success"),this.hide(),window.location.href=ue("/")}catch(e){console.error("Delete project error:",e),f("Failed to delete project","error")}},hide(){this.cleanupVideoState(),this.escHandler&&(document.removeEventListener("keydown",this.escHandler,!0),this.escHandler=null),this.modal&&(this.modal.remove(),this.modal=null),je()}},xn=ro;var so={modal:null,show(){this.modal=document.createElement("div"),this.modal.className="edit-create-modal",this.modal.innerHTML=`
      <div class="edit-create-overlay"></div>
      <div class="edit-create-content">
        <div class="edit-create-header">
          <h2>Create New Project</h2>
          <button class="edit-create-close">&times;</button>
        </div>
        <form class="edit-create-form" id="create-project-form">
          <div class="edit-form-group">
            <label for="project-name">Project Name</label>
            <input type="text" id="project-name" name="name" required placeholder="My New Project">
          </div>
          <div class="edit-form-group">
            <label for="project-slug">URL Slug</label>
            <input type="text" id="project-slug" name="slug" required placeholder="my-new-project" pattern="[a-z0-9][a-z0-9_\\-]*">
            <span class="edit-form-hint">Must start with letter/number. Lowercase, numbers, hyphens, underscores only.</span>
          </div>
          <div class="edit-form-group">
            <label for="project-date">Date</label>
            <input type="date" id="project-date" name="date" required value="${new Date().toISOString().split("T")[0]}">
          </div>
          <div class="edit-form-row">
            <div class="edit-form-group edit-form-checkbox">
              <label>
                <input type="checkbox" id="project-draft" name="draft" checked>
                Draft
              </label>
            </div>
            <div class="edit-form-group edit-form-checkbox">
              <label>
                <input type="checkbox" id="project-pinned" name="pinned">
                Pinned
              </label>
            </div>
          </div>
          <div class="edit-create-actions">
            <button type="button" class="edit-btn edit-btn-secondary" id="create-cancel">Cancel</button>
            <button type="submit" class="edit-btn edit-btn-primary">Create Project</button>
          </div>
        </form>
      </div>
    `,document.body.appendChild(this.modal),Ae(),this.setupEventListeners();let e=this.modal.querySelector("#project-name"),t=this.modal.querySelector("#project-slug");e&&t&&(e.addEventListener("input",()=>{t.value=this.generateSlug(e.value)}),e.focus())},generateSlug(e){return e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^[-_]+/,"").replace(/[-_]+$/,"")},setupEventListeners(){if(!this.modal)return;let e=this.modal.querySelector(".edit-create-close");e&&e.addEventListener("click",()=>this.hide());let t=this.modal.querySelector(".edit-create-overlay");t&&t.addEventListener("click",()=>this.hide());let n=this.modal.querySelector("#create-cancel");n&&n.addEventListener("click",()=>this.hide());let i=this.modal.querySelector("#create-project-form");i&&i.addEventListener("submit",async r=>{r.preventDefault(),await this.createProject()});let o=r=>{r.key==="Escape"&&this.modal&&(this.hide(),document.removeEventListener("keydown",o))};document.addEventListener("keydown",o)},async createProject(){if(!this.modal)return;let e=this.modal.querySelector("#create-project-form");if(!e)return;let t=new FormData(e),n={name:t.get("name"),slug:t.get("slug"),date:t.get("date"),draft:t.get("draft")==="on",pinned:t.get("pinned")==="on",markdown:""};try{await A("/api/create-project",{method:"POST",body:JSON.stringify(n)}),f("Project created!","success"),this.hide(),window.location.href=ue(`/${n.slug}`)}catch(i){console.error("Create project error:",i);let o=i instanceof Error?i.message:"Failed to create project";f(o,"error")}},hide(){this.modal&&(this.modal.remove(),this.modal=null),je()}},kn=so;typeof window<"u"&&(window.EditUtils=_t,window.EditBlocks=ze,window.EditMode=wn,window.EditMedia=j,window.EditSlash=C,window.EditUndo=W,window.ProjectSettings=xn,window.ProjectCreate=kn);Tn.init();})();
//# sourceMappingURL=edit-bundle.js.map
