// Auto-generated by esbuild - do not edit directly

"use strict";(()=>{function wn(){return"block-"+Date.now()+"-"+Math.random().toString(36).substring(2,11)}function ae(){let e=window.location.hostname;return e==="localhost"||e==="127.0.0.1"}function J(){let e="bb_show_drafts",n=new URLSearchParams(window.location.search);if(n.has("show_drafts")){let t=n.get("show_drafts")==="true";return t?sessionStorage.setItem(e,"true"):sessionStorage.removeItem(e),t}return sessionStorage.getItem(e)==="true"}function ce(e){try{let n=new URL(e,window.location.origin);return J()&&n.searchParams.set("show_drafts","true"),n.toString()}catch{return e}}var pe="data-scroll-lock-count",Je="data-scroll-lock-y";function He(){let e=document.body,n=Number(e.getAttribute(pe)||"0");if(n===0){let t=window.scrollY||window.pageYOffset||0;e.setAttribute(Je,String(t)),e.classList.add("modal-open"),e.style.position="fixed",e.style.top=`-${t}px`,e.style.left="0",e.style.right="0",e.style.width="100%",e.style.overflow="hidden"}e.setAttribute(pe,String(n+1))}function De(){let e=document.body,n=Number(e.getAttribute(pe)||"0");if(n<=0){e.classList.remove("modal-open");return}if(n>1){e.setAttribute(pe,String(n-1));return}let t=Number(e.getAttribute(Je)||"0");e.removeAttribute(pe),e.removeAttribute(Je),e.classList.remove("modal-open"),e.style.position="",e.style.top="",e.style.left="",e.style.right="",e.style.width="",e.style.overflow="",window.scrollTo(0,t)}function fe(e,n){let t=()=>{e.style.height="auto",e.style.height=e.scrollHeight+"px"};return e.addEventListener("input",()=>{t(),n&&n(e.value)}),setTimeout(t,0),t}function Ye(e,n){let t=document.createElement("img");return t.src=e.src,t.alt=e.alt||"",e.style&&t.setAttribute("style",e.style),e.align&&Ze(t,e.align),n&&t.addEventListener("click",i=>{i.stopPropagation(),n(t,e)}),t}function Qe(e,n){let t=document.createElement("video");return t.src=e.src,t.controls=!0,t.className="content-video",e.style&&t.setAttribute("style",e.style),e.align&&Ze(t,e.align),n&&t.addEventListener("click",i=>{i.stopPropagation(),n(t,e)}),t}function Ze(e,n){e.style.display="block",e.style.marginLeft="",e.style.marginRight="",n==="center"?(e.style.marginLeft="auto",e.style.marginRight="auto"):n==="right"&&(e.style.marginLeft="auto")}function wt(e){switch(e){case"center":return"margin-left: auto; margin-right: auto";case"right":return"margin-left: auto";default:return""}}function _e(e){if(!e)return"left";let n=e.includes("margin-left: auto")||e.includes("margin-left:auto"),t=e.includes("margin-right: auto")||e.includes("margin-right:auto");return n&&t?"center":n?"right":"left"}function Pe(e){let n=["display: block"];if(e.style){let i=e.style.replace(/margin-left:\s*auto;?\s*/g,"").replace(/margin-right:\s*auto;?\s*/g,"").replace(/display:\s*block;?\s*/g,"").trim();i&&n.push(i)}let t=wt(e.align??"left");return t&&n.push(t),n.join("; ")}function $(e,n){if(e.focus({preventScroll:!0}),!document.execCommand("insertText",!1,n)){let t=e.selectionStart,i=e.selectionEnd;e.setRangeText(n,t,i,"end")}}function Et(e,n,t,i){let o=e.selectionStart,r=e.selectionEnd,s=e.value.substring(o,r)||"text",l=n+s+t;e.focus({preventScroll:!0}),e.setSelectionRange(o,r),$(e,l),e.selectionStart=o+n.length,e.selectionEnd=o+n.length+s.length,i&&i()}function En(e,n,t,i,o){let r=e.lastIndexOf(`
`,n-1)+1,s=e.indexOf(`
`,t),l=s===-1?e.length:s,a=-1;for(let h=n;h>=r;h--)if(e.substring(h,h+i.length)===i){let p=h>0?e[h-1]:"";if(i!=="**"||p!=="*"){a=h;break}}if(a===-1)return null;let u=-1,w=Math.max(a+i.length,t);for(let h=w;h<=l-o.length;h++)if(e.substring(h,h+o.length)===o){let p=h+o.length<e.length?e[h+o.length]:"";if(o!=="**"||p!=="*"){u=h;break}}if(u===-1)return null;let v=a+i.length,g=u;return n>=v&&t<=g?{formatStart:a,formatEnd:u+o.length,innerStart:v,innerEnd:g}:null}function Me(e,n,t,i){let{value:o,selectionStart:r,selectionEnd:s}=e,l=En(o,r,s,n,t);if(l){let{formatStart:a,formatEnd:u,innerStart:w,innerEnd:v}=l,g=o.substring(w,v);e.focus({preventScroll:!0}),e.setSelectionRange(a,u),$(e,g),e.selectionStart=a,e.selectionEnd=a+g.length}else Et(e,n,t,()=>{});i&&i()}function et(e,n,t){if(!(e.metaKey||e.ctrlKey))return!1;switch(e.key){case"b":return e.preventDefault(),Me(n,"**","**",t),!0;case"i":return e.preventDefault(),Me(n,"*","*",t),!0;case"u":return e.preventDefault(),Me(n,"<u>","</u>",t),!0;case"k":return e.preventDefault(),St(n,t),!0}return!1}function bt(e){let{value:n,selectionStart:t}=e,i=-1;for(let a=t;a>=Math.max(0,t-500);a--){if(n[a]==="["){i=a;break}if(n[a]===`
`||n[a]===")")break}if(i===-1)return null;let r=n.substring(i).match(/^\[([^\]]*)\]\(([^)]*)\)/);if(!r)return null;let s=r[0],l=i+s.length;return t>l?null:{start:i,end:l,text:r[1]??"",url:r[2]??"",textStart:i+1,textEnd:i+1+(r[1]?.length??0),urlStart:i+(r[1]?.length??0)+3,urlEnd:l-1}}async function St(e,n){let t=bt(e);if(t){let i=prompt("Edit link URL (leave empty to remove link):",t.url);if(i===null)return;if(i==="")e.focus({preventScroll:!0}),e.setSelectionRange(t.start,t.end),$(e,t.text);else{let o=`[${t.text}](${i})`;e.focus({preventScroll:!0}),e.setSelectionRange(t.start,t.end),$(e,o)}}else{let i=e.selectionStart,o=e.selectionEnd,r=e.value.substring(i,o)||"link text",s=prompt("Enter link URL:");if(!s)return;let l=`[${r}](${s})`;e.focus({preventScroll:!0}),e.setSelectionRange(i,o),$(e,l)}n&&n()}function Be(e){return!e||e==="left"?"":`text-align: ${e}`}function Ce(e){return e?e.match(/text-align:\s*(left|center|right)/)?.[1]??"left":"left"}function bn(e,n){let{value:t,selectionStart:i,selectionEnd:o}=e,r="   ",s=t.lastIndexOf(`
`,i-1)+1,l=t.indexOf(`
`,o);l===-1&&(l=t.length);let a=t.substring(0,s),u=t.substring(s,l),w=t.substring(l),v=u.split(`
`).map(h=>{let p=h.match(/^(\s*)\d+\.\s(.*)$/);return p?r+(p[1]??"")+"- "+(p[2]??""):r+h}).join(`
`);e.value=a+v+w;let g=v.length-u.length;e.selectionStart=i+r.length,e.selectionEnd=o+g,e.dispatchEvent(new Event("input",{bubbles:!0})),n&&n()}function Sn(e,n){let{value:t,selectionStart:i,selectionEnd:o}=e,r=t.lastIndexOf(`
`,i-1)+1,s=t.indexOf(`
`,o);s===-1&&(s=t.length);let l=t.substring(0,r),a=t.substring(r,s),u=t.substring(s),w=0,v=0,g=a.split(`
`).map((h,p)=>{let c=h.match(/^( {1,4}|\t)/);if(c){let d=c[0].length;return p===0&&(w=d),v+=d,h.substring(d)}return h}).join(`
`);e.value=l+g+u,e.selectionStart=Math.max(r,i-w),e.selectionEnd=o-v,e.dispatchEvent(new Event("input",{bubbles:!0})),n&&n()}function Tn(e,n,t){let{value:i,selectionStart:o,selectionEnd:r}=n;if(o!==r)return!1;let s=i.lastIndexOf(`
`,o-1)+1,l=i.indexOf(`
`,o),a=i.substring(s,l===-1?i.length:l),u=a.match(/^(\s*)([-*+])\s(.*)$/);if(u){let[,v="",g="-",h=""]=u;if(h.trim()===""){e.preventDefault();let c=i.substring(0,s),d=i.substring(l===-1?i.length:l);return n.value=c+d,n.selectionStart=n.selectionEnd=s,n.dispatchEvent(new Event("input",{bubbles:!0})),t&&t(),!0}e.preventDefault();let p=`
${v}${g} `;return $(n,p),n.dispatchEvent(new Event("input",{bubbles:!0})),t&&t(),!0}let w=a.match(/^(\s*)(\d+)\.\s(.*)$/);if(w){let[,v="",g="1",h=""]=w;if(h.trim()===""){e.preventDefault();let d=i.substring(0,s),m=i.substring(l===-1?i.length:l);return n.value=d+m,n.selectionStart=n.selectionEnd=s,n.dispatchEvent(new Event("input",{bubbles:!0})),t&&t(),!0}e.preventDefault();let p=parseInt(g,10)+1,c=`
${v}${p}. `;return $(n,c),n.dispatchEvent(new Event("input",{bubbles:!0})),t&&t(),!0}return!1}function tt(e,n,t){return e.key==="Tab"&&!e.shiftKey?(e.preventDefault(),bn(n,t),!0):e.key==="Tab"&&e.shiftKey?(e.preventDefault(),Sn(n,t),!0):!!(e.key==="Enter"&&!e.shiftKey&&!e.metaKey&&!e.ctrlKey&&Tn(e,n,t))}function f(e,n="info",t=3e3){let i=document.createElement("div");i.className=`edit-notification edit-notification-${n}`,i.textContent=e,document.body.appendChild(i),requestAnimationFrame(()=>{i.classList.add("show")}),setTimeout(()=>{i.classList.remove("show"),setTimeout(()=>i.remove(),300)},t)}function Ie(e){return JSON.parse(JSON.stringify(e))}function Ln(e){let n=e.textContent?.trim()??"",t=e.innerHTML.trim();return n===""||t===""||t==="<br>"}function xn(e){let n=document.createRange(),t=window.getSelection();t&&(n.selectNodeContents(e),n.collapse(!1),t.removeAllRanges(),t.addRange(n))}async function I(e,n={}){let t=await fetch(e,{...n,headers:{"Content-Type":"application/json",...n.headers}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return await t.json()}function kn(e,n){let t;return function(...o){let r=()=>{clearTimeout(t),e(...o)};clearTimeout(t),t=setTimeout(r,n)}}var Tt={generateId:wn,isDevMode:ae,isShowDraftsActive:J,withShowDrafts:ce,setupAutoResizeTextarea:fe,createImageElement:Ye,createVideoElement:Qe,applyAlignment:Ze,getAlignmentStyle:wt,parseAlignmentFromStyle:_e,buildMediaStyleString:Pe,insertTextWithUndo:$,wrapSelection:Et,toggleFormat:Me,handleFormattingShortcuts:et,findLinkAtCursor:bt,insertLink:St,getTextAlignmentStyle:Be,parseTextAlignmentFromStyle:Ce,handleListShortcuts:tt,showNotification:f,deepClone:Ie,isElementEmpty:Ln,moveCaretToEnd:xn,fetchJSON:I,debounce:kn};var nt="<!-- block -->",Re="<!-- row -->",je="<!-- /row -->",it="<!-- col -->",ge="<!-- html -->",ve="<!-- /html -->";function de(e){return`block-${Date.now()}-${e}-${Math.random().toString(36).substring(2,7)}`}function Mn(e,n){if(n.startsWith(ge)&&n.endsWith(ve)){e.type="html",e.html=n.slice(ge.length,-ve.length).trim();return}if(n.startsWith("```")){e.type="code";let t=n.match(/^```(\w*)\n?([\s\S]*?)\n?```$/);t?(e.language=t[1]||"text",e.code=t[2]||""):(e.language="text",e.code=n.replace(/^```\w*\n?/,"").replace(/\n?```$/,""));return}if(n.startsWith("<img")||/^!\[.*?\]\(.*?\)$/.test(n)){if(e.type="image",n.startsWith("<img")){let t=n.match(/src="([^"]*)"/),i=n.match(/alt="([^"]*)"/),o=n.match(/style="([^"]*)"/);e.src=t?.[1]??"",e.alt=i?.[1]??"",e.style=o?.[1]??null,e.align=_e(e.style)}else{let t=n.match(/!\[(.*?)\]\((.*?)\)/);e.src=t?.[2]??"",e.alt=t?.[1]??"",e.style=null,e.align="left"}return}if(n.startsWith("<video")){e.type="video";let t=n.match(/src="([^"]*)"/),i=n.match(/style="([^"]*)"/);e.src=t?.[1]??"",e.style=i?.[1]??null,e.align=_e(e.style);return}if(n.startsWith('<div class="callout"')){e.type="callout";let t=n.match(/<div class="callout"(?:\s+style="([^"]*)")?>([\s\S]*?)<\/div>/);t?(e.align=t[1]?Ce(t[1]):"left",e.content=t[2]?.trim()??""):(e.content="",e.align="left");return}if(/^(\*{3,}|-{3,}|_{3,})$/.test(n)){e.type="divider";return}if(n.startsWith("<!-- align:")){e.type="text";let t=n.match(/^<!-- align:(center|right) -->\n?([\s\S]*?)\n?<!-- \/align -->$/);t?(e.align=t[1],e.content=t[2]?.trim()??""):e.align="left";return}if(n.startsWith('<div style="text-align:')||n.startsWith('<div style="text-align :')){e.type="text";let t=n.match(/<div style="([^"]*)">([\s\S]*?)<\/div>/);t?(e.align=Ce(t[1]),e.content=t[2]?.trim()??""):e.align="left";return}e.type="text",e.align="left"}function Ae(e,n){let t=e.trim(),i={id:de(n),content:t};switch(Mn(i,t),i.type){case"text":return{id:i.id,type:"text",content:i.content??"",align:i.align??"left"};case"image":return{id:i.id,type:"image",src:i.src??"",alt:i.alt??"",style:i.style??null,align:i.align??"left"};case"video":return{id:i.id,type:"video",src:i.src??"",style:i.style??null,align:i.align??"left"};case"code":return{id:i.id,type:"code",code:i.code??"",language:i.language??"text"};case"html":return{id:i.id,type:"html",html:i.html??"",align:i.align??"left"};case"callout":return{id:i.id,type:"callout",content:i.content??"",align:i.align??"left"};case"divider":return{id:i.id,type:"divider"};default:return{id:i.id,type:"text",content:i.content??"",align:"left"}}}function Lt(e){if(!e||!e.trim())return[{id:de(0),type:"text",content:"",align:"left"}];let t=e.split(new RegExp(`\\n+${nt}\\n+`)).map((i,o)=>{let r=i.trim();if(r.startsWith(Re)&&r.endsWith(je)){let l=r.slice(Re.length,-je.length).trim().split(new RegExp(`\\n*${it}\\n*`));if(l.length>=2)return{id:de(o),type:"row",left:Ae(l[0]??"",o*10),right:Ae(l[1]??"",o*10+1)}}return Ae(i,o)});return t.length?t:[{id:de(0),type:"text",content:"",align:"left"}]}function Hn(e){return Lt(e)}function xt(e){let n=e.style&&(e.style.includes("width")||e.style.includes("max-width")),t=e.align&&e.align!=="left";if(n||t){let i=Pe(e);return`<img src="${e.src}" alt="${e.alt||""}" style="${i}">`}return`![${e.alt||""}](${e.src})`}function kt(e){let n=e.style&&(e.style.includes("width")||e.style.includes("max-width")),t=e.align&&e.align!=="left";if(n||t){let i=Pe(e);return`<video src="${e.src}" controls style="${i}"></video>`}return`<video src="${e.src}" controls></video>`}function Mt(e){return"```"+(e.language||"")+`
`+(e.code||"")+"\n```"}function Ht(e){return e.align&&e.align!=="left"?`<div class="callout" style="${Be(e.align)}">${e.content}</div>`:`<div class="callout">${e.content}</div>`}function Dt(e){let n=e.html||"";if(e.align&&e.align!=="left"){let t=Be(e.align);return`${ge}
<div style="${t}">
${n}
</div>
${ve}`}return`${ge}
${n}
${ve}`}function Ne(e){switch(e.type){case"text":{let n=(e.content||"").trim();return e.align&&e.align!=="left"?`<!-- align:${e.align} -->
${n}
<!-- /align -->`:n}case"image":return xt(e);case"video":return kt(e);case"code":return Mt(e);case"html":return Dt(e);case"row":{let n=Ne(e.left),t=Ne(e.right);return`${Re}
${n}
${it}
${t}
${je}`}case"callout":return Ht(e);case"divider":return"---";default:return""}}function $e(e){return e.map(n=>Ne(n)).join(`

${nt}

`)}function A(e,n={}){let t={id:de(Date.now()),type:e};switch(e){case"text":return{...t,content:"",align:"left",...n};case"image":return{...t,src:"",alt:"",style:null,align:"left",...n};case"video":return{...t,src:"",style:null,align:"left",...n};case"code":return{...t,language:"javascript",code:"",...n};case"html":return{...t,html:"",align:"left",...n};case"callout":return{...t,content:"",align:"left",...n};case"row":return{...t,left:A("text"),right:A("text"),...n};case"divider":return{...t,...n};default:return{...t,content:"",align:"left",...n}}}var Dn=A,_n={BLOCK_SEPARATOR:nt,ROW_START:Re,ROW_END:je,COL_SEPARATOR:it,HTML_START:ge,HTML_END:ve,parseIntoBlocks:Lt,parseMarkdown:Hn,parseSingleBlock:Ae,blockToMarkdown:Ne,blocksToMarkdown:$e,formatImageMarkdown:xt,formatVideoMarkdown:kt,formatCodeMarkdown:Mt,formatHtmlBlock:Dt,formatCalloutHtml:Ht,createBlock:A,createEmptyBlock:Dn,generateBlockId:de},Ue=_n;var _t={MENU_WIDTH:240},we=[{id:"text",label:"Text",icon:"T",description:"Plain text paragraph"},{id:"image",label:"Image",icon:"\u{1F5BC}",description:"Upload or select an image"},{id:"video",label:"Video",icon:"\u{1F3AC}",description:"Upload a video file"},{id:"code",label:"Code",icon:"\u{1F4BB}",description:"Code block with syntax highlighting"},{id:"html",label:"HTML",icon:"<>",description:"Raw HTML (scripts, embeds, custom)"},{id:"callout",label:"Callout",icon:"\u{1F4CC}",description:"Highlighted message box"},{id:"divider",label:"Divider",icon:"\u2042",description:"Section break"}],S=null,V=!1,Ee=!1,he="",P=0,Z=null,ee=null,U=null,ye=null,ue=null;function Ve(){if(S)return S;let e=document.createElement("div");return e.className="slash-command-menu",e.style.display="none",document.body.appendChild(e),S=e,e}function ot(e){if(!S)return;S.style.display="block",S.style.width=`${_t.MENU_WIDTH}px`,S.style.left=`${Math.min(e.left,window.innerWidth-_t.MENU_WIDTH-20)}px`;let n=S.offsetHeight||200,t=window.innerHeight-e.bottom-10,i=e.top-10;t<n&&i>t?(S.style.top="auto",S.style.bottom=`${window.innerHeight-e.top+5}px`,S.style.maxHeight=`${Math.min(300,i)}px`):(S.style.top=`${e.bottom+5}px`,S.style.bottom="auto",S.style.maxHeight=`${Math.min(300,t)}px`)}function Bt(e){if(!e)return we;let n=e.toLowerCase();return we.filter(t=>t.label.toLowerCase().includes(n)||t.id.toLowerCase().includes(n)||t.description.toLowerCase().includes(n))}function be(e,n=0){S||Ve(),S&&(P=Math.max(0,Math.min(n,e.length-1)),S.innerHTML=e.map((t,i)=>`
      <button
        class="slash-menu-item ${i===P?"selected":""}"
        data-command="${t.id}"
      >
        <span class="slash-menu-icon">${t.icon}</span>
        <div class="slash-menu-content">
          <span class="slash-menu-label">${t.label}</span>
          <span class="slash-menu-description">${t.description}</span>
        </div>
      </button>
    `).join(""),S.querySelectorAll(".slash-menu-item").forEach((t,i)=>{t.addEventListener("click",()=>{let o=e[i];o&&At(o.id)})}))}function Pt(){if(!S)return;let e=S.querySelector(".slash-menu-item.selected");e&&e.scrollIntoView({block:"nearest",behavior:"smooth"})}function Ct(){rt(),ye=()=>{!V||!U||ot(U.getBoundingClientRect())},window.addEventListener("scroll",ye,!0),ue=e=>{!V||!S||S.contains(e.target)||U?.contains(e.target)||te()},requestAnimationFrame(()=>{ue&&document.addEventListener("mousedown",ue,!0)})}function rt(){ye&&(window.removeEventListener("scroll",ye,!0),ye=null),ue&&(document.removeEventListener("mousedown",ue,!0),ue=null)}function It(e,n){S||Ve(),V=!0,Ee=!0,he="",P=0,ee=n,U=e,be(we,0),ot(e.getBoundingClientRect()),Ct()}function Pn(e,n,t){S||Ve(),V=!0,Ee=!1,he="",P=0,ee=n,U=t??null,be(we,0),ot(e),Ct()}function te(){rt(),S&&(S.style.display="none"),V=!1,Ee=!1,he="",P=0,U=null}function At(e){let n=ee??0,t=Ee,i=!1;if(Ee&&ee!==null){let o=U&&U.tagName==="TEXTAREA"?U:document.querySelector(`.block-wrapper[data-block-index="${ee}"] .block-textarea`);if(o){let r=o.selectionStart,s=o.value,u=s.substring(0,r).lastIndexOf(`
`)+1;if(s[u]==="/"){let w=u,v=(s.substring(0,w)+s.substring(r)).replace(/\n+$/,"");if(o.value=v,o.classList.contains("text-line-input")){let h=o.closest(".block-wrapper");if(h){let p=h.querySelectorAll(".text-line-input");i=Array.from(p).every(c=>!c.value.trim())}else i=!v.trim();o.dispatchEvent(new Event("input",{bubbles:!0}))}else i=!v.trim(),Z&&Z("updateContent",{index:ee,content:v})}}}te(),Z&&(t?Z("execute",{commandId:e,insertIndex:i?n:n+1,replaceBlockIndex:i?n:null}):Z("execute",{commandId:e,insertIndex:n,replaceBlockIndex:null}))}function Bn(e){if(!V)return!1;let n=Bt(he);switch(e.key){case"ArrowDown":return e.preventDefault(),e.stopPropagation(),P=(P+1)%n.length,be(n,P),Pt(),!0;case"ArrowUp":return e.preventDefault(),e.stopPropagation(),P=(P-1+n.length)%n.length,be(n,P),Pt(),!0;case"Enter":case"Tab":if(e.preventDefault(),e.stopPropagation(),n.length>0){let t=n[P];t&&At(t.id)}return!0;case"Escape":return e.preventDefault(),e.stopPropagation(),te(),!0}return!1}function Cn(e,n){let t=e.selectionStart,o=e.value.substring(0,t),s=o.lastIndexOf(`
`)+1;if(o.substring(s)==="/"){It(e,n);return}if(V){let a=o.lastIndexOf("/");if(a!==-1){let u=o.substring(0,a);if(u===""||u.endsWith(`
`)){he=o.substring(a+1);let v=Bt(he);v.length===0?te():be(v,0)}else te()}else te()}}function In(e){Z=e,Ve()}function An(){rt(),S&&(S.remove(),S=null),V=!1,U=null,Z=null}function Rn(){return V}function jn(){return V}function Nn(){return ee}var $n={init:In,cleanup:An,showFromTextarea:It,showFromButton:Pn,hide:te,handleKeydown:Bn,handleTextareaInput:Cn,isActive:Rn,isVisible:jn,getActiveIndex:Nn,COMMANDS:we},B=$n;var x=null,qe=2e3,jt=.8,Un=["image/jpeg","image/png","image/gif","image/webp"],Vn=["video/mp4","video/quicktime","video/webm"],Se={MIN_WIDTH_PERCENT:20,MAX_WIDTH_PERCENT:100,HANDLE_POSITIONS:["nw","ne","sw","se"],FULL_WIDTH_THRESHOLD:2},L=null,Te=[],ie=!1,ne=null,lt=!1,Le=null,xe=null,st=null,Rt=null;function qn(e){x=e,Fn(),Nt()}function Fn(){document.addEventListener("paste",async e=>{if(!x?.isActive())return;let n=Array.from(e.clipboardData?.items??[]);for(let t of n)if(t.type.startsWith("image/")){e.preventDefault();let i=t.getAsFile();if(!i)continue;let o=document.activeElement?.closest(".block-wrapper"),r=o?parseInt(o.getAttribute("data-block-index")??"",10):null;r!==null&&!isNaN(r)&&await dt(i,r);break}})}function Nt(){lt||(Le=e=>Xn(e),xe=()=>Vt(),st=()=>ct(),Rt=e=>{if(!x?.isActive()||!L||ie)return;let n=e.target,t=n.closest(".image-block-wrapper"),i=n.closest(".resize-handle");t||i||at()},document.addEventListener("click",Rt),window.addEventListener("resize",st),window.addEventListener("scroll",st,!0),lt=!0)}function On(e,n){!e||!n||(lt||Nt(),!(L&&L.element===e)&&(at(),L={element:e,block:n},e.classList.add("media-selected"),Wn(e),ct()))}function at(){ie&&Vt(),L&&(L.element.classList.remove("media-selected"),Ut(),L=null)}function Wn(e){Ut();let n=e.getBoundingClientRect();Se.HANDLE_POSITIONS.forEach(t=>{let i=document.createElement("div");i.className=`resize-handle ${t}`,i.dataset.position=t,$t(i,t,n),i.addEventListener("mousedown",o=>zn(o,t)),document.body.appendChild(i),Te.push(i)})}function $t(e,n,t){switch(e.style.position="fixed",n){case"nw":e.style.top=`${t.top-6}px`,e.style.left=`${t.left-6}px`;break;case"ne":e.style.top=`${t.top-6}px`,e.style.left=`${t.right-6}px`;break;case"sw":e.style.top=`${t.bottom-6}px`,e.style.left=`${t.left-6}px`;break;case"se":e.style.top=`${t.bottom-6}px`,e.style.left=`${t.right-6}px`;break}}function ct(){if(!L||Te.length===0)return;let e=L.element.getBoundingClientRect();Te.forEach(n=>{let t=n.dataset.position;$t(n,t,e)})}function Ut(){Te.forEach(e=>e.remove()),Te=[]}function zn(e,n){if(!L)return;e.preventDefault(),e.stopPropagation();let t=L.element,i=t.getBoundingClientRect();if(!i.width)return;let o=t.closest(".row-column")||t.closest(".block-content")||t.closest(".image-block-wrapper")||t.parentElement,r=o?o.getBoundingClientRect():i,s=Math.max(80,r.width*Se.MIN_WIDTH_PERCENT/100),l=r.width*Se.MAX_WIDTH_PERCENT/100;ie=!0,t.classList.add("media-resizing"),ne={position:n,startX:e.clientX,startWidth:i.width,minWidth:s,maxWidth:l,lastWidth:i.width},Le&&xe&&(document.addEventListener("mousemove",Le),document.addEventListener("mouseup",xe)),document.body.style.userSelect="none"}function Xn(e){if(!ie||!L||!ne)return;let{position:n,startX:t,startWidth:i,minWidth:o,maxWidth:r}=ne,s=e.clientX-t;(n==="nw"||n==="sw")&&(s=-s);let l=i+s;l=Math.max(o,Math.min(r,l)),ne.lastWidth=l;let a=L.element,u=L.block;a.style.width=`${Math.round(l)}px`,a.style.height="auto",Ot(u,l,r),ct()}function Vt(){if(ie){if(ie=!1,L){L.element.classList.remove("media-resizing");let e=ne?.lastWidth,n=ne?.maxWidth;e&&n&&(Ot(L.block,e,n),Wt(L.block.style)||(L.element.style.width="",L.element.style.height=""),x?.markDirty())}Le&&xe&&(document.removeEventListener("mousemove",Le),document.removeEventListener("mouseup",xe)),document.body.style.userSelect="",ne=null}}function qt(e){let n={};return e&&e.split(";").forEach(t=>{let[i,...o]=t.split(":");if(!i)return;let r=o.join(":").trim();r&&(n[i.trim().toLowerCase()]=r)}),n}function Ft(e){return Object.entries(e).filter(([,n])=>n!=null&&n!=="").map(([n,t])=>`${n}: ${t}`).join("; ")}function Ot(e,n,t){if(!e)return;let i=qt(e.style);delete i["margin-left"],delete i["margin-right"],delete i.display,delete i.height,delete i["max-height"],delete i["max-width"],delete i["min-width"],delete i["min-height"],Math.abs(n-t)<=Se.FULL_WIDTH_THRESHOLD?delete i.width:i.width=`${Math.round(n)}px`;let o=Ft(i);e.style=o||null}function Wt(e){return e?/(^|;)\s*width\s*:/.test(e):!1}async function zt(e){return new Promise((n,t)=>{let i=new Image,o=document.createElement("canvas"),r=o.getContext("2d");if(!r){t(new Error("Could not get canvas context"));return}i.onload=()=>{let s=i.width,l=i.height;s>qe&&(l=Math.round(l*qe/s),s=qe),o.width=s,o.height=l,r.drawImage(i,0,0,s,l),o.toBlob(a=>{a?n(a):t(new Error("Failed to create blob"))},"image/webp",jt),URL.revokeObjectURL(i.src)},i.onerror=()=>{URL.revokeObjectURL(i.src),t(new Error("Failed to load image"))},i.src=URL.createObjectURL(e)})}async function Fe(e,n){let t=new FormData;t.append("file",e);let i=n==="video"?"/api/process-content-video":"/api/upload-media";n==="image"&&t.append("type","image");let o=await fetch(i,{method:"POST",body:t});if(!o.ok){let s=await o.json().catch(()=>({}));throw new Error(s.detail||`Upload failed: ${o.status}`)}return(await o.json()).url}async function dt(e,n){f("Processing image...","info");try{let t=await zt(e),i=await Fe(t,"image");x?.updateBlock(n,{src:i,alt:e.name.replace(/\.[^/.]+$/,"")}),f("Image uploaded!","success")}catch(t){console.error("Image upload failed:",t),f(t instanceof Error?t.message:"Image upload failed","error")}}async function Xt(e,n){f("Processing video...","info");try{let t=await Fe(e,"video");x?.updateBlock(n,{src:t}),f("Video processed!","success")}catch(t){console.error("Video upload failed:",t),f(t instanceof Error?t.message:"Video processing failed","error")}}async function Kn(e,n=null){f("Processing image...","info");try{let t=await zt(e),i=await Fe(t,"image");Jn(i,e.name,n),f("Image uploaded!","success")}catch(t){console.error("Image upload failed:",t),f("Image upload failed","error")}}async function Gn(e,n=null){f("Processing video...","info");try{let t=await Fe(e,"video");Yn(t,n),f("Video processed!","success")}catch(t){console.error("Video upload failed:",t),f(t instanceof Error?t.message:"Video processing failed","error")}}function Jn(e,n="",t=null){let i=A("image",{src:e,alt:n.replace(/\.[^/.]+$/,"")});if(t){x?.insertBlockAfter(t,"image");let o=x?.getBlocks()??[],r=o[o.length-1];r&&r.type==="image"&&(r.src=e,r.alt=n.replace(/\.[^/.]+$/,""),x?.renderBlocks())}else(x?.getBlocks()??[]).push(i),x?.renderBlocks(),x?.markDirty()}function Yn(e,n=null){let t=A("video",{src:e});if(n){x?.insertBlockAfter(n,"video");let i=x?.getBlocks()??[],o=i[i.length-1];o&&o.type==="video"&&(o.src=e,x?.renderBlocks())}else(x?.getBlocks()??[]).push(t),x?.renderBlocks(),x?.markDirty()}async function Qn(e){let n=document.createElement("input");n.type="file",n.accept="image/*",n.addEventListener("change",async()=>{let t=n.files?.[0];t&&await dt(t,e)}),n.click()}async function Zn(e){let n=document.createElement("input");n.type="file",n.accept="video/*",n.addEventListener("change",async()=>{let t=n.files?.[0];t&&await Xt(t,e)}),n.click()}var ei={MAX_IMAGE_WIDTH:qe,IMAGE_QUALITY:jt,ALLOWED_IMAGE_TYPES:Un,ALLOWED_VIDEO_TYPES:Vn,RESIZE_CONFIG:Se,get selectedMedia(){return L},get isResizing(){return ie},init:qn,select:On,deselect:at,handleImageUploadForBlock:dt,handleVideoUploadForBlock:Xt,handleImageUpload:Kn,handleVideoUpload:Gn,replaceImageByIndex:Qn,replaceVideoByIndex:Zn,parseStyle:qt,serializeStyle:Ft,styleHasWidth:Wt},R=ei;var oe=null,H=[],k=-1,Kt=50,Oe=!1,ut=null,Gt=500;function ti(e){oe=e,H=[],k=-1}function ni(){H=[],k=-1}function ii(){if(!oe)throw new Error("EditUndo not initialized");return{blocks:Ie(oe.getBlocks()),timestamp:Date.now()}}function Jt(){let e=ii();k<H.length-1&&(H=H.slice(0,k+1)),H.push(e),k=H.length-1,H.length>Kt&&(H.shift(),k--)}function oi(){Oe||(ut!==null&&clearTimeout(ut),ut=setTimeout(()=>{Jt()},Gt))}function Yt(e){!e||!oe||(Oe=!0,oe.setBlocks(Ie(e.blocks)),oe.renderBlocks(),oe.markDirty(),Oe=!1)}function ri(){if(k<=0){f("Nothing to undo","info");return}k===H.length-1&&Jt(),k--,Yt(H[k]),f("Undo","info",1e3)}function si(){if(k>=H.length-1){f("Nothing to redo","info");return}k++,Yt(H[k]),f("Redo","info",1e3)}function li(){H=[],k=-1}function ai(){return k>0}function ci(){return k<H.length-1}var di={get history(){return H},get currentIndex(){return k},get maxHistory(){return Kt},get isUndoing(){return Oe},DEBOUNCE_MS:Gt,init:ti,reset:ni,saveState:oi,undo:ri,redo:si,clear:li,canUndo:ai,canRedo:ci},We=di;var T=[],ke=null,F=null,X=!1,me=!1,Q=null,_=null,j=null,se="unchanged",K=null,re=null,O=null,q=null,ui=2e3,hi=5e3,mi=3e3,C={sourceIndex:null,currentDropIndex:null,isDragging:!1};async function pi(e){if(!ae()){console.log("Edit mode only available on localhost");return}ke=e,j="project",me=!0;try{F=await I(`/api/project/${e}`),en(F);let n=new URL(window.location.href);n.searchParams.set("edit",""),window.history.replaceState({},"",n)}catch(n){console.error("Failed to load project:",n),f("Failed to load project","error")}}async function fi(){if(!ae()){console.log("Edit mode only available on localhost");return}j="about",ke=null,me=!0;try{F=await I("/api/about"),en(F);let e=new URL(window.location.href);e.searchParams.set("edit",""),window.history.replaceState({},"",e)}catch(e){console.error("Failed to load about content:",e),f("Failed to load about content","error")}}function en(e){let n=j==="about"?document.querySelector(".about-content"):document.querySelector(".project-content");if(!n){console.error("Content container not found");return}if(j==="project"){let o=n.closest(".project-item");o&&o.querySelectorAll("video").forEach(s=>{s.pause()});let r=o?.querySelector(".edit-buttons");r&&(r.dataset.originalHtml=r.innerHTML,r.innerHTML=`
        <span class="edit-status"></span>
        <button class="edit-btn-action edit-btn-cancel" data-action="cancel">Cancel</button>
        <button class="edit-btn-action edit-btn-save" data-action="save">Save</button>
      `,_=r,_.querySelector('[data-action="cancel"]')?.addEventListener("click",Ke),_.querySelector('[data-action="save"]')?.addEventListener("click",Xe))}let t="markdown"in e?e.markdown:"";T=Ue.parseIntoBlocks(t||"");let i=document.createElement("div");i.className="edit-mode-container",j==="about"?(i.innerHTML=`
      <div class="edit-mode-toolbar">
        <div class="edit-toolbar-left">
          <span class="edit-project-name">About Page</span>
          <span class="edit-status"></span>
        </div>
        <div class="edit-toolbar-right">
          <button class="edit-btn edit-btn-secondary" data-action="cancel">Cancel</button>
          <button class="edit-btn edit-btn-primary" data-action="save">Save</button>
        </div>
      </div>
      <div class="edit-blocks-container"></div>
    `,_=i.querySelector(".edit-mode-toolbar"),_?.querySelector('[data-action="cancel"]')?.addEventListener("click",Ke),_?.querySelector('[data-action="save"]')?.addEventListener("click",Xe)):i.innerHTML=`
      <div class="edit-blocks-container"></div>
    `,n.innerHTML="",n.appendChild(i),n.classList.add("edit-mode-active"),Q=i.querySelector(".edit-blocks-container"),B.init(ji),R.init({updateBlock:cn,insertBlockAfter:sn,getBlocks:()=>T,renderBlocks:W,markDirty:M,isActive:()=>me}),We.init({getBlocks:()=>T,setBlocks:o=>{T=o},renderBlocks:W,markDirty:M}),document.addEventListener("keydown",an),W(),document.body.classList.add("editing"),window.addEventListener("beforeunload",tn)}function ze(){me=!1,K&&(clearTimeout(K),K=null),re&&(clearTimeout(re),re=null),O&&(clearTimeout(O),O=null),q&&(q.abort(),q=null),se="unchanged",document.removeEventListener("keydown",an),window.removeEventListener("beforeunload",tn),B.cleanup(),R.deselect(),document.body.classList.remove("editing");let e=j==="about"?document.querySelector(".about-content"):document.querySelector(".project-content");e&&e.classList.remove("edit-mode-active"),j==="project"&&_&&_.dataset.originalHtml&&(_.innerHTML=_.dataset.originalHtml,delete _.dataset.originalHtml);let n=new URL(window.location.href);n.searchParams.delete("edit"),window.history.replaceState({},"",n),j=null}function tn(e){X&&(e.preventDefault(),e.returnValue="")}function gi(){if(!_)return;let e=_.querySelector(".edit-status"),n=_.querySelector('[data-action="save"]');if(n?.classList.remove("has-changes","is-saving","has-error"),e)switch(se){case"unchanged":e.textContent="",e.style.color="";break;case"pending":e.textContent="(unsaved)",e.style.color="#eab308",n?.classList.add("has-changes");break;case"saving":e.textContent="Saving...",e.style.color="#3b82f6",n?.classList.add("is-saving");break;case"saved":e.textContent="Saved",e.style.color="#22c55e";break;case"error":e.textContent="Save failed",e.style.color="#ef4444",n?.classList.add("has-error");break}}function Y(e){se=e,gi(),e!=="saved"&&re&&(clearTimeout(re),re=null),e==="saved"&&(re=setTimeout(()=>{se==="saved"&&Y("unchanged")},mi))}function vi(){K&&clearTimeout(K),O&&(clearTimeout(O),O=null),K=setTimeout(()=>{nn()},ui)}async function nn(){if(!(!X||se==="saving")){q&&q.abort(),q=new AbortController,Y("saving");try{let e=$e(T),n;if(j==="about")n=await fetch("/api/save-about",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({markdown:e}),signal:q.signal});else{let t={slug:ke,name:F?.title||"",date:F?.created_at||"",pinned:!1,draft:F?.status==="draft",youtube:"",video:"",markdown:e};n=await fetch("/api/save-project",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:q.signal})}if(!n.ok)throw new Error(`Save failed: ${n.status}`);X=!1,Y("saved")}catch(e){if(e instanceof Error&&e.name==="AbortError")return;console.error("Auto-save error:",e),Y("error"),O=setTimeout(()=>{se==="error"&&X&&nn()},hi)}}}function W(){if(!Q)return;R.deselect();let e=Q;e.innerHTML="",T.forEach((n,t)=>{t>0&&e.appendChild(Pi(t)),e.appendChild(yi(n,t))}),e.appendChild(Bi(T.length))}function yi(e,n){let t=document.createElement("div");t.className="block-wrapper",t.dataset.blockIndex=String(n),t.dataset.blockId=e.id,t.dataset.blockType=e.type;let i=document.createElement("div");i.className="block-handle",i.innerHTML="\u22EE\u22EE",i.draggable=!0,i.addEventListener("dragstart",s=>Ci(s,n)),i.addEventListener("dragend",rn),t.appendChild(i);let o=document.createElement("div");o.className="block-content",o.appendChild(pt(e,n)),t.appendChild(o),e.type!=="divider"&&e.type!=="code"&&t.appendChild(wi(e,n));let r=document.createElement("button");return r.className="block-delete-btn",r.innerHTML="\xD7",r.title="Delete block",r.addEventListener("click",()=>ln(n)),t.appendChild(r),t.addEventListener("dragover",s=>Ii(s,n)),t.addEventListener("dragleave",Ai),t.addEventListener("drop",s=>Ri(s,n)),t}function wi(e,n){let t=document.createElement("div");t.className="block-align-toolbar";let i=("align"in e?e.align:"left")||"left";return[{value:"left",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg>',title:"Align left"},{value:"center",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/></svg>',title:"Align center"},{value:"right",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="6" y1="18" x2="21" y2="18"/></svg>',title:"Align right"}].forEach(({value:r,icon:s,title:l})=>{let a=document.createElement("button");a.className="block-align-btn"+(i===r?" active":""),a.innerHTML=s,a.title=l,a.type="button",a.addEventListener("click",u=>{u.stopPropagation(),Ei(n,r)}),t.appendChild(a)}),t}function Ei(e,n){let t=T[e];t&&"align"in t&&(t.align=n,M(),W())}function pt(e,n){switch(e.type){case"text":return Qt(e,n);case"image":return Li(e,n);case"video":return xi(e,n);case"code":return ki(e,n);case"html":return _i(e,n);case"callout":return Mi(e,n);case"row":return Hi(e,n);case"divider":return Di();default:return Qt(e,n)}}function Qt(e,n){let t=document.createElement("div");return t.className="text-block-wrapper",t.appendChild(bi(e,n)),t}function bi(e,n){let t=document.createElement("div");t.className="text-block-lines",e.align&&(t.style.textAlign=e.align);let i=(e.content||"").split(`
`);i.length||(i=[""]);let o=null,r=()=>{e.content=i.join(`
`),M()},s=(c=null,d=null)=>{if(t.innerHTML="",i.forEach((m,y)=>{let D=l(m,y);t.appendChild(D)}),requestAnimationFrame(()=>{t.querySelectorAll(".text-block-line").forEach(m=>{h(m)})}),c!==null){let m=t.querySelector(`.text-block-line[data-line-index="${c}"]`);m&&a(m,d)}},l=(c,d)=>{let m=document.createElement("div");m.className="text-block-line",m.dataset.lineIndex=String(d);let y=document.createElement("div");y.className="text-block-line-preview",i.length===1&&!i[0]?.trim()?(y.classList.add("text-block-line-placeholder"),y.textContent="Type something... (type / for commands)"):y.appendChild(Zt(c));let E=document.createElement("textarea");return E.className="text-line-input",E.value=c,E.rows=1,E.placeholder="Type something... (type / for commands)",y.addEventListener("click",b=>{b.preventDefault(),b.stopPropagation(),a(m)}),m.addEventListener("click",b=>{m.classList.contains("is-editing")||(b.preventDefault(),b.stopPropagation(),a(m))}),E.addEventListener("input",()=>{let b=E.value;if(B.handleTextareaInput(E,n),b.includes(`
`)){let N=b.split(`
`);i.splice(d,1,...N),r();let le=N[N.length-1]??"";s(d+N.length-1,le.length);return}i[d]=b,r(),h(m)}),E.addEventListener("keydown",b=>{if(!(B.isActive()&&B.handleKeydown(b))){if(et(b,E,M)){i[d]=E.value,r(),h(m);return}if(!tt(b,E,M)){if(b.key==="Enter"&&!b.shiftKey&&!b.metaKey&&!b.ctrlKey){b.preventDefault(),w(E,d);return}if(b.key==="Backspace"&&E.selectionStart===0&&E.selectionEnd===0){d>0&&(b.preventDefault(),v(d));return}if(b.key==="Delete"&&E.selectionStart===E.value.length&&E.selectionEnd===E.value.length){d<i.length-1&&(b.preventDefault(),g(d));return}if(b.key==="ArrowUp"&&E.selectionStart===0&&E.selectionEnd===0){d>0&&(b.preventDefault(),s(d-1,i[d-1]?.length??0));return}b.key==="ArrowDown"&&E.selectionStart===E.value.length&&E.selectionEnd===E.value.length&&d<i.length-1&&(b.preventDefault(),s(d+1,0))}}}),E.addEventListener("blur",()=>{o===d&&u(m)}),m.appendChild(y),m.appendChild(E),m},a=(c,d=null)=>{let m=Number(c.dataset.lineIndex);if(o!==null&&o!==m){let D=t.querySelector(`.text-block-line[data-line-index="${o}"]`);D&&u(D)}o=m,c.classList.add("is-editing");let y=c.querySelector(".text-line-input");y&&(y.focus(),d&&typeof d=="object"?(y.selectionStart=d.start,y.selectionEnd=d.end??d.start):typeof d=="number"?(y.selectionStart=d,y.selectionEnd=d):y.selectionStart=y.selectionEnd=y.value.length,h(c))},u=c=>{let d=c.querySelector(".text-line-input"),m=c.querySelector(".text-block-line-preview");c.classList.remove("is-editing");let y=d?.value??"";m?.classList.remove("text-block-line-placeholder"),m&&(m.innerHTML=""),i.length===1&&!i[0]?.trim()&&!y.trim()?(m?.classList.add("text-block-line-placeholder"),m&&(m.textContent="Type something... (type / for commands)")):m&&m.appendChild(Zt(y)),o=null,h(c)},w=(c,d)=>{let m=c.value,y=c.selectionStart,D=m.slice(0,y),E=m.slice(y),b=p(D);i[d]=D;let N=b?b+E.replace(/^\s+/,""):E;i.splice(d+1,0,N),r();let le=b?b.length:0;s(d+1,le)},v=c=>{if(c<=0)return;let d=i[c-1]??"",m=i[c]??"",y=d+m;i.splice(c-1,2,y),r(),s(c-1,d.length)},g=c=>{if(c>=i.length-1)return;let d=i[c]??"",m=i[c+1]??"",y=d+m;i.splice(c,2,y),r(),s(c,d.length)},h=c=>{let d=c.querySelector(".text-block-line-preview"),m=c.querySelector(".text-line-input");requestAnimationFrame(()=>{let y=d?.offsetHeight??0,D=m?.scrollHeight??0,E=Math.max(27,y);c.style.minHeight=`${E}px`,c.classList.contains("is-editing")?c.style.height=`${Math.max(E,D)}px`:c.style.height=""})},p=c=>{let d=c.match(/^(\s*)([-*+])\s+/);if(d)return`${d[1]??""}${d[2]??"-"} `;let m=c.match(/^(\s*)(\d+)\.\s+/);if(m){let y=parseInt(m[2]??"1",10)+1;return`${m[1]??""}${y}. `}return null};return s(),t}function Zt(e){let n=e.trim();if(!n){let r=document.createElement("span");return r.innerHTML="&nbsp;",r}if(/^(\*{3,}|-{3,}|_{3,})$/.test(n)){let r=document.createElement("hr");return r.className="text-line-divider",r}let t=e.match(/^(\s*)(#{1,6})\s+(.*)$/);if(t){let r=t[2]?.length??1,s=document.createElement(`h${r}`);return s.appendChild(ht(t[3]??"")),s}let i=e.match(/^(\s*)>\s+(.*)$/);if(i){let r=document.createElement("blockquote");return r.appendChild(ht(i[2]??"")),r}let o=document.createElement("span");return o.appendChild(ht(e)),o}function ht(e){let n=document.createDocumentFragment(),t=/\[([^\]]+)\]\(([^)]+)\)/g,i=0,o;for(;(o=t.exec(e))!==null;){let r=o.index;r>i&&mt(n,e.slice(i,r));let s=Ti(o[2]??"");if(s){let l=document.createElement("a");l.href=s,l.rel="noopener",l.target="_blank",mt(l,o[1]??""),n.appendChild(l)}else n.appendChild(document.createTextNode(o[0]));i=r+o[0].length}return i<e.length&&mt(n,e.slice(i)),n}function mt(e,n){e.appendChild(Si(n))}function Si(e){let n=document.createDocumentFragment();return n.appendChild(document.createTextNode(e)),n}function Ti(e){let n=(e||"").trim();if(!n)return null;if(n.startsWith("#")||n.startsWith("/")||n.startsWith("./")||n.startsWith("../"))return n;try{let t=new URL(n,window.location.origin);if(["http:","https:","mailto:","tel:"].includes(t.protocol))return t.href}catch{return null}return null}function Li(e,n){let t=document.createElement("div");if(t.className="image-block-wrapper",e.src){let i=Ye(e,r=>{R.select(r,e)});i.className="block-image",t.appendChild(i);let o=document.createElement("input");o.type="text",o.className="image-alt-input",o.placeholder="Image description...",o.value=e.alt||"",o.addEventListener("input",()=>{let r=T[n];r&&r.type==="image"&&(r.alt=o.value,M())}),t.appendChild(o)}else t.appendChild(on(n,"image"));return t}function xi(e,n){let t=document.createElement("div");if(t.className="video-block-wrapper",e.src){let i=Qe(e);i.className="block-video",t.appendChild(i)}else t.appendChild(on(n,"video"));return t}function ki(e,n){let t=document.createElement("div");t.className="code-block-wrapper";let i=document.createElement("select");i.className="code-language-select",["javascript","python","html","css","bash","json","sql","go","rust","text"].forEach(s=>{let l=document.createElement("option");l.value=s,l.textContent=s,s===(e.language||"javascript")&&(l.selected=!0),i.appendChild(l)}),i.addEventListener("change",()=>{let s=T[n];s&&s.type==="code"&&(s.language=i.value,M())}),t.appendChild(i);let r=document.createElement("textarea");return r.className="code-textarea",r.value=e.code||"",r.placeholder="Enter code...",r.spellcheck=!1,fe(r,s=>{let l=T[n];l&&l.type==="code"&&(l.code=s,M())}),r.addEventListener("keydown",s=>{s.key==="Tab"&&(s.preventDefault(),$(r,"    "),r.dispatchEvent(new Event("input",{bubbles:!0})))}),t.appendChild(r),t}function Mi(e,n){let t=document.createElement("div");t.className="callout-block-wrapper";let i=document.createElement("textarea");return i.className="callout-textarea",i.value=e.content||"",i.placeholder="Callout content...",e.align&&(i.style.textAlign=e.align),fe(i,o=>{let r=T[n];r&&r.type==="callout"&&(r.content=o,M())}),t.appendChild(i),t}function Hi(e,n){let t=document.createElement("div");t.className="row-block-wrapper";let i=document.createElement("div");i.className="row-column row-column-left",i.appendChild(pt(e.left,n));let o=document.createElement("div");return o.className="row-column row-column-right",o.appendChild(pt(e.right,n)),t.appendChild(i),t.appendChild(o),t}function Di(){let e=document.createElement("hr");return e.className="block-divider",e}function _i(e,n){let t=document.createElement("div");t.className="html-block-wrapper",e.align&&(t.style.textAlign=e.align);let i=document.createElement("div");i.className="html-block-preview",i.innerHTML=e.html||'<p style="color: #666;">Empty HTML block</p>',t.appendChild(i);let o=document.createElement("button");o.className="html-toggle-btn",o.textContent="Edit HTML",o.type="button",t.appendChild(o);let r=document.createElement("textarea");r.className="html-textarea",r.value=e.html||"",r.placeholder="Enter raw HTML...",r.style.display="none",t.appendChild(r);let s=!1;return o.addEventListener("click",()=>{s=!s,s?(i.style.display="none",r.style.display="block",o.textContent="Preview",r.focus()):(i.style.display="block",r.style.display="none",o.textContent="Edit HTML",i.innerHTML=r.value||'<p style="color: #666;">Empty HTML block</p>')}),fe(r,l=>{let a=T[n];a&&a.type==="html"&&(a.html=l,M())}),t}function Pi(e){let n=document.createElement("div");n.className="merge-divider",n.dataset.afterIndex=String(e);let t=document.createElement("button");return t.className="merge-add-btn",t.innerHTML="+",t.title="Add block",t.addEventListener("click",()=>{let i=t.getBoundingClientRect();B.showFromButton(i,e,t)}),n.appendChild(t),n}function Bi(e){let n=document.createElement("div");n.className="add-block-wrapper";let t=document.createElement("button");return t.className="merge-add-btn",t.innerHTML="+",t.title="Add block",t.addEventListener("click",()=>{let i=t.getBoundingClientRect();B.showFromButton(i,e,t)}),n.appendChild(t),n}function on(e,n){let t=document.createElement("div");t.className="upload-zone",t.innerHTML=`
    <div class="upload-icon">${n==="image"?"\u{1F5BC}":"\u{1F3AC}"}</div>
    <div class="upload-text">Drop ${n} here or click to upload</div>
    <input type="file" class="upload-input" accept="${n==="image"?"image/*":"video/*"}">
  `;let i=t.querySelector(".upload-input");return i.addEventListener("change",async()=>{let o=i.files?.[0];o&&(n==="image"?await R.handleImageUploadForBlock(o,e):await R.handleVideoUploadForBlock(o,e))}),t.addEventListener("click",o=>{o.target!==i&&i.click()}),t.addEventListener("dragover",o=>{o.preventDefault(),t.classList.add("drag-over")}),t.addEventListener("dragleave",()=>{t.classList.remove("drag-over")}),t.addEventListener("drop",async o=>{o.preventDefault(),t.classList.remove("drag-over");let r=o.dataTransfer?.files[0];r&&(n==="image"?await R.handleImageUploadForBlock(r,e):await R.handleVideoUploadForBlock(r,e))}),t}function Ci(e,n){C.sourceIndex=n,C.isDragging=!0;let t=Q?.querySelector(`[data-block-index="${n}"]`);t&&t.classList.add("dragging"),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",n.toString()))}function rn(){C.isDragging=!1,C.sourceIndex=null,C.currentDropIndex=null,Q?.querySelectorAll(".dragging, .drag-over-top, .drag-over-bottom").forEach(e=>{e.classList.remove("dragging","drag-over-top","drag-over-bottom")})}function Ii(e,n){if(e.preventDefault(),!C.isDragging)return;let t=e.currentTarget,i=t.getBoundingClientRect(),o=i.top+i.height/2;Q?.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(r=>{r.classList.remove("drag-over-top","drag-over-bottom")}),e.clientY<o?(t.classList.add("drag-over-top"),C.currentDropIndex=n):(t.classList.add("drag-over-bottom"),C.currentDropIndex=n+1)}function Ai(e){e.currentTarget.classList.remove("drag-over-top","drag-over-bottom")}function Ri(e,n){if(e.preventDefault(),!C.isDragging||C.sourceIndex===null)return;let t=C.sourceIndex,i=C.currentDropIndex;if(i!==null){if(t<i&&i--,t!==i){let[o]=T.splice(t,1);o&&(T.splice(i,0,o),M(),W())}rn()}}function ft(e,n){let t=A(n);T.splice(e,0,t),M(),W(),(n==="text"||n==="callout")&&setTimeout(()=>{let i=Q?.querySelector(`[data-block-index="${e}"] .text-line-input, [data-block-index="${e}"] .block-textarea, [data-block-index="${e}"] .callout-textarea`);i&&i.focus()},50)}function sn(e,n){let t=T.findIndex(i=>i.id===e);t!==-1&&ft(t+1,n)}function ln(e){T.length<=1?T[0]=A("text"):T.splice(e,1),M(),W()}function ji(e,n){if(e==="execute"){let t=n;if(t.replaceBlockIndex!==null){let i=t.replaceBlockIndex;T[i]=A(t.commandId),M(),W(),(t.commandId==="text"||t.commandId==="callout")&&setTimeout(()=>{let o=Q?.querySelector(`[data-block-index="${i}"] .text-line-input, [data-block-index="${i}"] .block-textarea, [data-block-index="${i}"] .callout-textarea`);o&&o.focus()},50)}else ft(t.insertIndex,t.commandId)}else if(e==="updateContent"){let t=n,i=T[t.index];i&&"content"in i&&(i.content=t.content)}}function an(e){me&&(B.isActive()&&B.handleKeydown(e)||((e.metaKey||e.ctrlKey)&&e.key==="s"&&(e.preventDefault(),Xe()),e.key==="Escape"&&(e.preventDefault(),e.stopPropagation(),Ke())))}function M(){X=!0,Y("pending"),vi()}async function Xe(){if(!X&&se!=="error"){ze(),window.location.reload();return}K&&(clearTimeout(K),K=null),O&&(clearTimeout(O),O=null),q&&q.abort(),Y("saving");try{let e=$e(T),n;if(j==="about")n=await fetch("/api/save-about",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({markdown:e})});else{let t={slug:ke,name:F?.title||"",date:F?.created_at||"",pinned:!1,draft:F?.status==="draft",youtube:"",video:"",markdown:e};n=await fetch("/api/save-project",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}if(!n.ok)throw new Error(`Save failed: ${n.status}`);X=!1,Y("saved"),ze(),window.location.reload()}catch(e){console.error("Save error:",e),Y("error"),f("Failed to save","error")}}function Ke(){X&&!confirm("You have unsaved changes. Discard them?")||(ze(),window.location.reload())}function cn(e,n){let t=T[e];t&&(Object.assign(t,n),M(),W())}var Ni={init:pi,initAbout:fi,cleanup:ze,get blocks(){return T},get isActive(){return me},get isDirty(){return X},get projectSlug(){return ke},get editMode(){return j},insertBlock:ft,insertBlockAfter:sn,deleteBlock:ln,updateBlock:cn,renderBlocks:W,markDirty:M,save:Xe,cancel:Ke},dn=Ni;var un="bb_show_drafts";function gt(){return document.body.dataset.isolationMode==="true"}function Ge(e,n={}){let t=new URL(e,window.location.origin);return Object.entries(n).forEach(([i,o])=>{o!=null&&t.searchParams.set(i,o)}),J()&&t.searchParams.set("show_drafts","true"),t.toString()}function vt(){if(document.querySelector('link[href*="edit-mode.css"]'))return;let e=document.createElement("link");e.rel="stylesheet",e.href="/static/css/edit-mode.css",document.head.appendChild(e)}function z(){return new Promise(e=>{vt(),e()})}function hn(e){let n=e.dataset.slug;if(!n||e.querySelector(".edit-buttons"))return;let t=document.createElement("div");t.className="edit-buttons";let i=document.createElement("button");i.className="edit-btn-action",i.textContent="Edit",i.addEventListener("click",async r=>{if(r.preventDefault(),r.stopPropagation(),!gt()){window.location.href=Ge(`/${n}`,{edit:""});return}window.EditMode||await z(),window.EditMode?.init(n)});let o=document.createElement("button");o.className="edit-btn-action edit-btn-settings",o.innerHTML="&#9881;",o.title="Project Settings",o.addEventListener("click",async r=>{r.preventDefault(),r.stopPropagation(),window.ProjectSettings||await z(),window.ProjectSettings?.show(n)}),t.appendChild(i),t.appendChild(o),e.appendChild(t)}function $i(e){let n=e.querySelector(".edit-buttons");n&&n.remove()}function Ui(){let e=document.querySelector("#main-header nav");if(!e||e.querySelector(".new-project-btn"))return;let n=window.location.pathname==="/me",t=document.createElement("button");t.className="new-project-btn",t.textContent=n?"Edit":"+ New Project",t.addEventListener("click",async i=>{i.preventDefault(),n?(window.EditMode||await z(),window.EditMode&&window.EditMode.initAbout()):(window.ProjectCreate||await z(),window.ProjectCreate?.show())}),e.insertBefore(t,e.firstChild)}function Vi(){if(window.location.pathname!=="/")return;let e=document.querySelector("#main-header nav");if(!e||e.querySelector(".show-drafts-toggle"))return;let n=J(),t=document.createElement("button");t.className="show-drafts-toggle"+(n?" active":""),t.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" style="width:14px;height:14px;vertical-align:-2px;margin-right:5px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Drafts',t.addEventListener("click",o=>{o.preventDefault();let r=new URL(window.location.href);n?(r.searchParams.delete("show_drafts"),sessionStorage.removeItem(un)):(r.searchParams.set("show_drafts","true"),sessionStorage.setItem(un,"true")),window.location.href=r.toString()});let i=e.querySelector(".new-project-btn");i?e.insertBefore(t,i):e.insertBefore(t,e.firstChild)}function qi(){document.addEventListener("keydown",async function(e){if((e.metaKey||e.ctrlKey)&&e.key==="e"){if(document.body.classList.contains("editing"))return;let n=document.activeElement;if(n&&(n.tagName==="INPUT"||n.tagName==="TEXTAREA"))return;if(e.preventDefault(),window.location.pathname==="/me"){let o=new URL(window.location.href);o.searchParams.set("edit",""),window.history.replaceState({},"",o),window.EditMode||await z(),window.EditMode&&window.EditMode.initAbout();return}let i=document.querySelector(".project-item.active");if(i){let o=i.dataset.slug;if(o){if(!gt()){window.location.href=Ge(`/${o}`,{edit:""});return}window.EditMode||await z(),window.EditMode?.init(o)}}}})}function mn(){if(J(),window.location.pathname==="/"&&!new URLSearchParams(window.location.search).has("show_drafts")&&J()){let n=new URL(window.location.href);n.searchParams.set("show_drafts","true"),window.location.replace(n.toString());return}if(vt(),Ui(),Vi(),document.querySelectorAll(".project-item.active").forEach(hn),document.body.addEventListener("project:afterSwap",e=>{let n=e,{element:t,isOpen:i}=n.detail;if(t?.classList?.contains("project-details")){let o=t.closest(".project-item");o&&(i?setTimeout(()=>hn(o),50):$i(o))}}),gt()){let e=new URLSearchParams(window.location.search),t=document.querySelector(".project-item.active")?.dataset.slug;t&&(e.has("edit")?setTimeout(async()=>{window.EditMode||await z(),window.EditMode?.init(t)},100):e.has("settings")&&(window.history.replaceState({},"",Ge(`/${t}`)),setTimeout(async()=>{window.ProjectSettings||await z(),window.ProjectSettings?.show(t)},100)))}window.location.pathname==="/me"&&new URLSearchParams(window.location.search).has("edit")&&setTimeout(async()=>{window.EditMode||await z(),window.EditMode&&window.EditMode.initAbout()},100),qi()}function Fi(){ae()&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",mn):mn())}var Oi={init:Fi,loadEditModeScripts:z,loadEditModeCSS:vt,isShowDraftsActive:J,buildUrlWithShowDrafts:Ge},pn=Oi;var yt=1,G=6,fn=3,Wi={modal:null,projectSlug:null,projectData:null,currentView:"settings",videoFile:null,videoFlowMode:"upload",spriteStart:0,spriteDuration:fn,objectUrl:null,activeXhr:null,videoEl:null,videoDuration:0,escHandler:null,_isDraggingSprite:!1,_mouseMoveHandler:null,_mouseUpHandler:null,_keyHandler:null,_beforeUnloadHandler:null,_spriteLooping:!1,_dragTarget:null,_dragOffset:0,_wasLoopingBeforeDrag:!1,_touchMoveHandler:null,_touchEndHandler:null,_rafId:null,_cachedTrack:null,_cachedRange:null,_cachedDimLeft:null,_cachedDimRight:null,_cachedInfo:null,_tempId:null,_hlsSessionId:null,_hlsComplete:!1,_hlsPollTimer:null,_thumbnailPollTimer:null,_hlsScriptPromise:null,_hlsPreviewUrl:null,_blobPreviewFailed:!1,_previewCodecErrorShown:!1,_hlsPreviewErrorShown:!1,_renderedThumbCount:0,async show(e){this.projectSlug=e;let n=document.querySelector(`#project-${e}`);n&&n.querySelectorAll("video").forEach(t=>t.pause());try{this.projectData=await I(`/api/project/${e}`),this.createModal()}catch(t){console.error("Failed to load project:",t),f("Failed to load project settings","error")}},createModal(){this.currentView="settings",this.modal=document.createElement("div"),this.modal.className="edit-settings-modal",this.modal.innerHTML=`
      <div class="edit-settings-overlay"></div>
      <div class="edit-settings-content"></div>
    `,document.body.appendChild(this.modal),He(),this.renderSettingsView(),this.setupBaseListeners()},setupBaseListeners(){if(!this.modal)return;let e=this.modal.querySelector(".edit-settings-overlay");e&&e.addEventListener("click",()=>{this.currentView==="video"?this.showSettingsView():this.hide()}),this.escHandler=n=>{n.key==="Escape"&&this.modal&&(n.preventDefault(),n.stopPropagation(),this.currentView==="video"?this.cancelUpload():this.hide())},document.addEventListener("keydown",this.escHandler,!0)},renderSettingsView(){this.currentView="settings";let e=this.projectData;if(!this.modal||!e)return;let n=this.modal.querySelector(".edit-settings-content");n&&(n.classList.remove("edit-settings-content--video"),n.innerHTML=`
      <div class="edit-settings-header">
        <h2>Project Settings</h2>
        <button class="edit-settings-close">&times;</button>
      </div>
      <form class="edit-settings-form" id="settings-form">
        <div class="edit-form-group">
          <label for="settings-name">Project Name</label>
          <input type="text" id="settings-name" name="name" value="${this.escAttr(e.name||"")}" required>
        </div>
        <div class="edit-form-group">
          <label for="settings-slug">URL Slug</label>
          <input type="text" id="settings-slug" name="slug" value="${this.escAttr(e.slug||"")}" required pattern="[a-z0-9\\-]+">
        </div>
        <div class="edit-form-group">
          <label for="settings-date">Date</label>
          <input type="date" id="settings-date" name="date" value="${e.date||""}" required>
        </div>
        <div class="edit-form-group">
          <label for="settings-youtube">YouTube Link</label>
          <input type="url" id="settings-youtube" name="youtube" value="${this.escAttr(e.youtube||"")}" placeholder="https://youtube.com/watch?v=...">
        </div>
        <div class="edit-form-row">
          <div class="edit-form-group edit-form-checkbox">
            <label>
              <input type="checkbox" id="settings-draft" name="draft" ${e.draft?"checked":""}>
              Draft
            </label>
          </div>
          <div class="edit-form-group edit-form-checkbox">
            <label>
              <input type="checkbox" id="settings-pinned" name="pinned" ${e.pinned?"checked":""}>
              Pinned
            </label>
          </div>
        </div>

        <div class="edit-form-section">
          <h3>Hero Video</h3>
          <div class="edit-form-group">
            <label>Current Video</label>
            ${e.video?.hls?`<div class="edit-video-info">
                    <span>HLS: ${e.video.hls.split("/").pop()}</span>
                    <div class="edit-video-actions">
                      <button type="button" class="edit-btn-small" id="update-hero-sprite">Update Sprite</button>
                      <button type="button" class="edit-btn-small" id="upload-hero-video">Replace</button>
                    </div>
                   </div>`:'<button type="button" class="edit-btn edit-btn-secondary" id="upload-hero-video">Upload Hero Video</button>'}
            <input type="file" id="hero-video-input" accept="video/*" style="display: none;">
          </div>
        </div>

        <div class="edit-settings-actions">
          <button type="button" class="edit-btn edit-btn-danger" id="delete-project">Delete Project</button>
          <div class="edit-settings-actions-right">
            <button type="button" class="edit-btn edit-btn-secondary" id="settings-cancel">Cancel</button>
            <button type="submit" class="edit-btn edit-btn-primary">Save Settings</button>
          </div>
        </div>
      </form>
    `,this.setupSettingsListeners())},setupSettingsListeners(){if(!this.modal)return;let e=this.modal.querySelector(".edit-settings-content");if(!e)return;let n=e.querySelector(".edit-settings-close");n&&n.addEventListener("click",()=>this.hide());let t=e.querySelector("#settings-cancel");t&&t.addEventListener("click",()=>this.hide());let i=e.querySelector("#settings-form");i&&i.addEventListener("submit",async a=>{a.preventDefault(),await this.saveSettings()});let o=e.querySelector("#delete-project");o&&o.addEventListener("click",async()=>{confirm(`Are you sure you want to delete "${this.projectData?.name}"? This cannot be undone.`)&&await this.deleteProject()});let r=e.querySelector("#upload-hero-video"),s=e.querySelector("#update-hero-sprite"),l=e.querySelector("#hero-video-input");r&&l&&(r.addEventListener("click",()=>l.click()),l.addEventListener("change",a=>{let w=a.target.files?.[0];if(w){if(!w.type.startsWith("video/")){f("Please select a video file","error");return}this.showVideoView(w)}})),s&&s.addEventListener("click",()=>{if(!this.projectData?.video?.hls){f("No existing hero video found for this project.","error");return}this.showVideoView()})},showVideoView(e=null){let n=!!e;if(this.currentView="video",this.videoFile=e,this.videoFlowMode=n?"upload":"existing",this.spriteStart=0,this.spriteDuration=fn,this.videoDuration=0,this._spriteLooping=!1,this._tempId=null,this._hlsSessionId=null,this._hlsComplete=!1,this._hlsPreviewUrl=null,this._blobPreviewFailed=!1,this._previewCodecErrorShown=!1,this._hlsPreviewErrorShown=!1,this._renderedThumbCount=0,!this.modal)return;let t=this.modal.querySelector(".edit-settings-content");if(!t)return;t.classList.add("edit-settings-content--video");let i=this.getProcessButtonText(),o=n?"Process Hero Video":"Update Hero Sprite",r=n&&e?`${this.escHtml(e.name)} (${(e.size/(1024*1024)).toFixed(1)} MB)`:"Using current hero HLS stream",s=n?"Uploading...":"Loading current video...";t.innerHTML=`
      <div class="edit-settings-header">
        <h2>${o}</h2>
        <button class="edit-settings-close">&times;</button>
      </div>
      <div class="edit-hero-video-preview">
        <video class="edit-hero-video-player" controls playsinline></video>
      </div>
      <div class="edit-hero-file-info">${r}</div>
      <div class="edit-hero-preview-status" hidden></div>
      <div class="edit-hero-timeline">
        <div class="edit-hero-timeline-track">
          <canvas class="edit-hero-timeline-thumbs"></canvas>
          <div class="edit-hero-timeline-dim-left"></div>
          <div class="edit-hero-timeline-dim-right"></div>
          <div class="edit-hero-sprite-range">
            <div class="edit-hero-sprite-handle edit-hero-sprite-handle--start" data-handle="start">
              <div class="edit-hero-sprite-handle-grip"></div>
            </div>
            <div class="edit-hero-sprite-handle edit-hero-sprite-handle--end" data-handle="end">
              <div class="edit-hero-sprite-handle-grip"></div>
            </div>
          </div>
          <div class="edit-hero-playhead"></div>
        </div>
      </div>
      <div class="edit-hero-timeline-loading" hidden>Refining timeline preview...</div>
      <div class="edit-hero-time-display">
        <span class="edit-hero-current-time">0:00</span>
        <span class="edit-hero-sprite-info">Sprite: 0:00 - 0:03 (3.0s)</span>
        <span class="edit-hero-total-time">0:00</span>
      </div>
      <div class="edit-hero-progress" style="display: none;">
        <div class="edit-hero-progress-bar">
          <div class="edit-hero-progress-fill"></div>
        </div>
        <div class="edit-hero-progress-text">${s}</div>
      </div>
      <div class="edit-hero-actions">
        <button type="button" class="edit-btn edit-btn-secondary" id="hero-video-cancel">Cancel</button>
        <button type="button" class="edit-btn edit-btn-primary" id="hero-video-process" disabled>${i}</button>
      </div>
    `,this.videoEl=t.querySelector(".edit-hero-video-player"),this.updatePreviewStatus();let l=t.querySelector(".edit-settings-close");l&&l.addEventListener("click",()=>this.cancelUpload());let a=t.querySelector("#hero-video-cancel");a&&a.addEventListener("click",()=>this.cancelUpload());let u=t.querySelector("#hero-video-process");if(u&&u.addEventListener("click",()=>this.processVideo()),n&&e){this.extractServerThumbnails(e,t);return}this.extractExistingVideoThumbnails(t)},getProcessButtonText(){return this.videoFlowMode==="existing"?"Generate New Sprite":"Confirm & Generate Sprite"},extractServerThumbnails(e,n){let t=n.querySelector("#hero-video-process"),i=n.querySelector(".edit-hero-progress"),o=n.querySelector(".edit-hero-progress-fill"),r=n.querySelector(".edit-hero-progress-text");if(!i||!o||!r)return;i.style.display="block",r.textContent="Uploading video...";let s=new FormData;s.append("file",e),this.projectSlug&&s.append("project_slug",this.projectSlug);let l=new XMLHttpRequest;this.activeXhr=l,l.upload.addEventListener("progress",a=>{if(a.lengthComputable){let u=a.loaded/a.total*50;o.style.width=`${u}%`;let w=(a.loaded/(1024*1024)).toFixed(1),v=(a.total/(1024*1024)).toFixed(1);r.textContent=`Uploading: ${w} / ${v} MB`}}),l.addEventListener("load",()=>{if(this.activeXhr=null,l.status>=200&&l.status<300)try{let a=JSON.parse(l.responseText);if(a.success){this._tempId=a.temp_id,this.videoDuration=a.duration;let u=n.querySelector(".edit-hero-total-time");u&&(u.textContent=this.formatTime(this.videoDuration)),this.updateSpriteRange(),this.renderServerThumbnails(a.frames);let w=n.querySelector(".edit-hero-timeline-loading");w&&(w.hidden=!1),this.pollRemainingThumbnails(),t&&(t.disabled=!1),a.hls_session_id?(this._hlsSessionId=a.hls_session_id,o.style.width="50%",r.textContent="Encoding HLS...",this.pollHlsProgress(o,r,i)):i.style.display="none",this.objectUrl=URL.createObjectURL(e),this.videoEl=n.querySelector(".edit-hero-video-player"),this.videoEl&&(this.videoEl.classList.remove("hls-video-preview"),this.videoEl.dataset.previewSource="blob",this.videoEl.addEventListener("error",()=>{!this.videoEl||!(this.videoEl.currentSrc||this.videoEl.src||"").startsWith("blob:")||this._previewCodecErrorShown||(this._blobPreviewFailed=!0,this._previewCodecErrorShown=!0,this.updatePreviewStatus("Preview unavailable: this upload codec is not supported by your browser yet. It will appear once HLS finishes encoding.","warning"),f("Browser cannot play this upload codec. Preview will switch to HLS when ready.","info",4500))},{once:!0}),this.videoEl.addEventListener("loadedmetadata",()=>{!this.videoEl||!(this.videoEl.currentSrc||this.videoEl.src||"").startsWith("blob:")||(this.videoEl.videoWidth===0&&!this._blobPreviewFailed?(this._blobPreviewFailed=!0,this.updatePreviewStatus("Preview unavailable: browser can only decode audio for this upload. It will appear once HLS finishes encoding.","warning")):this._blobPreviewFailed||this.updatePreviewStatus())},{once:!0}),this.objectUrl&&(this.videoEl.src=this.objectUrl),this.setupVideoListeners(n))}else throw new Error(a.detail||"Thumbnail extraction failed")}catch(a){f(`Thumbnail extraction failed: ${a.message}`,"error"),this.cancelUpload()}else{let a="Thumbnail extraction failed";try{a=JSON.parse(l.responseText).detail||a}catch{}f(a,"error"),this.cancelUpload()}}),l.addEventListener("error",()=>{this.activeXhr=null,f("Network error during thumbnail extraction","error"),this.cancelUpload()}),l.open("POST","/api/video-thumbnails"),l.send(s)},async extractExistingVideoThumbnails(e){let n=e.querySelector("#hero-video-process"),t=e.querySelector(".edit-hero-progress"),i=e.querySelector(".edit-hero-progress-fill"),o=e.querySelector(".edit-hero-progress-text");if(!(!t||!i||!o)){if(!this.projectSlug){f("Project slug missing. Please reload and try again.","error"),this.cancelUpload();return}t.style.display="block",i.style.width="15%",o.textContent="Loading current video...";try{let r=new FormData;r.append("project_slug",this.projectSlug);let s=await fetch("/api/video-thumbnails-existing",{method:"POST",body:r});if(!s.ok){let w=await s.json();throw new Error(w.detail||"Failed to load existing video")}let l=await s.json();if(!l.success)throw new Error(l.detail||"Failed to load existing video");this._tempId=l.temp_id,this.videoDuration=l.duration,this._hlsComplete=!0,this._hlsSessionId=null;let a=e.querySelector(".edit-hero-total-time");a&&(a.textContent=this.formatTime(this.videoDuration)),this.updateSpriteRange(),this.renderServerThumbnails(l.frames||[]);let u=e.querySelector(".edit-hero-timeline-loading");u&&(u.hidden=!1),this.pollRemainingThumbnails(),n&&(n.disabled=!1),this.videoEl=e.querySelector(".edit-hero-video-player"),this.updatePreviewStatus(),this.setupVideoListeners(e),i.style.width="65%",o.textContent="Loading HLS preview...",l.hls_url&&await this.switchPreviewToHls(l.hls_url),i.style.width="100%",o.textContent="Preview ready. Select sprite range and confirm.",setTimeout(()=>{this.currentView==="video"&&(t.style.display="none")},1200)}catch(r){f(`Failed to load existing hero video: ${r.message}`,"error"),this.cancelUpload()}}},pollRemainingThumbnails(){let e=async()=>{if(!(!this._tempId||this.currentView!=="video"))try{let n=await fetch(`/api/video-thumbnails/more/${this._tempId}`);if(!n.ok)return;let t=await n.json(),i=this.modal?.querySelector(".edit-hero-timeline-loading");if(t.frames&&t.frames.length>this._renderedThumbCount&&this.renderServerThumbnails(t.frames),t.complete)i&&(i.hidden=!0);else{if(i){i.hidden=!1;let o=Array.isArray(t.frames)?t.frames.length:this._renderedThumbCount;i.textContent=`Refining timeline preview... (${o} frames)`}this._thumbnailPollTimer=setTimeout(e,500)}}catch{this._thumbnailPollTimer=setTimeout(e,1e3)}};e()},pollHlsProgress(e,n,t){this._hlsSessionId&&(this._hlsPollTimer=setInterval(async()=>{if(!this._hlsSessionId||this.currentView!=="video"){this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null);return}try{let i=await fetch(`/api/hls-progress/${this._hlsSessionId}`);if(!i.ok)return;let o=await i.json();if(o.status==="complete")this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null),this._hlsComplete=!0,o.hls_url&&await this.switchPreviewToHls(o.hls_url),e.style.width="100%",n.textContent="HLS ready! Select sprite range and confirm.",setTimeout(()=>{t&&this.currentView==="video"&&(t.style.display="none")},1500);else if(o.status==="error")this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null),n.textContent="HLS encoding failed - will retry on confirm",e.style.background="#ef4444",setTimeout(()=>{t&&this.currentView==="video"&&(t.style.display="none",e.style.background="")},2e3);else{let r=o.progress||0,s=50+r*.5;e.style.width=`${s}%`,n.textContent=o.stage||`Encoding HLS... ${Math.round(r)}%`}}catch{}},1e3))},loadHlsScript(){if(window.Hls)return Promise.resolve();if(this._hlsScriptPromise)return this._hlsScriptPromise;let e=document.body.dataset.hlsJsSrc||"https://cdn.jsdelivr.net/npm/hls.js@1.5.12";return this._hlsScriptPromise=new Promise((n,t)=>{let i=document.createElement("script");i.src=e,i.async=!0,i.onload=()=>n(),i.onerror=()=>t(new Error("Failed to load HLS.js")),document.head.appendChild(i)}),this._hlsScriptPromise},async switchPreviewToHls(e){if(!e||!this.videoEl||this.currentView!=="video"||this._hlsPreviewUrl===e)return;let n=this.videoEl,t=Number.isFinite(n.currentTime)?n.currentTime:0,i=!n.paused||this._spriteLooping,o=!!n.canPlayType("application/vnd.apple.mpegurl"),r=()=>{if(t>0)try{n.currentTime=t}catch{}i&&n.play().catch(()=>{})},s=()=>{n.hlsInstance&&(n.hlsInstance.destroy(),n.hlsInstance=null)},l=()=>new Promise((w,v)=>{if(!window.Hls||!window.Hls.isSupported()){v(new Error("HLS.js not supported"));return}s();let g=new window.Hls({abrEwmaDefaultEstimate:5e6,capLevelToPlayerSize:!0});n.hlsInstance=g;let h=!1,p=(c,d)=>{h||(h=!0,c?(r(),w()):(s(),v(d||new Error("HLS.js failed to initialize"))))};g.on(window.Hls.Events.MANIFEST_PARSED,()=>p(!0)),g.on(window.Hls.Events.ERROR,(c,d)=>{let m=d;m&&m.fatal&&p(!1,new Error(m.details||"HLS.js fatal error"))}),g.loadSource(e),g.attachMedia(n)}),a=()=>new Promise((w,v)=>{if(!o){v(new Error("Native HLS not supported"));return}let g=()=>{p(),r(),w()},h=()=>{p(),v(new Error("Native HLS failed to load"))},p=()=>{n.removeEventListener("loadedmetadata",g),n.removeEventListener("error",h)};s(),n.addEventListener("loadedmetadata",g),n.addEventListener("error",h),n.src=e,n.load()}),u=!1;try{await l(),u=!0}catch{try{await this.loadHlsScript(),await l(),u=!0}catch{if(o)try{await a(),u=!0}catch{}}}if(!u){n.dataset.previewSource="blob",this._blobPreviewFailed&&!this._hlsPreviewErrorShown?(this._hlsPreviewErrorShown=!0,this.updatePreviewStatus("Preview unavailable: HLS preview could not be initialized.","error"),f("HLS preview could not be initialized. Video will still process, but live preview is unavailable.","error",5e3)):this.updatePreviewStatus();return}this._hlsPreviewUrl=e,n.classList.add("hls-video-preview"),n.dataset.previewSource="hls",this.updatePreviewStatus(),this.objectUrl&&(URL.revokeObjectURL(this.objectUrl),this.objectUrl=null)},updatePreviewStatus(e="",n="info"){if(!this.modal||this.currentView!=="video")return;let t=this.modal.querySelector(".edit-hero-preview-status");if(t){if(!e){t.hidden=!0,t.textContent="",t.classList.remove("is-info","is-warning","is-error","is-success");return}t.hidden=!1,t.textContent=e,t.classList.remove("is-info","is-warning","is-error","is-success"),t.classList.add(`is-${n}`)}},renderServerThumbnails(e){if(!this.modal)return;let n=this.modal.querySelector(".edit-hero-timeline-thumbs");if(!n||!e||e.length===0)return;this._renderedThumbCount=e.length;let t=n.parentElement;if(!t)return;let i=t.clientWidth,o=t.clientHeight,r=window.devicePixelRatio||1;n.width=i*r,n.height=o*r;let s=n.getContext("2d");if(!s)return;s.scale(r,r),s.clearRect(0,0,i,o);let l=e.length,a=new Array(l).fill(null),u=0,w=(g,h)=>{let p=Math.floor(h*i/l),c=h===l-1?i:Math.floor((h+1)*i/l),d=Math.max(1,c-p),m=g.width/g.height,y=d/o,D=0,E=0,b=g.width,N=g.height;m>y?(b=Math.max(1,Math.round(g.height*y)),D=Math.max(0,Math.floor((g.width-b)/2))):m<y&&(N=Math.max(1,Math.round(g.width/y)),E=Math.max(0,Math.floor((g.height-N)/2)));let le=Math.max(0,p-(h>0?1:0)),yn=Math.min(i-le,d+(h>0?1:0));s.drawImage(g,D,E,b,N,le,0,yn,o)},v=()=>{if(u++,u!==l)return;s.clearRect(0,0,i,o);let g=null;for(let p=0;p<l;p++){let c=a[p]??null;c?g=c:g&&(a[p]=g)}let h=null;for(let p=l-1;p>=0;p--){let c=a[p]??null;c?h=c:h&&(a[p]=h)}for(let p=0;p<l;p++){let c=a[p];c&&w(c,p)}n.classList.add("loaded")};e.forEach((g,h)=>{let p=new Image;p.onload=()=>{a[h]=p,v()},p.onerror=v,p.src="data:image/jpeg;base64,"+g})},setupVideoListeners(e){if(!this.videoEl)return;this.videoEl.addEventListener("timeupdate",()=>{if(!this.videoEl)return;this.updatePlayhead();let i=e.querySelector(".edit-hero-current-time");i&&(i.textContent=this.formatTime(this.videoEl.currentTime)),this._spriteLooping&&this.videoEl.currentTime>=this.spriteStart+this.spriteDuration&&(this.videoEl.currentTime=this.spriteStart)});let n=e.querySelector(".edit-hero-timeline-track");n&&n.addEventListener("click",i=>{if(this._isDraggingSprite||!this.videoEl)return;let o=n.getBoundingClientRect(),s=(i.clientX-o.left)/o.width*this.videoDuration,l=this.spriteStart+this.spriteDuration;s>=this.spriteStart&&s<=l?(this._spriteLooping=!0,this.videoEl.currentTime=s,this.videoEl.play()):(this._spriteLooping=!1,this.spriteStart=Math.max(0,Math.min(s,this.videoDuration-this.spriteDuration)),this.videoEl.currentTime=this.spriteStart,this.updateSpriteRange()),this.updateSpriteLoopUI()}),this._cachedTrack=e.querySelector(".edit-hero-timeline-track"),this._cachedRange=e.querySelector(".edit-hero-sprite-range"),this._cachedDimLeft=e.querySelector(".edit-hero-timeline-dim-left"),this._cachedDimRight=e.querySelector(".edit-hero-timeline-dim-right"),this._cachedInfo=e.querySelector(".edit-hero-sprite-info");let t=this._cachedRange;if(t){let i=(s,l)=>{if(this._isDraggingSprite=!0,this._dragTarget=l,t.classList.add("is-dragging"),this._wasLoopingBeforeDrag=this._spriteLooping,this.videoEl&&!this.videoEl.paused&&this.videoEl.pause(),l==="range"&&this._cachedTrack){let a=this._cachedTrack.getBoundingClientRect(),w=(s-a.left)/a.width*this.videoDuration;this._dragOffset=w-this.spriteStart}};t.addEventListener("mousedown",s=>{s.target.closest(".edit-hero-sprite-handle")||(i(s.clientX,"range"),s.preventDefault(),s.stopPropagation())}),t.addEventListener("touchstart",s=>{if(s.target.closest(".edit-hero-sprite-handle"))return;let a=s.touches[0];a&&(i(a.clientX,"range"),s.preventDefault(),s.stopPropagation())},{passive:!1});let o=t.querySelector(".edit-hero-sprite-handle--start");o&&(o.addEventListener("mousedown",s=>{i(s.clientX,"start"),s.preventDefault(),s.stopPropagation()}),o.addEventListener("touchstart",s=>{let l=s.touches[0];l&&(i(l.clientX,"start"),s.preventDefault(),s.stopPropagation())},{passive:!1}));let r=t.querySelector(".edit-hero-sprite-handle--end");r&&(r.addEventListener("mousedown",s=>{i(s.clientX,"end"),s.preventDefault(),s.stopPropagation()}),r.addEventListener("touchstart",s=>{let l=s.touches[0];l&&(i(l.clientX,"end"),s.preventDefault(),s.stopPropagation())},{passive:!1})),t.addEventListener("dblclick",s=>{s.preventDefault(),s.stopPropagation(),this._spriteLooping=!this._spriteLooping,this._spriteLooping&&this.videoEl&&(this.videoEl.currentTime=this.spriteStart,this.videoEl.play()),this.updateSpriteLoopUI()})}this._mouseMoveHandler=i=>{this._isDraggingSprite&&this.handleDrag(i.clientX)},document.addEventListener("mousemove",this._mouseMoveHandler),this._mouseUpHandler=()=>{this._isDraggingSprite&&(this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),this._isDraggingSprite=!1,this._dragTarget=null,this._cachedRange?.classList.remove("is-dragging"),this._wasLoopingBeforeDrag&&this.videoEl&&(this.videoEl.currentTime=this.spriteStart,this.videoEl.play()),this._wasLoopingBeforeDrag=!1)},document.addEventListener("mouseup",this._mouseUpHandler),this._touchMoveHandler=i=>{if(!this._isDraggingSprite)return;let o=i.touches[0];o&&this.handleDrag(o.clientX)},document.addEventListener("touchmove",this._touchMoveHandler,{passive:!0}),this._touchEndHandler=()=>{this._isDraggingSprite&&(this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),this._isDraggingSprite=!1,this._dragTarget=null,this._cachedRange?.classList.remove("is-dragging"),this._wasLoopingBeforeDrag&&this.videoEl&&(this.videoEl.currentTime=this.spriteStart,this.videoEl.play()),this._wasLoopingBeforeDrag=!1)},document.addEventListener("touchend",this._touchEndHandler),this._keyHandler=i=>{if(!(this.currentView!=="video"||!this.modal||!this.videoEl)){if(i.key==="ArrowLeft"){if(i.preventDefault(),i.shiftKey){let o=Math.max(yt,this.spriteDuration-.5);this.spriteDuration=o}else this.spriteStart=Math.max(0,this.spriteStart-.5);this.videoEl.currentTime=this.spriteStart,this.updateSpriteRange()}if(i.key==="ArrowRight"){if(i.preventDefault(),i.shiftKey){let o=Math.min(G,this.videoDuration-this.spriteStart),r=Math.min(o,this.spriteDuration+.5);this.spriteDuration=r,this.videoEl.currentTime=this.spriteStart+this.spriteDuration}else this.spriteStart=Math.min(this.videoDuration-this.spriteDuration,this.spriteStart+.5),this.videoEl.currentTime=this.spriteStart;this.updateSpriteRange()}}},document.addEventListener("keydown",this._keyHandler)},updateSpriteLoopUI(){if(!this.modal)return;let e=this.modal.querySelector(".edit-hero-sprite-info");e&&(this._spriteLooping?e.classList.add("looping"):e.classList.remove("looping"))},showSettingsView(){this.cleanupVideoState(),this.renderSettingsView()},cleanupVideoState(){this.videoEl&&this.videoEl.hlsInstance&&(this.videoEl.hlsInstance.destroy(),this.videoEl.hlsInstance=null),this.objectUrl&&(URL.revokeObjectURL(this.objectUrl),this.objectUrl=null),this._mouseMoveHandler&&(document.removeEventListener("mousemove",this._mouseMoveHandler),this._mouseMoveHandler=null),this._mouseUpHandler&&(document.removeEventListener("mouseup",this._mouseUpHandler),this._mouseUpHandler=null),this._keyHandler&&(document.removeEventListener("keydown",this._keyHandler),this._keyHandler=null),this._touchMoveHandler&&(document.removeEventListener("touchmove",this._touchMoveHandler),this._touchMoveHandler=null),this._touchEndHandler&&(document.removeEventListener("touchend",this._touchEndHandler),this._touchEndHandler=null),this._beforeUnloadHandler&&(window.removeEventListener("beforeunload",this._beforeUnloadHandler),this._beforeUnloadHandler=null),this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null),this._thumbnailPollTimer&&(clearTimeout(this._thumbnailPollTimer),this._thumbnailPollTimer=null),this.activeXhr&&(this.activeXhr.abort(),this.activeXhr=null),this.videoEl=null,this.videoFile=null,this.videoFlowMode="upload",this._tempId=null,this._isDraggingSprite=!1,this._spriteLooping=!1,this._hlsSessionId=null,this._hlsComplete=!1,this._hlsPreviewUrl=null,this._blobPreviewFailed=!1,this._previewCodecErrorShown=!1,this._hlsPreviewErrorShown=!1,this._renderedThumbCount=0,this._dragTarget=null,this._dragOffset=0,this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),this._cachedTrack=null,this._cachedRange=null,this._cachedDimLeft=null,this._cachedDimRight=null,this._cachedInfo=null},handleDrag(e){if(!this._dragTarget||!this._cachedTrack||!this.videoEl)return;let n=this._cachedTrack.getBoundingClientRect(),i=Math.max(0,Math.min(1,(e-n.left)/n.width))*this.videoDuration,o=this.spriteStart+this.spriteDuration;if(this._dragTarget==="start"){let r=Math.max(0,Math.min(i,o-yt)),s=o,l=s-r;l>G&&(l=G,s=r+G,s>this.videoDuration&&(s=this.videoDuration,r=s-G)),this.spriteStart=r,this.spriteDuration=l,this.videoEl.currentTime=this.spriteStart}else if(this._dragTarget==="end"){let r=Math.max(this.spriteStart+yt,Math.min(i,this.videoDuration)),s=this.spriteStart,l=r-s;l>G&&(l=G,s=r-G,s<0&&(s=0,r=G)),this.spriteStart=s,this.spriteDuration=l,this.videoEl.currentTime=r}else if(this._dragTarget==="range"){let r=i-this._dragOffset;r=Math.max(0,Math.min(r,this.videoDuration-this.spriteDuration)),this.spriteStart=r,this.videoEl.currentTime=this.spriteStart}this.updateSpriteRange()},updateSpriteRange(){if(!this.videoDuration)return;let e=this._cachedRange||this.modal?.querySelector(".edit-hero-sprite-range"),n=this._cachedInfo||this.modal?.querySelector(".edit-hero-sprite-info"),t=this._cachedDimLeft||this.modal?.querySelector(".edit-hero-timeline-dim-left"),i=this._cachedDimRight||this.modal?.querySelector(".edit-hero-timeline-dim-right");if(!e)return;let o=this.spriteStart/this.videoDuration*100,r=this.spriteDuration/this.videoDuration*100;if(e.style.left=`${o}%`,e.style.width=`${r}%`,t&&(t.style.width=`${o}%`),i&&(i.style.left=`${o+r}%`,i.style.width=`${100-o-r}%`),n){let s=this.spriteStart+this.spriteDuration;n.textContent=`Sprite: ${this.formatTime(this.spriteStart)} - ${this.formatTime(s)} (${this.spriteDuration.toFixed(1)}s)`}},updatePlayhead(){if(!this.modal||!this.videoEl||!this.videoDuration)return;let e=this.modal.querySelector(".edit-hero-playhead");if(!e)return;let n=this.videoEl.currentTime/this.videoDuration*100;e.style.left=`${n}%`},async processVideo(){if(!this.modal)return;let e=this.modal.querySelector("#hero-video-process"),n=this.modal.querySelector(".edit-hero-progress"),t=this.modal.querySelector(".edit-hero-progress-fill"),i=this.modal.querySelector(".edit-hero-progress-text");if(!e||!n||!t||!i)return;e.disabled=!0,e.textContent="Processing...",n.style.display="block",this._thumbnailPollTimer&&(clearTimeout(this._thumbnailPollTimer),this._thumbnailPollTimer=null),this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null),this._hlsSessionId&&!this._hlsComplete?(t.style.width="20%",i.textContent="Encoding video..."):(t.style.width="80%",i.textContent="Generating sprite sheet & thumbnail...");let o=null;this._hlsSessionId&&!this._hlsComplete&&(o=setInterval(async()=>{try{let r=await fetch(`/api/hls-progress/${this._hlsSessionId}`);if(!r.ok)return;let s=await r.json();if(s.status==="complete")o&&(clearInterval(o),o=null),this._hlsComplete=!0,s.hls_url&&await this.switchPreviewToHls(s.hls_url),t.style.width="80%",i.textContent="Generating sprite sheet & thumbnail...";else if(s.status==="error")o&&(clearInterval(o),o=null);else{let l=s.progress||0,a=20+l*.6;t.style.width=`${a}%`;let u=s.stage||`Encoding video... ${Math.round(l)}%`;i.textContent=u}}catch{}},1e3)),this._beforeUnloadHandler=r=>{r.preventDefault(),r.returnValue=""},window.addEventListener("beforeunload",this._beforeUnloadHandler);try{let r=this._tempId;this._tempId=null;let s=new FormData;r&&s.append("temp_id",r),this.projectSlug&&s.append("project_slug",this.projectSlug),s.append("sprite_start",String(this.spriteStart)),s.append("sprite_duration",String(this.spriteDuration)),this._hlsSessionId&&s.append("hls_session_id",this._hlsSessionId);let l=await fetch("/api/generate-sprite-sheet",{method:"POST",body:s});if(o&&(clearInterval(o),o=null),!l.ok){let u=await l.json();throw new Error(u.detail||"Sprite sheet generation failed")}let a=await l.json();if(a.success&&a.video){t.style.width="95%",i.textContent="Saving...",this.projectData&&(this.projectData.video=a.video),await this.saveVideoData(a.video),t.style.width="100%",i.textContent="Complete!";let u=this.videoFlowMode==="existing"?"Hero sprite updated successfully!":"Video processed successfully!";f(u,"success"),setTimeout(()=>this.showSettingsView(),800)}else throw new Error(a.detail||"Processing failed")}catch(r){o&&clearInterval(o),this.handleProcessingError(r.message,e,n)}finally{this._beforeUnloadHandler&&(window.removeEventListener("beforeunload",this._beforeUnloadHandler),this._beforeUnloadHandler=null)}},handleProcessingError(e,n,t){this._beforeUnloadHandler&&(window.removeEventListener("beforeunload",this._beforeUnloadHandler),this._beforeUnloadHandler=null),f(`Video processing failed: ${e}`,"error"),n&&(n.disabled=!1,n.textContent=this.getProcessButtonText()),t&&(t.style.display="none")},cancelUpload(){this.activeXhr&&(this.activeXhr.abort(),this.activeXhr=null),this.showSettingsView()},formatTime(e){let n=Math.floor(e/60),t=Math.floor(e%60);return`${n}:${t.toString().padStart(2,"0")}`},escAttr(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},escHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},async saveSettings(){if(!this.modal)return;let e=this.modal.querySelector("#settings-form");if(!e)return;let n=new FormData(e),t={name:n.get("name"),slug:n.get("slug"),date:n.get("date"),youtube:n.get("youtube")||null,draft:n.get("draft")==="on",pinned:n.get("pinned")==="on",video:this.projectData?.video,markdown:this.projectData?.markdown};try{await I("/api/save-project",{method:"POST",body:JSON.stringify(t)}),f("Settings saved!","success"),t.slug!==this.projectSlug?window.location.href=ce(`/${t.slug}`):(this.hide(),window.location.reload())}catch(i){console.error("Save settings error:",i),f("Failed to save settings","error")}},async saveVideoData(e){if(!this.projectData)return;let n={...this.projectData,video:e};try{await I("/api/save-project",{method:"POST",body:JSON.stringify(n)})}catch(t){console.error("Save video data error:",t)}},async deleteProject(){if(this.projectSlug)try{await I(`/api/project/${this.projectSlug}`,{method:"DELETE"}),f("Project deleted","success"),this.hide(),window.location.href=ce("/")}catch(e){console.error("Delete project error:",e),f("Failed to delete project","error")}},hide(){this.cleanupVideoState(),this.escHandler&&(document.removeEventListener("keydown",this.escHandler,!0),this.escHandler=null),this.modal&&(this.modal.remove(),this.modal=null),De()}},gn=Wi;var zi={modal:null,show(){this.modal=document.createElement("div"),this.modal.className="edit-create-modal",this.modal.innerHTML=`
      <div class="edit-create-overlay"></div>
      <div class="edit-create-content">
        <div class="edit-create-header">
          <h2>Create New Project</h2>
          <button class="edit-create-close">&times;</button>
        </div>
        <form class="edit-create-form" id="create-project-form">
          <div class="edit-form-group">
            <label for="project-name">Project Name</label>
            <input type="text" id="project-name" name="name" required placeholder="My New Project">
          </div>
          <div class="edit-form-group">
            <label for="project-slug">URL Slug</label>
            <input type="text" id="project-slug" name="slug" required placeholder="my-new-project" pattern="[a-z0-9\\-]+">
            <span class="edit-form-hint">Lowercase letters, numbers, and hyphens only</span>
          </div>
          <div class="edit-form-group">
            <label for="project-date">Date</label>
            <input type="date" id="project-date" name="date" required value="${new Date().toISOString().split("T")[0]}">
          </div>
          <div class="edit-form-row">
            <div class="edit-form-group edit-form-checkbox">
              <label>
                <input type="checkbox" id="project-draft" name="draft" checked>
                Draft
              </label>
            </div>
            <div class="edit-form-group edit-form-checkbox">
              <label>
                <input type="checkbox" id="project-pinned" name="pinned">
                Pinned
              </label>
            </div>
          </div>
          <div class="edit-create-actions">
            <button type="button" class="edit-btn edit-btn-secondary" id="create-cancel">Cancel</button>
            <button type="submit" class="edit-btn edit-btn-primary">Create Project</button>
          </div>
        </form>
      </div>
    `,document.body.appendChild(this.modal),He(),this.setupEventListeners();let e=this.modal.querySelector("#project-name"),n=this.modal.querySelector("#project-slug");e&&n&&(e.addEventListener("input",()=>{n.value=this.generateSlug(e.value)}),e.focus())},generateSlug(e){return e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim()},setupEventListeners(){if(!this.modal)return;let e=this.modal.querySelector(".edit-create-close");e&&e.addEventListener("click",()=>this.hide());let n=this.modal.querySelector(".edit-create-overlay");n&&n.addEventListener("click",()=>this.hide());let t=this.modal.querySelector("#create-cancel");t&&t.addEventListener("click",()=>this.hide());let i=this.modal.querySelector("#create-project-form");i&&i.addEventListener("submit",async r=>{r.preventDefault(),await this.createProject()});let o=r=>{r.key==="Escape"&&this.modal&&(this.hide(),document.removeEventListener("keydown",o))};document.addEventListener("keydown",o)},async createProject(){if(!this.modal)return;let e=this.modal.querySelector("#create-project-form");if(!e)return;let n=new FormData(e),t={name:n.get("name"),slug:n.get("slug"),date:n.get("date"),draft:n.get("draft")==="on",pinned:n.get("pinned")==="on",markdown:""};try{await I("/api/create-project",{method:"POST",body:JSON.stringify(t)}),f("Project created!","success"),this.hide(),window.location.href=ce(`/${t.slug}`)}catch(i){console.error("Create project error:",i),f("Failed to create project","error")}},hide(){this.modal&&(this.modal.remove(),this.modal=null),De()}},vn=zi;typeof window<"u"&&(window.EditUtils=Tt,window.EditBlocks=Ue,window.EditMode=dn,window.EditMedia=R,window.EditSlash=B,window.EditUndo=We,window.ProjectSettings=gn,window.ProjectCreate=vn);pn.init();})();
//# sourceMappingURL=edit-bundle.js.map
