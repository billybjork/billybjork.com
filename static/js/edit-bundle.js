// Auto-generated by esbuild - do not edit directly

"use strict";(()=>{function xi(e){let t=[{label:"Top of page",anchor:"#hero"}];return e.querySelectorAll("h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]").forEach(n=>{t.push({label:n.textContent?.trim()||n.id,anchor:`#${n.id}`})}),t}function Kn(e){return new Promise(t=>{let{existingUrl:n,container:o}=e,i=xi(o),r=!!n,s=document.createElement("div");s.className="link-dialog-backdrop";let l=document.createElement("div");l.className="link-dialog";let a=document.createElement("div");a.className="link-dialog-header",a.textContent=r?"Edit Link":"Insert Link";let c=document.createElement("input");c.type="text",c.className="link-dialog-url",c.placeholder="Paste or type a URL...",c.value=n||"";let d=document.createElement("div");d.className="link-dialog-divider",d.textContent="or link to a section";let f=document.createElement("div");f.className="link-dialog-sections",i.forEach(({label:T,anchor:M})=>{let C=document.createElement("button");C.type="button",C.className="link-dialog-section",C.textContent=T,C.addEventListener("click",()=>{g(),t({action:"insert",url:M})}),f.appendChild(C)});let S=document.createElement("div");S.className="link-dialog-actions";let h=document.createElement("button");h.type="button",h.className="edit-btn edit-btn-secondary",h.textContent="Cancel",h.addEventListener("click",()=>{g(),t({action:"cancel"})});let b=document.createElement("button");if(b.type="button",b.className="edit-btn edit-btn-primary",b.textContent=r?"Update":"Insert",b.addEventListener("click",()=>{let T=c.value.trim();T&&(g(),t({action:"insert",url:T}))}),S.appendChild(h),r){let T=document.createElement("button");T.type="button",T.className="edit-btn edit-btn-secondary",T.textContent="Remove Link",T.addEventListener("click",()=>{g(),t({action:"remove"})}),S.appendChild(T)}S.appendChild(b),l.appendChild(a),l.appendChild(c),l.appendChild(d),l.appendChild(f),l.appendChild(S),s.appendChild(l);let g=()=>{s.classList.remove("visible"),setTimeout(()=>{s.remove(),Ke(),document.removeEventListener("keydown",E)},150)},E=T=>{if(T.key==="Escape")T.preventDefault(),g(),t({action:"cancel"});else if(T.key==="Enter"&&document.activeElement===c){T.preventDefault();let M=c.value.trim();M&&(g(),t({action:"insert",url:M}))}};s.addEventListener("click",T=>{T.target===s&&(g(),t({action:"cancel"}))}),document.body.appendChild(s),ze(),document.addEventListener("keydown",E),requestAnimationFrame(()=>{s.classList.add("visible"),c.focus(),n&&c.select()})})}var Xn="edit-notification-stack";function ki(){return"block-"+Date.now()+"-"+Math.random().toString(36).substring(2,11)}function Xe(){return document.body?.dataset.editMode==="true"}function Mi(){return document.body?.classList.contains("editing")===!0}function Ee(){let e="bb_show_drafts",t=new URLSearchParams(window.location.search);if(t.has("show_drafts")){let n=t.get("show_drafts")==="true";return n?sessionStorage.setItem(e,"true"):sessionStorage.removeItem(e),n}return sessionStorage.getItem(e)==="true"}function Se(e){try{let t=new URL(e,window.location.origin);return Ee()&&t.searchParams.set("show_drafts","true"),t.toString()}catch{return e}}var lt="data-scroll-lock-count",Zt="data-scroll-lock-y";function ze(){let e=document.body,t=Number(e.getAttribute(lt)||"0");if(t===0){let n=window.scrollY||window.pageYOffset||0;e.setAttribute(Zt,String(n)),e.classList.add("modal-open"),e.style.position="fixed",e.style.top=`-${n}px`,e.style.left="0",e.style.right="0",e.style.width="100%",e.style.overflow="hidden"}e.setAttribute(lt,String(t+1))}function Ke(){let e=document.body,t=Number(e.getAttribute(lt)||"0");if(t<=0){e.classList.remove("modal-open");return}if(t>1){e.setAttribute(lt,String(t-1));return}let n=Number(e.getAttribute(Zt)||"0");e.removeAttribute(lt),e.removeAttribute(Zt),e.classList.remove("modal-open"),e.style.position="",e.style.top="",e.style.left="",e.style.right="",e.style.width="",e.style.overflow="";let o=document.documentElement,i=o.style.scrollBehavior;o.style.scrollBehavior="auto",window.scrollTo({top:n,left:0,behavior:"auto"}),requestAnimationFrame(()=>{i?o.style.scrollBehavior=i:o.style.removeProperty("scroll-behavior")})}function at(e,t){let n=()=>{e.style.height="auto",e.style.height=e.scrollHeight+"px"};return e.addEventListener("input",()=>{n(),t&&t(e.value)}),n(),requestAnimationFrame(n),n}function Qt(e,t){let n=document.createElement("img");return n.src=e.src,n.alt=e.alt||"",e.style&&n.setAttribute("style",e.style),e.align&&tn(n,e.align),t&&n.addEventListener("click",o=>{o.stopPropagation(),t(n,e)}),n}function en(e,t){let n=document.createElement("video");return n.src=e.src,e.poster&&(n.poster=e.poster,n.setAttribute("poster",e.poster)),n.className="content-video",Mt(n,!!e.autoplay),e.style&&n.setAttribute("style",e.style),e.align&&tn(n,e.align),t&&n.addEventListener("click",o=>{o.stopPropagation(),t(n,e)}),n}function Mt(e,t){let n=Mi();e.loop=t,e.muted=t,e.defaultMuted=t,e.playsInline=n||t,e.controls=n||!t,e.autoplay=!n&&t,e.autoplay?e.setAttribute("autoplay",""):e.removeAttribute("autoplay"),t?e.setAttribute("muted",""):e.removeAttribute("muted"),e.playsInline?e.setAttribute("playsinline",""):e.removeAttribute("playsinline"),n&&e.pause()}function tn(e,t){e.style.display="block",e.style.marginLeft="",e.style.marginRight="",t==="center"?(e.style.marginLeft="auto",e.style.marginRight="auto"):t==="right"&&(e.style.marginLeft="auto")}function Yn(e){switch(e){case"center":return"margin-left: auto; margin-right: auto";case"right":return"margin-left: auto";default:return""}}function ct(e){if(!e)return"left";let t=e.includes("margin-left: auto")||e.includes("margin-left:auto"),n=e.includes("margin-right: auto")||e.includes("margin-right:auto");return t&&n?"center":t?"right":"left"}function dt(e){let t=["display: block"];if(e.style){let o=e.style.replace(/margin-left:\s*auto;?\s*/g,"").replace(/margin-right:\s*auto;?\s*/g,"").replace(/display:\s*block;?\s*/g,"").trim();o&&t.push(o)}let n=Yn(e.align??"left");return n&&t.push(n),t.join("; ")}function ne(e,t){if(e.focus({preventScroll:!0}),!document.execCommand("insertText",!1,t)){let n=e.selectionStart,o=e.selectionEnd;e.setRangeText(t,n,o,"end")}}function Jn(e,t,n,o){let i=e.selectionStart,r=e.selectionEnd,s=e.value.substring(i,r)||"text",l=t+s+n;e.focus({preventScroll:!0}),e.setSelectionRange(i,r),ne(e,l),e.selectionStart=i+t.length,e.selectionEnd=i+t.length+s.length,o&&o()}function Hi(e,t,n,o,i){let r=e.lastIndexOf(`
`,t-1)+1,s=e.indexOf(`
`,n),l=s===-1?e.length:s,a=-1;for(let h=t;h>=r;h--)if(e.substring(h,h+o.length)===o){let b=h>0?e[h-1]:"";if(o!=="**"||b!=="*"){a=h;break}}if(a===-1)return null;let c=-1,d=Math.max(a+o.length,n);for(let h=d;h<=l-i.length;h++)if(e.substring(h,h+i.length)===i){let b=h+i.length<e.length?e[h+i.length]:"";if(i!=="**"||b!=="*"){c=h;break}}if(c===-1)return null;let f=a+o.length,S=c;return t>=f&&n<=S?{formatStart:a,formatEnd:c+i.length,innerStart:f,innerEnd:S}:null}function we(e,t,n,o){let{value:i,selectionStart:r,selectionEnd:s}=e,l=Hi(i,r,s,t,n);if(l){let{formatStart:a,formatEnd:c,innerStart:d,innerEnd:f}=l,S=i.substring(d,f);e.focus({preventScroll:!0}),e.setSelectionRange(a,c),ne(e,S),e.selectionStart=a,e.selectionEnd=a+S.length}else Jn(e,t,n,()=>{});o&&o()}function nn(e,t,n,o){if(!(e.metaKey||e.ctrlKey))return!1;switch(e.key){case"b":return e.preventDefault(),we(t,"**","**",n),!0;case"i":return e.preventDefault(),we(t,"*","*",n),!0;case"u":return e.preventDefault(),we(t,"<u>","</u>",n),!0;case"k":return e.preventDefault(),ut(t,o??null,n),!0}return!1}function Ht(e){let{value:t,selectionStart:n}=e,o=-1;for(let a=n;a>=Math.max(0,n-500);a--){if(t[a]==="["){o=a;break}if(t[a]===`
`||t[a]===")")break}if(o===-1)return null;let r=t.substring(o).match(/^\[([^\]]*)\]\(([^)]*)\)/);if(!r)return null;let s=r[0],l=o+s.length;return n>l?null:{start:o,end:l,text:r[1]??"",url:r[2]??"",textStart:o+1,textEnd:o+1+(r[1]?.length??0),urlStart:o+(r[1]?.length??0)+3,urlEnd:l-1}}function Ci(e){let t=(e||"").trim();return t?t.startsWith("#")||t.startsWith("/")||t.startsWith("./")||t.startsWith("../")||/^[a-zA-Z][a-zA-Z\d+.-]*:/.test(t)?t:/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(t)?`mailto:${t}`:/^(?:www\.)?[\w-]+(?:\.[\w-]+)+(?::\d+)?(?:[/?#]|$)/.test(t)?`https://${t}`:t:""}async function ut(e,t,n){let o=Ht(e),i=e.selectionStart,r=e.selectionEnd,s=e.value.substring(i,r)||"link text",l=await Kn({existingUrl:o?.url,container:t??document.body});if(l.action!=="cancel"){if(l.action==="remove"&&o)e.focus({preventScroll:!0}),e.setSelectionRange(o.start,o.end),ne(e,o.text);else if(l.action==="insert"&&l.url){let a=Ci(l.url);if(!a)return;if(o){let c=`[${o.text}](${a})`;e.focus({preventScroll:!0}),e.setSelectionRange(o.start,o.end),ne(e,c)}else{let c=`[${s}](${a})`;e.focus({preventScroll:!0}),e.setSelectionRange(i,r),ne(e,c)}}n&&n()}}function on(e){return!e||e==="left"?"":`text-align: ${e}`}function rn(e){return e?e.match(/text-align:\s*(left|center|right)/)?.[1]??"left":"left"}function Pi(e,t){let{value:n,selectionStart:o,selectionEnd:i}=e,r="   ",s=n.lastIndexOf(`
`,o-1)+1,l=n.indexOf(`
`,i);l===-1&&(l=n.length);let a=n.substring(0,s),c=n.substring(s,l),d=n.substring(l),f=c.split(`
`).map(h=>{let b=h.match(/^(\s*)\d+\.\s(.*)$/);return b?r+(b[1]??"")+"- "+(b[2]??""):r+h}).join(`
`);e.value=a+f+d;let S=f.length-c.length;e.selectionStart=o+r.length,e.selectionEnd=i+S,e.dispatchEvent(new Event("input",{bubbles:!0})),t&&t()}function Bi(e,t){let{value:n,selectionStart:o,selectionEnd:i}=e,r=n.lastIndexOf(`
`,o-1)+1,s=n.indexOf(`
`,i);s===-1&&(s=n.length);let l=n.substring(0,r),a=n.substring(r,s),c=n.substring(s),d=0,f=0,S=a.split(`
`).map((h,b)=>{let g=h.match(/^( {1,4}|\t)/);if(g){let E=g[0].length;return b===0&&(d=E),f+=E,h.substring(E)}return h}).join(`
`);e.value=l+S+c,e.selectionStart=Math.max(r,o-d),e.selectionEnd=i-f,e.dispatchEvent(new Event("input",{bubbles:!0})),t&&t()}function Ii(e,t,n){let{value:o,selectionStart:i,selectionEnd:r}=t;if(i!==r)return!1;let s=o.lastIndexOf(`
`,i-1)+1,l=o.indexOf(`
`,i),a=o.substring(s,l===-1?o.length:l),c=a.match(/^(\s*)([-*+])\s(.*)$/);if(c){let[,f="",S="-",h=""]=c;if(h.trim()===""){e.preventDefault();let g=o.substring(0,s),E=o.substring(l===-1?o.length:l);return t.value=g+E,t.selectionStart=t.selectionEnd=s,t.dispatchEvent(new Event("input",{bubbles:!0})),n&&n(),!0}e.preventDefault();let b=`
${f}${S} `;return ne(t,b),t.dispatchEvent(new Event("input",{bubbles:!0})),n&&n(),!0}let d=a.match(/^(\s*)(\d+)\.\s(.*)$/);if(d){let[,f="",S="1",h=""]=d;if(h.trim()===""){e.preventDefault();let E=o.substring(0,s),T=o.substring(l===-1?o.length:l);return t.value=E+T,t.selectionStart=t.selectionEnd=s,t.dispatchEvent(new Event("input",{bubbles:!0})),n&&n(),!0}e.preventDefault();let b=parseInt(S,10)+1,g=`
${f}${b}. `;return ne(t,g),t.dispatchEvent(new Event("input",{bubbles:!0})),n&&n(),!0}return!1}function sn(e,t,n){return e.key==="Tab"&&!e.shiftKey?(e.preventDefault(),Pi(t,n),!0):e.key==="Tab"&&e.shiftKey?(e.preventDefault(),Bi(t,n),!0):!!(e.key==="Enter"&&!e.shiftKey&&!e.metaKey&&!e.ctrlKey&&Ii(e,t,n))}function L(e,t="info",n=3e3){let o=document.getElementById(Xn);o||(o=document.createElement("div"),o.id=Xn,o.className="edit-notification-stack",document.body.appendChild(o));let i=document.createElement("div");i.className=`edit-notification edit-notification-${t}`,i.textContent=e,o.appendChild(i),requestAnimationFrame(()=>{i.classList.add("show")}),setTimeout(()=>{i.classList.remove("show"),setTimeout(()=>{i.remove(),o&&o.childElementCount===0&&o.remove()},300)},n)}function Ct(e){return JSON.parse(JSON.stringify(e))}function _i(e){let t=e.textContent?.trim()??"",n=e.innerHTML.trim();return t===""||n===""||n==="<br>"}function Di(e){let t=document.createRange(),n=window.getSelection();n&&(t.selectNodeContents(e),t.collapse(!1),n.removeAllRanges(),n.addRange(t))}async function X(e,t={}){let n=await fetch(e,{...t,headers:{"Content-Type":"application/json",...t.headers}});if(!n.ok){let o="";try{o=(await n.json()).detail||""}catch{}throw new Error(o||`HTTP error! status: ${n.status}`)}return await n.json()}function Ri(e,t){let n;return function(...i){let r=()=>{clearTimeout(n),e(...i)};clearTimeout(n),n=setTimeout(r,t)}}var Ai={generateId:ki,isDevMode:Xe,isShowDraftsActive:Ee,withShowDrafts:Se,setupAutoResizeTextarea:at,createImageElement:Qt,createVideoElement:en,applyVideoPlaybackSettings:Mt,applyAlignment:tn,getAlignmentStyle:Yn,parseAlignmentFromStyle:ct,buildMediaStyleString:dt,insertTextWithUndo:ne,wrapSelection:Jn,toggleFormat:we,handleFormattingShortcuts:nn,findLinkAtCursor:Ht,insertLink:ut,getTextAlignmentStyle:on,parseTextAlignmentFromStyle:rn,handleListShortcuts:sn,showNotification:L,deepClone:Ct,isElementEmpty:_i,moveCaretToEnd:Di,fetchJSON:X,debounce:Ri};var cn="<!-- block -->",Bt="<!-- row -->",It="<!-- /row -->",dn="<!-- col -->",Gn="<!-- html -->",Zn="<!-- /html -->",Ni=/^<!--\s*html(?:\s+style="([^"]*)")?\s*-->\s*([\s\S]*?)\s*<!--\s*\/html\s*-->$/,ji=/\n*<p\s+class=(["'])media-caption\1>([\s\S]*?)<\/p>\s*$/i;function Ye(e){return`block-${Date.now()}-${e}-${Math.random().toString(36).substring(2,7)}`}function $i(e){return e&&e.replace(/&quot;/g,'"').trim()||null}function Ui(e){return e.replace(/"/g,"&quot;")}function Fi(e){let t=(e??"").trim();return t?`<!-- html style="${Ui(t)}" -->`:Gn}function Oi(e){return e==="image"||e==="video"||e==="html"}function Vi(e){return e.replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")}function qi(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Wi(e){let t=e.match(ji);if(!t)return{content:e,caption:null};let n=t.index??e.length;return{content:e.slice(0,n).trim(),caption:Vi((t[2]??"").trim())}}function un(e){let t=(e??"").trim();return t?`
<p class="media-caption">${qi(t)}</p>`:""}function ln(e,t){let n=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp(`\\b${n}\\s*=\\s*(?:"([^"]*)"|'([^']*)')`,"i"),i=e.match(o);return i?((i[1]??i[2]??"")||"").trim():null}function zi(e){let t=e.match(/<source\b[^>]*\bsrc\s*=\s*(?:"([^"]*)"|'([^']*)')/i);return((t?.[1]??t?.[2]??"")||"").trim()}function an(e,t){let n=t.match(Ni);if(n){e.type="html",e.style=$i(n[1]),e.html=(n[2]??"").trim(),e.align=ct(e.style);return}if(t.startsWith("```")){e.type="code";let o=t.match(/^```(\w*)\n?([\s\S]*?)\n?```$/);o?(e.language=o[1]||"text",e.code=o[2]||""):(e.language="text",e.code=t.replace(/^```\w*\n?/,"").replace(/\n?```$/,""));return}if(t.startsWith("<img")||/^!\[.*?\]\(.*?\)$/.test(t)){if(e.type="image",t.startsWith("<img")){let o=t.match(/src="([^"]*)"/),i=t.match(/alt="([^"]*)"/),r=t.match(/style="([^"]*)"/);e.src=o?.[1]??"",e.alt=i?.[1]??"",e.style=r?.[1]??null,e.align=ct(e.style)}else{let o=t.match(/!\[(.*?)\]\((.*?)\)/);e.src=o?.[2]??"",e.alt=o?.[1]??"",e.style=null,e.align="left"}return}if(t.startsWith("<video")){e.type="video";let o=t.match(/^<video\b[^>]*>/i)?.[0]??t,i=/<video\b[^>]*\sautoplay(?:\s*=\s*(?:"[^"]*"|'[^']*'|[^\s>]+))?/i.test(t),r=ln(o,"src");e.src=r||zi(t),e.poster=ln(o,"poster")??"",e.style=ln(o,"style"),e.align=ct(e.style),e.autoplay=i;return}if(t.startsWith('<div class="callout"')){e.type="callout";let o=t.match(/<div class="callout"(?:\s+style="([^"]*)")?>([\s\S]*?)<\/div>/);o?(e.align=o[1]?rn(o[1]):"left",e.content=o[2]?.trim()??""):(e.content="",e.align="left");return}if(/^(\*{3,}|-{3,}|_{3,})$/.test(t)){e.type="divider";return}if(t.startsWith("<!-- align:")){e.type="text";let o=t.match(/^<!-- align:(center|right) -->\n?([\s\S]*?)\n?<!-- \/align -->$/);o?(e.align=o[1],e.content=o[2]?.trim()??""):e.align="left";return}e.type="text",e.align="left"}function Pt(e,t){let n=e.trim(),o={id:Ye(t),content:n},i=Wi(n);if(i.caption!==null){let r={id:o.id};an(r,i.content),Oi(r.type)?Object.assign(o,r,{caption:i.caption}):an(o,n)}else an(o,n);switch(o.type){case"text":return{id:o.id,type:"text",content:o.content??"",align:o.align??"left"};case"image":return{id:o.id,type:"image",src:o.src??"",alt:o.alt??"",style:o.style??null,caption:o.caption??"",align:o.align??"left"};case"video":return{id:o.id,type:"video",src:o.src??"",poster:o.poster??"",style:o.style??null,caption:o.caption??"",align:o.align??"left",autoplay:o.autoplay??!1};case"code":return{id:o.id,type:"code",code:o.code??"",language:o.language??"text"};case"html":return{id:o.id,type:"html",html:o.html??"",style:o.style??null,caption:o.caption??"",align:o.align??"left"};case"callout":return{id:o.id,type:"callout",content:o.content??"",align:o.align??"left"};case"divider":return{id:o.id,type:"divider"};default:return{id:o.id,type:"text",content:o.content??"",align:"left"}}}function Ki(e){if(!e||!e.trim())return[{id:Ye(0),type:"text",content:"",align:"left"}];let n=e.split(new RegExp(`\\n+${cn}\\n+`)).map((o,i)=>{let r=o.trim();if(r.startsWith(Bt)&&r.endsWith(It)){let l=r.slice(Bt.length,-It.length).trim().split(new RegExp(`\\n*${dn}\\n*`));if(l.length>=2)return{id:Ye(i),type:"row",left:Pt(l[0]??"",i*10),right:Pt(l[1]??"",i*10+1)}}return Pt(o,i)});return n.length?n:[{id:Ye(0),type:"text",content:"",align:"left"}]}function Qn(e){let t=e.style&&(e.style.includes("width")||e.style.includes("max-width")),n=e.align&&e.align!=="left",o=un(e.caption);if(t||n){let i=dt(e);return`<img src="${e.src}" alt="${e.alt||""}" style="${i}">${o}`}return`![${e.alt||""}](${e.src})${o}`}function eo(e){let t=[`src="${e.src}"`];e.poster&&t.push(`poster="${e.poster}"`);let n=e.autoplay?"autoplay loop muted playsinline":"controls";t.push(n);let o=e.style&&(e.style.includes("width")||e.style.includes("max-width")),i=e.align&&e.align!=="left",r=un(e.caption);if(o||i){let s=dt(e);return t.push(`style="${s}"`),`<video ${t.join(" ")}></video>${r}`}return`<video ${t.join(" ")}></video>${r}`}function to(e){return"```"+(e.language||"")+`
`+(e.code||"")+"\n```"}function no(e){return e.align&&e.align!=="left"?`<div class="callout" style="${on(e.align)}">${e.content}</div>`:`<div class="callout">${e.content}</div>`}function oo(e){let t=e.html||"",n=!!(e.style&&e.style.trim()),o=!!(e.align&&e.align!=="left"),i=n||o?dt(e):e.style,r=Fi(i),s=un(e.caption);return`${r}
${t}
${Zn}${s}`}function _t(e){switch(e.type){case"text":{let t=(e.content||"").trim();return e.align&&e.align!=="left"?`<!-- align:${e.align} -->
${t}
<!-- /align -->`:t}case"image":return Qn(e);case"video":return eo(e);case"code":return to(e);case"html":return oo(e);case"row":{let t=_t(e.left),n=_t(e.right);return`${Bt}
${t}
${dn}
${n}
${It}`}case"callout":return no(e);case"divider":return"---";default:return""}}function pt(e){return e.map(t=>_t(t)).join(`

${cn}

`)}function Le(e,t={}){let n={id:Ye(Date.now()),type:e};switch(e){case"text":return{...n,content:"",align:"left",...t};case"image":return{...n,src:"",alt:"",style:null,caption:"",align:"left",...t};case"video":return{...n,src:"",poster:"",style:null,caption:"",align:"left",autoplay:!1,...t};case"code":return{...n,language:"javascript",code:"",...t};case"html":return{...n,html:"",style:null,caption:"",align:"left",...t};case"callout":return{...n,content:"",align:"left",...t};case"row":return{...n,left:Le("text"),right:Le("text"),...t};case"divider":return{...n,...t};default:return{...n,content:"",align:"left",...t}}}var Xi={BLOCK_SEPARATOR:cn,ROW_START:Bt,ROW_END:It,COL_SEPARATOR:dn,HTML_START:Gn,HTML_END:Zn,parseIntoBlocks:Ki,parseSingleBlock:Pt,blockToMarkdown:_t,blocksToMarkdown:pt,formatImageMarkdown:Qn,formatVideoMarkdown:eo,formatCodeMarkdown:to,formatHtmlBlock:oo,formatCalloutHtml:no,createBlock:Le,generateBlockId:Ye},pn=Xi;var Yi=/^\s*([0-9]*\.?[0-9]+)\s*px(?:\s*!important)?\s*$/i,hn=new WeakMap,io=!1;function Ji(e){return e.dataset.autoHeight!=="false"}function Gi(){io||(io=!0,window.addEventListener("message",e=>{if(!e.source||typeof e.data!="object"||e.data?.type!=="sandbox-resize")return;let t=hn.get(e.source);t&&e.data.nonce===t.nonce&&Ji(t.iframe)&&(t.iframe.style.height=`${e.data.height}px`)}))}function Zi(){return crypto.randomUUID()}function ro(e,t){let n=new RegExp(`(?:^|;)\\s*${t}\\s*:\\s*([^;]+)`,"i"),o=e.match(n);if(!o)return null;let i=o[1]?.match(Yi);if(!i)return null;let r=Number.parseFloat(i[1]??"");return!Number.isFinite(r)||r<=0?null:r}function Qi(e){let t=/(?:^|;)\s*margin-left\s*:\s*auto(?:\s*!important)?\s*(?:;|$)/i.test(e),n=/(?:^|;)\s*margin-right\s*:\s*auto(?:\s*!important)?\s*(?:;|$)/i.test(e);return t&&n?"center":t?"right":null}function er(e,t){if(e.style.marginLeft="",e.style.marginRight="",t==="center"){e.style.marginLeft="auto",e.style.marginRight="auto";return}t==="right"&&(e.style.marginLeft="auto",e.style.marginRight="0")}function so(e,t,n){t&&(e.style.cssText+=`; ${t}`);let o=n??(t?Qi(t):null)??"left";if(er(e,o),!t)return;let i=ro(t,"width"),r=ro(t,"height");!i||!r||(e.style.width=`${i}px`,e.style.height="auto",e.style.aspectRatio=`${i} / ${r}`,e.style.maxWidth="100%")}function tr(e,t){return`<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body>
${e}
<script>
(function() {
  var nonce = "${t}";
  function reportHeight() {
    var height = Math.max(
      document.body.scrollHeight,
      document.documentElement.scrollHeight
    );
    window.parent.postMessage({ type: 'sandbox-resize', nonce: nonce, height: height }, '*');
  }
  new ResizeObserver(reportHeight).observe(document.body);
  window.addEventListener('load', reportHeight);
  reportHeight();
})();
<\/script>
</body>
</html>`}function lo(e,t={}){Gi();let n=document.createElement("iframe");n.className="html-block-sandbox";let o=["allow-scripts"];t.allowFullscreen!==!1&&n.setAttribute("allow","fullscreen"),t.allowPointerLock&&o.push("allow-pointer-lock"),n.setAttribute("sandbox",o.join(" "));let i=Zi();return n.srcdoc=tr(e,i),n.style.minHeight=`${t.minHeight??60}px`,n.dataset.autoHeight="true",n.addEventListener("load",()=>{n.contentWindow&&hn.set(n.contentWindow,{iframe:n,nonce:i})}),n}function ao(e){e.contentWindow&&hn.delete(e.contentWindow)}function Je(e){let t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n.toString().padStart(2,"0")}`}function mn(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function G(e){return mn(e).replace(/"/g,"&quot;")}function nr(e,t){switch(e.type){case"text":return{...e,...t};case"image":return{...e,...t};case"video":return{...e,...t};case"code":return{...e,...t};case"html":return{...e,...t};case"callout":return{...e,...t};case"row":return{...e,...t};case"divider":default:return{...e}}}function Dt(e,t,n){let o=e[t];if(!o)return{changed:!1,nextBlocks:e};let i=n(o);if(i===o)return{changed:!1,nextBlocks:e};let r=e.slice();return r[t]=i,{changed:!0,nextBlocks:r}}function fn(e,t,n){let o=t.rowSide;return o?Dt(e,t.index,i=>{if(i.type!=="row")return i;let r=i[o],s=n(r);return s===r?i:o==="left"?{...i,left:s}:{...i,right:s}}):Dt(e,t.index,n)}function co(e,t,n){return fn(e,t,o=>nr(o,n))}function uo(e,t,n={}){return e(t,n)}function mt(e,t){let n=(t??"").trim();n&&e.add(n)}function po(e){if(!e)return!1;try{let t=new URL(e);return t.protocol!=="http:"&&t.protocol!=="https:"?!1:/\.(webp|png|jpe?g|gif|avif)$/i.test(t.pathname)}catch{return!1}}function ht(e,t){if(t){if(t.type==="video"){mt(e,t.poster);return}t.type==="row"&&(ht(e,t.left),ht(e,t.right))}}var gn={MENU_WIDTH:240,MOBILE_BREAKPOINT:768},Pe={text:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg>',image:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>',video:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M10 9l5 3-5 3V9z"/></svg>',code:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',html:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/><line x1="12" y1="2" x2="12" y2="22" opacity="0.5"/></svg>',callout:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',divider:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="12" x2="21" y2="12"/><circle cx="8" cy="12" r="1" fill="currentColor"/><circle cx="12" cy="12" r="1" fill="currentColor"/><circle cx="16" cy="12" r="1" fill="currentColor"/></svg>'},gt=[{id:"text",label:"Text",icon:Pe.text,description:"Plain text paragraph"},{id:"image",label:"Image",icon:Pe.image,description:"Upload or select an image"},{id:"video",label:"Video",icon:Pe.video,description:"Upload a video file"},{id:"code",label:"Code",icon:Pe.code,description:"Code block with syntax highlighting"},{id:"html",label:"HTML",icon:Pe.html,description:"Raw HTML (scripts, embeds, custom)"},{id:"callout",label:"Callout",icon:Pe.callout,description:"Highlighted message box"},{id:"divider",label:"Divider",icon:Pe.divider,description:"Section break"}],P=null,pe=!1,vt=!1,Ze="",Z=0,Be=null,Ie=null,se=null,ft=null,Ge=null;function Rt(){if(P)return P;let e=document.createElement("div");return e.className="slash-command-menu",e.style.display="none",document.body.appendChild(e),P=e,e}function vn(e){if(!P)return;if(P.style.display="block",window.matchMedia(`(max-width: ${gn.MOBILE_BREAKPOINT}px)`).matches){P.style.width="auto",P.style.left="10px",P.style.right="10px",P.style.top="auto",P.style.bottom="10px",P.style.maxHeight="50vh";return}P.style.width=`${gn.MENU_WIDTH}px`,P.style.left=`${Math.min(e.left,window.innerWidth-gn.MENU_WIDTH-20)}px`,P.style.right="auto";let n=P.offsetHeight||200,o=window.innerHeight-e.bottom-10,i=e.top-10;o<n&&i>o?(P.style.top="auto",P.style.bottom=`${window.innerHeight-e.top+5}px`,P.style.maxHeight=`${Math.min(300,i)}px`):(P.style.top=`${e.bottom+5}px`,P.style.bottom="auto",P.style.maxHeight=`${Math.min(300,o)}px`)}function mo(e){if(!e)return gt;let t=e.toLowerCase();return gt.filter(n=>n.label.toLowerCase().includes(t)||n.id.toLowerCase().includes(t)||n.description.toLowerCase().includes(t))}function yt(e,t=0){P||Rt(),P&&(Z=Math.max(0,Math.min(t,e.length-1)),P.innerHTML=e.map((n,o)=>`
      <button
        class="slash-menu-item ${o===Z?"selected":""}"
        data-command="${n.id}"
      >
        <span class="slash-menu-icon">${n.icon}</span>
        <div class="slash-menu-content">
          <span class="slash-menu-label">${n.label}</span>
          <span class="slash-menu-description">${n.description}</span>
        </div>
      </button>
    `).join(""),P.querySelectorAll(".slash-menu-item").forEach((n,o)=>{n.addEventListener("click",()=>{let i=e[o];i&&vo(i.id)})}))}function ho(){if(!P)return;let e=P.querySelector(".slash-menu-item.selected");e&&e.scrollIntoView({block:"nearest",behavior:"smooth"})}function fo(){yn(),ft=()=>{!pe||!se||vn(se.getBoundingClientRect())},window.addEventListener("scroll",ft,!0),Ge=e=>{!pe||!P||P.contains(e.target)||se?.contains(e.target)||_e()},requestAnimationFrame(()=>{Ge&&document.addEventListener("mousedown",Ge,!0)})}function yn(){ft&&(window.removeEventListener("scroll",ft,!0),ft=null),Ge&&(document.removeEventListener("mousedown",Ge,!0),Ge=null)}function go(e,t){P||Rt(),pe=!0,vt=!0,Ze="",Z=0,Ie=t,se=e,yt(gt,0),vn(e.getBoundingClientRect()),fo()}function or(e,t,n){P||Rt(),pe=!0,vt=!1,Ze="",Z=0,Ie=t,se=n??null,yt(gt,0),vn(e),fo()}function _e(){yn(),P&&(P.style.display="none"),pe=!1,vt=!1,Ze="",Z=0,se=null}function vo(e){let t=Ie??0,n=vt,o=!1;if(vt&&Ie!==null){let i=se&&se.tagName==="TEXTAREA"?se:document.querySelector(`.block-wrapper[data-block-index="${Ie}"] .block-textarea`);if(i){let r=i.selectionStart,s=i.value,c=s.substring(0,r).lastIndexOf(`
`)+1;if(s[c]==="/"){let d=c,f=(s.substring(0,d)+s.substring(r)).replace(/\n+$/,"");if(i.value=f,i.classList.contains("text-line-input")){let h=i.closest(".block-wrapper");if(h){let b=h.querySelectorAll(".text-line-input");o=Array.from(b).every(g=>!g.value.trim())}else o=!f.trim();i.dispatchEvent(new Event("input",{bubbles:!0}))}else o=!f.trim(),Be&&Be("updateContent",{index:Ie,content:f})}}}_e(),Be&&(n?Be("execute",{commandId:e,insertIndex:o?t:t+1,replaceBlockIndex:o?t:null}):Be("execute",{commandId:e,insertIndex:t,replaceBlockIndex:null}))}function ir(e){if(!pe)return!1;let t=mo(Ze);switch(e.key){case"ArrowDown":return e.preventDefault(),e.stopPropagation(),Z=(Z+1)%t.length,yt(t,Z),ho(),!0;case"ArrowUp":return e.preventDefault(),e.stopPropagation(),Z=(Z-1+t.length)%t.length,yt(t,Z),ho(),!0;case"Enter":case"Tab":if(e.preventDefault(),e.stopPropagation(),t.length>0){let n=t[Z];n&&vo(n.id)}return!0;case"Escape":return e.preventDefault(),e.stopPropagation(),_e(),!0}return!1}function rr(e,t){let n=e.selectionStart,i=e.value.substring(0,n),s=i.lastIndexOf(`
`)+1;if(i.substring(s)==="/"){go(e,t);return}if(pe){let a=i.lastIndexOf("/");if(a!==-1){let c=i.substring(0,a);if(c===""||c.endsWith(`
`)){Ze=i.substring(a+1);let f=mo(Ze);f.length===0?_e():yt(f,0)}else _e()}else _e()}}function sr(e){Be=e,Rt()}function lr(){yn(),P&&(P.remove(),P=null),pe=!1,se=null,Be=null}function ar(){return pe}function cr(){return Ie}var dr={init:sr,cleanup:lr,showFromTextarea:go,showFromButton:or,hide:_e,handleKeydown:ir,handleTextareaInput:rr,isActive:ar,getActiveIndex:cr,COMMANDS:gt},oe=dr;var A=null,At=2e3,Ln=.8,ur=["image/jpeg","image/png","image/gif","image/webp"],pr=["video/mp4","video/quicktime","video/webm"],Re={MIN_WIDTH_PERCENT:20,MAX_WIDTH_PERCENT:100,MIN_HEIGHT_PX:60,CORNER_HANDLE_POSITIONS:["nw","ne","sw","se"],IFRAME_HANDLE_POSITIONS:["nw","ne","sw","se","n","e","s","w"],FULL_WIDTH_THRESHOLD:2},_=null,bt=[],Ae=!1,he=null,En=!1,wt=null,Et=null,bn=null,yo=null;function Tn(e){if(!A)return null;let t=A.getBlocks();for(let n=0;n<t.length;n+=1){let o=t[n];if(o){if(o.id===e)return{index:n};if(o.type==="row"){if(o.left.id===e)return{index:n,rowSide:"left"};if(o.right.id===e)return{index:n,rowSide:"right"}}}}return null}function wo(e,t){if(!A)return null;let n=A.getBlocks()[e];return n?t?n.type!=="row"?null:{index:e,rowSide:t}:{index:e}:null}function Nt(e,t,n={}){if(!A)return;if(!e.rowSide){A.updateBlock(e.index,t,n);return}let o=A.getBlocks()[e.index];if(!o||o.type!=="row")return;let i={...o[e.rowSide],...t};e.rowSide==="left"?A.updateBlock(e.index,{left:i},n):A.updateBlock(e.index,{right:i},n)}function hr(e){A=e,mr(),Eo()}function mr(){document.addEventListener("paste",async e=>{if(!A?.isActive())return;let t=Array.from(e.clipboardData?.items??[]);for(let n of t)if(n.type.startsWith("image/")){e.preventDefault();let o=n.getAsFile();if(!o)continue;let i=document.activeElement?.closest(".block-wrapper"),r=i?parseInt(i.getAttribute("data-block-index")??"",10):null,s=document.activeElement?.closest(".row-column-left, .row-column-right"),l=s?.classList.contains("row-column-left")?"left":s?.classList.contains("row-column-right")?"right":void 0;r!==null&&!isNaN(r)&&await Pn(o,r,l);break}})}function Eo(){En||(wt=e=>br(e),Et=()=>To(),bn=()=>kn(),yo=e=>{if(!A?.isActive()||!_||Ae)return;let t=e.target,n=t.closest(".image-block-wrapper, .video-block-wrapper, .html-block-wrapper"),o=t.closest(".resize-handle");n||o||xn()},document.addEventListener("click",yo),window.addEventListener("resize",bn),window.addEventListener("scroll",bn,!0),En=!0)}function fr(e,t){!e||!t||(En||Eo(),!(_&&_.element===e)&&(xn(),_={element:e,block:t,location:Tn(t.id)},e.classList.add("media-selected"),gr(e),kn()))}function xn(){Ae&&To(),_&&(_.element.classList.remove("media-selected"),Lo(),_=null)}function gr(e){Lo();let t=e.getBoundingClientRect();vr().forEach(o=>{let i=document.createElement("div");i.className=`resize-handle ${o}`,i.dataset.position=o,So(i,o,t),i.addEventListener("mousedown",r=>yr(r,o)),document.body.appendChild(i),bt.push(i)})}function vr(){return _?.block.type==="html"?Re.IFRAME_HANDLE_POSITIONS:Re.CORNER_HANDLE_POSITIONS}function So(e,t,n){let i=n.left+n.width/2,r=n.top+n.height/2;switch(e.style.position="fixed",t){case"nw":e.style.top=`${n.top-6}px`,e.style.left=`${n.left-6}px`;break;case"ne":e.style.top=`${n.top-6}px`,e.style.left=`${n.right-6}px`;break;case"sw":e.style.top=`${n.bottom-6}px`,e.style.left=`${n.left-6}px`;break;case"se":e.style.top=`${n.bottom-6}px`,e.style.left=`${n.right-6}px`;break;case"n":e.style.top=`${n.top-6}px`,e.style.left=`${i-6}px`;break;case"e":e.style.top=`${r-6}px`,e.style.left=`${n.right-6}px`;break;case"s":e.style.top=`${n.bottom-6}px`,e.style.left=`${i-6}px`;break;case"w":e.style.top=`${r-6}px`,e.style.left=`${n.left-6}px`;break}}function kn(){if(!_||bt.length===0)return;let e=_.element.getBoundingClientRect();bt.forEach(t=>{let n=t.dataset.position;So(t,n,e)})}function Lo(){bt.forEach(e=>e.remove()),bt=[]}function yr(e,t){if(!_)return;e.preventDefault(),e.stopPropagation();let n=_.element,o=n.getBoundingClientRect();if(!o.width)return;let i=n.closest(".row-column")||n.closest(".block-content")||n.closest(".image-block-wrapper")||n.closest(".video-block-wrapper")||n.closest(".html-block-preview-container")||n.parentElement,r=i?i.getBoundingClientRect():o,s=Math.max(80,r.width*Re.MIN_WIDTH_PERCENT/100),l=r.width*Re.MAX_WIDTH_PERCENT/100,a=Re.MIN_HEIGHT_PX,c=Math.max(a,o.height*3,window.innerHeight*.9);Ae=!0,n.classList.add("media-resizing"),he={position:t,startX:e.clientX,startY:e.clientY,startWidth:o.width,startHeight:o.height,minWidth:s,maxWidth:l,minHeight:a,maxHeight:c,lastWidth:o.width,lastHeight:o.height,aspectRatio:o.width>0&&o.height>0?o.width/o.height:16/9},wt&&Et&&(document.addEventListener("mousemove",wt),document.addEventListener("mouseup",Et)),document.body.style.userSelect="none"}function br(e){if(!Ae||!_||!he)return;let{position:t,startX:n,startY:o,startWidth:i,startHeight:r,minWidth:s,maxWidth:l,minHeight:a,maxHeight:c,aspectRatio:d}=he,f=_.element,S=_.block,h=f instanceof HTMLIFrameElement,b=t==="nw"||t==="ne"||t==="sw"||t==="se",g=i,E=r;if(h)if(b){let C=e.clientX-n;(t==="nw"||t==="sw")&&(C=-C),g=Qe(i+C,s,l),E=g/d,(E<a||E>c)&&(E=Qe(E,a,c),g=Qe(E*d,s,l),E=g/d)}else if(t==="e"||t==="w"){let C=e.clientX-n;t==="w"&&(C=-C),g=Qe(i+C,s,l),E=r}else{let C=e.clientY-o;t==="n"&&(C=-C),E=Qe(r+C,a,c),g=i}else{let C=e.clientX-n;(t==="nw"||t==="sw")&&(C=-C),g=Qe(i+C,s,l),E=r}he.lastWidth=g,he.lastHeight=E,f.style.width=`${Math.round(g)}px`,h?(f.style.height=`${Math.round(E)}px`,f.dataset.autoHeight="false"):f.style.height="auto";let T=Mo(S.style,g,l,{height:h?E:void 0,keepHeight:h}),M=_.location??Tn(S.id);M&&(Nt(M,{style:T},{render:!1,markDirty:!1}),_.location=M),_.block={...S,style:T},kn()}function To(){if(Ae){if(Ae=!1,_){_.element.classList.remove("media-resizing");let e=he?.lastWidth,t=he?.lastHeight,n=he?.maxWidth;if(e&&n){let o=_.element instanceof HTMLIFrameElement,i=Mo(_.block.style,e,n,{height:o?t:void 0,keepHeight:o}),r=_.location??Tn(_.block.id);r&&(Nt(r,{style:i},{render:!1,markDirty:!1}),_.location=r),!Sn(i)&&!wn(i)?(_.element.style.width="",_.element.style.height=""):Sn(i)?wn(i)||(_.element.style.height=""):_.element.style.width="",o&&(_.element.dataset.autoHeight=wn(i)?"false":"true"),A?.markDirty()}}wt&&Et&&(document.removeEventListener("mousemove",wt),document.removeEventListener("mouseup",Et)),document.body.style.userSelect="",he=null}}function xo(e){let t={};return e&&e.split(";").forEach(n=>{let[o,...i]=n.split(":");if(!o)return;let r=i.join(":").trim();r&&(t[o.trim().toLowerCase()]=r)}),t}function ko(e){return Object.entries(e).filter(([,t])=>t!=null&&t!=="").map(([t,n])=>`${t}: ${n}`).join("; ")}function Mo(e,t,n,o={}){let{height:i,keepHeight:r=!1}=o,s=xo(e);return delete s["margin-left"],delete s["margin-right"],delete s.display,delete s["max-width"],delete s["min-width"],r?(delete s["max-height"],delete s["min-height"],typeof i=="number"&&Number.isFinite(i)&&(s.height=`${Math.round(i)}px`)):(delete s.height,delete s["max-height"],delete s["min-height"]),Math.abs(t-n)<=Re.FULL_WIDTH_THRESHOLD?delete s.width:s.width=`${Math.round(t)}px`,ko(s)||null}function Sn(e){return e?/(^|;)\s*width\s*:/.test(e):!1}function wn(e){return e?/(^|;)\s*height\s*:/.test(e):!1}function Qe(e,t,n){return Math.max(t,Math.min(n,e))}async function Mn(e){return new Promise((t,n)=>{let o=new Image,i=document.createElement("canvas"),r=i.getContext("2d");if(!r){n(new Error("Could not get canvas context"));return}o.onload=()=>{let s=o.width,l=o.height;s>At&&(l=Math.round(l*At/s),s=At),i.width=s,i.height=l,r.drawImage(o,0,0,s,l),i.toBlob(a=>{a?t(a):n(new Error("Failed to create blob"))},"image/webp",Ln),URL.revokeObjectURL(o.src)},o.onerror=()=>{URL.revokeObjectURL(o.src),n(new Error("Failed to load image"))},o.src=URL.createObjectURL(e)})}async function et(e,t,n){if(t==="video")return wr(e,n);let o=new FormData;o.append("file",e),o.append("type","image");let i=await fetch("/api/upload-media",{method:"POST",body:o});if(!i.ok){let s=await i.json().catch(()=>({}));throw new Error(s.detail||`Upload failed: ${i.status}`)}return(await i.json()).url}function bo(e){return(e/(1024*1024)).toFixed(1)}function De(e,t){e?.(t)}function wr(e,t){return new Promise((n,o)=>{let i=new XMLHttpRequest,r=new FormData;r.append("file",e),i.upload.addEventListener("progress",s=>{if(!s.lengthComputable||s.total<=0){De(t,{stage:"uploading",progress:10,message:"Uploading video..."});return}let l=Math.max(0,Math.min(100,s.loaded/s.total*100)),a=Math.max(1,Math.min(65,Math.round(l*.65)));De(t,{stage:"uploading",progress:a,loadedBytes:s.loaded,totalBytes:s.total,message:`Uploading video... ${Math.round(l)}% (${bo(s.loaded)} / ${bo(s.total)} MB)`})}),i.upload.addEventListener("load",()=>{De(t,{stage:"processing",progress:72,message:"Upload complete. Processing video..."})}),i.addEventListener("load",()=>{let s={};try{s=JSON.parse(i.responseText||"{}")}catch{s={}}if(i.status>=200&&i.status<300&&typeof s.url=="string"&&s.url){De(t,{stage:"complete",progress:100,message:"Video ready!"}),n(s.url);return}let l=s.detail||`Upload failed: ${i.status}`;De(t,{stage:"error",progress:100,message:l}),o(new Error(l))}),i.addEventListener("error",()=>{let s="Upload failed: network error";De(t,{stage:"error",progress:100,message:s}),o(new Error(s))}),i.addEventListener("abort",()=>{let s="Upload canceled";De(t,{stage:"error",progress:100,message:s}),o(new Error(s))}),i.open("POST","/api/process-content-video"),i.send(r)})}function Er(e){return e.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&e.videoWidth>0&&e.videoHeight>0?Promise.resolve():new Promise((t,n)=>{let o=window.setTimeout(()=>{s(),n(new Error("Video frame is not ready. Try playing or scrubbing the video first."))},8e3),i=()=>{e.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&e.videoWidth>0&&e.videoHeight>0&&(s(),t())},r=()=>{s(),n(new Error("Unable to read the video frame."))},s=()=>{window.clearTimeout(o),e.removeEventListener("loadeddata",i),e.removeEventListener("canplay",i),e.removeEventListener("seeked",i),e.removeEventListener("error",r)};e.addEventListener("loadeddata",i),e.addEventListener("canplay",i),e.addEventListener("seeked",i),e.addEventListener("error",r),e.readyState<HTMLMediaElement.HAVE_METADATA&&e.load(),i()})}function Sr(e,t,n){return new Promise((o,i)=>{e.toBlob(r=>{r?o(r):i(new Error("Failed to capture video frame."))},t,n)})}async function Hn(e){let t=await Mn(e);return et(t,"image")}function Lr(e){let t=e.querySelector("source[src]");return(e.currentSrc||e.src||t?.src||"").trim()}async function Tr(e,t){let n=await fetch("/api/content-video-poster",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_url:e,frame_time:t})}),o=await n.json().catch(()=>({}));if(!n.ok||typeof o.url!="string"||!o.url){let i=o.detail||`Poster extraction failed: ${n.status}`;throw new Error(i)}return o.url}async function Cn(e){let t=Lr(e),n=Number.isFinite(e.currentTime)?Math.max(0,e.currentTime):0;try{await Er(e);let o=e.videoWidth,i=e.videoHeight;if(!o||!i)throw new Error("Video dimensions are unavailable.");let r=document.createElement("canvas");r.width=o,r.height=i;let s=r.getContext("2d");if(!s)throw new Error("Could not initialize frame capture.");s.drawImage(e,0,0,o,i);let l=await Sr(r,"image/webp",Ln);return await et(l,"image")}catch(o){if(t)return Tr(t,n);throw o instanceof Error?o:new Error("Failed to capture frame from video.")}}async function Pn(e,t,n){L("Processing image...","info");try{let o=await Mn(e),i=await et(o,"image"),r=wo(t,n);if(!r)throw new Error("Target block not found");Nt(r,{src:i,alt:e.name.replace(/\.[^/.]+$/,"")}),L("Image uploaded!","success")}catch(o){console.error("Image upload failed:",o),L(o instanceof Error?o.message:"Image upload failed","error")}}async function Ho(e,t,n={}){L("Processing video...","info");try{let o=await et(e,"video",n.onProgress),i=wo(t,n.rowSide);if(!i)throw new Error("Target block not found");Nt(i,{src:o}),L("Video processed!","success")}catch(o){console.error("Video upload failed:",o),L(o instanceof Error?o.message:"Video processing failed","error")}}async function xr(e,t=null){L("Processing image...","info");try{let n=await Mn(e),o=await et(n,"image");Mr(o,e.name,t),L("Image uploaded!","success")}catch(n){console.error("Image upload failed:",n),L("Image upload failed","error")}}async function kr(e,t=null,n={}){L("Processing video...","info");try{let o=await et(e,"video",n.onProgress);Hr(o,t),L("Video processed!","success")}catch(o){console.error("Video upload failed:",o),L(o instanceof Error?o.message:"Video processing failed","error")}}function Mr(e,t="",n=null){let o=t.replace(/\.[^/.]+$/,"");if(n)A?.insertBlockAfter(n,"image",{src:e,alt:o});else{let i=A?.getBlocks().length??0;A?.insertBlock(i,"image",{src:e,alt:o})}}function Hr(e,t=null){if(t)A?.insertBlockAfter(t,"video",{src:e});else{let n=A?.getBlocks().length??0;A?.insertBlock(n,"video",{src:e})}}async function Cr(e){let t=document.createElement("input");t.type="file",t.accept="image/*",t.addEventListener("change",async()=>{let n=t.files?.[0];n&&await Pn(n,e)}),t.click()}async function Pr(e){let t=document.createElement("input");t.type="file",t.accept="video/*",t.addEventListener("change",async()=>{let n=t.files?.[0];n&&await Ho(n,e)}),t.click()}var Br={MAX_IMAGE_WIDTH:At,IMAGE_QUALITY:Ln,ALLOWED_IMAGE_TYPES:ur,ALLOWED_VIDEO_TYPES:pr,RESIZE_CONFIG:Re,get selectedMedia(){return _},get isResizing(){return Ae},init:hr,select:fr,deselect:xn,handleImageUploadForBlock:Pn,handleVideoUploadForBlock:Ho,handleImageUpload:xr,handleVideoUpload:kr,replaceImageByIndex:Cr,replaceVideoByIndex:Pr,uploadPosterForVideo:Hn,capturePosterFromVideo:Cn,parseStyle:xo,serializeStyle:ko,styleHasWidth:Sn},V=Br;var me=null,N=[],F=-1,Co=50,tt=!1,q=null,Po=500;function Ir(e,t){return!e||!t?!1:JSON.stringify(e.blocks)===JSON.stringify(t.blocks)}function _r(e){me=e,N=[],F=-1,tt=!1,q!==null&&(clearTimeout(q),q=null)}function Dr(){N=[],F=-1,tt=!1,q!==null&&(clearTimeout(q),q=null)}function Rr(){if(!me)throw new Error("EditUndo not initialized");return{blocks:Ct(me.getBlocks()),timestamp:Date.now()}}function Bo(){let e=Rr();F<N.length-1&&(N=N.slice(0,F+1));let t=N[N.length-1];if(Ir(t,e)){F=N.length-1;return}N.push(e),F=N.length-1,N.length>Co&&(N.shift(),F--)}function Ar(){tt||(q!==null&&clearTimeout(q),q=setTimeout(()=>{q=null,Bo()},Po))}function Io(){q!==null&&(clearTimeout(q),q=null,Bo())}function _o(e){if(!e||!me)return;tt=!0;let t=Ct(e.blocks);me.restoreBlocks?me.restoreBlocks(t):(me.setBlocks(t),me.renderBlocks()),me.markDirty(),tt=!1}function Nr(){if(Io(),F<=0){L("Nothing to undo","info");return}F--,_o(N[F]),L("Undo","info",1e3)}function jr(){if(Io(),F>=N.length-1){L("Nothing to redo","info");return}F++,_o(N[F]),L("Redo","info",1e3)}function $r(){N=[],F=-1,q!==null&&(clearTimeout(q),q=null)}function Ur(){return F>0}function Fr(){return F<N.length-1}var Or={get history(){return N},get currentIndex(){return F},get maxHistory(){return Co},get isUndoing(){return tt},DEBOUNCE_MS:Po,init:_r,reset:Dr,saveState:Ar,undo:Nr,redo:jr,clear:$r,canUndo:Ur,canRedo:Fr},Ne=Or;var St="bb_edit_scroll_restore_v1";function Vr(e){let t=Math.max(0,document.documentElement.scrollHeight-window.innerHeight);return Math.max(0,Math.min(e,t))}function qr(e){let t=document.documentElement,n=t.style.scrollBehavior;t.style.scrollBehavior="auto",e(),requestAnimationFrame(()=>{n?t.style.scrollBehavior=n:t.style.removeProperty("scroll-behavior")})}function Do(e=null){let t=[e,".project-item.active .project-content",".about-content",".project-content"].filter(n=>!!n);for(let n of t){let o=document.querySelector(n);if(o)return{element:o,selector:n}}return{element:null,selector:null}}function Wr(e){if(document.body.classList.contains("editing")){let o=Array.from(e.querySelectorAll(".block-wrapper[data-block-index]")),i=o.find(s=>s.getBoundingClientRect().bottom>=0)??o[o.length-1]??null;if(!i)return{anchorIndex:null,anchorTop:null};let r=Number.parseInt(i.dataset.blockIndex??"",10);return{anchorIndex:Number.isNaN(r)?null:r,anchorTop:i.getBoundingClientRect().top}}let t=Array.from(e.querySelectorAll(".content-block")),n=t.find(o=>o.getBoundingClientRect().bottom>=0)??t[t.length-1]??null;return n?{anchorIndex:t.indexOf(n),anchorTop:n.getBoundingClientRect().top}:{anchorIndex:null,anchorTop:null}}function zr(e,t){return t.anchorIndex===null?null:document.body.classList.contains("editing")?e.querySelector(`.block-wrapper[data-block-index="${t.anchorIndex}"]`):Array.from(e.querySelectorAll(".content-block"))[t.anchorIndex]??null}function Bn(e,t){if(t<=0)return;let n=t,o=()=>{e(),n-=1,n>0&&requestAnimationFrame(o)};requestAnimationFrame(o)}function je(e=window.location.pathname,t=null){let{element:n,selector:o}=Do(t),i=null;if(n){let l=window.scrollY+n.getBoundingClientRect().top;i=window.scrollY-l}let r=n?Wr(n):{anchorIndex:null,anchorTop:null},s={pathname:e,scrollY:window.scrollY,containerSelector:o,offsetWithinContainer:i,anchorIndex:r.anchorIndex,anchorTop:r.anchorTop,expiresAt:Date.now()+3e4};sessionStorage.setItem(St,JSON.stringify(s))}function Ro(){let e=sessionStorage.getItem(St);if(!e)return;let t;try{t=JSON.parse(e)}catch{sessionStorage.removeItem(St);return}if(!t||Date.now()>t.expiresAt){sessionStorage.removeItem(St);return}if(t.pathname!==window.location.pathname)return;let n=()=>{if(window.location.hash)return;let{element:o}=Do(t.containerSelector),i=t.scrollY;if(o&&t.anchorTop!==null){let r=zr(o,t);if(r){let s=r.getBoundingClientRect().top-t.anchorTop;i=window.scrollY+s}else t.offsetWithinContainer!==null&&(i=window.scrollY+o.getBoundingClientRect().top+t.offsetWithinContainer)}else o&&t.offsetWithinContainer!==null&&(i=window.scrollY+o.getBoundingClientRect().top+t.offsetWithinContainer);qr(()=>{window.scrollTo({top:Vr(i),left:0,behavior:"auto"})})};sessionStorage.removeItem(St),Bn(n,4),window.addEventListener("load",()=>{Bn(n,4)},{once:!0}),setTimeout(()=>{Bn(n,2)},180)}var jt=class{constructor(t=3,n=2){this.passCount=t;this.mediaPassCount=n}renderScrollRestoreToken=0;containerScrollRestoreToken=0;modeSwitchScrollRestoreToken=0;captureRenderScrollAnchor(t){if(!t)return null;let n=Array.from(t.querySelectorAll(".block-wrapper[data-block-id]"));if(n.length===0)return null;let o=n.find(l=>l.getBoundingClientRect().bottom>=0)??n[n.length-1]??null;if(!o)return null;let i=o.dataset.blockId??null,r=Number.parseInt(o.dataset.blockIndex??"",10),s=Number.isNaN(r)?0:r;return{blockId:i,blockIndex:s,blockTop:o.getBoundingClientRect().top}}restoreRenderScrollAnchor({anchor:t,container:n,blockCount:o}){if(!t||!n||o===0)return;let i=++this.renderScrollRestoreToken,r=()=>{if(!n||o===0)return;let s=null;if(t.blockId&&(s=n.querySelector(`.block-wrapper[data-block-id="${t.blockId}"]`)),!s){let a=Math.max(0,Math.min(t.blockIndex,o-1));s=n.querySelector(`.block-wrapper[data-block-index="${a}"]`)}if(!s)return;let l=s.getBoundingClientRect().top-t.blockTop;Math.abs(l)<1||this.withInstantScroll(()=>{window.scrollTo({top:this.clampScrollTop(window.scrollY+l),left:0,behavior:"auto"})})};this.scheduleScrollRestorePasses(i,()=>this.renderScrollRestoreToken,r,this.passCount),this.bindMediaShiftReanchors(n,()=>{this.scheduleScrollRestorePasses(i,()=>this.renderScrollRestoreToken,r,this.mediaPassCount)})}captureContainerScrollAnchor(t){let n=window.scrollY+t.getBoundingClientRect().top;return{offsetWithinContainer:window.scrollY-n}}captureContentBlockAnchor(t){let n=Array.from(t.querySelectorAll(".content-block"));if(n.length===0)return null;let o=n.find(r=>r.getBoundingClientRect().bottom>=0)??n[n.length-1]??null;if(!o)return null;let i=n.indexOf(o);return i<0?null:{blockIndex:i,blockTop:o.getBoundingClientRect().top}}restoreModeSwitchBlockAnchor({anchor:t,container:n,blockCount:o,stabilityRoot:i=n??document.body}){if(!t||!n||o===0)return;let r=++this.modeSwitchScrollRestoreToken,s=()=>{if(!n||o===0)return;let l=Math.max(0,Math.min(t.blockIndex,o-1)),a=n.querySelector(`.block-wrapper[data-block-index="${l}"]`);if(!a)return;let c=a.getBoundingClientRect().top-t.blockTop;Math.abs(c)<1||this.withInstantScroll(()=>{window.scrollTo({top:this.clampScrollTop(window.scrollY+c),left:0,behavior:"auto"})})};this.scheduleScrollRestorePasses(r,()=>this.modeSwitchScrollRestoreToken,s,this.passCount),this.bindMediaShiftReanchors(i,()=>{this.scheduleScrollRestorePasses(r,()=>this.modeSwitchScrollRestoreToken,s,this.mediaPassCount)})}restoreContainerScrollAnchor({contentContainer:t,anchor:n,stabilityRoot:o=t}){let i=++this.containerScrollRestoreToken,r=()=>{let l=window.scrollY+t.getBoundingClientRect().top+n.offsetWithinContainer;this.withInstantScroll(()=>{window.scrollTo({top:this.clampScrollTop(l),left:0,behavior:"auto"})})};this.scheduleScrollRestorePasses(i,()=>this.containerScrollRestoreToken,r,this.passCount),this.bindMediaShiftReanchors(o,()=>{this.scheduleScrollRestorePasses(i,()=>this.containerScrollRestoreToken,r,this.mediaPassCount)})}withInstantScroll(t){let n=document.documentElement,o=n.style.scrollBehavior;n.style.scrollBehavior="auto",t(),requestAnimationFrame(()=>{o?n.style.scrollBehavior=o:n.style.removeProperty("scroll-behavior")})}clampScrollTop(t){let n=Math.max(0,document.documentElement.scrollHeight-window.innerHeight);return Math.max(0,Math.min(t,n))}scheduleScrollRestorePasses(t,n,o,i){if(i<=0)return;let r=i,s=()=>{t===n()&&(o(),r-=1,r>0&&requestAnimationFrame(s))};requestAnimationFrame(s)}bindMediaShiftReanchors(t,n){t.querySelectorAll("img").forEach(o=>{o.complete||(o.addEventListener("load",n,{once:!0}),o.addEventListener("error",n,{once:!0}))}),t.querySelectorAll("video").forEach(o=>{o.readyState>=1||(o.addEventListener("loadedmetadata",n,{once:!0}),o.addEventListener("error",n,{once:!0}))})}};function $t(e,t="-"){let n=e.normalize("NFKD").replace(/[\u0300-\u036f]/g,"");return n=n.replace(/[^\x00-\x7F]/g,""),n=n.replace(/[^\w\s-]/g,"").trim().toLowerCase(),n.replace(/[\s-]+/g,t)}function Ut(e,t){if(!t.has(e)&&e)return t.add(e),e;let n=e.match(/^(.+)_(\d+)$/),o=n?.[1]??e,i=n?.[2]?parseInt(n[2],10)+1:1,r=`${o}_${i}`;for(;t.has(r);)i++,r=`${o}_${i}`;return t.add(r),r}function In(e,t){e.appendChild(Kr(t))}function Kr(e){return Ao(e,0)}function Ao(e,t){let n=document.createDocumentFragment();if(!e)return n;if(t>=8)return n.appendChild(document.createTextNode(e)),n;let o=0;for(;o<e.length;){let i=e.slice(o),r=_n(i);if(!r){n.appendChild(document.createTextNode(i));break}r.index>0&&n.appendChild(document.createTextNode(i.slice(0,r.index)));let s=document.createElement(r.tagName);r.tagName==="code"?s.textContent=r.content:s.appendChild(Ao(r.content,t+1)),n.appendChild(s),o+=r.index+r.length}return n}function _n(e){let t=[Xr,Yr,Jr,Gr,Zr,Qr,es,ts,ns,os],n=null;return t.forEach(o=>{let i=o(e);i&&(!n||i.index<n.index)&&(n=i)}),n}function Te(e,t,n=1){if(!e||typeof e.index!="number")return null;let o=e[n];return o?{index:e.index,length:e[0].length,tagName:t,content:o}:null}function Xr(e){return Te(e.match(/`([^`\n]+?)`/),"code")}function Yr(e){return Te(e.match(/<u>([\s\S]+?)<\/u>/i),"u")}function Jr(e){let t=e.match(/<(strong|b)>([\s\S]+?)<\/(strong|b)>/i);if(!t||typeof t.index!="number")return null;let n=(t[1]||"").toLowerCase(),o=(t[3]||"").toLowerCase();return!n||n!==o?null:{index:t.index,length:t[0].length,tagName:"strong",content:t[2]??""}}function Gr(e){let t=e.match(/<(em|i)>([\s\S]+?)<\/(em|i)>/i);if(!t||typeof t.index!="number")return null;let n=(t[1]||"").toLowerCase(),o=(t[3]||"").toLowerCase();return!n||n!==o?null:{index:t.index,length:t[0].length,tagName:"em",content:t[2]??""}}function Zr(e){return Te(e.match(/<code>([\s\S]+?)<\/code>/i),"code")}function Qr(e){return Te(e.match(/\*\*([^*\n][\s\S]*?)\*\*/),"strong")}function es(e){return Te(e.match(/__([^_\n][\s\S]*?)__/),"strong")}function ts(e){return Te(e.match(/~~([^~\n][\s\S]*?)~~/),"s")}function ns(e){return Te(e.match(/\*([^*\n][^*\n]*?)\*/),"em")}function os(e){return Te(e.match(/_([^_\n][^_\n]*?)_/),"em")}function Dn(e){let t=(e||"").trim();if(!t)return null;if(t.startsWith("#")||t.startsWith("/")||t.startsWith("./")||t.startsWith("../"))return t;try{let n=new URL(t,window.location.origin);if(["http:","https:","mailto:","tel:"].includes(n.protocol))return n.href}catch{return null}return null}function $e(e){let t=document.createDocumentFragment(),n=/\[([^\]]+)\]\(([^)]+)\)/g,o=0,i;for(;(i=n.exec(e))!==null;){let r=i.index;r>o&&In(t,e.slice(o,r));let s=Dn(i[2]??"");if(s){let l=document.createElement("a");l.href=s,s.startsWith("#")||s.startsWith("/")||s.startsWith("./")||s.startsWith("../")||(l.rel="noopener",l.target="_blank"),In(l,i[1]??""),t.appendChild(l)}else t.appendChild(document.createTextNode(i[0]));o=r+i[0].length}return o<e.length&&In(t,e.slice(o)),t}var is="https://cdn.jsdelivr.net/npm/hls.js@1.5.12",rs="application/vnd.apple.mpegurl",No={abrEwmaDefaultEstimate:5e6,capLevelToPlayerSize:!0},Ft=null;function jo(){return window.Hls?Promise.resolve():Ft||(Ft=new Promise((e,t)=>{let n=document.createElement("script");n.src=document.body.dataset.hlsJsSrc||is,n.async=!0,n.onload=()=>e(),n.onerror=()=>t(new Error("Failed to load HLS.js")),document.head.appendChild(n)}),Ft)}function $o(e){return!!e.canPlayType(rs)}function Ot(e){e.hlsInstance&&(e.hlsInstance.destroy(),e.hlsInstance=null)}function Uo(e,t,n="",o="info"){if(!e||t!=="video")return;let i=e.querySelector(".edit-hero-preview-status");if(i){if(!n){i.hidden=!0,i.textContent="",i.classList.remove("is-info","is-warning","is-error","is-success");return}i.hidden=!1,i.textContent=n,i.classList.remove("is-info","is-warning","is-error","is-success"),i.classList.add(`is-${o}`)}}async function Fo(e){let t={hlsPreviewUrl:e.currentPreviewUrl,hlsPreviewErrorShown:e.hlsPreviewErrorShown,objectUrl:e.objectUrl};if(!e.hlsUrl||!e.videoEl||e.currentView!=="video"||e.currentPreviewUrl===e.hlsUrl)return t;let n=e.videoEl,o=Number.isFinite(n.currentTime)?n.currentTime:0,i=!n.paused||e.spriteLooping,r=$o(n),s=()=>{if(o>0)try{n.currentTime=o}catch{}i&&n.play().catch(()=>{})},l=()=>{Ot(n)},a=()=>new Promise((f,S)=>{if(!window.Hls||!window.Hls.isSupported()){S(new Error("HLS.js not supported"));return}l();let h=new window.Hls(No);n.hlsInstance=h;let b=!1,g=(E,T)=>{b||(b=!0,E?(s(),f()):(l(),S(T||new Error("HLS.js failed to initialize"))))};h.on(window.Hls.Events.MANIFEST_PARSED,()=>g(!0)),h.on(window.Hls.Events.ERROR,(E,T)=>{let M=T;M&&M.fatal&&g(!1,new Error(M.details||"HLS.js fatal error"))}),h.loadSource(e.hlsUrl),h.attachMedia(n)}),c=()=>new Promise((f,S)=>{if(!r){S(new Error("Native HLS not supported"));return}let h=()=>{g(),s(),f()},b=()=>{g(),S(new Error("Native HLS failed to load"))},g=()=>{n.removeEventListener("loadedmetadata",h),n.removeEventListener("error",b)};l(),n.addEventListener("loadedmetadata",h),n.addEventListener("error",b),n.src=e.hlsUrl,n.load()}),d=!1;try{await a(),d=!0}catch{try{await jo(),await a(),d=!0}catch{if(r)try{await c(),d=!0}catch{}}}return d?(t.hlsPreviewUrl=e.hlsUrl,n.classList.add("hls-video-preview"),n.dataset.previewSource="hls",e.setStatus(),t.objectUrl&&(URL.revokeObjectURL(t.objectUrl),t.objectUrl=null),t):(n.dataset.previewSource="blob",e.blobPreviewFailed&&!t.hlsPreviewErrorShown?(t.hlsPreviewErrorShown=!0,e.setStatus("Preview unavailable: HLS preview could not be initialized.","error"),L("HLS preview could not be initialized. Video will still process, but live preview is unavailable.","error",5e3)):e.setStatus(),t)}function Oo(e){return`
      <div class="edit-settings-header">
        <h2>Project Settings</h2>
        <button class="edit-settings-close">&times;</button>
      </div>
      <form class="edit-settings-form" id="settings-form">
        <div class="edit-form-group">
          <label for="settings-name">Project Name</label>
          <input type="text" id="settings-name" name="name" value="${G(e.name||"")}" required>
        </div>
        <div class="edit-form-group">
          <label for="settings-slug">URL Slug</label>
          <input type="text" id="settings-slug" name="slug" value="${G(e.slug||"")}" required pattern="[a-z0-9\\-]+">
        </div>
        <div class="edit-form-group">
          <label for="settings-date">Date</label>
          <input type="date" id="settings-date" name="date" value="${e.date||""}" required>
        </div>
        <div class="edit-form-group">
          <label for="settings-youtube">YouTube Link</label>
          <input type="url" id="settings-youtube" name="youtube" value="${G(e.youtube||"")}" placeholder="https://youtube.com/watch?v=...">
        </div>
        <div class="edit-form-row">
          <div class="edit-form-group edit-form-checkbox">
            <label>
              <input type="checkbox" id="settings-draft" name="draft" ${e.draft?"checked":""}>
              Draft
            </label>
          </div>
          <div class="edit-form-group edit-form-checkbox">
            <label>
              <input type="checkbox" id="settings-pinned" name="pinned" ${e.pinned?"checked":""}>
              Pinned
            </label>
          </div>
        </div>

        <div class="edit-form-section">
          <h3>Hero Video</h3>
          <div class="edit-form-group">
            <label>Current Video</label>
            ${e.video?.hls?`<div class="edit-video-info">
                    <span>HLS: ${e.video.hls.split("/").pop()}</span>
                    <div class="edit-video-actions">
                      <button type="button" class="edit-btn-small" id="update-hero-sprite">Update Sprite</button>
                      <button type="button" class="edit-btn-small" id="upload-hero-video">Replace</button>
                    </div>
                   </div>`:'<button type="button" class="edit-btn edit-btn-secondary" id="upload-hero-video">Upload Hero Video</button>'}
            <input type="file" id="hero-video-input" accept="video/*" style="display: none;">
          </div>
        </div>

        <div class="edit-settings-actions">
          <button type="button" class="edit-btn edit-btn-danger" id="delete-project">Delete Project</button>
          <div class="edit-settings-actions-right">
            <button type="button" class="edit-btn edit-btn-secondary" id="settings-cancel">Cancel</button>
            <button type="submit" class="edit-btn edit-btn-primary">Save Settings</button>
          </div>
        </div>
      </form>
    `}function Vo({isUploadFlow:e,file:t,processButtonText:n}){let o=e?"Process Hero Video":"Update Hero Sprite",i=e&&t?`${mn(t.name)} (${(t.size/(1024*1024)).toFixed(1)} MB)`:"Using current hero HLS stream";return`
      <div class="edit-settings-header">
        <h2>${o}</h2>
        <button class="edit-settings-close">&times;</button>
      </div>
      <div class="edit-hero-video-preview">
        <video class="edit-hero-video-player" controls playsinline></video>
      </div>
      <div class="edit-hero-file-info">${i}</div>
      <div class="edit-hero-preview-status" hidden></div>
      <div class="edit-hero-timeline">
        <div class="edit-hero-timeline-track">
          <canvas class="edit-hero-timeline-thumbs"></canvas>
          <div class="edit-hero-timeline-dim-left"></div>
          <div class="edit-hero-timeline-dim-right"></div>
          <div class="edit-hero-sprite-range">
            <div class="edit-hero-sprite-handle edit-hero-sprite-handle--start" data-handle="start">
              <div class="edit-hero-sprite-handle-grip"></div>
            </div>
            <div class="edit-hero-sprite-handle edit-hero-sprite-handle--end" data-handle="end">
              <div class="edit-hero-sprite-handle-grip"></div>
            </div>
          </div>
          <div class="edit-hero-playhead"></div>
        </div>
      </div>
      <div class="edit-hero-timeline-loading" hidden>Refining timeline preview...</div>
      <div class="edit-hero-time-display">
        <span class="edit-hero-current-time">0:00</span>
        <span class="edit-hero-sprite-info">Sprite: 0:00 - 0:03 (3.0s)</span>
        <span class="edit-hero-total-time">0:00</span>
      </div>
      <div class="edit-hero-progress" style="display: none;">
        <div class="edit-hero-progress-bar">
          <div class="edit-hero-progress-fill"></div>
        </div>
        <div class="edit-hero-progress-text">${e?"Uploading...":"Loading current video..."}</div>
      </div>
      <div class="edit-hero-actions">
        <button type="button" class="edit-btn edit-btn-secondary" id="hero-video-cancel">Cancel</button>
        <button type="button" class="edit-btn edit-btn-primary" id="hero-video-process" disabled>${n}</button>
      </div>
    `}function qo(e,t){if(!e)return 0;let n=e.querySelector(".edit-hero-timeline-thumbs");if(!n||!t||t.length===0)return 0;let o=n.parentElement;if(!o)return 0;let i=o.clientWidth,r=o.clientHeight,s=window.devicePixelRatio||1;n.width=i*s,n.height=r*s;let l=n.getContext("2d");if(!l)return 0;l.scale(s,s),l.clearRect(0,0,i,r);let a=t.length,c=new Array(a).fill(null),d=0,f=(h,b)=>{let g=Math.floor(b*i/a),E=b===a-1?i:Math.floor((b+1)*i/a),T=Math.max(1,E-g),M=h.width/h.height,C=T/r,B=0,U=0,ue=h.width,qe=h.height;M>C?(ue=Math.max(1,Math.round(h.height*C)),B=Math.max(0,Math.floor((h.width-ue)/2))):M<C&&(qe=Math.max(1,Math.round(h.width/C)),U=Math.max(0,Math.floor((h.height-qe)/2)));let xt=Math.max(0,g-(b>0?1:0)),Gt=Math.min(i-xt,T+(b>0?1:0));l.drawImage(h,B,U,ue,qe,xt,0,Gt,r)},S=()=>{if(d++,d!==a)return;l.clearRect(0,0,i,r);let h=null;for(let g=0;g<a;g++){let E=c[g]??null;E?h=E:h&&(c[g]=h)}let b=null;for(let g=a-1;g>=0;g--){let E=c[g]??null;E?b=E:b&&(c[g]=b)}for(let g=0;g<a;g++){let E=c[g];E&&f(E,g)}n.classList.add("loaded")};return t.forEach((h,b)=>{let g=new Image;g.onload=()=>{c[b]=g,S()},g.onerror=S,g.src="data:image/jpeg;base64,"+h}),a}var Rn=1,fe=6,Wo=3,ss={modal:null,projectSlug:null,projectData:null,currentView:"settings",videoFile:null,videoFlowMode:"upload",spriteStart:0,spriteDuration:Wo,objectUrl:null,activeXhr:null,videoEl:null,videoDuration:0,escHandler:null,_isDraggingSprite:!1,_mouseMoveHandler:null,_mouseUpHandler:null,_keyHandler:null,_beforeUnloadHandler:null,_spriteLooping:!1,_dragTarget:null,_dragOffset:0,_wasLoopingBeforeDrag:!1,_touchMoveHandler:null,_touchEndHandler:null,_rafId:null,_cachedTrack:null,_cachedRange:null,_cachedDimLeft:null,_cachedDimRight:null,_cachedInfo:null,_tempId:null,_hlsSessionId:null,_hlsComplete:!1,_hlsPollTimer:null,_thumbnailPollTimer:null,_hlsPreviewUrl:null,_blobPreviewFailed:!1,_previewCodecErrorShown:!1,_hlsPreviewErrorShown:!1,_renderedThumbCount:0,_thumbPollErrorLogged:!1,_hlsPollErrorLogged:!1,_processingPollErrorLogged:!1,videoOnlyMode:!1,onVideoSaved:null,async show(e){this.projectSlug=e,this.videoOnlyMode=!1,this.onVideoSaved=null;let t=document.querySelector(`#project-${e}`);t&&t.querySelectorAll("video").forEach(n=>n.pause());try{this.projectData=await X(`/api/project/${e}`),this.createModal()}catch(n){console.error("Failed to load project:",n),L("Failed to load project settings","error")}},async showVideoEditor(e,t={}){this.projectSlug=e,this.videoOnlyMode=!0,this.onVideoSaved=t.onVideoSaved??null;let n=document.querySelector(`#project-${e}`);n&&n.querySelectorAll("video").forEach(o=>o.pause());try{this.projectData=t.projectData??await X(`/api/project/${e}`),this.createModal(),this.showVideoView(t.file??null)}catch(o){console.error("Failed to load project:",o),L("Failed to load hero video editor","error")}},createModal(){this.currentView="settings",this.modal=document.createElement("div"),this.modal.className="edit-settings-modal",this.modal.innerHTML=`
      <div class="edit-settings-overlay"></div>
      <div class="edit-settings-content"></div>
    `,document.body.appendChild(this.modal),ze(),this.videoOnlyMode||this.renderSettingsView(),this.setupBaseListeners()},setupBaseListeners(){if(!this.modal)return;let e=this.modal.querySelector(".edit-settings-overlay");e&&e.addEventListener("click",()=>{this.currentView==="video"?this.videoOnlyMode?this.hide():this.showSettingsView():this.hide()}),this.escHandler=t=>{t.key==="Escape"&&this.modal&&(t.preventDefault(),t.stopPropagation(),this.currentView==="video"?this.videoOnlyMode?this.hide():this.cancelUpload():this.hide())},document.addEventListener("keydown",this.escHandler,!0)},renderSettingsView(){this.currentView="settings";let e=this.projectData;if(!this.modal||!e)return;let t=this.modal.querySelector(".edit-settings-content");t&&(t.classList.remove("edit-settings-content--video"),t.innerHTML=Oo(e),this.setupSettingsListeners())},setupSettingsListeners(){if(!this.modal)return;let e=this.modal.querySelector(".edit-settings-content");if(!e)return;let t=e.querySelector(".edit-settings-close");t&&t.addEventListener("click",()=>this.hide());let n=e.querySelector("#settings-cancel");n&&n.addEventListener("click",()=>this.hide());let o=e.querySelector("#settings-form");o&&o.addEventListener("submit",async a=>{a.preventDefault(),await this.saveSettings()});let i=e.querySelector("#delete-project");i&&i.addEventListener("click",async()=>{confirm(`Are you sure you want to delete "${this.projectData?.name}"? This cannot be undone.`)&&await this.deleteProject()});let r=e.querySelector("#upload-hero-video"),s=e.querySelector("#update-hero-sprite"),l=e.querySelector("#hero-video-input");r&&l&&(r.addEventListener("click",()=>l.click()),l.addEventListener("change",a=>{let d=a.target.files?.[0];if(d){if(!d.type.startsWith("video/")){L("Please select a video file","error");return}this.showVideoView(d)}})),s&&s.addEventListener("click",()=>{if(!this.projectData?.video?.hls){L("No existing hero video found for this project.","error");return}this.showVideoView()})},showVideoView(e=null){let t=!!e;if(this.currentView="video",this.videoFile=e,this.videoFlowMode=t?"upload":"existing",this.spriteStart=0,this.spriteDuration=Wo,this.videoDuration=0,this._spriteLooping=!1,this._tempId=null,this._hlsSessionId=null,this._hlsComplete=!1,this._hlsPreviewUrl=null,this._blobPreviewFailed=!1,this._previewCodecErrorShown=!1,this._hlsPreviewErrorShown=!1,this._renderedThumbCount=0,this._thumbPollErrorLogged=!1,this._hlsPollErrorLogged=!1,this._processingPollErrorLogged=!1,!this.modal)return;let n=this.modal.querySelector(".edit-settings-content");if(!n)return;n.classList.add("edit-settings-content--video");let o=this.getProcessButtonText();n.innerHTML=Vo({isUploadFlow:t,file:e,processButtonText:o}),this.videoEl=n.querySelector(".edit-hero-video-player"),this.updatePreviewStatus();let i=n.querySelector(".edit-settings-close");i&&i.addEventListener("click",()=>this.cancelUpload());let r=n.querySelector("#hero-video-cancel");r&&r.addEventListener("click",()=>this.cancelUpload());let s=n.querySelector("#hero-video-process");if(s&&s.addEventListener("click",()=>this.processVideo()),t&&e){this.extractServerThumbnails(e,n);return}this.extractExistingVideoThumbnails(n)},getProcessButtonText(){return this.videoFlowMode==="existing"?"Generate New Sprite":"Confirm & Generate Sprite"},extractServerThumbnails(e,t){let n=t.querySelector("#hero-video-process"),o=t.querySelector(".edit-hero-progress"),i=t.querySelector(".edit-hero-progress-fill"),r=t.querySelector(".edit-hero-progress-text");if(!o||!i||!r)return;o.style.display="block",r.textContent="Uploading video...";let s=new FormData;s.append("file",e),this.projectSlug&&s.append("project_slug",this.projectSlug);let l=new XMLHttpRequest;this.activeXhr=l,l.upload.addEventListener("progress",a=>{if(a.lengthComputable){let c=a.loaded/a.total*50;i.style.width=`${c}%`;let d=(a.loaded/(1024*1024)).toFixed(1),f=(a.total/(1024*1024)).toFixed(1);r.textContent=`Uploading: ${d} / ${f} MB`}}),l.addEventListener("load",()=>{if(this.activeXhr=null,l.status>=200&&l.status<300)try{let a=JSON.parse(l.responseText);if(a.success){this._tempId=a.temp_id,this.videoDuration=a.duration;let c=t.querySelector(".edit-hero-total-time");c&&(c.textContent=Je(this.videoDuration)),this.updateSpriteRange(),this.renderServerThumbnails(a.frames);let d=t.querySelector(".edit-hero-timeline-loading");d&&(d.hidden=!1),this.pollRemainingThumbnails(),n&&(n.disabled=!1),a.hls_session_id?(this._hlsSessionId=a.hls_session_id,i.style.width="50%",r.textContent="Encoding HLS...",this.pollHlsProgress(i,r,o)):o.style.display="none",this.objectUrl=URL.createObjectURL(e),this.videoEl=t.querySelector(".edit-hero-video-player"),this.videoEl&&(this.videoEl.classList.remove("hls-video-preview"),this.videoEl.dataset.previewSource="blob",this.videoEl.addEventListener("error",()=>{!this.videoEl||!(this.videoEl.currentSrc||this.videoEl.src||"").startsWith("blob:")||this._previewCodecErrorShown||(this._blobPreviewFailed=!0,this._previewCodecErrorShown=!0,this.updatePreviewStatus("Preview unavailable: this upload codec is not supported by your browser yet. It will appear once HLS finishes encoding.","warning"),L("Browser cannot play this upload codec. Preview will switch to HLS when ready.","info",4500))},{once:!0}),this.videoEl.addEventListener("loadedmetadata",()=>{!this.videoEl||!(this.videoEl.currentSrc||this.videoEl.src||"").startsWith("blob:")||(this.videoEl.videoWidth===0&&!this._blobPreviewFailed?(this._blobPreviewFailed=!0,this.updatePreviewStatus("Preview unavailable: browser can only decode audio for this upload. It will appear once HLS finishes encoding.","warning")):this._blobPreviewFailed||this.updatePreviewStatus())},{once:!0}),this.objectUrl&&(this.videoEl.src=this.objectUrl),this.setupVideoListeners(t))}else throw new Error(a.detail||"Thumbnail extraction failed")}catch(a){L(`Thumbnail extraction failed: ${a.message}`,"error"),this.cancelUpload()}else{let a="Thumbnail extraction failed";try{a=JSON.parse(l.responseText).detail||a}catch{}L(a,"error"),this.cancelUpload()}}),l.addEventListener("error",()=>{this.activeXhr=null,L("Network error during thumbnail extraction","error"),this.cancelUpload()}),l.open("POST","/api/video-thumbnails"),l.send(s)},async extractExistingVideoThumbnails(e){let t=e.querySelector("#hero-video-process"),n=e.querySelector(".edit-hero-progress"),o=e.querySelector(".edit-hero-progress-fill"),i=e.querySelector(".edit-hero-progress-text");if(!(!n||!o||!i)){if(!this.projectSlug){L("Project slug missing. Please reload and try again.","error"),this.cancelUpload();return}n.style.display="block",o.style.width="15%",i.textContent="Loading current video...";try{let r=new FormData;r.append("project_slug",this.projectSlug);let s=await fetch("/api/video-thumbnails-existing",{method:"POST",body:r});if(!s.ok){let d=await s.json();throw new Error(d.detail||"Failed to load existing video")}let l=await s.json();if(!l.success)throw new Error(l.detail||"Failed to load existing video");this._tempId=l.temp_id,this.videoDuration=l.duration,this._hlsComplete=!0,this._hlsSessionId=null;let a=e.querySelector(".edit-hero-total-time");a&&(a.textContent=Je(this.videoDuration)),this.updateSpriteRange(),this.renderServerThumbnails(l.frames||[]);let c=e.querySelector(".edit-hero-timeline-loading");c&&(c.hidden=!1),this.pollRemainingThumbnails(),t&&(t.disabled=!1),this.videoEl=e.querySelector(".edit-hero-video-player"),this.updatePreviewStatus(),this.setupVideoListeners(e),o.style.width="65%",i.textContent="Loading HLS preview...",l.hls_url&&await this.switchPreviewToHls(l.hls_url),o.style.width="100%",i.textContent="Preview ready. Select sprite range and confirm.",setTimeout(()=>{this.currentView==="video"&&(n.style.display="none")},1200)}catch(r){L(`Failed to load existing hero video: ${r.message}`,"error"),this.cancelUpload()}}},pollRemainingThumbnails(){let e=async()=>{if(!(!this._tempId||this.currentView!=="video"))try{let t=await fetch(`/api/video-thumbnails/more/${this._tempId}`);if(!t.ok)return;let n=await t.json();this._thumbPollErrorLogged=!1;let o=this.modal?.querySelector(".edit-hero-timeline-loading");if(n.frames&&n.frames.length>this._renderedThumbCount&&this.renderServerThumbnails(n.frames),n.complete)o&&(o.hidden=!0);else{if(o){o.hidden=!1;let i=Array.isArray(n.frames)?n.frames.length:this._renderedThumbCount;o.textContent=`Refining timeline preview... (${i} frames)`}this._thumbnailPollTimer=setTimeout(e,500)}}catch(t){this._thumbPollErrorLogged||(this._thumbPollErrorLogged=!0,console.warn("Timeline thumbnail polling failed; retrying.",t)),this._thumbnailPollTimer=setTimeout(e,1e3)}};e()},pollHlsProgress(e,t,n){this._hlsSessionId&&(this._hlsPollTimer=setInterval(async()=>{if(!this._hlsSessionId||this.currentView!=="video"){this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null);return}try{let o=await fetch(`/api/hls-progress/${this._hlsSessionId}`);if(!o.ok)return;let i=await o.json();if(this._hlsPollErrorLogged=!1,i.status==="complete")this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null),this._hlsComplete=!0,i.hls_url&&await this.switchPreviewToHls(i.hls_url),e.style.width="100%",t.textContent="HLS ready! Select sprite range and confirm.",setTimeout(()=>{n&&this.currentView==="video"&&(n.style.display="none")},1500);else if(i.status==="error")this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null),t.textContent="HLS encoding failed - will retry on confirm",e.style.background="#ef4444",setTimeout(()=>{n&&this.currentView==="video"&&(n.style.display="none",e.style.background="")},2e3);else{let r=i.progress||0,s=50+r*.5;e.style.width=`${s}%`,t.textContent=i.stage||`Encoding HLS... ${Math.round(r)}%`}}catch(o){this._hlsPollErrorLogged||(this._hlsPollErrorLogged=!0,console.warn("HLS progress polling failed; retrying.",o))}},1e3))},async switchPreviewToHls(e){let t=await Fo({hlsUrl:e,videoEl:this.videoEl,currentView:this.currentView,currentPreviewUrl:this._hlsPreviewUrl,spriteLooping:this._spriteLooping,blobPreviewFailed:this._blobPreviewFailed,hlsPreviewErrorShown:this._hlsPreviewErrorShown,objectUrl:this.objectUrl,setStatus:(n,o)=>this.updatePreviewStatus(n,o)});this._hlsPreviewUrl=t.hlsPreviewUrl,this._hlsPreviewErrorShown=t.hlsPreviewErrorShown,this.objectUrl=t.objectUrl},updatePreviewStatus(e="",t="info"){Uo(this.modal,this.currentView,e,t)},renderServerThumbnails(e){let t=qo(this.modal,e);t>0&&(this._renderedThumbCount=t)},setupVideoListeners(e){if(!this.videoEl)return;this.videoEl.addEventListener("timeupdate",()=>{if(!this.videoEl)return;this.updatePlayhead();let i=e.querySelector(".edit-hero-current-time");i&&(i.textContent=Je(this.videoEl.currentTime)),this._spriteLooping&&this.videoEl.currentTime>=this.spriteStart+this.spriteDuration&&(this.videoEl.currentTime=this.spriteStart)});let t=e.querySelector(".edit-hero-timeline-track");t&&t.addEventListener("click",i=>{if(this._isDraggingSprite||!this.videoEl)return;let r=t.getBoundingClientRect(),l=(i.clientX-r.left)/r.width*this.videoDuration,a=this.spriteStart+this.spriteDuration;l>=this.spriteStart&&l<=a?(this._spriteLooping=!0,this.videoEl.currentTime=l,this.videoEl.play()):(this._spriteLooping=!1,this.spriteStart=Math.max(0,Math.min(l,this.videoDuration-this.spriteDuration)),this.videoEl.currentTime=this.spriteStart,this.updateSpriteRange()),this.updateSpriteLoopUI()}),this._cachedTrack=e.querySelector(".edit-hero-timeline-track"),this._cachedRange=e.querySelector(".edit-hero-sprite-range"),this._cachedDimLeft=e.querySelector(".edit-hero-timeline-dim-left"),this._cachedDimRight=e.querySelector(".edit-hero-timeline-dim-right"),this._cachedInfo=e.querySelector(".edit-hero-sprite-info");let n=this._cachedRange,o=()=>{};if(n){o=()=>{this._isDraggingSprite&&(this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),this._isDraggingSprite=!1,this._dragTarget=null,this._cachedRange?.classList.remove("is-dragging"),this._wasLoopingBeforeDrag&&this.videoEl&&(this.videoEl.currentTime=this.spriteStart,this.videoEl.play()),this._wasLoopingBeforeDrag=!1)};let i=(l,a)=>{if(this._isDraggingSprite=!0,this._dragTarget=a,n.classList.add("is-dragging"),this._wasLoopingBeforeDrag=this._spriteLooping,this.videoEl&&!this.videoEl.paused&&this.videoEl.pause(),a==="range"&&this._cachedTrack){let c=this._cachedTrack.getBoundingClientRect(),f=(l-c.left)/c.width*this.videoDuration;this._dragOffset=f-this.spriteStart}};n.addEventListener("mousedown",l=>{l.target.closest(".edit-hero-sprite-handle")||(i(l.clientX,"range"),l.preventDefault(),l.stopPropagation())}),n.addEventListener("touchstart",l=>{if(l.target.closest(".edit-hero-sprite-handle"))return;let c=l.touches[0];c&&(i(c.clientX,"range"),l.preventDefault(),l.stopPropagation())},{passive:!1});let r=n.querySelector(".edit-hero-sprite-handle--start");r&&(r.addEventListener("mousedown",l=>{i(l.clientX,"start"),l.preventDefault(),l.stopPropagation()}),r.addEventListener("touchstart",l=>{let a=l.touches[0];a&&(i(a.clientX,"start"),l.preventDefault(),l.stopPropagation())},{passive:!1}));let s=n.querySelector(".edit-hero-sprite-handle--end");s&&(s.addEventListener("mousedown",l=>{i(l.clientX,"end"),l.preventDefault(),l.stopPropagation()}),s.addEventListener("touchstart",l=>{let a=l.touches[0];a&&(i(a.clientX,"end"),l.preventDefault(),l.stopPropagation())},{passive:!1})),n.addEventListener("dblclick",l=>{l.preventDefault(),l.stopPropagation(),this._spriteLooping=!this._spriteLooping,this._spriteLooping&&this.videoEl&&(this.videoEl.currentTime=this.spriteStart,this.videoEl.play()),this.updateSpriteLoopUI()})}this._mouseMoveHandler=i=>{this._isDraggingSprite&&this.handleDrag(i.clientX)},document.addEventListener("mousemove",this._mouseMoveHandler),this._mouseUpHandler=()=>{o()},document.addEventListener("mouseup",this._mouseUpHandler),this._touchMoveHandler=i=>{if(!this._isDraggingSprite)return;let r=i.touches[0];r&&this.handleDrag(r.clientX)},document.addEventListener("touchmove",this._touchMoveHandler,{passive:!0}),this._touchEndHandler=()=>{o()},document.addEventListener("touchend",this._touchEndHandler),this._keyHandler=i=>{if(!(this.currentView!=="video"||!this.modal||!this.videoEl)){if(i.key==="ArrowLeft"){if(i.preventDefault(),i.shiftKey){let r=Math.max(Rn,this.spriteDuration-.5);this.spriteDuration=r}else this.spriteStart=Math.max(0,this.spriteStart-.5);this.videoEl.currentTime=this.spriteStart,this.updateSpriteRange()}if(i.key==="ArrowRight"){if(i.preventDefault(),i.shiftKey){let r=Math.min(fe,this.videoDuration-this.spriteStart),s=Math.min(r,this.spriteDuration+.5);this.spriteDuration=s,this.videoEl.currentTime=this.spriteStart+this.spriteDuration}else this.spriteStart=Math.min(this.videoDuration-this.spriteDuration,this.spriteStart+.5),this.videoEl.currentTime=this.spriteStart;this.updateSpriteRange()}}},document.addEventListener("keydown",this._keyHandler)},updateSpriteLoopUI(){if(!this.modal)return;let e=this.modal.querySelector(".edit-hero-sprite-info");e&&(this._spriteLooping?e.classList.add("looping"):e.classList.remove("looping"))},showSettingsView(){if(this.videoOnlyMode){this.hide();return}this.cleanupVideoState(),this.renderSettingsView()},cleanupVideoState(){this.videoEl&&Ot(this.videoEl),this.objectUrl&&(URL.revokeObjectURL(this.objectUrl),this.objectUrl=null),this._mouseMoveHandler&&(document.removeEventListener("mousemove",this._mouseMoveHandler),this._mouseMoveHandler=null),this._mouseUpHandler&&(document.removeEventListener("mouseup",this._mouseUpHandler),this._mouseUpHandler=null),this._keyHandler&&(document.removeEventListener("keydown",this._keyHandler),this._keyHandler=null),this._touchMoveHandler&&(document.removeEventListener("touchmove",this._touchMoveHandler),this._touchMoveHandler=null),this._touchEndHandler&&(document.removeEventListener("touchend",this._touchEndHandler),this._touchEndHandler=null),this._beforeUnloadHandler&&(window.removeEventListener("beforeunload",this._beforeUnloadHandler),this._beforeUnloadHandler=null),this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null),this._thumbnailPollTimer&&(clearTimeout(this._thumbnailPollTimer),this._thumbnailPollTimer=null),this.activeXhr&&(this.activeXhr.abort(),this.activeXhr=null),this.videoEl=null,this.videoFile=null,this.videoFlowMode="upload",this._tempId=null,this._isDraggingSprite=!1,this._spriteLooping=!1,this._hlsSessionId=null,this._hlsComplete=!1,this._hlsPreviewUrl=null,this._blobPreviewFailed=!1,this._previewCodecErrorShown=!1,this._hlsPreviewErrorShown=!1,this._renderedThumbCount=0,this._thumbPollErrorLogged=!1,this._hlsPollErrorLogged=!1,this._processingPollErrorLogged=!1,this._dragTarget=null,this._dragOffset=0,this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),this._cachedTrack=null,this._cachedRange=null,this._cachedDimLeft=null,this._cachedDimRight=null,this._cachedInfo=null},handleDrag(e){if(!this._dragTarget||!this._cachedTrack||!this.videoEl)return;let t=this._cachedTrack.getBoundingClientRect(),o=Math.max(0,Math.min(1,(e-t.left)/t.width))*this.videoDuration,i=this.spriteStart+this.spriteDuration;if(this._dragTarget==="start"){let r=Math.max(0,Math.min(o,i-Rn)),s=i,l=s-r;l>fe&&(l=fe,s=r+fe,s>this.videoDuration&&(s=this.videoDuration,r=s-fe)),this.spriteStart=r,this.spriteDuration=l,this.videoEl.currentTime=this.spriteStart}else if(this._dragTarget==="end"){let r=Math.max(this.spriteStart+Rn,Math.min(o,this.videoDuration)),s=this.spriteStart,l=r-s;l>fe&&(l=fe,s=r-fe,s<0&&(s=0,r=fe)),this.spriteStart=s,this.spriteDuration=l,this.videoEl.currentTime=r}else if(this._dragTarget==="range"){let r=o-this._dragOffset;r=Math.max(0,Math.min(r,this.videoDuration-this.spriteDuration)),this.spriteStart=r,this.videoEl.currentTime=this.spriteStart}this.updateSpriteRange()},updateSpriteRange(){if(!this.videoDuration)return;let e=this._cachedRange||this.modal?.querySelector(".edit-hero-sprite-range"),t=this._cachedInfo||this.modal?.querySelector(".edit-hero-sprite-info"),n=this._cachedDimLeft||this.modal?.querySelector(".edit-hero-timeline-dim-left"),o=this._cachedDimRight||this.modal?.querySelector(".edit-hero-timeline-dim-right");if(!e)return;let i=this.spriteStart/this.videoDuration*100,r=this.spriteDuration/this.videoDuration*100;if(e.style.left=`${i}%`,e.style.width=`${r}%`,n&&(n.style.width=`${i}%`),o&&(o.style.left=`${i+r}%`,o.style.width=`${100-i-r}%`),t){let s=this.spriteStart+this.spriteDuration;t.textContent=`Sprite: ${Je(this.spriteStart)} - ${Je(s)} (${this.spriteDuration.toFixed(1)}s)`}},updatePlayhead(){if(!this.modal||!this.videoEl||!this.videoDuration)return;let e=this.modal.querySelector(".edit-hero-playhead");if(!e)return;let t=Number.isFinite(this.videoEl.duration)&&this.videoEl.duration>0?this.videoEl.duration:this.videoDuration;if(!Number.isFinite(t)||t<=0)return;let n=Math.max(0,Math.min(this.videoEl.currentTime,t)),o=Math.max(0,Math.min(100,n/t*100));e.style.left=`${o}%`},async processVideo(){if(!this.modal)return;let e=this.modal.querySelector("#hero-video-process"),t=this.modal.querySelector(".edit-hero-progress"),n=this.modal.querySelector(".edit-hero-progress-fill"),o=this.modal.querySelector(".edit-hero-progress-text");if(!e||!t||!n||!o)return;e.disabled=!0,e.textContent="Processing...",t.style.display="block",this._thumbnailPollTimer&&(clearTimeout(this._thumbnailPollTimer),this._thumbnailPollTimer=null),this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null),this._hlsSessionId&&!this._hlsComplete?(n.style.width="20%",o.textContent="Encoding video..."):(n.style.width="80%",o.textContent="Generating sprite sheet & thumbnail...");let i=null;this._hlsSessionId&&!this._hlsComplete&&(i=setInterval(async()=>{try{let r=await fetch(`/api/hls-progress/${this._hlsSessionId}`);if(!r.ok)return;let s=await r.json();if(this._processingPollErrorLogged=!1,s.status==="complete")i&&(clearInterval(i),i=null),this._hlsComplete=!0,s.hls_url&&await this.switchPreviewToHls(s.hls_url),n.style.width="80%",o.textContent="Generating sprite sheet & thumbnail...";else if(s.status==="error")i&&(clearInterval(i),i=null);else{let l=s.progress||0,a=20+l*.6;n.style.width=`${a}%`;let c=s.stage||`Encoding video... ${Math.round(l)}%`;o.textContent=c}}catch(r){this._processingPollErrorLogged||(this._processingPollErrorLogged=!0,console.warn("Processing HLS progress polling failed; retrying.",r))}},1e3)),this._beforeUnloadHandler=r=>{r.preventDefault(),r.returnValue=""},window.addEventListener("beforeunload",this._beforeUnloadHandler);try{let r=this._tempId;this._tempId=null;let s=new FormData;r&&s.append("temp_id",r),this.projectSlug&&s.append("project_slug",this.projectSlug),s.append("sprite_start",String(this.spriteStart)),s.append("sprite_duration",String(this.spriteDuration)),this._hlsSessionId&&s.append("hls_session_id",this._hlsSessionId);let l=await fetch("/api/generate-sprite-sheet",{method:"POST",body:s});if(i&&(clearInterval(i),i=null),!l.ok){let c=await l.json();throw new Error(c.detail||"Sprite sheet generation failed")}let a=await l.json();if(a.success&&a.video){n.style.width="95%",o.textContent="Saving...",this.projectData&&(this.projectData.video=a.video),this.onVideoSaved?await this.onVideoSaved(a.video):await this.saveVideoData(a.video),n.style.width="100%",o.textContent="Complete!";let c=this.videoFlowMode==="existing"?"Hero sprite updated successfully!":"Video processed successfully!";L(c,"success"),setTimeout(()=>this.showSettingsView(),800)}else throw new Error(a.detail||"Processing failed")}catch(r){i&&clearInterval(i),this.handleProcessingError(r.message,e,t)}finally{this._beforeUnloadHandler&&(window.removeEventListener("beforeunload",this._beforeUnloadHandler),this._beforeUnloadHandler=null)}},handleProcessingError(e,t,n){this._beforeUnloadHandler&&(window.removeEventListener("beforeunload",this._beforeUnloadHandler),this._beforeUnloadHandler=null),L(`Video processing failed: ${e}`,"error"),t&&(t.disabled=!1,t.textContent=this.getProcessButtonText()),n&&(n.style.display="none")},cancelUpload(){this.activeXhr&&(this.activeXhr.abort(),this.activeXhr=null),this.showSettingsView()},async saveSettings(){if(!this.modal)return;let e=this.modal.querySelector("#settings-form");if(!e)return;let t=new FormData(e),n={name:t.get("name"),slug:t.get("slug"),original_slug:this.projectSlug,date:t.get("date"),youtube:t.get("youtube")||null,draft:t.get("draft")==="on",pinned:t.get("pinned")==="on",video:this.projectData?.video,markdown:this.projectData?.markdown,base_revision:this.projectData?.revision};try{let o=await X("/api/save-project",{method:"POST",body:JSON.stringify(n)});o.revision&&this.projectData&&(this.projectData.revision=o.revision),L("Settings saved!","success"),n.slug!==this.projectSlug?window.location.href=Se(`/${n.slug}`):(this.hide(),window.location.reload())}catch(o){console.error("Save settings error:",o),L("Failed to save settings","error")}},async saveVideoData(e){if(!this.projectData)return;let t={...this.projectData,original_slug:this.projectSlug,video:e,base_revision:this.projectData.revision},n=await X("/api/save-project",{method:"POST",body:JSON.stringify(t)});n.revision&&(this.projectData.revision=n.revision)},async deleteProject(){if(this.projectSlug)try{await X(`/api/project/${this.projectSlug}`,{method:"DELETE"}),L("Project deleted","success"),this.hide(),window.location.href=Se("/")}catch(e){console.error("Delete project error:",e),L("Failed to delete project","error")}},hide(){this.cleanupVideoState(),this.escHandler&&(document.removeEventListener("keydown",this.escHandler,!0),this.escHandler=null),this.modal&&(this.modal.remove(),this.modal=null),this.onVideoSaved=null,this.videoOnlyMode=!1,Ke()}},Vt=ss;var ie={dragHandle:'<svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><circle cx="9" cy="6" r="1.5"/><circle cx="15" cy="6" r="1.5"/><circle cx="9" cy="12" r="1.5"/><circle cx="15" cy="12" r="1.5"/><circle cx="9" cy="18" r="1.5"/><circle cx="15" cy="18" r="1.5"/></svg>',delete:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',image:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>',video:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M10 9l5 3-5 3V9z"/></svg>',columns:'<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="4" width="8" height="16" rx="1.5"/><rect x="13" y="4" width="8" height="16" rx="1.5"/></svg>',split:'<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="4" y="3" width="16" height="7" rx="1.5"/><rect x="4" y="14" width="16" height="7" rx="1.5"/></svg>',swap:'<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="16 3 21 8 16 13"/><line x1="21" y1="8" x2="3" y2="8"/><polyline points="8 21 3 16 8 11"/><line x1="3" y1="16" x2="21" y2="16"/></svg>',divider:'<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><circle cx="6" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="18" cy="12" r="2"/></svg>',undo:'<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 14L4 9l5-5"/><path d="M4 9h8a8 8 0 0 1 8 8v3"/></svg>',redo:'<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M15 14l5-5-5-5"/><path d="M20 9h-8a8 8 0 0 0-8 8v3"/></svg>',trash:'<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg>'},as=[{action:"bold",content:"B",ariaLabel:"Bold",title:"Bold (Cmd/Ctrl+B)"},{action:"italic",content:"I",ariaLabel:"Italic",title:"Italic (Cmd/Ctrl+I)"},{action:"underline",content:"U",ariaLabel:"Underline",title:"Underline (Cmd/Ctrl+U)"},{action:"link",ariaLabel:"Insert/Edit link",title:"Insert/Edit link (Cmd/Ctrl+K)",isHtml:!0,content:'<svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M9 17H7a5 5 0 0 1 0-10h2"/><path d="M15 7h2a5 5 0 1 1 0 10h-2"/><path d="M8 12h8"/></svg>'},{action:"heading-1",content:"H1",ariaLabel:"Heading 1",title:"Heading 1"},{action:"heading-2",content:"H2",ariaLabel:"Heading 2",title:"Heading 2"},{action:"heading-3",content:"H3",ariaLabel:"Heading 3",title:"Heading 3"},{action:"heading-4",content:"H4",ariaLabel:"Heading 4",title:"Heading 4"}];var I=[],te=null,Y=null,ce=!1,Oe=!1,$=null,Q=null,D=null,qt=null,le=null,Wt=!1,Ue="unchanged",ve=null,ge=null,de=null,ae=null,cs=2e3,ds=5e3,us=3e3,Ve=null,J=new Set,Lt=!1,ee={sourceIndex:null,currentDropIndex:null,isDragging:!1},xe=null,ke=null,Me=null,zt=!1,it=null,nt=new jt;function He(){if(!Q)return;let e=Q.getBoundingClientRect(),t=Math.max(56,Math.ceil(e.height)+8);document.documentElement.style.setProperty("--edit-toolbar-offset",`${t}px`)}function ps(){Wt||(window.addEventListener("resize",He,{passive:!0}),window.addEventListener("orientationchange",He),window.visualViewport?.addEventListener("resize",He),Wt=!0)}function hs(){Wt&&(window.removeEventListener("resize",He),window.removeEventListener("orientationchange",He),window.visualViewport?.removeEventListener("resize",He),Wt=!1,document.documentElement.style.removeProperty("--edit-toolbar-offset"))}async function ms(e){if(!Xe()){console.log("Edit mode only available on localhost");return}te=e,D="project",Oe=!0;try{let t=await X(`/api/project/${e}`);Y=t,Ve=t.revision??null,Qo(Y);let n=new URL(window.location.href);n.searchParams.set("edit",""),window.history.replaceState({},"",n)}catch(t){console.error("Failed to load project:",t),L("Failed to load project","error")}}async function fs(){if(!Xe()){console.log("Edit mode only available on localhost");return}D="about",te=null,Oe=!0;try{let e=await X("/api/about");Y=e,Ve=e.revision??null,Qo(Y);let t=new URL(window.location.href);t.searchParams.set("edit",""),window.history.replaceState({},"",t)}catch(e){console.error("Failed to load about content:",e),L("Failed to load about content","error")}}function Qo(e){let t=D==="about"?document.querySelector(".about-content"):document.querySelector(".project-content"),n=D==="project"?t?.closest(".project-item")??null:null;if(!t){console.error("Content container not found");return}if(D==="project"){n&&n.querySelectorAll("video").forEach(c=>{c.pause()});let a=n?.querySelector(".edit-buttons");a&&(qt=a,a.classList.add("edit-controls-hidden"))}Q=vs(e),st(),ps(),He();let o="markdown"in e?e.markdown:"";I=pn.parseIntoBlocks(o||""),J.clear();let i=nt.captureContainerScrollAnchor(t),r=nt.captureContentBlockAnchor(t),s=document.createElement("div");if(s.className="edit-mode-container",s.innerHTML=`
    <div class="edit-blocks-container"></div>
  `,t.innerHTML="",t.appendChild(s),t.classList.add("edit-mode-active"),$=s.querySelector(".edit-blocks-container"),oe.init(Gs),V.init({updateBlock:fi,insertBlock:Xt,insertBlockAfter:di,getBlocks:()=>I,renderBlocks:Fe,markDirty:W,isActive:()=>Oe}),Ne.init({getBlocks:()=>I,setBlocks:a=>{I=a},renderBlocks:Fe,restoreBlocks:Is,markDirty:W}),Ne.saveState(),document.addEventListener("keydown",pi),document.body.classList.add("editing"),ys(),D==="project"&&n){let a=e;el(n,a);let d=n.querySelector(".project-details")?.querySelector(".video-container");le=tl(a),le&&(d?d.before(le):t.before(le)),xe=nl(a),d?d.after(xe):le?le.after(xe):t.before(xe)}Fe();let l=D==="project"?t.closest(".project-item")??t:t;r?nt.restoreModeSwitchBlockAnchor({anchor:r,container:$,blockCount:I.length,stabilityRoot:l}):nt.restoreContainerScrollAnchor({contentContainer:t,anchor:i,stabilityRoot:l}),window.addEventListener("beforeunload",ti)}function $n(e,t={}){if(D!=="project"||!te||!Y)throw new Error("Project data is not loaded");let n=Y,i={slug:String(n.slug||te).trim(),original_slug:te,name:n.name,date:n.date,pinned:n.pinned??!1,draft:n.draft??!1,youtube:n.youtube||"",video:n.video??{},markdown:e};return J.size>0&&(i.cleanup_candidates=Array.from(J)),t.force?i.force=!0:i.base_revision=Ve,i}function gs(e){if(D!=="project"||typeof e!="string")return;let t=e.trim();if(!t||!Y||!("slug"in Y))return;let n=te;if(Y.slug=t,n===t)return;te=t;let o=document.querySelector(".project-item.active");if(o){o.dataset.slug=t,n&&o.id===`project-${n}`&&(o.id=`project-${t}`);let s=o.querySelector(".project-details");s&&n&&s.id===`details-${n}`&&(s.id=`details-${t}`)}let i=le?.querySelector("#inline-settings-slug");i&&(i.value=t);let r=new URL(window.location.href);r.pathname!==`/${t}`&&(r.pathname=`/${t}`,window.history.replaceState({},"",r.toString()))}function Un(e){e.revision&&(Ve=e.revision),D==="project"&&(J.clear(),gs(e.slug))}function ei(){document.querySelector(".edit-conflict-banner")?.remove();let e=document.createElement("div");e.className="edit-conflict-banner",e.innerHTML=`
    <span class="edit-conflict-message">Content was modified in another session</span>
    <button class="edit-conflict-btn edit-conflict-keep">Keep mine</button>
    <button class="edit-conflict-btn edit-conflict-reload">Load theirs</button>
  `,e.style.cssText="position:fixed;top:0;left:0;right:0;z-index:10000;display:flex;align-items:center;justify-content:center;gap:12px;padding:12px 20px;background:#7c2d12;color:#fff;font-size:14px;font-family:-apple-system,BlinkMacSystemFont,sans-serif;box-shadow:0 2px 8px rgba(0,0,0,.3)";let t=e.querySelector(".edit-conflict-keep"),n=e.querySelector(".edit-conflict-reload");[t,n].forEach(o=>{o.style.cssText="padding:6px 16px;border:1px solid rgba(255,255,255,.3);border-radius:6px;background:transparent;color:#fff;font-size:13px;cursor:pointer"}),t.addEventListener("click",async()=>{e.remove();let o=pt(I);try{let i;if(D==="about")i=await fetch("/api/save-about",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({markdown:o,force:!0})});else{let r=$n(o,{force:!0});i=await fetch("/api/save-project",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})}if(i.ok){let r=await i.json();Un(r),ce=!1,z({type:"save_ok"}),L("Changes saved (overwritten)","success")}else z({type:"save_error"}),L("Force save failed","error")}catch(i){console.error("Force save failed:",i),z({type:"save_error"}),L("Force save failed","error")}}),n.addEventListener("click",()=>{e.remove(),rt(),window.location.reload()}),document.body.appendChild(e)}function rt(){Oe=!1,ve&&(clearTimeout(ve),ve=null),ge&&(clearTimeout(ge),ge=null),de&&(clearTimeout(de),de=null),ae&&(ae.abort(),ae=null),z({type:"reset"}),Ve=null,J.clear(),document.querySelector(".edit-conflict-banner")?.remove(),document.removeEventListener("keydown",pi),window.removeEventListener("beforeunload",ti),oe.cleanup(),V.deselect(),bs(),document.body.classList.remove("editing");let e=D==="about"?document.querySelector(".about-content"):document.querySelector(".project-content");e&&e.classList.remove("edit-mode-active"),hs(),Q&&(Q.remove(),Q=null),qt&&(qt.classList.remove("edit-controls-hidden"),qt=null),xe&&(xe.remove(),xe=null),le&&(le.remove(),le=null);let t=new URL(window.location.href);t.searchParams.delete("edit"),window.history.replaceState({},"",t),D=null}function ti(e){ce&&(e.preventDefault(),e.returnValue="")}function vs(e){let t=D==="about"?"About Page":"name"in e?e.name:"Project",n=document.createElement("div");n.className="edit-mode-toolbar edit-mode-toolbar-fixed",n.style.position="fixed",n.style.inset="0 0 auto 0",n.style.top="0",n.style.bottom="auto",n.style.left="0",n.style.right="0",n.style.zIndex="1200";let o=D==="project"?`<button class="edit-btn edit-btn-icon edit-btn-icon-danger" data-action="delete" aria-label="Delete project" title="Delete project">${ie.trash}</button>`:"";return n.innerHTML=`
    <div class="edit-toolbar-left">
      <span class="edit-project-name">Editing: ${G(t)}</span>
      <span class="edit-status" aria-live="polite"></span>
    </div>
    <div class="edit-toolbar-right">
      ${o}
      <button class="edit-btn edit-btn-icon" data-action="undo" aria-label="Undo" title="Undo (Cmd/Ctrl+Z)">${ie.undo}</button>
      <button class="edit-btn edit-btn-icon" data-action="redo" aria-label="Redo" title="Redo (Cmd/Ctrl+Shift+Z / Cmd/Ctrl+Y)">${ie.redo}</button>
      <button class="edit-btn edit-btn-secondary" data-action="cancel">Discard</button>
      <button class="edit-btn edit-btn-primary" data-action="save">Save</button>
    </div>
  `,n.querySelector('[data-action="undo"]')?.addEventListener("click",hi),n.querySelector('[data-action="redo"]')?.addEventListener("click",jn),n.querySelector('[data-action="undo"]')?.addEventListener("mousedown",i=>{i.preventDefault()}),n.querySelector('[data-action="redo"]')?.addEventListener("mousedown",i=>{i.preventDefault()}),n.querySelector('[data-action="cancel"]')?.addEventListener("click",Vn),n.querySelector('[data-action="save"]')?.addEventListener("click",On),n.querySelector('[data-action="delete"]')?.addEventListener("click",Qs),document.body.appendChild(n),n}function ys(){ni(),!zt&&(document.addEventListener("selectionchange",oi),window.addEventListener("resize",j),window.addEventListener("scroll",j,!0),zt=!0)}function bs(){it!==null&&(cancelAnimationFrame(it),it=null),zt&&(document.removeEventListener("selectionchange",oi),window.removeEventListener("resize",j),window.removeEventListener("scroll",j,!0),zt=!1),Me=null,ke&&(ke.remove(),ke=null)}function ni(){if(ke)return ke;let e=document.createElement("div");return e.className="inline-format-toolbar",as.forEach(({action:t,content:n,title:o,ariaLabel:i,isHtml:r})=>{let s=document.createElement("button");s.type="button",s.className=`inline-format-btn inline-format-btn-${t}`,s.dataset.action=t,s.setAttribute("aria-label",i),s.title=o,r?s.innerHTML=n:s.textContent=n,s.addEventListener("mousedown",l=>{l.preventDefault()}),s.addEventListener("click",l=>{l.preventDefault(),Ss(t)}),e.appendChild(s)}),document.body.appendChild(e),ke=e,e}function Tt(e){Me=e,j()}function oi(){j()}function j(){Oe&&it===null&&(it=requestAnimationFrame(()=>{it=null,ws()}))}function ws(){let e=ni(),t=Me;if(!t||!t.row.isConnected||!t.textarea.isConnected){e.classList.remove("visible");return}let n=t.textarea,{selectionStart:o,selectionEnd:i}=n;if(document.activeElement!==n||o===i){e.classList.remove("visible");return}let r=ks(n);if(!r){e.classList.remove("visible");return}Es(n),e.classList.add("visible");let s=e.getBoundingClientRect(),l=8,a=r.left+r.width/2-s.width/2;a=Math.max(l,Math.min(a,window.innerWidth-s.width-l));let c=r.top-s.height-10;c<l&&(c=r.bottom+10),e.style.left=`${Math.max(l,a)}px`,e.style.top=`${Math.max(l,c)}px`}function Es(e){if(!ke)return;let{value:t,selectionStart:n,selectionEnd:o}=e,i=n<o,r=Ts(t),s=i?Ht(e):null,l=!!s&&n>=s.start&&o<=s.end;ke.querySelectorAll(".inline-format-btn").forEach(a=>{let c=a.dataset.action;if(!c)return;let d=!1;switch(c){case"bold":d=i&&An(t,n,o,"**","**","bold");break;case"italic":d=i&&An(t,n,o,"*","*","italic");break;case"underline":d=i&&An(t,n,o,"<u>","</u>");break;case"link":d=l;break;case"heading-1":case"heading-2":case"heading-3":case"heading-4":d=r===Number.parseInt(c.slice(-1),10);break;default:d=!1}a.classList.toggle("is-active",d)})}function Ss(e){if(!Me)return;let{textarea:t,onEdit:n}=Me;switch(e){case"bold":we(t,"**","**",n);break;case"italic":we(t,"*","*",n);break;case"underline":we(t,"<u>","</u>",n);break;case"link":ut(t,$,()=>{n(),j()});return;case"heading-1":case"heading-2":case"heading-3":case"heading-4":Ls(t,Number.parseInt(e.slice(-1),10)),n();break;default:return}j()}function Ls(e,t){let n=Math.max(1,Math.min(t,6)),o=e.value,i=e.selectionStart,r=e.selectionEnd,s=o.match(/^(\s*)(#{1,6})\s+(.*)$/),l=o.match(/^(\s*)/),a=s?.[1]??l?.[1]??"",c="#".repeat(n),d=o,f=a.length,S=a.length;if(s){let E=s[2]?.length??1,T=s[3]??"";f=a.length+E+1,E===n?(d=`${a}${T}`,S=a.length):(d=`${a}${c} ${T}`,S=a.length+c.length+1)}else{let E=o.slice(a.length).replace(/^\s+/,"");d=`${a}${c} ${E}`,f=a.length,S=a.length+c.length+1}e.focus({preventScroll:!0}),e.setSelectionRange(0,e.value.length),ne(e,d);let h=S-f,b=Math.max(0,Math.min(d.length,i+h)),g=Math.max(0,Math.min(d.length,r+h));e.selectionStart=b,e.selectionEnd=g}function Ts(e){let t=e.match(/^(\s*)(#{1,6})\s+/);return t?t[2]?.length??null:null}function An(e,t,n,o,i,r="default"){return!!xs(e,t,n,o,i,r)}function xs(e,t,n,o,i,r="default"){let s=e.lastIndexOf(`
`,t-1)+1,l=e.indexOf(`
`,n),a=l===-1?e.length:l,c=-1;for(let b=t;b>=s;b-=1){if(e.slice(b,b+o.length)!==o)continue;let g=b>0?e[b-1]:"",E=b+o.length<e.length?e[b+o.length]:"";if(!(r==="bold"&&(g==="*"||E==="*"))&&!(r==="italic"&&(g==="*"||E==="*"))){c=b;break}}if(c===-1)return null;let d=-1,f=Math.max(c+o.length,n);for(let b=f;b<=a-i.length;b+=1){if(e.slice(b,b+i.length)!==i)continue;let g=b>0?e[b-1]:"",E=b+i.length<e.length?e[b+i.length]:"";if(!(r==="bold"&&(g==="*"||E==="*"))&&!(r==="italic"&&(g==="*"||E==="*"))){d=b;break}}if(d===-1)return null;let S=c+o.length,h=d;return t<S||n>h?null:{innerStart:S,innerEnd:h}}function ks(e){let t=e.selectionStart,n=e.selectionEnd;if(t===n)return null;let o=window.getComputedStyle(e),i=document.createElement("div");["box-sizing","width","font-family","font-size","font-weight","font-style","line-height","letter-spacing","text-transform","text-align","white-space","word-break","overflow-wrap","padding-top","padding-right","padding-bottom","padding-left","border-top-width","border-right-width","border-bottom-width","border-left-width"].forEach(g=>{i.style.setProperty(g,o.getPropertyValue(g))}),i.style.position="fixed",i.style.left="-9999px",i.style.top="0",i.style.visibility="hidden",i.style.pointerEvents="none",i.style.height="auto",i.style.minHeight="0",i.style.maxHeight="none",i.style.overflow="hidden",i.style.whiteSpace="pre-wrap",i.style.wordWrap="break-word",i.style.width=`${e.offsetWidth}px`;let s=document.createTextNode(e.value.slice(0,t)),l=document.createElement("span");l.textContent=e.value.slice(t,n)||" ",i.appendChild(s),i.appendChild(l),document.body.appendChild(i);let a=l.getBoundingClientRect(),c=i.getBoundingClientRect(),d=e.getBoundingClientRect(),f=d.left+(a.left-c.left)-e.scrollLeft,S=d.top+(a.top-c.top)-e.scrollTop,h=Math.max(1,a.width),b=Math.max(1,a.height);return i.remove(),new DOMRect(f,S,h,b)}function st(){if(!Q)return;let e=Q.querySelector(".edit-status"),t=Q.querySelector('[data-action="save"]');if(t?.classList.remove("has-changes","is-saving","has-error"),t&&(t.disabled=!1,t.textContent="Save"),e)switch(Ue){case"unchanged":e.textContent="No unsaved changes",e.style.color="";break;case"pending":e.textContent="(unsaved)",e.style.color="#eab308",t?.classList.add("has-changes");break;case"saving":e.textContent="Saving...",e.style.color="#3b82f6",t?.classList.add("is-saving"),t&&(t.disabled=!0,t.textContent="Saving...");break;case"saved":e.textContent="All changes saved",e.style.color="#22c55e";break;case"error":e.textContent="Save failed",e.style.color="#ef4444",t?.classList.add("has-error");break;case"conflict":e.textContent="Conflict",e.style.color="#f97316",t?.classList.add("has-error");break}let n=Q.querySelector('[data-action="undo"]'),o=Q.querySelector('[data-action="redo"]');n&&(n.disabled=!1),o&&(o.disabled=!1),He()}function Ms(e,t){switch(t.type){case"edit":return"pending";case"save_start":return e==="conflict"?e:"saving";case"save_ok":return"saved";case"save_error":return"error";case"conflict":return"conflict";case"fade":return e==="saved"?"unchanged":e;case"reset":return"unchanged";default:return e}}function z(e){let t=Ms(Ue,e);Ue=t,st(),t!=="saved"&&ge&&(clearTimeout(ge),ge=null),t==="saved"&&(ge&&clearTimeout(ge),ge=setTimeout(()=>{z({type:"fade"})},us))}function ye(e,t={}){let{render:n=!0,markDirty:o=!0}=t,i=n?nt.captureRenderScrollAnchor($):null;I=e,o&&W(),n&&(Fe(),nt.restoreRenderScrollAnchor({anchor:i,container:$,blockCount:I.length}))}function Nn(e,t,n={}){let o=Dt(I,e,t);return o.changed?(ye(o.nextBlocks,n),!0):!1}function ii(e,t,n={}){let o=fn(I,e,t);return o.changed?(ye(o.nextBlocks,n),!0):!1}function be(e,t,n={}){let o=co(I,e,t);o.changed&&ye(o.nextBlocks,n)}function Hs(e,t={}){return uo((n,o)=>Le(n,o),e,t)}function Cs(){ve&&clearTimeout(ve),de&&(clearTimeout(de),de=null),ve=setTimeout(()=>{ri()},cs)}async function ri(){if(!(!ce||Ue==="saving"||Ue==="conflict")){if(D==="project"&&!Y){console.warn("Auto-save skipped: project data not loaded");return}ae&&ae.abort(),ae=new AbortController,z({type:"save_start"});try{let e=pt(I),t;if(D==="about")t=await fetch("/api/save-about",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({markdown:e,base_revision:Ve}),signal:ae.signal});else{let o=$n(e);t=await fetch("/api/save-project",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o),signal:ae.signal})}if(t.status===409){z({type:"conflict"}),ei();return}if(!t.ok)throw new Error(`Save failed: ${t.status}`);let n=await t.json();Un(n),ce=!1,z({type:"save_ok"})}catch(e){if(e instanceof Error&&e.name==="AbortError")return;console.error("Auto-save error:",e),z({type:"save_error"}),de=setTimeout(()=>{Ue==="error"&&ce&&ri()},ds)}}}function Ps(e){return e.type==="row"?`row:${e.id}:${e.left.type}:${e.left.id}:${e.right.type}:${e.right.id}`:`${e.type}:${e.id}`}function zo(e){return e.map(Ps).join("|")}function Bs(){let e=document.activeElement;if(!(e instanceof HTMLTextAreaElement||e instanceof HTMLInputElement))return null;let t=e.closest(".block-wrapper");if(!t)return null;let n=Number.parseInt(t.dataset.blockIndex??"",10);if(Number.isNaN(n))return null;let o=e.closest(".text-block-line"),i=o?Number.parseInt(o.dataset.lineIndex??"",10):Number.NaN,r=Number.isNaN(i)?null:i;return{blockIndex:n,lineIndex:r,inputClass:e.className||"",selectionStart:e.selectionStart??0,selectionEnd:e.selectionEnd??0}}function Ko(e){if(!e||!$)return;let t=$.querySelector(`.block-wrapper[data-block-index="${e.blockIndex}"]`);if(!t)return;if(e.lineIndex!==null){let s=t.querySelector(`.text-block-line[data-line-index="${e.lineIndex}"]`);s&&!s.classList.contains("is-editing")&&s.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0}))}let n=null;if(e.lineIndex!==null&&(n=t.querySelector(`.text-block-line[data-line-index="${e.lineIndex}"] .text-line-input`)),!n&&e.inputClass.trim()){let s=e.inputClass.split(/\s+/).filter(Boolean).map(l=>`.${l}`).join("");s&&(n=t.querySelector(s))}if(n||(n=t.querySelector('textarea, input[type="text"], input[type="url"]')),!n)return;n.focus({preventScroll:!0});let o=n.value.length,i=Math.max(0,Math.min(o,e.selectionStart)),r=Math.max(0,Math.min(o,e.selectionEnd));n.selectionStart=i,n.selectionEnd=r}function Is(e){let t=I,n=Bs();V.deselect();let o=zo(t),i=zo(e);if(I=e,!$||o!==i){Fe(),Ko(n);return}let r=!1;for(let s=0;s<e.length;s+=1){let l=t[s],a=e[s];if(!l||!a){r=!0;break}if(JSON.stringify(l)===JSON.stringify(a))continue;let c=$.querySelector(`.block-wrapper[data-block-index="${s}"]`);if(!c){r=!0;break}let d=c.querySelector(":scope > .block-content");if(!d){r=!0;break}c.dataset.blockId=a.id,c.dataset.blockType=a.type,d.innerHTML="",d.appendChild(Kt(a,{index:s}));let f=a.type!=="divider"&&a.type!=="code"&&a.type!=="row",S=c.querySelector(":scope > .block-align-toolbar");if(f){let h=si(a,{index:s});S?S.replaceWith(h):c.appendChild(h)}else S?.remove()}r?Fe():Tt(null),Ko(n)}function Fe(){if(!$)return;V.deselect(),Tt(null);let e=$;e.innerHTML="",e.appendChild(Go(0,"top")),I.forEach((t,n)=>{n>0&&e.appendChild(zs(n)),e.appendChild(_s(t,n))}),I.length>0&&e.appendChild(Go(I.length,"bottom"))}function _s(e,t){let n=document.createElement("div");n.className="block-wrapper",n.dataset.blockIndex=String(t),n.dataset.blockId=e.id,n.dataset.blockType=e.type;let o=document.createElement("div");o.className="block-handle",o.innerHTML=ie.dragHandle,o.draggable=!0,o.addEventListener("dragstart",s=>Ks(s,t)),o.addEventListener("dragend",ci),n.appendChild(o);let i=document.createElement("div");i.className="block-content",i.appendChild(Kt(e,{index:t})),n.appendChild(i),e.type!=="divider"&&e.type!=="code"&&e.type!=="row"&&n.appendChild(si(e,{index:t}));let r=document.createElement("button");return r.className="block-delete-btn",r.innerHTML=ie.delete,r.title="Delete block",r.addEventListener("click",()=>ui(t)),n.appendChild(r),n.addEventListener("dragover",s=>Xs(s,t)),n.addEventListener("dragleave",Ys),n.addEventListener("drop",s=>Js(s,t)),n}function si(e,t){let n=document.createElement("div");n.className="block-align-toolbar";let o=("align"in e?e.align:"left")||"left";return[{value:"left",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg>',title:"Align left"},{value:"center",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/></svg>',title:"Align center"},{value:"right",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="6" y1="18" x2="21" y2="18"/></svg>',title:"Align right"}].forEach(({value:r,icon:s,title:l})=>{let a=document.createElement("button");a.className="block-align-btn"+(o===r?" active":""),a.innerHTML=s,a.title=l,a.type="button",a.addEventListener("click",c=>{c.stopPropagation(),Ds(t,r)}),n.appendChild(a)}),n}function Ds(e,t){ii(e,n=>"align"in n?{...n,align:t}:n)}function Kt(e,t){switch(e.type){case"text":return Xo(e,t);case"image":return As(e,t);case"video":return Ns(e,t);case"code":return js(e,t);case"html":return Os(e,t);case"callout":return $s(e,t);case"row":return Us(e,t.index);case"divider":return Fs();default:return Xo(e,t)}}function Xo(e,t){let n=document.createElement("div");return n.className="text-block-wrapper",n.appendChild(Rs(e,t)),n}function Rs(e,t){let n=document.createElement("div");n.className="text-block-lines",e.align&&(n.style.textAlign=e.align);let o=(e.content||"").split(`
`);o.length||(o=[""]);let i=null,r=!1,s=!t.rowSide,l=(m,u)=>{if(u<0)return null;let w=new Set;for(let p=0;p<=u;p+=1){let H=(p===u?m:o[p]??"").match(/^(\s*)(#{1,6})\s+(.*)$/);if(!H)continue;let v=document.createElement("span");v.appendChild($e(H[3]??""));let y=$t(v.textContent?.trim()??"");if(!y)continue;let k=Ut(y,w);if(p===u)return k}return null},a=(m,u,w)=>Math.max(u,Math.min(w,m)),c=(m,u)=>{let w=[u];for(let p=0;p<m.length;p++)w.push(u+p+1);return w},d=(m,u)=>{u.length&&(m[m.length-1]=u[0]??m[m.length-1]??0,u.length>1&&m.push(...u.slice(1)))},f=(m,u,w=0)=>{let p=[u];if(!m)return p;if(w>=8)return d(p,c(m,u)),p;let x=0;for(;x<m.length;){let H=m.slice(x),v=_n(H);if(!v){d(p,c(H,u+x));break}if(v.index>0){let kt=H.slice(0,v.index);d(p,c(kt,u+x))}let y=x+v.index,k=u+y,R=H.slice(v.index,v.index+v.length),O=R.indexOf(v.content);if(O<0){d(p,c(R,k)),x=y+v.length;continue}let K=k+O,re=v.tagName==="code"?c(v.content,K):f(v.content,K,w+1);d(p,re),x=y+v.length}return p},S=(m,u)=>{if(!m)return[0];if(u==="divider")return[m.length];let w=0;if(u?.startsWith("heading-")){let k=m.match(/^(\s*)(#{1,6})\s+/);k&&(w=k[0].length)}else if(u==="quote"){let k=m.match(/^(\s*)>\s+/);k&&(w=k[0].length)}let p=m.slice(w),x=[w],H=/\[([^\]]+)\]\(([^)]+)\)/g,v=0,y;for(;(y=H.exec(p))!==null;){let k=y.index;if(k>v){let re=p.slice(v,k);d(x,f(re,w+v))}let R=y[0]??"",O=y[1]??"",K=y[2]??"";Dn(K)?d(x,f(O,w+k+1)):d(x,c(R,w+k)),v=k+R.length}if(v<p.length){let k=p.slice(v);d(x,f(k,w+v))}return x},h=(m,u)=>{let w=m.ownerDocument,p=u.clientX,x=u.clientY,H=null,v=0;if(typeof w.caretPositionFromPoint=="function"){let k=w.caretPositionFromPoint(p,x);k&&(H=k.offsetNode,v=k.offset)}if(!H&&typeof w.caretRangeFromPoint=="function"){let k=w.caretRangeFromPoint(p,x);k&&(H=k.startContainer,v=k.startOffset)}if(!H||H!==m&&!m.contains(H))return null;let y=w.createRange();y.selectNodeContents(m);try{y.setEnd(H,v)}catch{return null}return y.toString().length},b=(m,u)=>{let w=m.querySelector(".text-line-input"),p=m.querySelector(".text-block-line-preview");if(!w||!p)return null;let x=h(p,u);if(x===null)return null;let H=S(w.value,m.dataset.lineType);if(!H.length)return null;let v=a(x,0,H.length-1);return H[v]??w.value.length},g=(m,u,w)=>{if(u!==m&&!m.contains(u))return null;let p=m.ownerDocument.createRange();p.selectNodeContents(m);try{p.setEnd(u,w)}catch{return null}return p.toString().length},E=m=>{let u=m.querySelector(".text-line-input"),w=m.querySelector(".text-block-line-preview");if(!u||!w)return null;let p=window.getSelection();if(!p||p.rangeCount===0||p.isCollapsed)return null;let x=null,H=null;for(let R=0;R<p.rangeCount;R+=1){let O=p.getRangeAt(R);try{if(!O.intersectsNode(w))continue}catch{continue}let K=g(w,O.startContainer,O.startOffset),re=g(w,O.endContainer,O.endOffset);if(!(K===null||re===null)){x=Math.min(K,re),H=Math.max(K,re);break}}if(x===null||H===null||x===H)return null;let v=S(u.value,m.dataset.lineType);if(!v.length)return null;let y=v[a(x,0,v.length-1)]??u.value.length,k=v[a(H,0,v.length-1)]??u.value.length;return y===k?null:{start:Math.min(y,k),end:Math.max(y,k)}},T=m=>{let u=window.getSelection();if(!u||u.rangeCount===0||u.isCollapsed)return!1;for(let w=0;w<u.rangeCount;w+=1){let p=u.getRangeAt(w);try{if(p.intersectsNode(m))return!0}catch{}}return!1},M=()=>{let m=o.join(`
`);ii(t,u=>u.type==="text"?{...u,content:m}:u,{render:!1})},C=(m,u)=>{let w=Number.parseInt(m.dataset.lineIndex??"",10);Number.isNaN(w)||w<0||w>=o.length||(o[w]=u.value,M(),We(m),W())},B=(m=null,u=null)=>{Me?.textarea&&n.contains(Me.textarea)&&Tt(null),n.innerHTML="";let w=new Set;if(o.forEach((p,x)=>{let H=U(p,x,w);n.appendChild(H)}),requestAnimationFrame(()=>{n.querySelectorAll(".text-block-line").forEach(p=>{We(p)})}),m!==null){let p=n.querySelector(`.text-block-line[data-line-index="${m}"]`);p&&ue(p,u)}},U=(m,u,w)=>{let p=document.createElement("div");p.className="text-block-line",p.dataset.lineIndex=String(u);let x=document.createElement("div");if(x.className="text-block-line-preview",o.length===1&&!o[0]?.trim())p.dataset.lineType="empty",x.classList.add("text-block-line-placeholder"),x.textContent="Type something... (type / for commands)";else{let y=Yo(m,w);p.dataset.lineType=y.type,x.appendChild(y.node)}let v=document.createElement("textarea");return v.className="text-line-input",v.value=m,v.rows=1,v.placeholder="Type something... (type / for commands)",x.addEventListener("mouseup",y=>{if(p.classList.contains("is-editing"))return;let k=E(p);k&&(r=!0,y.stopPropagation(),ue(p,k))}),x.addEventListener("click",y=>{if(r){r=!1,y.preventDefault(),y.stopPropagation();return}if(T(x)){y.stopPropagation();return}y.preventDefault(),y.stopPropagation(),ue(p,b(p,y))}),p.addEventListener("click",y=>{if(r){r=!1,y.preventDefault(),y.stopPropagation();return}T(p)||p.classList.contains("is-editing")||(y.preventDefault(),y.stopPropagation(),ue(p))}),v.addEventListener("input",()=>{let y=v.value;if(s&&oe.handleTextareaInput(v,t.index),y.includes(`
`)){let O=y.split(`
`);o.splice(u,1,...O),M();let K=O[O.length-1]??"";B(u+O.length-1,K.length);return}let k=Number.parseInt(p.dataset.lineIndex??"",10),R=Number.isNaN(k)?u:k;o[R]=y,M(),We(p),j()}),v.addEventListener("keydown",y=>{if(!(s&&oe.isActive()&&oe.handleKeydown(y))){if((y.metaKey||y.ctrlKey)&&y.key==="k"){y.preventDefault(),ut(v,$,()=>{let k=Number.parseInt(p.dataset.lineIndex??"",10),R=Number.isNaN(k)?u:k;o[R]=v.value,M(),W(),j()});return}if(nn(y,v,W,$)){let k=Number.parseInt(p.dataset.lineIndex??"",10),R=Number.isNaN(k)?u:k;o[R]=v.value,M(),We(p),j();return}if(!sn(y,v,W)){if(y.key==="Enter"&&!y.shiftKey&&!y.metaKey&&!y.ctrlKey){y.preventDefault(),xt(v,u);return}if(y.key==="Backspace"&&v.selectionStart===0&&v.selectionEnd===0){u>0&&(y.preventDefault(),Gt(u));return}if(y.key==="Delete"&&v.selectionStart===v.value.length&&v.selectionEnd===v.value.length){u<o.length-1&&(y.preventDefault(),Li(u));return}if(y.key==="ArrowLeft"&&!y.shiftKey&&!y.metaKey&&!y.ctrlKey&&!y.altKey&&v.selectionStart===0&&v.selectionEnd===0){u>0&&(y.preventDefault(),B(u-1,o[u-1]?.length??0));return}if(y.key==="ArrowRight"&&!y.shiftKey&&!y.metaKey&&!y.ctrlKey&&!y.altKey&&v.selectionStart===v.value.length&&v.selectionEnd===v.value.length){u<o.length-1&&(y.preventDefault(),B(u+1,0));return}if(y.key==="ArrowUp"&&v.selectionStart===0&&v.selectionEnd===0){u>0&&(y.preventDefault(),B(u-1,o[u-1]?.length??0));return}y.key==="ArrowDown"&&v.selectionStart===v.value.length&&v.selectionEnd===v.value.length&&u<o.length-1&&(y.preventDefault(),B(u+1,0))}}}),v.addEventListener("blur",()=>{i===u&&qe(p)}),v.addEventListener("select",j),v.addEventListener("keyup",j),v.addEventListener("mouseup",j),p.appendChild(x),p.appendChild(v),p},ue=(m,u=null)=>{let w=Number(m.dataset.lineIndex);if(i!==null&&i!==w){let x=n.querySelector(`.text-block-line[data-line-index="${i}"]`);x&&qe(x)}i=w,m.classList.add("is-editing");let p=m.querySelector(".text-line-input");p&&(p.focus({preventScroll:!0}),u&&typeof u=="object"?(p.selectionStart=u.start,p.selectionEnd=u.end??u.start):typeof u=="number"?(p.selectionStart=u,p.selectionEnd=u):p.selectionStart=p.selectionEnd=p.value.length,Tt({textarea:p,row:m,onEdit:()=>{C(m,p)}}),j(),We(m))},qe=m=>{let u=m.querySelector(".text-line-input"),w=m.querySelector(".text-block-line-preview"),p=Number.parseInt(m.dataset.lineIndex??"",10);m.classList.remove("is-editing");let x=u?.value??"";if(w?.classList.remove("text-block-line-placeholder"),w&&(w.innerHTML=""),o.length===1&&!o[0]?.trim()&&!x.trim())m.dataset.lineType="empty",w?.classList.add("text-block-line-placeholder"),w&&(w.textContent="Type something... (type / for commands)");else if(w){let v=new Set;if(!Number.isNaN(p))for(let R=0;R<p;R+=1){let K=(o[R]??"").match(/^(\s*)(#{1,6})\s+(.*)$/);if(!K)continue;let re=document.createElement("span");re.appendChild($e(K[3]??""));let kt=$t(re.textContent?.trim()??"");kt&&Ut(kt,v)}let y=Yo(x,v),k=Number.isNaN(p)?null:l(x,p);k&&y.node instanceof HTMLElement&&/^H[1-6]$/.test(y.node.tagName)&&(y.node.id=k),m.dataset.lineType=y.type,w.appendChild(y.node)}Me?.textarea===u&&Tt(null),i=null,We(m)},xt=(m,u)=>{let w=m.value,p=m.selectionStart,x=w.slice(0,p),H=w.slice(p),v=Ti(x);o[u]=x;let y=v?v+H.replace(/^\s+/,""):H;o.splice(u+1,0,y),M();let k=v?v.length:0;B(u+1,k)},Gt=m=>{if(m<=0)return;let u=o[m-1]??"",w=o[m]??"",p=u+w;o.splice(m-1,2,p),M(),B(m-1,u.length)},Li=m=>{if(m>=o.length-1)return;let u=o[m]??"",w=o[m+1]??"",p=u+w;o.splice(m,2,p),M(),B(m,u.length)},We=m=>{let u=m.querySelector(".text-block-line-preview"),w=m.querySelector(".text-line-input");requestAnimationFrame(()=>{let p=u?.offsetHeight??0,x=w?.scrollHeight??0,H=Math.max(27,p);m.style.minHeight=`${H}px`,m.classList.contains("is-editing")?m.style.height=`${Math.max(H,x)}px`:m.style.height=""})},Ti=m=>{let u=m.match(/^(\s*)([-*+])\s+/);if(u)return`${u[1]??""}${u[2]??"-"} `;let w=m.match(/^(\s*)(\d+)\.\s+/);if(w){let p=parseInt(w[2]??"1",10)+1;return`${w[1]??""}${p}. `}return null};return n.addEventListener("click",m=>{if(m.target!==n)return;let u=Array.from(n.querySelectorAll(".text-block-line"));if(!u.length)return;let w=m.clientY,p=null,x=1/0;for(let H of u){let v=H.getBoundingClientRect(),y=v.top+v.height/2,k=Math.abs(w-y);k<x&&(x=k,p=H)}p&&!p.classList.contains("is-editing")&&(m.preventDefault(),ue(p))}),B(),n}function Yo(e,t){let n=e.trim();if(!n){let s=document.createElement("span");return s.innerHTML="&nbsp;",{node:s,type:"empty"}}if(/^(\*{3,}|-{3,}|_{3,})$/.test(n)){let s=document.createElement("hr");return s.className="text-line-divider",{node:s,type:"divider"}}let o=e.match(/^(\s*)(#{1,6})\s+(.*)$/);if(o){let s=o[2]?.length??1,l=document.createElement(`h${s}`);l.appendChild($e(o[3]??""));let a=$t(l.textContent?.trim()??"");return a&&(l.id=Ut(a,t)),{node:l,type:`heading-${s}`}}let i=e.match(/^(\s*)>\s+(.*)$/);if(i){let s=document.createElement("blockquote");return s.appendChild($e(i[2]??"")),{node:s,type:"quote"}}if(/^(\s*)([-*+]|\d+\.)\s+/.test(e)){let s=document.createElement("span");return s.appendChild($e(e)),{node:s,type:"list"}}let r=document.createElement("span");return r.appendChild($e(e)),{node:r,type:"paragraph"}}function Fn(e,t){let n=document.createElement("input");return n.type="text",n.className="media-caption-input",n.placeholder="Caption (optional)...",n.value=e||"",n.addEventListener("input",()=>{be(t,{caption:n.value},{render:!1})}),n}function Jo(e,t){let n=(t??"").trim();if(!n){e.poster="",e.removeAttribute("poster");return}e.poster=n,e.setAttribute("poster",n)}function As(e,t){let n=document.createElement("div");if(n.className="image-block-wrapper",e.src){let o=Qt(e,r=>{V.select(r,e)});o.className="block-image",n.appendChild(o);let i=document.createElement("input");i.type="text",i.className="image-alt-input",i.placeholder="Image description...",i.value=e.alt||"",i.addEventListener("input",()=>{be(t,{alt:i.value},{render:!1})}),n.appendChild(i),n.appendChild(Fn(e.caption,t))}else n.appendChild(ai(t,"image"));return n}function Ns(e,t){let n=document.createElement("div");if(n.className="video-block-wrapper",e.src){let o=en(e,B=>{V.select(B,e)});o.className="block-video",n.appendChild(o);let i=document.createElement("div");i.className="video-poster-controls";let r=document.createElement("label");r.className="video-option-row";let s=document.createElement("input");s.type="checkbox",s.className="video-option-checkbox",s.checked=!!e.autoplay,r.appendChild(s);let l=document.createElement("span");l.className="video-option-label",l.textContent="Autoplay (muted loop)",r.appendChild(l);let a=document.createElement("input");a.type="url",a.className="video-poster-input",a.placeholder="Poster image URL (optional)...",a.value=e.poster||"";let c=document.createElement("div");c.className="video-poster-actions";let d=document.createElement("button");d.type="button",d.className="edit-btn-small video-poster-action",d.textContent="Upload poster",c.appendChild(d);let f=document.createElement("button");f.type="button",f.className="edit-btn-small video-poster-action",f.textContent="Use current frame",c.appendChild(f);let S=document.createElement("button");S.type="button",S.className="edit-btn-small video-poster-action",S.textContent="Clear",c.appendChild(S);let h=document.createElement("input");h.type="file",h.accept="image/*",h.className="video-poster-upload-input",h.hidden=!0;let b=!1,g=(e.poster||"").trim(),E=()=>{let B=s.checked;i.classList.toggle("poster-fields-hidden",B),a.disabled=B||b,d.disabled=B||b,f.disabled=B||b,S.disabled=B||b};s.addEventListener("change",()=>{let B=s.checked;Mt(o,B),be(t,{autoplay:B},{render:!1}),E()});let T=B=>{let U=B.trim();g&&g!==U&&po(g)&&mt(J,g),g=U,Jo(o,U),be(t,{poster:U},{render:!1}),S.hidden=U.length===0,a.value!==U&&(a.value=U)},M=B=>{b=B,E()};a.addEventListener("input",()=>{T(a.value)}),d.addEventListener("click",()=>{b||h.click()}),h.addEventListener("change",async()=>{let B=h.files?.[0];if(h.value="",!(!B||b)){M(!0);try{let U=await V.uploadPosterForVideo(B);T(U),L("Poster uploaded!","success")}catch(U){L(U instanceof Error?U.message:"Poster upload failed","error")}finally{M(!1)}}}),f.addEventListener("click",async()=>{if(!b){M(!0);try{let B=await V.capturePosterFromVideo(o);T(B),L("Poster captured from frame!","success")}catch(B){L(B instanceof Error?B.message:"Frame capture failed","error")}finally{M(!1)}}}),S.addEventListener("click",()=>{b||T("")});let C=(e.poster||"").trim();Jo(o,C),g=C,S.hidden=C.length===0,a.value!==C&&(a.value=C),E(),i.appendChild(r),i.appendChild(a),i.appendChild(c),i.appendChild(h),n.appendChild(i),n.appendChild(Fn(e.caption,t))}else n.appendChild(ai(t,"video"));return n}function js(e,t){let n=document.createElement("div");n.className="code-block-wrapper";let o=document.createElement("select");o.className="code-language-select",["javascript","python","html","css","bash","json","sql","go","rust","text"].forEach(s=>{let l=document.createElement("option");l.value=s,l.textContent=s,s===(e.language||"javascript")&&(l.selected=!0),o.appendChild(l)}),o.addEventListener("change",()=>{be(t,{language:o.value},{render:!1})}),n.appendChild(o);let r=document.createElement("textarea");return r.className="code-textarea",r.value=e.code||"",r.placeholder="Enter code...",r.spellcheck=!1,at(r,s=>{be(t,{code:s},{render:!1})}),r.addEventListener("keydown",s=>{s.key==="Tab"&&(s.preventDefault(),ne(r,"    "),r.dispatchEvent(new Event("input",{bubbles:!0})))}),n.appendChild(r),n}function $s(e,t){let n=document.createElement("div");n.className="callout-block-wrapper";let o=document.createElement("textarea");return o.className="callout-textarea",o.value=e.content||"",o.placeholder="Callout content...",e.align&&(o.style.textAlign=e.align),at(o,i=>{be(t,{content:i},{render:!1})}),n.appendChild(o),n}function Us(e,t){let n=document.createElement("div");n.className="row-block-wrapper";let o=document.createElement("div");o.className="row-toolbar";let i=document.createElement("button");i.className="row-action-btn row-action-btn-split",i.type="button",i.innerHTML=ie.split,i.title="Split columns into blocks",i.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation(),Ws(t)}),o.appendChild(i);let r=document.createElement("button");r.className="row-action-btn",r.type="button",r.innerHTML=ie.swap,r.title="Swap column sides",r.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation(),qs(t)}),o.appendChild(r),n.appendChild(o);let s=document.createElement("div");s.className="row-columns";let l=document.createElement("div");l.className="row-column row-column-left",l.appendChild(Kt(e.left,{index:t,rowSide:"left"}));let a=document.createElement("div");return a.className="row-column row-column-right",a.appendChild(Kt(e.right,{index:t,rowSide:"right"})),s.appendChild(l),s.appendChild(a),n.appendChild(s),n}function Fs(){let e=document.createElement("div");return e.className="block-divider",e.innerHTML=ie.divider,e}function Os(e,t){let n=document.createElement("div");n.className="html-block-wrapper",e.align&&(n.style.textAlign=e.align);let o=document.createElement("div");o.className="html-block-preview-container",n.appendChild(o);let i=null,r=null,s=!1,l=!1,a=document.createElement("div");a.className="html-block-controls";let c=document.createElement("button");c.className="html-toggle-btn",c.textContent="Edit HTML",c.type="button",a.appendChild(c);let d=document.createElement("button");d.className="html-toggle-btn",d.textContent="Interact",d.type="button",a.appendChild(d);function f(){r&&(r.style.display=l?"none":"block"),d.classList.toggle("is-active",l),d.textContent=l?"Resize":"Interact",d.disabled=s||!i,d.style.display=s?"none":""}function S(g){if(i&&(ao(i),i.remove(),i=null),!g.trim()){i=null,r=null,o.innerHTML='<p class="html-block-empty">Empty HTML block</p>',f();return}o.innerHTML="",i=lo(g,{allowFullscreen:!0});let E=i,T=!!e.style&&/(^|;)\s*height\s*:/.test(e.style);E.dataset.autoHeight=T?"false":"true",so(E,e.style,e.align),o.appendChild(E),r=document.createElement("button"),r.type="button",r.className="html-block-select-overlay",r.setAttribute("aria-label","Select HTML block for resize"),r.addEventListener("click",M=>{M.preventDefault(),M.stopPropagation(),V.select(E,e)}),o.appendChild(r),f()}S(e.html||"");let h=document.createElement("textarea");h.className="html-textarea",h.value=e.html||"",h.placeholder="Enter raw HTML...",h.style.display="none";let b=Fn(e.caption,t);return n.appendChild(h),n.appendChild(a),n.appendChild(b),c.addEventListener("click",()=>{s=!s,s?(o.style.display="none",h.style.display="block",c.textContent="Preview",l=!1,V.deselect(),f(),h.focus({preventScroll:!0})):(o.style.display="block",h.style.display="none",c.textContent="Edit HTML",S(h.value))}),d.addEventListener("click",()=>{!i||s||(l=!l,l?V.deselect():V.select(i,e),f())}),at(h,g=>{be(t,{html:g},{render:!1})}),f(),n}function li(e){let t=I[e-1],n=I[e];return!t||!n?!1:t.type!=="row"&&n.type!=="row"}function Vs(e){if(!li(e))return;let t=I[e-1],n=I[e];if(!t||!n)return;let o=Le("row",{left:t,right:n}),i=I.slice();i.splice(e-1,2,o),ye(i)}function qs(e){Nn(e,t=>t.type!=="row"?t:{...t,left:t.right,right:t.left})}function Ws(e){let t=I[e];if(!t||t.type!=="row")return;let n=I.slice();n.splice(e,1,t.left,t.right),ye(n)}function zs(e){let t=document.createElement("div");t.className="merge-divider",t.dataset.afterIndex=String(e);let n=document.createElement("button");if(n.className="merge-add-btn",n.innerHTML="+",n.title="Add block",n.addEventListener("click",()=>{let o=n.getBoundingClientRect();oe.showFromButton(o,e,n)}),t.appendChild(n),li(e)){let o=document.createElement("button");o.className="merge-columns-btn",o.type="button",o.innerHTML=ie.columns,o.title="Turn these two blocks into columns",o.addEventListener("click",()=>{Vs(e)}),t.appendChild(o)}return t}function Go(e,t="bottom"){let n=document.createElement("div");n.className=`add-block-wrapper add-block-wrapper-${t}`;let o=document.createElement("button");return o.className="merge-add-btn",o.innerHTML="+",o.title="Add block",o.addEventListener("click",()=>{let i=o.getBoundingClientRect();oe.showFromButton(i,e,o)}),n.appendChild(o),n}function ai(e,t){let n=document.createElement("div");n.className="upload-zone";let o=t==="video";n.innerHTML=`
    <div class="upload-icon">${o?ie.video:ie.image}</div>
    <div class="upload-text">Drop ${t} here or click to upload</div>
    ${o?`<div class="upload-zone-progress" hidden>
        <div class="upload-zone-progress-bar">
          <div class="upload-zone-progress-fill"></div>
        </div>
        <div class="upload-zone-progress-text" aria-live="polite"></div>
      </div>`:""}
    <input type="file" class="upload-input" accept="${o?"video/*":"image/*"}">
  `;let i=n.querySelector(".upload-zone-progress"),r=n.querySelector(".upload-zone-progress-fill"),s=n.querySelector(".upload-zone-progress-text"),l=!1,a=f=>{!i||!r||!s||(i.hidden=!1,r.style.width=`${Math.max(0,Math.min(100,f.progress))}%`,r.classList.toggle("is-indeterminate",f.stage==="processing"),s.textContent=f.message,n.classList.toggle("uploading",f.stage!=="error"&&f.stage!=="complete"),n.classList.toggle("upload-error",f.stage==="error"))},c=async f=>{if(!l){l=!0,n.classList.remove("upload-error");try{t==="image"?await V.handleImageUploadForBlock(f,e.index,e.rowSide):(a({stage:"uploading",progress:0,message:"Starting upload..."}),await V.handleVideoUploadForBlock(f,e.index,{rowSide:e.rowSide,onProgress:a}))}finally{l=!1,d.value="",t==="image"&&n.classList.remove("uploading")}}},d=n.querySelector(".upload-input");return d.addEventListener("change",async()=>{let f=d.files?.[0];f&&await c(f)}),n.addEventListener("click",f=>{l||f.target!==d&&d.click()}),n.addEventListener("dragover",f=>{f.preventDefault(),!l&&n.classList.add("drag-over")}),n.addEventListener("dragleave",()=>{n.classList.remove("drag-over")}),n.addEventListener("drop",async f=>{if(f.preventDefault(),l)return;n.classList.remove("drag-over");let S=f.dataTransfer?.files[0];S&&await c(S)}),n}function Ks(e,t){ee.sourceIndex=t,ee.isDragging=!0;let n=$?.querySelector(`[data-block-index="${t}"]`);n&&n.classList.add("dragging"),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",t.toString()))}function ci(){ee.isDragging=!1,ee.sourceIndex=null,ee.currentDropIndex=null,$?.querySelectorAll(".dragging, .drag-over-top, .drag-over-bottom").forEach(e=>{e.classList.remove("dragging","drag-over-top","drag-over-bottom")})}function Xs(e,t){if(e.preventDefault(),!ee.isDragging)return;let n=e.currentTarget,o=n.getBoundingClientRect(),i=o.top+o.height/2;$?.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(r=>{r.classList.remove("drag-over-top","drag-over-bottom")}),e.clientY<i?(n.classList.add("drag-over-top"),ee.currentDropIndex=t):(n.classList.add("drag-over-bottom"),ee.currentDropIndex=t+1)}function Ys(e){e.currentTarget.classList.remove("drag-over-top","drag-over-bottom")}function Js(e,t){if(e.preventDefault(),!ee.isDragging||ee.sourceIndex===null)return;let n=ee.sourceIndex,o=ee.currentDropIndex;if(o!==null){if(n<o&&o--,n!==o){let i=I.slice(),[r]=i.splice(n,1);r&&(i.splice(o,0,r),ye(i))}ci()}}function Xt(e,t,n={}){let o=Hs(t,n),i=Math.max(0,Math.min(e,I.length)),r=I.slice();r.splice(i,0,o),ye(r),(t==="text"||t==="callout")&&setTimeout(()=>{let s=$?.querySelector(`[data-block-index="${i}"] .text-line-input, [data-block-index="${i}"] .block-textarea, [data-block-index="${i}"] .callout-textarea`);s&&s.focus({preventScroll:!0})},50)}function di(e,t,n={}){let o=I.findIndex(i=>i.id===e);o!==-1&&Xt(o+1,t,n)}function ui(e){let t=I[e];if(t&&ht(J,t),I.length<=1)ye([Le("text")]);else{let n=I.slice();n.splice(e,1),ye(n)}}function Gs(e,t){if(e==="execute"){let n=t;if(n.replaceBlockIndex!==null){let o=n.replaceBlockIndex;ht(J,I[o]),Nn(o,()=>Le(n.commandId)),(n.commandId==="text"||n.commandId==="callout")&&setTimeout(()=>{let i=$?.querySelector(`[data-block-index="${o}"] .text-line-input, [data-block-index="${o}"] .block-textarea, [data-block-index="${o}"] .callout-textarea`);i&&i.focus({preventScroll:!0})},50)}else Xt(n.insertIndex,n.commandId)}else if(e==="updateContent"){let n=t;Nn(n.index,o=>"content"in o?{...o,content:n.content}:o,{render:!1,markDirty:!1})}}function pi(e){if(Oe&&!(oe.isActive()&&oe.handleKeydown(e))){if((e.metaKey||e.ctrlKey)&&!e.altKey&&e.key.toLowerCase()==="z"){e.preventDefault(),e.shiftKey?jn():hi();return}if((e.metaKey||e.ctrlKey)&&!e.altKey&&e.key.toLowerCase()==="y"){e.preventDefault(),jn();return}(e.metaKey||e.ctrlKey)&&e.key==="s"&&(e.preventDefault(),On()),e.key==="Escape"&&(e.preventDefault(),e.stopPropagation(),Vn())}}function hi(){if(mi("undo")){st();return}Ne.undo(),st(),j()}function jn(){if(mi("redo")){st();return}Ne.redo(),st(),j()}function mi(e){let t=document.activeElement;if(!(t instanceof HTMLTextAreaElement||t instanceof HTMLInputElement)||t.disabled||t.readOnly)return!1;if(t instanceof HTMLInputElement){let i=(t.type||"text").toLowerCase();if(!new Set(["text","search","url","tel","email","password"]).has(i))return!1}let n=e==="undo"?"undo":"redo";return document.execCommand(n)?(j(),!0):!1}function W(){ce=!0,Ne.saveState(),z({type:"edit"}),Cs()}async function Zs(){if(D!=="project"||J.size===0)return;let e=Array.from(J);try{let t=await fetch("/api/cleanup-assets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({urls:e}),keepalive:!0});t.ok?(J.clear(),Lt=!1):Lt||(Lt=!0,console.warn("Asset cleanup request failed:",t.status))}catch(t){Lt||(Lt=!0,console.warn("Asset cleanup request failed:",t))}}async function On(){if(!ce&&Ue!=="error"){je(window.location.pathname),rt(),window.location.reload();return}ve&&(clearTimeout(ve),ve=null),de&&(clearTimeout(de),de=null),ae&&ae.abort(),z({type:"save_start"});try{let e=pt(I),t;if(D==="about")t=await fetch("/api/save-about",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({markdown:e,base_revision:Ve})});else{let o=$n(e);t=await fetch("/api/save-project",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})}if(t.status===409){z({type:"conflict"}),ei();return}if(!t.ok)throw new Error(`Save failed: ${t.status}`);let n=await t.json();Un(n),ce=!1,z({type:"save_ok"}),je(window.location.pathname),rt(),window.location.reload()}catch(e){console.error("Save error:",e),z({type:"save_error"}),L("Failed to save","error")}}async function Vn(){ce&&!confirm("You have unsaved changes. Discard them?")||(await Zs(),je(window.location.pathname),rt(),window.location.reload())}async function Qs(){if(D!=="project"||!te)return;let t=ot()?.name||"this project";if(confirm(`Are you sure you want to delete "${t}"? This cannot be undone.`))try{await X(`/api/project/${te}`,{method:"DELETE"}),L("Project deleted","success"),rt(),window.location.href=Se("/")}catch(n){console.error("Delete project error:",n),L("Failed to delete project","error")}}function fi(e,t,n={}){be({index:e},t,n)}function ot(){return!Y||!("slug"in Y)?null:Y}function el(e,t){let n=e.querySelector(".project-header"),o=e.querySelector(".project-name"),i=e.querySelector(".project-date");if(!n||!o||!i)return;n.classList.add("edit-project-header-active"),i.innerHTML=`
    <input
      type="date"
      class="edit-project-header-date-input"
      value="${G(t.date||"")}"
      aria-label="Project date"
    >
  `,o.innerHTML=`
    <input
      type="text"
      class="edit-project-header-name-input"
      value="${G(t.name||"")}"
      aria-label="Project name"
      required
    >
  `;let r=i.querySelector(".edit-project-header-date-input"),s=o.querySelector(".edit-project-header-name-input");if(!r||!s)return;let l=a=>{a.stopPropagation()};[r,s].forEach(a=>{a.addEventListener("click",l),a.addEventListener("mousedown",l),a.addEventListener("pointerdown",l),a.addEventListener("keydown",l)}),r.addEventListener("input",()=>{t.date=r.value,W()}),s.addEventListener("input",()=>{t.name=s.value;let a=Q?.querySelector(".edit-project-name");if(a){let c=t.name.trim()||"Project";a.textContent=`Editing: ${c}`}W()})}function tl(e){let t=document.createElement("section");t.className="edit-inline-project-settings",t.innerHTML=`
    <div class="edit-inline-project-settings-grid">
      <div class="edit-form-group">
        <label for="inline-settings-slug">URL Slug</label>
        <input
          type="text"
          id="inline-settings-slug"
          value="${G(e.slug||"")}"
          pattern="[a-z0-9_\\-]+"
          required
        >
      </div>
      <div class="edit-form-group">
        <label for="inline-settings-youtube">YouTube Link</label>
        <input
          type="url"
          id="inline-settings-youtube"
          value="${G(e.youtube||"")}"
          placeholder="https://youtube.com/watch?v=..."
        >
      </div>
    </div>
    <div class="edit-form-row edit-inline-project-settings-flags">
      <label class="edit-form-checkbox">
        <input type="checkbox" id="inline-settings-draft" ${e.draft?"checked":""}>
        <span>Draft</span>
      </label>
      <label class="edit-form-checkbox">
        <input type="checkbox" id="inline-settings-pinned" ${e.pinned?"checked":""}>
        <span>Pinned</span>
      </label>
    </div>
  `;let n=t.querySelector("#inline-settings-slug"),o=t.querySelector("#inline-settings-youtube"),i=t.querySelector("#inline-settings-draft"),r=t.querySelector("#inline-settings-pinned");return n?.addEventListener("input",()=>{e.slug=n.value,W()}),o?.addEventListener("input",()=>{e.youtube=o.value.trim(),W()}),i?.addEventListener("change",()=>{e.draft=i.checked,W()}),r?.addEventListener("change",()=>{e.pinned=r.checked,W()}),t}function Zo(e=null){if(D!=="project"||!te)return;let t=ot();t&&Vt.showVideoEditor(te,{file:e,projectData:t,onVideoSaved:n=>{let o=t.video||{};for(let i of["hls","thumbnail","spriteSheet"]){let r=o[i],s=n[i];r&&r!==s&&mt(J,r)}t.video={...n},xe?.refreshState?.(),W()}})}function nl(e){let t=document.createElement("div");t.className="edit-hero-thumbnail-controls";let n=e.video?.thumbnail||"";t.innerHTML=`
    <div class="edit-hero-media-grid">
      <div class="edit-hero-video-panel">
        <div class="edit-hero-video-header">
          <span class="edit-hero-panel-label">Hero Video</span>
          <span class="edit-hero-video-status"></span>
        </div>
        <div class="edit-hero-video-buttons">
          <button type="button" class="edit-btn-small" data-action="update-sprite">Update Sprite</button>
          <button type="button" class="edit-btn-small" data-action="replace-video">Replace</button>
        </div>
        <input type="file" class="edit-hero-video-file" accept="video/*" style="display: none;">
      </div>
      <div class="edit-hero-thumbnail-panel">
        <div class="edit-hero-thumbnail-header">
          <span class="edit-hero-panel-label">Thumbnail</span>
        </div>
        <div class="edit-hero-thumbnail-content">
          <img class="edit-hero-thumbnail-preview" src="${G(n)}"
              alt="Thumbnail" style="${n?"":"display:none"}">
          <div class="edit-hero-thumbnail-actions">
            <input type="url" class="edit-hero-thumbnail-input"
                placeholder="Thumbnail image URL..."
                value="${G(n)}">
            <div class="edit-hero-thumbnail-buttons">
              <button type="button" class="edit-btn-small" data-action="upload">Upload</button>
              <button type="button" class="edit-btn-small" data-action="capture">Use current frame</button>
              <button type="button" class="edit-btn-small" data-action="clear" style="${n?"":"display:none"}">Clear</button>
            </div>
            <input type="file" class="edit-hero-thumbnail-file" accept="image/*" style="display: none;">
          </div>
        </div>
      </div>
    </div>
  `;let o=t.querySelector(".edit-hero-video-status"),i=t.querySelector('[data-action="update-sprite"]'),r=t.querySelector('[data-action="replace-video"]'),s=t.querySelector(".edit-hero-video-file"),l=t.querySelector(".edit-hero-thumbnail-input"),a=t.querySelector(".edit-hero-thumbnail-preview"),c=t.querySelector('[data-action="upload"]'),d=t.querySelector('[data-action="capture"]'),f=t.querySelector('[data-action="clear"]'),S=t.querySelector(".edit-hero-thumbnail-file"),h=()=>{let T=ot()?.video?.thumbnail?.trim()||"";l.value=T,T?(a.src=T,a.style.display="",f.style.display=""):(a.style.display="none",f.style.display="none")},b=()=>{let T=ot()?.video?.hls?.trim()||"",M=T.length>0;o.textContent=M?`Current: ${T.split("/").pop()}`:"No hero video yet",i.disabled=!M,r.textContent=M?"Replace":"Upload Hero Video",d.disabled=!M,h()};t.refreshState=b,b();let g=E=>{let T=ot();if(!T)return;T.video||(T.video={});let M=E||void 0,C=T.video.thumbnail;C&&C!==M&&mt(J,C),T.video.thumbnail=M,W(),h()};return i.addEventListener("click",()=>{if(!ot()?.video?.hls){L("No existing hero video found for this project.","error");return}Zo()}),r.addEventListener("click",()=>s.click()),s.addEventListener("change",()=>{let E=s.files?.[0];if(E){if(!E.type.startsWith("video/")){L("Please select a video file","error"),s.value="";return}Zo(E),s.value=""}}),l.addEventListener("change",()=>{g(l.value.trim()||null)}),l.addEventListener("blur",()=>{g(l.value.trim()||null)}),c.addEventListener("click",()=>S.click()),S.addEventListener("change",async()=>{let E=S.files?.[0];if(E){if(!E.type.startsWith("image/")){L("Please select an image file","error");return}try{c.disabled=!0,c.textContent="Uploading...",L("Uploading thumbnail...","info");let T=await Hn(E);g(T),L("Thumbnail uploaded!","success")}catch(T){L(`Upload failed: ${T.message}`,"error")}finally{c.disabled=!1,c.textContent="Upload",S.value=""}}}),d.addEventListener("click",async()=>{let T=t.closest(".project-item")?.querySelector(".video-container video");if(!T){L("No video element found","error");return}if(T.readyState<2){L("Video not ready yet. Please wait for it to load.","info");return}try{d.disabled=!0,d.textContent="Capturing...";let M=await Cn(T);g(M),L("Thumbnail captured!","success")}catch(M){L(`Capture failed: ${M.message}`,"error")}finally{d.disabled=!1,d.textContent="Use current frame",b()}}),f.addEventListener("click",()=>{g(null),L("Thumbnail cleared","info")}),t}var ol={init:ms,initAbout:fs,cleanup:rt,get blocks(){return I},get isActive(){return Oe},get isDirty(){return ce},get projectSlug(){return te},get editMode(){return D},insertBlock:Xt,insertBlockAfter:di,deleteBlock:ui,updateBlock:fi,renderBlocks:Fe,markDirty:W,save:On,cancel:Vn},gi=ol;var vi="bb_show_drafts",il=["/static/css/edit-mode-base.css","/static/css/edit-mode-settings.css","/static/css/edit-mode-extras.css"],rl='<svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',sl='<svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>',ll='<svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',Yt=null,yi=!1,Jt=null;function qn(){return document.body.dataset.isolationMode==="true"}function Wn(e,t={}){let n=new URL(e,window.location.origin);return Object.entries(t).forEach(([o,i])=>{i!=null&&n.searchParams.set(o,i)}),Ee()&&n.searchParams.set("show_drafts","true"),n.toString()}function zn(){il.forEach(e=>{if(Array.from(document.querySelectorAll('link[rel="stylesheet"]')).some(o=>{let i=o.getAttribute("href")||"";return i===e||i.endsWith(e)}))return;let n=document.createElement("link");n.rel="stylesheet",n.href=e,document.head.appendChild(n)})}function Ce(){return new Promise(e=>{zn(),e()})}function bi(e){let t=e.dataset.slug;if(!t||e.dataset.editHandlersAttached==="true")return;e.dataset.editHandlersAttached="true",e.querySelectorAll(".edit-project-btn").forEach(o=>{o.dataset.action==="edit"&&o.addEventListener("click",async r=>{if(r.preventDefault(),r.stopPropagation(),!qn()){let s=Wn(`/${t}`,{edit:""});je(new URL(s).pathname,".project-item.active .project-content"),window.location.href=s;return}window.EditMode||await Ce(),window.EditMode?.init(t)})})}function al(){let e=document.querySelector("#main-header"),t=e?.querySelector("nav");if(!e||!t)return;let n=()=>{t.classList.remove("compact-edit-actions"),t.querySelector(".new-project-btn, .show-drafts-toggle")&&e.scrollWidth>e.clientWidth+1&&t.classList.add("compact-edit-actions")},o=()=>{Jt!==null&&cancelAnimationFrame(Jt),Jt=requestAnimationFrame(()=>{Jt=null,n()})};o(),yi||(window.addEventListener("resize",o,{passive:!0}),yi=!0),typeof ResizeObserver<"u"&&(Yt?.disconnect(),Yt=new ResizeObserver(o),Yt.observe(e),Yt.observe(t))}function cl(){let e=document.querySelector("#main-header nav");if(!e||e.querySelector(".new-project-btn"))return;let t=window.location.pathname==="/me",n=t?"Edit":"New Project",o=t?sl:rl,i=document.createElement("button");i.type="button",i.className="new-project-btn",i.title=n,i.setAttribute("aria-label",n),i.innerHTML=`${o}<span class="btn-label">${n}</span>`,i.addEventListener("click",async r=>{r.preventDefault(),t?(window.EditMode||await Ce(),window.EditMode&&window.EditMode.initAbout()):(window.ProjectCreate||await Ce(),window.ProjectCreate?.show())}),e.insertBefore(i,e.firstChild)}function dl(){if(window.location.pathname!=="/")return;let e=document.querySelector("#main-header nav");if(!e||e.querySelector(".show-drafts-toggle"))return;let t=Ee(),n=document.createElement("button");n.type="button",n.className="show-drafts-toggle"+(t?" active":""),n.title="Drafts",n.setAttribute("aria-label",t?"Hide drafts":"Show drafts"),n.innerHTML=`${ll}<span class="btn-label">Drafts</span>`,n.addEventListener("click",i=>{i.preventDefault();let r=new URL(window.location.href);t?(r.searchParams.delete("show_drafts"),sessionStorage.removeItem(vi)):(r.searchParams.set("show_drafts","true"),sessionStorage.setItem(vi,"true")),window.location.href=r.toString()});let o=e.querySelector(".new-project-btn");o?e.insertBefore(n,o):e.insertBefore(n,e.firstChild)}function ul(){document.addEventListener("keydown",async function(e){if((e.metaKey||e.ctrlKey)&&e.key==="e"){if(document.body.classList.contains("editing"))return;let t=document.activeElement;if(t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"))return;if(e.preventDefault(),window.location.pathname==="/me"){let i=new URL(window.location.href);i.searchParams.set("edit",""),window.history.replaceState({},"",i),window.EditMode||await Ce(),window.EditMode&&window.EditMode.initAbout();return}let o=document.querySelector(".project-item.active");if(o){let i=o.dataset.slug;if(i){if(!qn()){let r=Wn(`/${i}`,{edit:""});je(new URL(r).pathname,".project-item.active .project-content"),window.location.href=r;return}window.EditMode||await Ce(),window.EditMode?.init(i)}}}})}function wi(){if(Ro(),Ee(),window.location.pathname==="/"&&!new URLSearchParams(window.location.search).has("show_drafts")&&Ee()){let t=new URL(window.location.href);t.searchParams.set("show_drafts","true"),window.location.replace(t.toString());return}if(zn(),cl(),dl(),al(),document.querySelectorAll(".project-item.active").forEach(bi),document.body.addEventListener("project:afterSwap",e=>{let t=e,{element:n,isOpen:o}=t.detail;if(n?.classList?.contains("project-details")){let i=n.closest(".project-item");i&&o&&setTimeout(()=>bi(i),50)}}),qn()){let e=new URLSearchParams(window.location.search),n=document.querySelector(".project-item.active")?.dataset.slug;if(n&&(e.has("edit")||e.has("settings"))){if(e.has("settings")){let o=new URL(window.location.href);o.searchParams.delete("settings"),o.searchParams.set("edit",""),window.history.replaceState({},"",o.toString())}setTimeout(async()=>{window.EditMode||await Ce(),window.EditMode?.init(n)},100)}}window.location.pathname==="/me"&&new URLSearchParams(window.location.search).has("edit")&&setTimeout(async()=>{window.EditMode||await Ce(),window.EditMode&&window.EditMode.initAbout()},100),ul()}function pl(){Xe()&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",wi):wi())}var hl={init:pl,loadEditModeScripts:Ce,loadEditModeCSS:zn,isShowDraftsActive:Ee,buildUrlWithShowDrafts:Wn},Ei=hl;var ml={modal:null,show(){this.modal=document.createElement("div"),this.modal.className="edit-create-modal",this.modal.innerHTML=`
      <div class="edit-create-overlay"></div>
      <div class="edit-create-content">
        <div class="edit-create-header">
          <h2>Create New Project</h2>
          <button class="edit-create-close">&times;</button>
        </div>
        <form class="edit-create-form" id="create-project-form">
          <div class="edit-form-group">
            <label for="project-name">Project Name</label>
            <input type="text" id="project-name" name="name" required placeholder="My New Project">
          </div>
          <div class="edit-form-group">
            <label for="project-slug">URL Slug</label>
            <input type="text" id="project-slug" name="slug" required placeholder="my-new-project" pattern="[a-z0-9][a-z0-9_\\-]*">
            <span class="edit-form-hint">Must start with letter/number. Lowercase, numbers, hyphens, underscores only.</span>
          </div>
          <div class="edit-form-group">
            <label for="project-date">Date</label>
            <input type="date" id="project-date" name="date" required value="${new Date().toISOString().split("T")[0]}">
          </div>
          <div class="edit-form-row">
            <div class="edit-form-group edit-form-checkbox">
              <label>
                <input type="checkbox" id="project-draft" name="draft" checked>
                Draft
              </label>
            </div>
            <div class="edit-form-group edit-form-checkbox">
              <label>
                <input type="checkbox" id="project-pinned" name="pinned">
                Pinned
              </label>
            </div>
          </div>
          <div class="edit-create-actions">
            <button type="button" class="edit-btn edit-btn-secondary" id="create-cancel">Cancel</button>
            <button type="submit" class="edit-btn edit-btn-primary">Create Project</button>
          </div>
        </form>
      </div>
    `,document.body.appendChild(this.modal),ze(),this.setupEventListeners();let e=this.modal.querySelector("#project-name"),t=this.modal.querySelector("#project-slug");e&&t&&(e.addEventListener("input",()=>{t.value=this.generateSlug(e.value)}),e.focus())},generateSlug(e){return e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^[-_]+/,"").replace(/[-_]+$/,"")},setupEventListeners(){if(!this.modal)return;let e=this.modal.querySelector(".edit-create-close");e&&e.addEventListener("click",()=>this.hide());let t=this.modal.querySelector(".edit-create-overlay");t&&t.addEventListener("click",()=>this.hide());let n=this.modal.querySelector("#create-cancel");n&&n.addEventListener("click",()=>this.hide());let o=this.modal.querySelector("#create-project-form");o&&o.addEventListener("submit",async r=>{r.preventDefault(),await this.createProject()});let i=r=>{r.key==="Escape"&&this.modal&&(this.hide(),document.removeEventListener("keydown",i))};document.addEventListener("keydown",i)},async createProject(){if(!this.modal)return;let e=this.modal.querySelector("#create-project-form");if(!e)return;let t=new FormData(e),n={name:t.get("name"),slug:t.get("slug"),date:t.get("date"),draft:t.get("draft")==="on",pinned:t.get("pinned")==="on",markdown:""};try{await X("/api/create-project",{method:"POST",body:JSON.stringify(n)}),L("Project created!","success"),this.hide(),window.location.href=Se(`/${n.slug}`)}catch(o){console.error("Create project error:",o);let i=o instanceof Error?o.message:"Failed to create project";L(i,"error")}},hide(){this.modal&&(this.modal.remove(),this.modal=null),Ke()}},Si=ml;typeof window<"u"&&(window.EditMode=gi,window.ProjectSettings=Vt,window.ProjectCreate=Si);Ei.init();})();
//# sourceMappingURL=edit-bundle.js.map
