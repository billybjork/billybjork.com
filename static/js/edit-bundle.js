// Auto-generated by esbuild - do not edit directly

"use strict";(()=>{function ln(){return"block-"+Date.now()+"-"+Math.random().toString(36).substring(2,11)}function re(){let e=window.location.hostname;return e==="localhost"||e==="127.0.0.1"}function K(){let e="bb_show_drafts",n=new URLSearchParams(window.location.search);if(n.has("show_drafts")){let t=n.get("show_drafts")==="true";return t?sessionStorage.setItem(e,"true"):sessionStorage.removeItem(e),t}return sessionStorage.getItem(e)==="true"}function cn(e){try{let n=new URL(e,window.location.origin);return K()&&n.searchParams.set("show_drafts","true"),n.toString()}catch{return e}}function de(e,n){let t=()=>{e.style.height="auto",e.style.height=e.scrollHeight+"px"};return e.addEventListener("input",()=>{t(),n&&n(e.value)}),setTimeout(t,0),t}function qe(e,n){let t=document.createElement("img");return t.src=e.src,t.alt=e.alt||"",e.style&&t.setAttribute("style",e.style),e.align&&Ke(t,e.align),n&&t.addEventListener("click",o=>{o.stopPropagation(),n(t,e)}),t}function ze(e,n){let t=document.createElement("video");return t.src=e.src,t.controls=!0,t.className="content-video",e.style&&t.setAttribute("style",e.style),e.align&&Ke(t,e.align),n&&t.addEventListener("click",o=>{o.stopPropagation(),n(t,e)}),t}function Ke(e,n){e.style.display="block",e.style.marginLeft="",e.style.marginRight="",n==="center"?(e.style.marginLeft="auto",e.style.marginRight="auto"):n==="right"&&(e.style.marginLeft="auto")}function mt(e){switch(e){case"center":return"margin-left: auto; margin-right: auto";case"right":return"margin-left: auto";default:return""}}function Se(e){if(!e)return"left";let n=e.includes("margin-left: auto")||e.includes("margin-left:auto"),t=e.includes("margin-right: auto")||e.includes("margin-right:auto");return n&&t?"center":n?"right":"left"}function ke(e){let n=["display: block"];if(e.style){let o=e.style.replace(/margin-left:\s*auto;?\s*/g,"").replace(/margin-right:\s*auto;?\s*/g,"").replace(/display:\s*block;?\s*/g,"").trim();o&&n.push(o)}let t=mt(e.align??"left");return t&&n.push(t),n.join("; ")}function $(e,n){if(e.focus({preventScroll:!0}),!document.execCommand("insertText",!1,n)){let t=e.selectionStart,o=e.selectionEnd;e.setRangeText(n,t,o,"end")}}function ft(e,n,t,o){let i=e.selectionStart,r=e.selectionEnd,a=e.value.substring(i,r)||"text",s=n+a+t;e.focus({preventScroll:!0}),e.setSelectionRange(i,r),$(e,s),e.selectionStart=i+n.length,e.selectionEnd=i+n.length+a.length,o&&o()}function dn(e,n,t,o,i){let r=e.lastIndexOf(`
`,n-1)+1,a=e.indexOf(`
`,t),s=a===-1?e.length:a,d=-1;for(let m=n;m>=r;m--)if(e.substring(m,m+o.length)===o){let S=m>0?e[m-1]:"";if(o!=="**"||S!=="*"){d=m;break}}if(d===-1)return null;let v=-1,L=Math.max(d+o.length,t);for(let m=L;m<=s-i.length;m++)if(e.substring(m,m+i.length)===i){let S=m+i.length<e.length?e[m+i.length]:"";if(i!=="**"||S!=="*"){v=m;break}}if(v===-1)return null;let y=d+o.length,B=v;return n>=y&&t<=B?{formatStart:d,formatEnd:v+i.length,innerStart:y,innerEnd:B}:null}function Te(e,n,t,o){let{value:i,selectionStart:r,selectionEnd:a}=e,s=dn(i,r,a,n,t);if(s){let{formatStart:d,formatEnd:v,innerStart:L,innerEnd:y}=s,B=i.substring(L,y);e.focus({preventScroll:!0}),e.setSelectionRange(d,v),$(e,B),e.selectionStart=d,e.selectionEnd=d+B.length}else ft(e,n,t,()=>{});o&&o()}function Ge(e,n,t){if(!(e.metaKey||e.ctrlKey))return!1;switch(e.key){case"b":return e.preventDefault(),Te(n,"**","**",t),!0;case"i":return e.preventDefault(),Te(n,"*","*",t),!0;case"u":return e.preventDefault(),Te(n,"<u>","</u>",t),!0;case"k":return e.preventDefault(),gt(n,t),!0}return!1}function pt(e){let{value:n,selectionStart:t}=e,o=-1;for(let d=t;d>=Math.max(0,t-500);d--){if(n[d]==="["){o=d;break}if(n[d]===`
`||n[d]===")")break}if(o===-1)return null;let r=n.substring(o).match(/^\[([^\]]*)\]\(([^)]*)\)/);if(!r)return null;let a=r[0],s=o+a.length;return t>s?null:{start:o,end:s,text:r[1]??"",url:r[2]??"",textStart:o+1,textEnd:o+1+(r[1]?.length??0),urlStart:o+(r[1]?.length??0)+3,urlEnd:s-1}}async function gt(e,n){let t=pt(e);if(t){let o=prompt("Edit link URL (leave empty to remove link):",t.url);if(o===null)return;if(o==="")e.focus({preventScroll:!0}),e.setSelectionRange(t.start,t.end),$(e,t.text);else{let i=`[${t.text}](${o})`;e.focus({preventScroll:!0}),e.setSelectionRange(t.start,t.end),$(e,i)}}else{let o=e.selectionStart,i=e.selectionEnd,r=e.value.substring(o,i)||"link text",a=prompt("Enter link URL:");if(!a)return;let s=`[${r}](${a})`;e.focus({preventScroll:!0}),e.setSelectionRange(o,i),$(e,s)}n&&n()}function un(e,n){e.style.textAlign=n||"left"}function xe(e){return!e||e==="left"?"":`text-align: ${e}`}function Le(e){return e?e.match(/text-align:\s*(left|center|right)/)?.[1]??"left":"left"}function mn(e,n){let{value:t,selectionStart:o,selectionEnd:i}=e,r="   ",a=t.lastIndexOf(`
`,o-1)+1,s=t.indexOf(`
`,i);s===-1&&(s=t.length);let d=t.substring(0,a),v=t.substring(a,s),L=t.substring(s),y=v.split(`
`).map(m=>{let S=m.match(/^(\s*)\d+\.\s(.*)$/);return S?r+(S[1]??"")+"- "+(S[2]??""):r+m}).join(`
`);e.value=d+y+L;let B=y.length-v.length;e.selectionStart=o+r.length,e.selectionEnd=i+B,e.dispatchEvent(new Event("input",{bubbles:!0})),n&&n()}function fn(e,n){let{value:t,selectionStart:o,selectionEnd:i}=e,r=t.lastIndexOf(`
`,o-1)+1,a=t.indexOf(`
`,i);a===-1&&(a=t.length);let s=t.substring(0,r),d=t.substring(r,a),v=t.substring(a),L=0,y=0,B=d.split(`
`).map((m,S)=>{let c=m.match(/^( {1,4}|\t)/);if(c){let l=c[0].length;return S===0&&(L=l),y+=l,m.substring(l)}return m}).join(`
`);e.value=s+B+v,e.selectionStart=Math.max(r,o-L),e.selectionEnd=i-y,e.dispatchEvent(new Event("input",{bubbles:!0})),n&&n()}function pn(e,n,t){let{value:o,selectionStart:i,selectionEnd:r}=n;if(i!==r)return!1;let a=o.lastIndexOf(`
`,i-1)+1,s=o.indexOf(`
`,i),d=o.substring(a,s===-1?o.length:s),v=d.match(/^(\s*)([-*+])\s(.*)$/);if(v){let[,y="",B="-",m=""]=v;if(m.trim()===""){e.preventDefault();let c=o.substring(0,a),l=o.substring(s===-1?o.length:s);return n.value=c+l,n.selectionStart=n.selectionEnd=a,n.dispatchEvent(new Event("input",{bubbles:!0})),t&&t(),!0}e.preventDefault();let S=`
${y}${B} `;return $(n,S),n.dispatchEvent(new Event("input",{bubbles:!0})),t&&t(),!0}let L=d.match(/^(\s*)(\d+)\.\s(.*)$/);if(L){let[,y="",B="1",m=""]=L;if(m.trim()===""){e.preventDefault();let l=o.substring(0,a),u=o.substring(s===-1?o.length:s);return n.value=l+u,n.selectionStart=n.selectionEnd=a,n.dispatchEvent(new Event("input",{bubbles:!0})),t&&t(),!0}e.preventDefault();let S=parseInt(B,10)+1,c=`
${y}${S}. `;return $(n,c),n.dispatchEvent(new Event("input",{bubbles:!0})),t&&t(),!0}return!1}function Xe(e,n,t){return e.key==="Tab"&&!e.shiftKey?(e.preventDefault(),mn(n,t),!0):e.key==="Tab"&&e.shiftKey?(e.preventDefault(),fn(n,t),!0):!!(e.key==="Enter"&&!e.shiftKey&&!e.metaKey&&!e.ctrlKey&&pn(e,n,t))}function w(e,n="info",t=3e3){let o=document.createElement("div");o.className=`edit-notification edit-notification-${n}`,o.textContent=e,document.body.appendChild(o),requestAnimationFrame(()=>{o.classList.add("show")}),setTimeout(()=>{o.classList.remove("show"),setTimeout(()=>o.remove(),300)},t)}function Be(e){return JSON.parse(JSON.stringify(e))}function gn(e){let n=e.textContent?.trim()??"",t=e.innerHTML.trim();return n===""||t===""||t==="<br>"}function hn(e){let n=document.createRange(),t=window.getSelection();t&&(n.selectNodeContents(e),n.collapse(!1),t.removeAllRanges(),t.addRange(n))}async function Me(e,n={}){let t=await fetch(e,{...n,headers:{"Content-Type":"application/json",...n.headers}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return await t.json()}function vn(e,n){let t;return function(...i){let r=()=>{clearTimeout(t),e(...i)};clearTimeout(t),t=setTimeout(r,n)}}var ht={generateId:ln,isDevMode:re,isShowDraftsActive:K,withShowDrafts:cn,setupAutoResizeTextarea:de,createImageElement:qe,createVideoElement:ze,applyAlignment:Ke,getAlignmentStyle:mt,parseAlignmentFromStyle:Se,buildMediaStyleString:ke,insertTextWithUndo:$,wrapSelection:ft,toggleFormat:Te,handleFormattingShortcuts:Ge,findLinkAtCursor:pt,insertLink:gt,applyTextAlignment:un,getTextAlignmentStyle:xe,parseTextAlignmentFromStyle:Le,handleListShortcuts:Xe,showNotification:w,deepClone:Be,isElementEmpty:gn,moveCaretToEnd:hn,fetchJSON:Me,debounce:vn};var Je="<!-- block -->",De="<!-- row -->",He="<!-- /row -->",Ye="<!-- col -->",ue="<!-- html -->",me="<!-- /html -->";function ae(e){return`block-${Date.now()}-${e}-${Math.random().toString(36).substring(2,7)}`}function En(e,n){if(n.startsWith(ue)&&n.endsWith(me)){e.type="html",e.html=n.slice(ue.length,-me.length).trim();return}if(n.startsWith("```")){e.type="code";let t=n.match(/^```(\w*)\n?([\s\S]*?)\n?```$/);t?(e.language=t[1]||"text",e.code=t[2]||""):(e.language="text",e.code=n.replace(/^```\w*\n?/,"").replace(/\n?```$/,""));return}if(n.startsWith("<img")||/^!\[.*?\]\(.*?\)$/.test(n)){if(e.type="image",n.startsWith("<img")){let t=n.match(/src="([^"]*)"/),o=n.match(/alt="([^"]*)"/),i=n.match(/style="([^"]*)"/);e.src=t?.[1]??"",e.alt=o?.[1]??"",e.style=i?.[1]??null,e.align=Se(e.style)}else{let t=n.match(/!\[(.*?)\]\((.*?)\)/);e.src=t?.[2]??"",e.alt=t?.[1]??"",e.style=null,e.align="left"}return}if(n.startsWith("<video")){e.type="video";let t=n.match(/src="([^"]*)"/),o=n.match(/style="([^"]*)"/);e.src=t?.[1]??"",e.style=o?.[1]??null,e.align=Se(e.style);return}if(n.startsWith('<div class="callout"')){e.type="callout";let t=n.match(/<div class="callout"(?:\s+style="([^"]*)")?>([\s\S]*?)<\/div>/);t?(e.align=t[1]?Le(t[1]):"left",e.content=t[2]?.trim()??""):(e.content="",e.align="left");return}if(/^(\*{3,}|-{3,}|_{3,})$/.test(n)){e.type="divider";return}if(n.startsWith("<!-- align:")){e.type="text";let t=n.match(/^<!-- align:(center|right) -->\n?([\s\S]*?)\n?<!-- \/align -->$/);t?(e.align=t[1],e.content=t[2]?.trim()??""):e.align="left";return}if(n.startsWith('<div style="text-align:')||n.startsWith('<div style="text-align :')){e.type="text";let t=n.match(/<div style="([^"]*)">([\s\S]*?)<\/div>/);t?(e.align=Le(t[1]),e.content=t[2]?.trim()??""):e.align="left";return}e.type="text",e.align="left"}function Ce(e,n){let t=e.trim(),o={id:ae(n),content:t};switch(En(o,t),o.type){case"text":return{id:o.id,type:"text",content:o.content??"",align:o.align??"left"};case"image":return{id:o.id,type:"image",src:o.src??"",alt:o.alt??"",style:o.style??null,align:o.align??"left"};case"video":return{id:o.id,type:"video",src:o.src??"",style:o.style??null,align:o.align??"left"};case"code":return{id:o.id,type:"code",code:o.code??"",language:o.language??"text"};case"html":return{id:o.id,type:"html",html:o.html??"",align:o.align??"left"};case"callout":return{id:o.id,type:"callout",content:o.content??"",align:o.align??"left"};case"divider":return{id:o.id,type:"divider"};default:return{id:o.id,type:"text",content:o.content??"",align:"left"}}}function vt(e){if(!e||!e.trim())return[{id:ae(0),type:"text",content:"",align:"left"}];let t=e.split(new RegExp(`\\n+${Je}\\n+`)).map((o,i)=>{let r=o.trim();if(r.startsWith(De)&&r.endsWith(He)){let s=r.slice(De.length,-He.length).trim().split(new RegExp(`\\n*${Ye}\\n*`));if(s.length>=2)return{id:ae(i),type:"row",left:Ce(s[0]??"",i*10),right:Ce(s[1]??"",i*10+1)}}return Ce(o,i)});return t.length?t:[{id:ae(0),type:"text",content:"",align:"left"}]}function yn(e){return vt(e)}function Et(e){let n=e.style&&(e.style.includes("width")||e.style.includes("max-width")),t=e.align&&e.align!=="left";if(n||t){let o=ke(e);return`<img src="${e.src}" alt="${e.alt||""}" style="${o}">`}return`![${e.alt||""}](${e.src})`}function yt(e){let n=e.style&&(e.style.includes("width")||e.style.includes("max-width")),t=e.align&&e.align!=="left";if(n||t){let o=ke(e);return`<video src="${e.src}" controls style="${o}"></video>`}return`<video src="${e.src}" controls></video>`}function wt(e){return"```"+(e.language||"")+`
`+(e.code||"")+"\n```"}function bt(e){return e.align&&e.align!=="left"?`<div class="callout" style="${xe(e.align)}">${e.content}</div>`:`<div class="callout">${e.content}</div>`}function Tt(e){let n=e.html||"";if(e.align&&e.align!=="left"){let t=xe(e.align);return`${ue}
<div style="${t}">
${n}
</div>
${me}`}return`${ue}
${n}
${me}`}function Ae(e){switch(e.type){case"text":{let n=(e.content||"").trim();return e.align&&e.align!=="left"?`<!-- align:${e.align} -->
${n}
<!-- /align -->`:n}case"image":return Et(e);case"video":return yt(e);case"code":return wt(e);case"html":return Tt(e);case"row":{let n=Ae(e.left),t=Ae(e.right);return`${De}
${n}
${Ye}
${t}
${He}`}case"callout":return bt(e);case"divider":return"---";default:return""}}function Ie(e){return e.map(n=>Ae(n)).join(`

${Je}

`)}function N(e,n={}){let t={id:ae(Date.now()),type:e};switch(e){case"text":return{...t,content:"",align:"left",...n};case"image":return{...t,src:"",alt:"",style:null,align:"left",...n};case"video":return{...t,src:"",style:null,align:"left",...n};case"code":return{...t,language:"javascript",code:"",...n};case"html":return{...t,html:"",align:"left",...n};case"callout":return{...t,content:"",align:"left",...n};case"row":return{...t,left:N("text"),right:N("text"),...n};case"divider":return{...t,...n};default:return{...t,content:"",align:"left",...n}}}var wn=N,bn={BLOCK_SEPARATOR:Je,ROW_START:De,ROW_END:He,COL_SEPARATOR:Ye,HTML_START:ue,HTML_END:me,parseIntoBlocks:vt,parseMarkdown:yn,parseSingleBlock:Ce,blockToMarkdown:Ae,blocksToMarkdown:Ie,formatImageMarkdown:Et,formatVideoMarkdown:yt,formatCodeMarkdown:wt,formatHtmlBlock:Tt,formatCalloutHtml:bt,createBlock:N,createEmptyBlock:wn,generateBlockId:ae},Ne=bn;var St={MENU_WIDTH:240},pe=[{id:"text",label:"Text",icon:"T",description:"Plain text paragraph"},{id:"image",label:"Image",icon:"\u{1F5BC}",description:"Upload or select an image"},{id:"video",label:"Video",icon:"\u{1F3AC}",description:"Upload a video file"},{id:"code",label:"Code",icon:"\u{1F4BB}",description:"Code block with syntax highlighting"},{id:"html",label:"HTML",icon:"<>",description:"Raw HTML (scripts, embeds, custom)"},{id:"callout",label:"Callout",icon:"\u{1F4CC}",description:"Highlighted message box"},{id:"divider",label:"Divider",icon:"\u2042",description:"Section break"}],h=null,O=!1,ge=!1,le="",D=0,J=null,Y=null,j=null,fe=null,se=null;function Re(){if(h)return h;let e=document.createElement("div");return e.className="slash-command-menu",e.style.display="none",document.body.appendChild(e),h=e,e}function Qe(e){if(!h)return;h.style.display="block",h.style.width=`${St.MENU_WIDTH}px`,h.style.left=`${Math.min(e.left,window.innerWidth-St.MENU_WIDTH-20)}px`;let n=h.offsetHeight||200,t=window.innerHeight-e.bottom-10,o=e.top-10;t<n&&o>t?(h.style.top="auto",h.style.bottom=`${window.innerHeight-e.top+5}px`,h.style.maxHeight=`${Math.min(300,o)}px`):(h.style.top=`${e.bottom+5}px`,h.style.bottom="auto",h.style.maxHeight=`${Math.min(300,t)}px`)}function xt(e){if(!e)return pe;let n=e.toLowerCase();return pe.filter(t=>t.label.toLowerCase().includes(n)||t.id.toLowerCase().includes(n)||t.description.toLowerCase().includes(n))}function he(e,n=0){h||Re(),h&&(D=Math.max(0,Math.min(n,e.length-1)),h.innerHTML=e.map((t,o)=>`
      <button
        class="slash-menu-item ${o===D?"selected":""}"
        data-command="${t.id}"
      >
        <span class="slash-menu-icon">${t.icon}</span>
        <div class="slash-menu-content">
          <span class="slash-menu-label">${t.label}</span>
          <span class="slash-menu-description">${t.description}</span>
        </div>
      </button>
    `).join(""),h.querySelectorAll(".slash-menu-item").forEach((t,o)=>{t.addEventListener("click",()=>{let i=e[o];i&&Mt(i.id)})}))}function kt(){if(!h)return;let e=h.querySelector(".slash-menu-item.selected");e&&e.scrollIntoView({block:"nearest",behavior:"smooth"})}function Lt(){Ze(),fe=()=>{!O||!j||Qe(j.getBoundingClientRect())},window.addEventListener("scroll",fe,!0),se=e=>{!O||!h||h.contains(e.target)||j?.contains(e.target)||Q()},requestAnimationFrame(()=>{se&&document.addEventListener("mousedown",se,!0)})}function Ze(){fe&&(window.removeEventListener("scroll",fe,!0),fe=null),se&&(document.removeEventListener("mousedown",se,!0),se=null)}function Bt(e,n){h||Re(),O=!0,ge=!0,le="",D=0,Y=n,j=e,he(pe,0),Qe(e.getBoundingClientRect()),Lt()}function Tn(e,n,t){h||Re(),O=!0,ge=!1,le="",D=0,Y=n,j=t??null,he(pe,0),Qe(e),Lt()}function Q(){Ze(),h&&(h.style.display="none"),O=!1,ge=!1,le="",D=0,j=null}function Mt(e){let n=Y??0,t=ge,o=!1;if(ge&&Y!==null){let i=j&&j.tagName==="TEXTAREA"?j:document.querySelector(`.block-wrapper[data-block-index="${Y}"] .block-textarea`);if(i){let r=i.selectionStart,a=i.value,v=a.substring(0,r).lastIndexOf(`
`)+1;if(a[v]==="/"){let L=v,y=(a.substring(0,L)+a.substring(r)).replace(/\n+$/,"");if(i.value=y,i.classList.contains("text-line-input")){let m=i.closest(".block-wrapper");if(m){let S=m.querySelectorAll(".text-line-input");o=Array.from(S).every(c=>!c.value.trim())}else o=!y.trim();i.dispatchEvent(new Event("input",{bubbles:!0}))}else o=!y.trim(),J&&J("updateContent",{index:Y,content:y})}}}Q(),J&&(t?J("execute",{commandId:e,insertIndex:o?n:n+1,replaceBlockIndex:o?n:null}):J("execute",{commandId:e,insertIndex:n,replaceBlockIndex:null}))}function Sn(e){if(!O)return!1;let n=xt(le);switch(e.key){case"ArrowDown":return e.preventDefault(),e.stopPropagation(),D=(D+1)%n.length,he(n,D),kt(),!0;case"ArrowUp":return e.preventDefault(),e.stopPropagation(),D=(D-1+n.length)%n.length,he(n,D),kt(),!0;case"Enter":case"Tab":if(e.preventDefault(),e.stopPropagation(),n.length>0){let t=n[D];t&&Mt(t.id)}return!0;case"Escape":return e.preventDefault(),e.stopPropagation(),Q(),!0}return!1}function kn(e,n){let t=e.selectionStart,i=e.value.substring(0,t),a=i.lastIndexOf(`
`)+1;if(i.substring(a)==="/"){Bt(e,n);return}if(O){let d=i.lastIndexOf("/");if(d!==-1){let v=i.substring(0,d);if(v===""||v.endsWith(`
`)){le=i.substring(d+1);let y=xt(le);y.length===0?Q():he(y,0)}else Q()}else Q()}}function xn(e){J=e,Re()}function Ln(){Ze(),h&&(h.remove(),h=null),O=!1,j=null,J=null}function Bn(){return O}function Mn(){return O}function Cn(){return Y}var Dn={init:xn,cleanup:Ln,showFromTextarea:Bt,showFromButton:Tn,hide:Q,handleKeydown:Sn,handleTextareaInput:kn,isActive:Bn,isVisible:Mn,getActiveIndex:Cn,COMMANDS:pe},H=Dn;var T=null,Pe=2e3,Dt=.8,Hn=["image/jpeg","image/png","image/gif","image/webp"],An=["video/mp4","video/quicktime","video/webm"],ve={MIN_WIDTH_PERCENT:20,MAX_WIDTH_PERCENT:100,HANDLE_POSITIONS:["nw","ne","sw","se"],FULL_WIDTH_THRESHOLD:2},b=null,Ee=[],ee=!1,Z=null,tt=!1,ye=null,we=null,et=null,Ct=null;function In(e){T=e,Nn(),Ht()}function Nn(){document.addEventListener("paste",async e=>{if(!T?.isActive())return;let n=Array.from(e.clipboardData?.items??[]);for(let t of n)if(t.type.startsWith("image/")){e.preventDefault();let o=t.getAsFile();if(!o)continue;let i=document.activeElement?.closest(".block-wrapper"),r=i?parseInt(i.getAttribute("data-block-index")??"",10):null;r!==null&&!isNaN(r)&&await it(o,r);break}})}function Ht(){tt||(ye=e=>jn(e),we=()=>Nt(),et=()=>ot(),Ct=e=>{if(!T?.isActive()||!b||ee)return;let n=e.target,t=n.closest(".image-block-wrapper"),o=n.closest(".resize-handle");t||o||nt()},document.addEventListener("click",Ct),window.addEventListener("resize",et),window.addEventListener("scroll",et,!0),tt=!0)}function Rn(e,n){!e||!n||(tt||Ht(),!(b&&b.element===e)&&(nt(),b={element:e,block:n},e.classList.add("media-selected"),Pn(e),ot()))}function nt(){ee&&Nt(),b&&(b.element.classList.remove("media-selected"),It(),b=null)}function Pn(e){It();let n=e.getBoundingClientRect();ve.HANDLE_POSITIONS.forEach(t=>{let o=document.createElement("div");o.className=`resize-handle ${t}`,o.dataset.position=t,At(o,t,n),o.addEventListener("mousedown",i=>$n(i,t)),document.body.appendChild(o),Ee.push(o)})}function At(e,n,t){switch(e.style.position="fixed",n){case"nw":e.style.top=`${t.top-6}px`,e.style.left=`${t.left-6}px`;break;case"ne":e.style.top=`${t.top-6}px`,e.style.left=`${t.right-6}px`;break;case"sw":e.style.top=`${t.bottom-6}px`,e.style.left=`${t.left-6}px`;break;case"se":e.style.top=`${t.bottom-6}px`,e.style.left=`${t.right-6}px`;break}}function ot(){if(!b||Ee.length===0)return;let e=b.element.getBoundingClientRect();Ee.forEach(n=>{let t=n.dataset.position;At(n,t,e)})}function It(){Ee.forEach(e=>e.remove()),Ee=[]}function $n(e,n){if(!b)return;e.preventDefault(),e.stopPropagation();let t=b.element,o=t.getBoundingClientRect();if(!o.width)return;let i=t.closest(".row-column")||t.closest(".block-content")||t.closest(".image-block-wrapper")||t.parentElement,r=i?i.getBoundingClientRect():o,a=Math.max(80,r.width*ve.MIN_WIDTH_PERCENT/100),s=r.width*ve.MAX_WIDTH_PERCENT/100;ee=!0,t.classList.add("media-resizing"),Z={position:n,startX:e.clientX,startWidth:o.width,minWidth:a,maxWidth:s,lastWidth:o.width},ye&&we&&(document.addEventListener("mousemove",ye),document.addEventListener("mouseup",we)),document.body.style.userSelect="none"}function jn(e){if(!ee||!b||!Z)return;let{position:n,startX:t,startWidth:o,minWidth:i,maxWidth:r}=Z,a=e.clientX-t;(n==="nw"||n==="sw")&&(a=-a);let s=o+a;s=Math.max(i,Math.min(r,s)),Z.lastWidth=s;let d=b.element,v=b.block;d.style.width=`${Math.round(s)}px`,d.style.height="auto",$t(v,s,r),ot()}function Nt(){if(ee){if(ee=!1,b){b.element.classList.remove("media-resizing");let e=Z?.lastWidth,n=Z?.maxWidth;e&&n&&($t(b.block,e,n),jt(b.block.style)||(b.element.style.width="",b.element.style.height=""),T?.markDirty())}ye&&we&&(document.removeEventListener("mousemove",ye),document.removeEventListener("mouseup",we)),document.body.style.userSelect="",Z=null}}function Rt(e){let n={};return e&&e.split(";").forEach(t=>{let[o,...i]=t.split(":");if(!o)return;let r=i.join(":").trim();r&&(n[o.trim().toLowerCase()]=r)}),n}function Pt(e){return Object.entries(e).filter(([,n])=>n!=null&&n!=="").map(([n,t])=>`${n}: ${t}`).join("; ")}function $t(e,n,t){if(!e)return;let o=Rt(e.style);delete o["margin-left"],delete o["margin-right"],delete o.display,delete o.height,delete o["max-height"],delete o["max-width"],delete o["min-width"],delete o["min-height"],Math.abs(n-t)<=ve.FULL_WIDTH_THRESHOLD?delete o.width:o.width=`${Math.round(n)}px`;let i=Pt(o);e.style=i||null}function jt(e){return e?/(^|;)\s*width\s*:/.test(e):!1}async function Ot(e){return new Promise((n,t)=>{let o=new Image,i=document.createElement("canvas"),r=i.getContext("2d");if(!r){t(new Error("Could not get canvas context"));return}o.onload=()=>{let a=o.width,s=o.height;a>Pe&&(s=Math.round(s*Pe/a),a=Pe),i.width=a,i.height=s,r.drawImage(o,0,0,a,s),i.toBlob(d=>{d?n(d):t(new Error("Failed to create blob"))},"image/webp",Dt),URL.revokeObjectURL(o.src)},o.onerror=()=>{URL.revokeObjectURL(o.src),t(new Error("Failed to load image"))},o.src=URL.createObjectURL(e)})}async function $e(e,n){let t=new FormData;t.append("file",e);let o=n==="video"?"/api/process-content-video":"/api/upload-media";n==="image"&&t.append("type","image");let i=await fetch(o,{method:"POST",body:t});if(!i.ok){let a=await i.json().catch(()=>({}));throw new Error(a.detail||`Upload failed: ${i.status}`)}return(await i.json()).url}async function it(e,n){w("Processing image...","info");try{let t=await Ot(e),o=await $e(t,"image");T?.updateBlock(n,{src:o,alt:e.name.replace(/\.[^/.]+$/,"")}),w("Image uploaded!","success")}catch(t){console.error("Image upload failed:",t),w(t instanceof Error?t.message:"Image upload failed","error")}}async function Ut(e,n){w("Processing video...","info");try{let t=await $e(e,"video");T?.updateBlock(n,{src:t}),w("Video processed!","success")}catch(t){console.error("Video upload failed:",t),w(t instanceof Error?t.message:"Video processing failed","error")}}async function On(e,n=null){w("Processing image...","info");try{let t=await Ot(e),o=await $e(t,"image");Wn(o,e.name,n),w("Image uploaded!","success")}catch(t){console.error("Image upload failed:",t),w("Image upload failed","error")}}async function Un(e,n=null){w("Processing video...","info");try{let t=await $e(e,"video");_n(t,n),w("Video processed!","success")}catch(t){console.error("Video upload failed:",t),w(t instanceof Error?t.message:"Video processing failed","error")}}function Wn(e,n="",t=null){let o=N("image",{src:e,alt:n.replace(/\.[^/.]+$/,"")});if(t){T?.insertBlockAfter(t,"image");let i=T?.getBlocks()??[],r=i[i.length-1];r&&r.type==="image"&&(r.src=e,r.alt=n.replace(/\.[^/.]+$/,""),T?.renderBlocks())}else(T?.getBlocks()??[]).push(o),T?.renderBlocks(),T?.markDirty()}function _n(e,n=null){let t=N("video",{src:e});if(n){T?.insertBlockAfter(n,"video");let o=T?.getBlocks()??[],i=o[o.length-1];i&&i.type==="video"&&(i.src=e,T?.renderBlocks())}else(T?.getBlocks()??[]).push(t),T?.renderBlocks(),T?.markDirty()}async function Fn(e){let n=document.createElement("input");n.type="file",n.accept="image/*",n.addEventListener("change",async()=>{let t=n.files?.[0];t&&await it(t,e)}),n.click()}async function Vn(e){let n=document.createElement("input");n.type="file",n.accept="video/*",n.addEventListener("change",async()=>{let t=n.files?.[0];t&&await Ut(t,e)}),n.click()}var qn={MAX_IMAGE_WIDTH:Pe,IMAGE_QUALITY:Dt,ALLOWED_IMAGE_TYPES:Hn,ALLOWED_VIDEO_TYPES:An,RESIZE_CONFIG:ve,get selectedMedia(){return b},get isResizing(){return ee},init:In,select:Rn,deselect:nt,handleImageUploadForBlock:it,handleVideoUploadForBlock:Ut,handleImageUpload:On,handleVideoUpload:Un,replaceImageByIndex:Fn,replaceVideoByIndex:Vn,parseStyle:Rt,serializeStyle:Pt,styleHasWidth:jt},R=qn;var te=null,M=[],k=-1,Wt=50,je=!1,rt=null,_t=500;function zn(e){te=e,M=[],k=-1}function Kn(){M=[],k=-1}function Gn(){if(!te)throw new Error("EditUndo not initialized");return{blocks:Be(te.getBlocks()),timestamp:Date.now()}}function Ft(){let e=Gn();k<M.length-1&&(M=M.slice(0,k+1)),M.push(e),k=M.length-1,M.length>Wt&&(M.shift(),k--)}function Xn(){je||(rt!==null&&clearTimeout(rt),rt=setTimeout(()=>{Ft()},_t))}function Vt(e){!e||!te||(je=!0,te.setBlocks(Be(e.blocks)),te.renderBlocks(),te.markDirty(),je=!1)}function Jn(){if(k<=0){w("Nothing to undo","info");return}k===M.length-1&&Ft(),k--,Vt(M[k]),w("Undo","info",1e3)}function Yn(){if(k>=M.length-1){w("Nothing to redo","info");return}k++,Vt(M[k]),w("Redo","info",1e3)}function Qn(){M=[],k=-1}function Zn(){return k>0}function eo(){return k<M.length-1}var to={get history(){return M},get currentIndex(){return k},get maxHistory(){return Wt},get isUndoing(){return je},DEBOUNCE_MS:_t,init:zn,reset:Kn,saveState:Xn,undo:Jn,redo:Yn,clear:Qn,canUndo:Zn,canRedo:eo},Oe=to;var E=[],be=null,W=null,q=!1,ce=!1,X=null,C=null,P=null,oe="unchanged",z=null,ne=null,_=null,U=null,no=2e3,oo=5e3,io=3e3,A={sourceIndex:null,currentDropIndex:null,isDragging:!1};async function ro(e){if(!re()){console.log("Edit mode only available on localhost");return}be=e,P="project",ce=!0;try{W=await Me(`/api/project/${e}`),Kt(W);let n=new URL(window.location.href);n.searchParams.set("edit",""),window.history.replaceState({},"",n)}catch(n){console.error("Failed to load project:",n),w("Failed to load project","error")}}async function ao(){if(!re()){console.log("Edit mode only available on localhost");return}P="about",be=null,ce=!0;try{W=await Me("/api/about"),Kt(W);let e=new URL(window.location.href);e.searchParams.set("edit",""),window.history.replaceState({},"",e)}catch(e){console.error("Failed to load about content:",e),w("Failed to load about content","error")}}function Kt(e){let n=P==="about"?document.querySelector(".about-content"):document.querySelector(".project-content");if(!n){console.error("Content container not found");return}if(P==="project"){let i=n.closest(".project-item");i&&i.querySelectorAll("video").forEach(a=>{a.pause()});let r=i?.querySelector(".edit-buttons");r&&(r.dataset.originalHtml=r.innerHTML,r.innerHTML=`
        <span class="edit-status"></span>
        <button class="edit-btn-action edit-btn-cancel" data-action="cancel">Cancel</button>
        <button class="edit-btn-action edit-btn-save" data-action="save">Save</button>
      `,C=r,C.querySelector('[data-action="cancel"]')?.addEventListener("click",_e),C.querySelector('[data-action="save"]')?.addEventListener("click",We))}let t="markdown"in e?e.markdown:"";E=Ne.parseIntoBlocks(t||"");let o=document.createElement("div");o.className="edit-mode-container",P==="about"?(o.innerHTML=`
      <div class="edit-mode-toolbar">
        <div class="edit-toolbar-left">
          <span class="edit-project-name">About Page</span>
          <span class="edit-status"></span>
        </div>
        <div class="edit-toolbar-right">
          <button class="edit-btn edit-btn-secondary" data-action="cancel">Cancel</button>
          <button class="edit-btn edit-btn-primary" data-action="save">Save</button>
        </div>
      </div>
      <div class="edit-blocks-container"></div>
    `,C=o.querySelector(".edit-mode-toolbar"),C?.querySelector('[data-action="cancel"]')?.addEventListener("click",_e),C?.querySelector('[data-action="save"]')?.addEventListener("click",We)):o.innerHTML=`
      <div class="edit-blocks-container"></div>
    `,n.innerHTML="",n.appendChild(o),n.classList.add("edit-mode-active"),X=o.querySelector(".edit-blocks-container"),H.init(Co),R.init({updateBlock:tn,insertBlockAfter:Qt,getBlocks:()=>E,renderBlocks:F,markDirty:x,isActive:()=>ce}),Oe.init({getBlocks:()=>E,setBlocks:i=>{E=i},renderBlocks:F,markDirty:x}),document.addEventListener("keydown",en),F(),document.body.classList.add("editing"),window.addEventListener("beforeunload",Gt)}function Ue(){ce=!1,z&&(clearTimeout(z),z=null),ne&&(clearTimeout(ne),ne=null),_&&(clearTimeout(_),_=null),U&&(U.abort(),U=null),oe="unchanged",document.removeEventListener("keydown",en),window.removeEventListener("beforeunload",Gt),H.cleanup(),R.deselect(),document.body.classList.remove("editing");let e=P==="about"?document.querySelector(".about-content"):document.querySelector(".project-content");e&&e.classList.remove("edit-mode-active"),P==="project"&&C&&C.dataset.originalHtml&&(C.innerHTML=C.dataset.originalHtml,delete C.dataset.originalHtml);let n=new URL(window.location.href);n.searchParams.delete("edit"),window.history.replaceState({},"",n),P=null}function Gt(e){q&&(e.preventDefault(),e.returnValue="")}function so(){if(!C)return;let e=C.querySelector(".edit-status"),n=C.querySelector('[data-action="save"]');if(n?.classList.remove("has-changes","is-saving","has-error"),e)switch(oe){case"unchanged":e.textContent="",e.style.color="";break;case"pending":e.textContent="(unsaved)",e.style.color="#eab308",n?.classList.add("has-changes");break;case"saving":e.textContent="Saving...",e.style.color="#3b82f6",n?.classList.add("is-saving");break;case"saved":e.textContent="Saved",e.style.color="#22c55e";break;case"error":e.textContent="Save failed",e.style.color="#ef4444",n?.classList.add("has-error");break}}function G(e){oe=e,so(),e!=="saved"&&ne&&(clearTimeout(ne),ne=null),e==="saved"&&(ne=setTimeout(()=>{oe==="saved"&&G("unchanged")},io))}function lo(){z&&clearTimeout(z),_&&(clearTimeout(_),_=null),z=setTimeout(()=>{Xt()},no)}async function Xt(){if(!(!q||oe==="saving")){U&&U.abort(),U=new AbortController,G("saving");try{let e=Ie(E),n;if(P==="about")n=await fetch("/api/save-about",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({markdown:e}),signal:U.signal});else{let t={slug:be,name:W?.title||"",date:W?.created_at||"",pinned:!1,draft:W?.status==="draft",youtube:"",video:"",markdown:e};n=await fetch("/api/save-project",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:U.signal})}if(!n.ok)throw new Error(`Save failed: ${n.status}`);q=!1,G("saved")}catch(e){if(e instanceof Error&&e.name==="AbortError")return;console.error("Auto-save error:",e),G("error"),_=setTimeout(()=>{oe==="error"&&q&&Xt()},oo)}}}function F(){if(!X)return;R.deselect();let e=X;e.innerHTML="",E.forEach((n,t)=>{t>0&&e.appendChild(So(t)),e.appendChild(co(n,t))}),e.appendChild(ko(E.length))}function co(e,n){let t=document.createElement("div");t.className="block-wrapper",t.dataset.blockIndex=String(n),t.dataset.blockId=e.id,t.dataset.blockType=e.type;let o=document.createElement("div");o.className="block-handle",o.innerHTML="\u22EE\u22EE",o.draggable=!0,o.addEventListener("dragstart",a=>xo(a,n)),o.addEventListener("dragend",Yt),t.appendChild(o);let i=document.createElement("div");i.className="block-content",i.appendChild(lt(e,n)),t.appendChild(i),e.type!=="divider"&&e.type!=="code"&&t.appendChild(uo(e,n));let r=document.createElement("button");return r.className="block-delete-btn",r.innerHTML="\xD7",r.title="Delete block",r.addEventListener("click",()=>Zt(n)),t.appendChild(r),t.addEventListener("dragover",a=>Lo(a,n)),t.addEventListener("dragleave",Bo),t.addEventListener("drop",a=>Mo(a,n)),t}function uo(e,n){let t=document.createElement("div");t.className="block-align-toolbar";let o=("align"in e?e.align:"left")||"left";return[{value:"left",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg>',title:"Align left"},{value:"center",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/></svg>',title:"Align center"},{value:"right",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="6" y1="18" x2="21" y2="18"/></svg>',title:"Align right"}].forEach(({value:r,icon:a,title:s})=>{let d=document.createElement("button");d.className="block-align-btn"+(o===r?" active":""),d.innerHTML=a,d.title=s,d.type="button",d.addEventListener("click",v=>{v.stopPropagation(),mo(n,r)}),t.appendChild(d)}),t}function mo(e,n){let t=E[e];t&&"align"in t&&(t.align=n,x(),F())}function lt(e,n){switch(e.type){case"text":return qt(e,n);case"image":return ho(e,n);case"video":return vo(e,n);case"code":return Eo(e,n);case"html":return To(e,n);case"callout":return yo(e,n);case"row":return wo(e,n);case"divider":return bo();default:return qt(e,n)}}function qt(e,n){let t=document.createElement("div");return t.className="text-block-wrapper",t.appendChild(fo(e,n)),t}function fo(e,n){let t=document.createElement("div");t.className="text-block-lines",e.align&&(t.style.textAlign=e.align);let o=(e.content||"").split(`
`);o.length||(o=[""]);let i=null,r=()=>{e.content=o.join(`
`),x()},a=(c=null,l=null)=>{if(t.innerHTML="",o.forEach((u,f)=>{let I=s(u,f);t.appendChild(I)}),requestAnimationFrame(()=>{t.querySelectorAll(".text-block-line").forEach(u=>{m(u)})}),c!==null){let u=t.querySelector(`.text-block-line[data-line-index="${c}"]`);u&&d(u,l)}},s=(c,l)=>{let u=document.createElement("div");u.className="text-block-line",u.dataset.lineIndex=String(l);let f=document.createElement("div");f.className="text-block-line-preview",o.length===1&&!o[0]?.trim()?(f.classList.add("text-block-line-placeholder"),f.textContent="Type something... (type / for commands)"):f.appendChild(zt(c));let p=document.createElement("textarea");return p.className="text-line-input",p.value=c,p.rows=1,p.placeholder="Type something... (type / for commands)",f.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),d(u)}),u.addEventListener("click",g=>{u.classList.contains("is-editing")||(g.preventDefault(),g.stopPropagation(),d(u))}),p.addEventListener("input",()=>{let g=p.value;if(H.handleTextareaInput(p,n),g.includes(`
`)){let ie=g.split(`
`);o.splice(l,1,...ie),r();let Ve=ie[ie.length-1]??"";a(l+ie.length-1,Ve.length);return}o[l]=g,r(),m(u)}),p.addEventListener("keydown",g=>{if(!(H.isActive()&&H.handleKeydown(g))){if(Ge(g,p,x)){o[l]=p.value,r(),m(u);return}if(!Xe(g,p,x)){if(g.key==="Enter"&&!g.shiftKey&&!g.metaKey&&!g.ctrlKey){g.preventDefault(),L(p,l);return}if(g.key==="Backspace"&&p.selectionStart===0&&p.selectionEnd===0){l>0&&(g.preventDefault(),y(l));return}if(g.key==="Delete"&&p.selectionStart===p.value.length&&p.selectionEnd===p.value.length){l<o.length-1&&(g.preventDefault(),B(l));return}if(g.key==="ArrowUp"&&p.selectionStart===0&&p.selectionEnd===0){l>0&&(g.preventDefault(),a(l-1,o[l-1]?.length??0));return}g.key==="ArrowDown"&&p.selectionStart===p.value.length&&p.selectionEnd===p.value.length&&l<o.length-1&&(g.preventDefault(),a(l+1,0))}}}),p.addEventListener("blur",()=>{i===l&&v(u)}),u.appendChild(f),u.appendChild(p),u},d=(c,l=null)=>{let u=Number(c.dataset.lineIndex);if(i!==null&&i!==u){let I=t.querySelector(`.text-block-line[data-line-index="${i}"]`);I&&v(I)}i=u,c.classList.add("is-editing");let f=c.querySelector(".text-line-input");f&&(f.focus(),l&&typeof l=="object"?(f.selectionStart=l.start,f.selectionEnd=l.end??l.start):typeof l=="number"?(f.selectionStart=l,f.selectionEnd=l):f.selectionStart=f.selectionEnd=f.value.length,m(c))},v=c=>{let l=c.querySelector(".text-line-input"),u=c.querySelector(".text-block-line-preview");c.classList.remove("is-editing");let f=l?.value??"";u?.classList.remove("text-block-line-placeholder"),u&&(u.innerHTML=""),o.length===1&&!o[0]?.trim()&&!f.trim()?(u?.classList.add("text-block-line-placeholder"),u&&(u.textContent="Type something... (type / for commands)")):u&&u.appendChild(zt(f)),i=null,m(c)},L=(c,l)=>{let u=c.value,f=c.selectionStart,I=u.slice(0,f),p=u.slice(f),g=S(I);o[l]=I;let ie=g?g+p.replace(/^\s+/,""):p;o.splice(l+1,0,ie),r();let Ve=g?g.length:0;a(l+1,Ve)},y=c=>{if(c<=0)return;let l=o[c-1]??"",u=o[c]??"",f=l+u;o.splice(c-1,2,f),r(),a(c-1,l.length)},B=c=>{if(c>=o.length-1)return;let l=o[c]??"",u=o[c+1]??"",f=l+u;o.splice(c,2,f),r(),a(c,l.length)},m=c=>{let l=c.querySelector(".text-block-line-preview"),u=c.querySelector(".text-line-input");requestAnimationFrame(()=>{let f=l?.offsetHeight??0,I=u?.scrollHeight??0,p=Math.max(27,f);c.style.minHeight=`${p}px`,c.classList.contains("is-editing")?c.style.height=`${Math.max(p,I)}px`:c.style.height=""})},S=c=>{let l=c.match(/^(\s*)([-*+])\s+/);if(l)return`${l[1]??""}${l[2]??"-"} `;let u=c.match(/^(\s*)(\d+)\.\s+/);if(u){let f=parseInt(u[2]??"1",10)+1;return`${u[1]??""}${f}. `}return null};return a(),t}function zt(e){let n=e.trim();if(!n){let r=document.createElement("span");return r.innerHTML="&nbsp;",r}if(/^(\*{3,}|-{3,}|_{3,})$/.test(n)){let r=document.createElement("hr");return r.className="text-line-divider",r}let t=e.match(/^(\s*)(#{1,6})\s+(.*)$/);if(t){let r=t[2]?.length??1,a=document.createElement(`h${r}`);return a.appendChild(at(t[3]??"")),a}let o=e.match(/^(\s*)>\s+(.*)$/);if(o){let r=document.createElement("blockquote");return r.appendChild(at(o[2]??"")),r}let i=document.createElement("span");return i.appendChild(at(e)),i}function at(e){let n=document.createDocumentFragment(),t=/\[([^\]]+)\]\(([^)]+)\)/g,o=0,i;for(;(i=t.exec(e))!==null;){let r=i.index;r>o&&st(n,e.slice(o,r));let a=go(i[2]??"");if(a){let s=document.createElement("a");s.href=a,s.rel="noopener",s.target="_blank",st(s,i[1]??""),n.appendChild(s)}else n.appendChild(document.createTextNode(i[0]));o=r+i[0].length}return o<e.length&&st(n,e.slice(o)),n}function st(e,n){e.appendChild(po(n))}function po(e){let n=document.createDocumentFragment();return n.appendChild(document.createTextNode(e)),n}function go(e){let n=(e||"").trim();if(!n)return null;if(n.startsWith("#")||n.startsWith("/")||n.startsWith("./")||n.startsWith("../"))return n;try{let t=new URL(n,window.location.origin);if(["http:","https:","mailto:","tel:"].includes(t.protocol))return t.href}catch{return null}return null}function ho(e,n){let t=document.createElement("div");if(t.className="image-block-wrapper",e.src){let o=qe(e,r=>{R.select(r,e)});o.className="block-image",t.appendChild(o);let i=document.createElement("input");i.type="text",i.className="image-alt-input",i.placeholder="Image description...",i.value=e.alt||"",i.addEventListener("input",()=>{let r=E[n];r&&r.type==="image"&&(r.alt=i.value,x())}),t.appendChild(i)}else t.appendChild(Jt(n,"image"));return t}function vo(e,n){let t=document.createElement("div");if(t.className="video-block-wrapper",e.src){let o=ze(e);o.className="block-video",t.appendChild(o)}else t.appendChild(Jt(n,"video"));return t}function Eo(e,n){let t=document.createElement("div");t.className="code-block-wrapper";let o=document.createElement("select");o.className="code-language-select",["javascript","python","html","css","bash","json","sql","go","rust","text"].forEach(a=>{let s=document.createElement("option");s.value=a,s.textContent=a,a===(e.language||"javascript")&&(s.selected=!0),o.appendChild(s)}),o.addEventListener("change",()=>{let a=E[n];a&&a.type==="code"&&(a.language=o.value,x())}),t.appendChild(o);let r=document.createElement("textarea");return r.className="code-textarea",r.value=e.code||"",r.placeholder="Enter code...",r.spellcheck=!1,de(r,a=>{let s=E[n];s&&s.type==="code"&&(s.code=a,x())}),r.addEventListener("keydown",a=>{a.key==="Tab"&&(a.preventDefault(),$(r,"    "),r.dispatchEvent(new Event("input",{bubbles:!0})))}),t.appendChild(r),t}function yo(e,n){let t=document.createElement("div");t.className="callout-block-wrapper";let o=document.createElement("textarea");return o.className="callout-textarea",o.value=e.content||"",o.placeholder="Callout content...",e.align&&(o.style.textAlign=e.align),de(o,i=>{let r=E[n];r&&r.type==="callout"&&(r.content=i,x())}),t.appendChild(o),t}function wo(e,n){let t=document.createElement("div");t.className="row-block-wrapper";let o=document.createElement("div");o.className="row-column row-column-left",o.appendChild(lt(e.left,n));let i=document.createElement("div");return i.className="row-column row-column-right",i.appendChild(lt(e.right,n)),t.appendChild(o),t.appendChild(i),t}function bo(){let e=document.createElement("hr");return e.className="block-divider",e}function To(e,n){let t=document.createElement("div");t.className="html-block-wrapper",e.align&&(t.style.textAlign=e.align);let o=document.createElement("div");o.className="html-block-preview",o.innerHTML=e.html||'<p style="color: #666;">Empty HTML block</p>',t.appendChild(o);let i=document.createElement("button");i.className="html-toggle-btn",i.textContent="Edit HTML",i.type="button",t.appendChild(i);let r=document.createElement("textarea");r.className="html-textarea",r.value=e.html||"",r.placeholder="Enter raw HTML...",r.style.display="none",t.appendChild(r);let a=!1;return i.addEventListener("click",()=>{a=!a,a?(o.style.display="none",r.style.display="block",i.textContent="Preview",r.focus()):(o.style.display="block",r.style.display="none",i.textContent="Edit HTML",o.innerHTML=r.value||'<p style="color: #666;">Empty HTML block</p>')}),de(r,s=>{let d=E[n];d&&d.type==="html"&&(d.html=s,x())}),t}function So(e){let n=document.createElement("div");n.className="merge-divider",n.dataset.afterIndex=String(e);let t=document.createElement("button");return t.className="merge-add-btn",t.innerHTML="+",t.title="Add block",t.addEventListener("click",()=>{let o=t.getBoundingClientRect();H.showFromButton(o,e,t)}),n.appendChild(t),n}function ko(e){let n=document.createElement("div");n.className="add-block-wrapper";let t=document.createElement("button");return t.className="merge-add-btn",t.innerHTML="+",t.title="Add block",t.addEventListener("click",()=>{let o=t.getBoundingClientRect();H.showFromButton(o,e,t)}),n.appendChild(t),n}function Jt(e,n){let t=document.createElement("div");t.className="upload-zone",t.innerHTML=`
    <div class="upload-icon">${n==="image"?"\u{1F5BC}":"\u{1F3AC}"}</div>
    <div class="upload-text">Drop ${n} here or click to upload</div>
    <input type="file" class="upload-input" accept="${n==="image"?"image/*":"video/*"}">
  `;let o=t.querySelector(".upload-input");return o.addEventListener("change",async()=>{let i=o.files?.[0];i&&(n==="image"?await R.handleImageUploadForBlock(i,e):await R.handleVideoUploadForBlock(i,e))}),t.addEventListener("click",i=>{i.target!==o&&o.click()}),t.addEventListener("dragover",i=>{i.preventDefault(),t.classList.add("drag-over")}),t.addEventListener("dragleave",()=>{t.classList.remove("drag-over")}),t.addEventListener("drop",async i=>{i.preventDefault(),t.classList.remove("drag-over");let r=i.dataTransfer?.files[0];r&&(n==="image"?await R.handleImageUploadForBlock(r,e):await R.handleVideoUploadForBlock(r,e))}),t}function xo(e,n){A.sourceIndex=n,A.isDragging=!0;let t=X?.querySelector(`[data-block-index="${n}"]`);t&&t.classList.add("dragging"),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",n.toString()))}function Yt(){A.isDragging=!1,A.sourceIndex=null,A.currentDropIndex=null,X?.querySelectorAll(".dragging, .drag-over-top, .drag-over-bottom").forEach(e=>{e.classList.remove("dragging","drag-over-top","drag-over-bottom")})}function Lo(e,n){if(e.preventDefault(),!A.isDragging)return;let t=e.currentTarget,o=t.getBoundingClientRect(),i=o.top+o.height/2;X?.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(r=>{r.classList.remove("drag-over-top","drag-over-bottom")}),e.clientY<i?(t.classList.add("drag-over-top"),A.currentDropIndex=n):(t.classList.add("drag-over-bottom"),A.currentDropIndex=n+1)}function Bo(e){e.currentTarget.classList.remove("drag-over-top","drag-over-bottom")}function Mo(e,n){if(e.preventDefault(),!A.isDragging||A.sourceIndex===null)return;let t=A.sourceIndex,o=A.currentDropIndex;if(o!==null){if(t<o&&o--,t!==o){let[i]=E.splice(t,1);i&&(E.splice(o,0,i),x(),F())}Yt()}}function ct(e,n){let t=N(n);E.splice(e,0,t),x(),F(),(n==="text"||n==="callout")&&setTimeout(()=>{let o=X?.querySelector(`[data-block-index="${e}"] .text-line-input, [data-block-index="${e}"] .block-textarea, [data-block-index="${e}"] .callout-textarea`);o&&o.focus()},50)}function Qt(e,n){let t=E.findIndex(o=>o.id===e);t!==-1&&ct(t+1,n)}function Zt(e){E.length<=1?E[0]=N("text"):E.splice(e,1),x(),F()}function Co(e,n){if(e==="execute"){let t=n;if(t.replaceBlockIndex!==null){let o=t.replaceBlockIndex;E[o]=N(t.commandId),x(),F(),(t.commandId==="text"||t.commandId==="callout")&&setTimeout(()=>{let i=X?.querySelector(`[data-block-index="${o}"] .text-line-input, [data-block-index="${o}"] .block-textarea, [data-block-index="${o}"] .callout-textarea`);i&&i.focus()},50)}else ct(t.insertIndex,t.commandId)}else if(e==="updateContent"){let t=n,o=E[t.index];o&&"content"in o&&(o.content=t.content)}}function en(e){ce&&(H.isActive()&&H.handleKeydown(e)||((e.metaKey||e.ctrlKey)&&e.key==="s"&&(e.preventDefault(),We()),e.key==="Escape"&&(e.preventDefault(),e.stopPropagation(),_e())))}function x(){q=!0,G("pending"),lo()}async function We(){if(!q&&oe!=="error"){Ue(),window.location.reload();return}z&&(clearTimeout(z),z=null),_&&(clearTimeout(_),_=null),U&&U.abort(),G("saving");try{let e=Ie(E),n;if(P==="about")n=await fetch("/api/save-about",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({markdown:e})});else{let t={slug:be,name:W?.title||"",date:W?.created_at||"",pinned:!1,draft:W?.status==="draft",youtube:"",video:"",markdown:e};n=await fetch("/api/save-project",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}if(!n.ok)throw new Error(`Save failed: ${n.status}`);q=!1,G("saved"),Ue(),window.location.reload()}catch(e){console.error("Save error:",e),G("error"),w("Failed to save","error")}}function _e(){q&&!confirm("You have unsaved changes. Discard them?")||(Ue(),window.location.reload())}function tn(e,n){let t=E[e];t&&(Object.assign(t,n),x(),F())}var Do={init:ro,initAbout:ao,cleanup:Ue,get blocks(){return E},get isActive(){return ce},get isDirty(){return q},get projectSlug(){return be},get editMode(){return P},insertBlock:ct,insertBlockAfter:Qt,deleteBlock:Zt,updateBlock:tn,renderBlocks:F,markDirty:x,save:We,cancel:_e},nn=Do;var on="bb_show_drafts";function dt(){return document.body.dataset.isolationMode==="true"}function Fe(e,n={}){let t=new URL(e,window.location.origin);return Object.entries(n).forEach(([o,i])=>{i!=null&&t.searchParams.set(o,i)}),K()&&t.searchParams.set("show_drafts","true"),t.toString()}function ut(){if(document.querySelector('link[href*="edit-mode.css"]'))return;let e=document.createElement("link");e.rel="stylesheet",e.href="/static/css/edit-mode.css",document.head.appendChild(e)}function V(){return new Promise(e=>{ut(),e()})}function rn(e){let n=e.dataset.slug;if(!n||e.querySelector(".edit-buttons"))return;let t=document.createElement("div");t.className="edit-buttons";let o=document.createElement("button");o.className="edit-btn-action",o.textContent="Edit",o.addEventListener("click",async r=>{if(r.preventDefault(),r.stopPropagation(),!dt()){window.location.href=Fe(`/${n}`,{edit:""});return}window.EditMode||await V(),window.EditMode?.init(n)});let i=document.createElement("button");i.className="edit-btn-action edit-btn-settings",i.innerHTML="&#9881;",i.title="Project Settings",i.addEventListener("click",async r=>{r.preventDefault(),r.stopPropagation(),window.ProjectSettings||await V(),window.ProjectSettings?.show?.(n)}),t.appendChild(o),t.appendChild(i),e.appendChild(t)}function Ho(e){let n=e.querySelector(".edit-buttons");n&&n.remove()}function Ao(){let e=document.querySelector("#main-header nav");if(!e||e.querySelector(".new-project-btn"))return;let n=window.location.pathname==="/me",t=document.createElement("button");t.className="new-project-btn",t.textContent=n?"Edit":"+ New Project",t.addEventListener("click",async o=>{o.preventDefault(),n?(window.EditMode||await V(),window.EditMode&&window.EditMode.initAbout()):(window.ProjectCreate||await V(),window.ProjectCreate?.show?.())}),e.insertBefore(t,e.firstChild)}function Io(){if(window.location.pathname!=="/")return;let e=document.querySelector("#main-header nav");if(!e||e.querySelector(".show-drafts-toggle"))return;let n=K(),t=document.createElement("button");t.className="show-drafts-toggle"+(n?" active":""),t.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" style="width:14px;height:14px;vertical-align:-2px;margin-right:5px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Drafts',t.addEventListener("click",i=>{i.preventDefault();let r=new URL(window.location.href);n?(r.searchParams.delete("show_drafts"),sessionStorage.removeItem(on)):(r.searchParams.set("show_drafts","true"),sessionStorage.setItem(on,"true")),window.location.href=r.toString()});let o=e.querySelector(".new-project-btn");o?e.insertBefore(t,o):e.insertBefore(t,e.firstChild)}function No(){document.addEventListener("keydown",async function(e){if((e.metaKey||e.ctrlKey)&&e.key==="e"){if(document.body.classList.contains("editing"))return;let n=document.activeElement;if(n&&(n.tagName==="INPUT"||n.tagName==="TEXTAREA"))return;if(e.preventDefault(),window.location.pathname==="/me"){let i=new URL(window.location.href);i.searchParams.set("edit",""),window.history.replaceState({},"",i),window.EditMode||await V(),window.EditMode&&window.EditMode.initAbout();return}let o=document.querySelector(".project-item.active");if(o){let i=o.dataset.slug;if(i){if(!dt()){window.location.href=Fe(`/${i}`,{edit:""});return}window.EditMode||await V(),window.EditMode?.init(i)}}}})}function an(){if(K(),window.location.pathname==="/"&&!new URLSearchParams(window.location.search).has("show_drafts")&&K()){let n=new URL(window.location.href);n.searchParams.set("show_drafts","true"),window.location.replace(n.toString());return}if(ut(),Ao(),Io(),document.querySelectorAll(".project-item.active").forEach(rn),document.body.addEventListener("project:afterSwap",e=>{let n=e,{element:t,isOpen:o}=n.detail;if(t?.classList?.contains("project-details")){let i=t.closest(".project-item");i&&(o?setTimeout(()=>rn(i),50):Ho(i))}}),dt()){let e=new URLSearchParams(window.location.search),t=document.querySelector(".project-item.active")?.dataset.slug;t&&(e.has("edit")?setTimeout(async()=>{window.EditMode||await V(),window.EditMode?.init(t)},100):e.has("settings")&&(window.history.replaceState({},"",Fe(`/${t}`)),setTimeout(async()=>{window.ProjectSettings||await V(),window.ProjectSettings?.show?.(t)},100)))}window.location.pathname==="/me"&&new URLSearchParams(window.location.search).has("edit")&&setTimeout(async()=>{window.EditMode||await V(),window.EditMode&&window.EditMode.initAbout()},100),No()}function Ro(){re()&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",an):an())}var Po={init:Ro,loadEditModeScripts:V,loadEditModeCSS:ut,isShowDraftsActive:K,buildUrlWithShowDrafts:Fe},sn=Po;typeof window<"u"&&(window.EditUtils=ht,window.EditBlocks=Ne,window.EditMode=nn,window.EditMedia=R,window.EditSlash=H,window.EditUndo=Oe);sn.init();})();
//# sourceMappingURL=edit-bundle.js.map
