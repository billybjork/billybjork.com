// Auto-generated by esbuild - do not edit directly

"use strict";(()=>{function Ri(e){let t=[{label:"Top of page",anchor:"#hero"}];return e.querySelectorAll("h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]").forEach(n=>{t.push({label:n.textContent?.trim()||n.id,anchor:`#${n.id}`})}),t}function Sn(e){return new Promise(t=>{let{existingUrl:n,container:i}=e,o=Ri(i),r=!!n,s=document.createElement("div");s.className="link-dialog-backdrop";let l=document.createElement("div");l.className="link-dialog";let a=document.createElement("div");a.className="link-dialog-header",a.textContent=r?"Edit Link":"Insert Link";let c=document.createElement("input");c.type="text",c.className="link-dialog-url",c.placeholder="Paste or type a URL...",c.value=n||"";let u=document.createElement("div");u.className="link-dialog-divider",u.textContent="or link to a section";let d=document.createElement("div");d.className="link-dialog-sections",o.forEach(({label:x,anchor:I})=>{let C=document.createElement("button");C.type="button",C.className="link-dialog-section",C.textContent=x,C.addEventListener("click",()=>{w(),t({action:"insert",url:I})}),d.appendChild(C)});let v=document.createElement("div");v.className="link-dialog-actions";let p=document.createElement("button");p.type="button",p.className="edit-btn edit-btn-secondary",p.textContent="Cancel",p.addEventListener("click",()=>{w(),t({action:"cancel"})});let g=document.createElement("button");if(g.type="button",g.className="edit-btn edit-btn-primary",g.textContent=r?"Update":"Insert",g.addEventListener("click",()=>{let x=c.value.trim();x&&(w(),t({action:"insert",url:x}))}),v.appendChild(p),r){let x=document.createElement("button");x.type="button",x.className="edit-btn edit-btn-secondary",x.textContent="Remove Link",x.addEventListener("click",()=>{w(),t({action:"remove"})}),v.appendChild(x)}v.appendChild(g),l.appendChild(a),l.appendChild(c),l.appendChild(u),l.appendChild(d),l.appendChild(v),s.appendChild(l);let w=()=>{s.classList.remove("visible"),setTimeout(()=>{s.remove(),Be(),document.removeEventListener("keydown",T)},150)},T=x=>{if(x.key==="Escape")x.preventDefault(),w(),t({action:"cancel"});else if(x.key==="Enter"&&document.activeElement===c){x.preventDefault();let I=c.value.trim();I&&(w(),t({action:"insert",url:I}))}};s.addEventListener("click",x=>{x.target===s&&(w(),t({action:"cancel"}))}),document.body.appendChild(s),He(),document.addEventListener("keydown",T),requestAnimationFrame(()=>{s.classList.add("visible"),c.focus(),n&&c.select()})})}var Tn="edit-notification-stack";function Ni(){return"block-"+Date.now()+"-"+Math.random().toString(36).substring(2,11)}function Pe(){return document.body?.dataset.editMode==="true"}function ji(){return document.body?.classList.contains("editing")===!0}function de(){let e="bb_show_drafts",t=new URLSearchParams(window.location.search);if(t.has("show_drafts")){let n=t.get("show_drafts")==="true";return n?sessionStorage.setItem(e,"true"):sessionStorage.removeItem(e),n}return sessionStorage.getItem(e)==="true"}function _e(e){try{let t=new URL(e,window.location.origin);return de()&&t.searchParams.set("show_drafts","true"),t.toString()}catch{return e}}var qe="data-scroll-lock-count",Ct="data-scroll-lock-y";function He(){let e=document.body,t=Number(e.getAttribute(qe)||"0");if(t===0){let n=window.scrollY||window.pageYOffset||0;e.setAttribute(Ct,String(n)),e.classList.add("modal-open"),e.style.position="fixed",e.style.top=`-${n}px`,e.style.left="0",e.style.right="0",e.style.width="100%",e.style.overflow="hidden"}e.setAttribute(qe,String(t+1))}function Be(){let e=document.body,t=Number(e.getAttribute(qe)||"0");if(t<=0){e.classList.remove("modal-open");return}if(t>1){e.setAttribute(qe,String(t-1));return}let n=Number(e.getAttribute(Ct)||"0");e.removeAttribute(qe),e.removeAttribute(Ct),e.classList.remove("modal-open"),e.style.position="",e.style.top="",e.style.left="",e.style.right="",e.style.width="",e.style.overflow="";let i=document.documentElement,o=i.style.scrollBehavior;i.style.scrollBehavior="auto",window.scrollTo({top:n,left:0,behavior:"auto"}),requestAnimationFrame(()=>{o?i.style.scrollBehavior=o:i.style.removeProperty("scroll-behavior")})}function Ve(e,t){let n=()=>{e.style.height="auto",e.style.height=e.scrollHeight+"px"};return e.addEventListener("input",()=>{n(),t&&t(e.value)}),n(),requestAnimationFrame(n),n}function Ht(e,t){let n=document.createElement("img");return n.src=e.src,n.alt=e.alt||"",e.style&&n.setAttribute("style",e.style),e.align&&Pt(n,e.align),t&&n.addEventListener("click",i=>{i.stopPropagation(),t(n,e)}),n}function Bt(e,t){let n=document.createElement("video");return n.src=e.src,e.poster&&(n.poster=e.poster,n.setAttribute("poster",e.poster)),n.className="content-video",ct(n,!!e.autoplay),e.style&&n.setAttribute("style",e.style),e.align&&Pt(n,e.align),t&&n.addEventListener("click",i=>{i.stopPropagation(),t(n,e)}),n}function ct(e,t){let n=ji();e.loop=t,e.muted=t,e.defaultMuted=t,e.playsInline=n||t,e.controls=n||!t,e.autoplay=!n&&t,e.autoplay?e.setAttribute("autoplay",""):e.removeAttribute("autoplay"),t?e.setAttribute("muted",""):e.removeAttribute("muted"),e.playsInline?e.setAttribute("playsinline",""):e.removeAttribute("playsinline"),n&&e.pause()}function Pt(e,t){e.style.display="block",e.style.marginLeft="",e.style.marginRight="",t==="center"?(e.style.marginLeft="auto",e.style.marginRight="auto"):t==="right"&&(e.style.marginLeft="auto")}function Ln(e){switch(e){case"center":return"margin-left: auto; margin-right: auto";case"right":return"margin-left: auto";default:return""}}function We(e){if(!e)return"left";let t=e.includes("margin-left: auto")||e.includes("margin-left:auto"),n=e.includes("margin-right: auto")||e.includes("margin-right:auto");return t&&n?"center":t?"right":"left"}function ze(e){let t=["display: block"];if(e.style){let i=e.style.replace(/margin-left:\s*auto;?\s*/g,"").replace(/margin-right:\s*auto;?\s*/g,"").replace(/display:\s*block;?\s*/g,"").trim();i&&t.push(i)}let n=Ln(e.align??"left");return n&&t.push(n),t.join("; ")}function G(e,t){if(e.focus({preventScroll:!0}),!document.execCommand("insertText",!1,t)){let n=e.selectionStart,i=e.selectionEnd;e.setRangeText(t,n,i,"end")}}function xn(e,t,n,i){let o=e.selectionStart,r=e.selectionEnd,s=e.value.substring(o,r)||"text",l=t+s+n;e.focus({preventScroll:!0}),e.setSelectionRange(o,r),G(e,l),e.selectionStart=o+t.length,e.selectionEnd=o+t.length+s.length,i&&i()}function $i(e,t,n,i,o){let r=e.lastIndexOf(`
`,t-1)+1,s=e.indexOf(`
`,n),l=s===-1?e.length:s,a=-1;for(let p=t;p>=r;p--)if(e.substring(p,p+i.length)===i){let g=p>0?e[p-1]:"";if(i!=="**"||g!=="*"){a=p;break}}if(a===-1)return null;let c=-1,u=Math.max(a+i.length,n);for(let p=u;p<=l-o.length;p++)if(e.substring(p,p+o.length)===o){let g=p+o.length<e.length?e[p+o.length]:"";if(o!=="**"||g!=="*"){c=p;break}}if(c===-1)return null;let d=a+i.length,v=c;return t>=d&&n<=v?{formatStart:a,formatEnd:c+o.length,innerStart:d,innerEnd:v}:null}function at(e,t,n,i){let{value:o,selectionStart:r,selectionEnd:s}=e,l=$i(o,r,s,t,n);if(l){let{formatStart:a,formatEnd:c,innerStart:u,innerEnd:d}=l,v=o.substring(u,d);e.focus({preventScroll:!0}),e.setSelectionRange(a,c),G(e,v),e.selectionStart=a,e.selectionEnd=a+v.length}else xn(e,t,n,()=>{});i&&i()}function _t(e,t,n,i){if(!(e.metaKey||e.ctrlKey))return!1;switch(e.key){case"b":return e.preventDefault(),at(t,"**","**",n),!0;case"i":return e.preventDefault(),at(t,"*","*",n),!0;case"u":return e.preventDefault(),at(t,"<u>","</u>",n),!0;case"k":return e.preventDefault(),dt(t,i??null,n),!0}return!1}function kn(e){let{value:t,selectionStart:n}=e,i=-1;for(let a=n;a>=Math.max(0,n-500);a--){if(t[a]==="["){i=a;break}if(t[a]===`
`||t[a]===")")break}if(i===-1)return null;let r=t.substring(i).match(/^\[([^\]]*)\]\(([^)]*)\)/);if(!r)return null;let s=r[0],l=i+s.length;return n>l?null:{start:i,end:l,text:r[1]??"",url:r[2]??"",textStart:i+1,textEnd:i+1+(r[1]?.length??0),urlStart:i+(r[1]?.length??0)+3,urlEnd:l-1}}function Ui(e){let t=(e||"").trim();return t?t.startsWith("#")||t.startsWith("/")||t.startsWith("./")||t.startsWith("../")||/^[a-zA-Z][a-zA-Z\d+.-]*:/.test(t)?t:/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(t)?`mailto:${t}`:/^(?:www\.)?[\w-]+(?:\.[\w-]+)+(?::\d+)?(?:[/?#]|$)/.test(t)?`https://${t}`:t:""}async function dt(e,t,n){let i=kn(e),o=e.selectionStart,r=e.selectionEnd,s=e.value.substring(o,r)||"link text",l=await Sn({existingUrl:i?.url,container:t??document.body});if(l.action!=="cancel"){if(l.action==="remove"&&i)e.focus({preventScroll:!0}),e.setSelectionRange(i.start,i.end),G(e,i.text);else if(l.action==="insert"&&l.url){let a=Ui(l.url);if(!a)return;if(i){let c=`[${i.text}](${a})`;e.focus({preventScroll:!0}),e.setSelectionRange(i.start,i.end),G(e,c)}else{let c=`[${s}](${a})`;e.focus({preventScroll:!0}),e.setSelectionRange(o,r),G(e,c)}}n&&n()}}function It(e){return!e||e==="left"?"":`text-align: ${e}`}function ut(e){return e?e.match(/text-align:\s*(left|center|right)/)?.[1]??"left":"left"}function Fi(e,t){let{value:n,selectionStart:i,selectionEnd:o}=e,r="   ",s=n.lastIndexOf(`
`,i-1)+1,l=n.indexOf(`
`,o);l===-1&&(l=n.length);let a=n.substring(0,s),c=n.substring(s,l),u=n.substring(l),d=c.split(`
`).map(p=>{let g=p.match(/^(\s*)\d+\.\s(.*)$/);return g?r+(g[1]??"")+"- "+(g[2]??""):r+p}).join(`
`);e.value=a+d+u;let v=d.length-c.length;e.selectionStart=i+r.length,e.selectionEnd=o+v,e.dispatchEvent(new Event("input",{bubbles:!0})),t&&t()}function Oi(e,t){let{value:n,selectionStart:i,selectionEnd:o}=e,r=n.lastIndexOf(`
`,i-1)+1,s=n.indexOf(`
`,o);s===-1&&(s=n.length);let l=n.substring(0,r),a=n.substring(r,s),c=n.substring(s),u=0,d=0,v=a.split(`
`).map((p,g)=>{let w=p.match(/^( {1,4}|\t)/);if(w){let T=w[0].length;return g===0&&(u=T),d+=T,p.substring(T)}return p}).join(`
`);e.value=l+v+c,e.selectionStart=Math.max(r,i-u),e.selectionEnd=o-d,e.dispatchEvent(new Event("input",{bubbles:!0})),t&&t()}function qi(e,t,n){let{value:i,selectionStart:o,selectionEnd:r}=t;if(o!==r)return!1;let s=i.lastIndexOf(`
`,o-1)+1,l=i.indexOf(`
`,o),a=i.substring(s,l===-1?i.length:l),c=a.match(/^(\s*)([-*+])\s(.*)$/);if(c){let[,d="",v="-",p=""]=c;if(p.trim()===""){e.preventDefault();let w=i.substring(0,s),T=i.substring(l===-1?i.length:l);return t.value=w+T,t.selectionStart=t.selectionEnd=s,t.dispatchEvent(new Event("input",{bubbles:!0})),n&&n(),!0}e.preventDefault();let g=`
${d}${v} `;return G(t,g),t.dispatchEvent(new Event("input",{bubbles:!0})),n&&n(),!0}let u=a.match(/^(\s*)(\d+)\.\s(.*)$/);if(u){let[,d="",v="1",p=""]=u;if(p.trim()===""){e.preventDefault();let T=i.substring(0,s),x=i.substring(l===-1?i.length:l);return t.value=T+x,t.selectionStart=t.selectionEnd=s,t.dispatchEvent(new Event("input",{bubbles:!0})),n&&n(),!0}e.preventDefault();let g=parseInt(v,10)+1,w=`
${d}${g}. `;return G(t,w),t.dispatchEvent(new Event("input",{bubbles:!0})),n&&n(),!0}return!1}function Dt(e,t,n){return e.key==="Tab"&&!e.shiftKey?(e.preventDefault(),Fi(t,n),!0):e.key==="Tab"&&e.shiftKey?(e.preventDefault(),Oi(t,n),!0):!!(e.key==="Enter"&&!e.shiftKey&&!e.metaKey&&!e.ctrlKey&&qi(e,t,n))}function E(e,t="info",n=3e3){let i=document.getElementById(Tn);i||(i=document.createElement("div"),i.id=Tn,i.className="edit-notification-stack",document.body.appendChild(i));let o=document.createElement("div");o.className=`edit-notification edit-notification-${t}`,o.textContent=e,i.appendChild(o),requestAnimationFrame(()=>{o.classList.add("show")}),setTimeout(()=>{o.classList.remove("show"),setTimeout(()=>{o.remove(),i&&i.childElementCount===0&&i.remove()},300)},n)}function pt(e){return JSON.parse(JSON.stringify(e))}function Vi(e){let t=e.textContent?.trim()??"",n=e.innerHTML.trim();return t===""||n===""||n==="<br>"}function Wi(e){let t=document.createRange(),n=window.getSelection();n&&(t.selectNodeContents(e),t.collapse(!1),n.removeAllRanges(),n.addRange(t))}async function K(e,t={}){let n=await fetch(e,{...t,headers:{"Content-Type":"application/json",...t.headers}});if(!n.ok){let i="";try{i=(await n.json()).detail||""}catch{}throw new Error(i||`HTTP error! status: ${n.status}`)}return await n.json()}function zi(e,t){let n;return function(...o){let r=()=>{clearTimeout(n),e(...o)};clearTimeout(n),n=setTimeout(r,t)}}var Ki={generateId:Ni,isDevMode:Pe,isShowDraftsActive:de,withShowDrafts:_e,setupAutoResizeTextarea:Ve,createImageElement:Ht,createVideoElement:Bt,applyVideoPlaybackSettings:ct,applyAlignment:Pt,getAlignmentStyle:Ln,parseAlignmentFromStyle:We,buildMediaStyleString:ze,insertTextWithUndo:G,wrapSelection:xn,toggleFormat:at,handleFormattingShortcuts:_t,findLinkAtCursor:kn,insertLink:dt,getTextAlignmentStyle:It,parseTextAlignmentFromStyle:ut,handleListShortcuts:Dt,showNotification:E,deepClone:pt,isElementEmpty:Vi,moveCaretToEnd:Wi,fetchJSON:K,debounce:zi};var Nt="<!-- block -->",ht="<!-- row -->",ft="<!-- /row -->",jt="<!-- col -->",Mn="<!-- html -->",Cn="<!-- /html -->",Xi=/^<!--\s*html(?:\s+style="([^"]*)")?\s*-->\s*([\s\S]*?)\s*<!--\s*\/html\s*-->$/,Yi=/\n*<p\s+class=(["'])media-caption\1>([\s\S]*?)<\/p>\s*$/i;function Ie(e){return`block-${Date.now()}-${e}-${Math.random().toString(36).substring(2,7)}`}function Gi(e){return e&&e.replace(/&quot;/g,'"').trim()||null}function Ji(e){return e.replace(/"/g,"&quot;")}function Zi(e){let t=(e??"").trim();return t?`<!-- html style="${Ji(t)}" -->`:Mn}function Qi(e){return e==="image"||e==="video"||e==="html"}function eo(e){return e.replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")}function to(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function no(e){let t=e.match(Yi);if(!t)return{content:e,caption:null};let n=t.index??e.length;return{content:e.slice(0,n).trim(),caption:eo((t[2]??"").trim())}}function $t(e){let t=(e??"").trim();return t?`
<p class="media-caption">${to(t)}</p>`:""}function At(e,t){let n=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(`\\b${n}\\s*=\\s*(?:"([^"]*)"|'([^']*)')`,"i"),o=e.match(i);return o?((o[1]??o[2]??"")||"").trim():null}function io(e){let t=e.match(/<source\b[^>]*\bsrc\s*=\s*(?:"([^"]*)"|'([^']*)')/i);return((t?.[1]??t?.[2]??"")||"").trim()}function Rt(e,t){let n=t.match(Xi);if(n){if(e.type="html",e.style=Gi(n[1]),e.html=(n[2]??"").trim(),e.align=We(e.style),e.align==="left"){let i=e.html.match(/^<div\b[^>]*\bstyle\s*=\s*["'][^"']*\btext-align\s*:\s*(center|right)\b[^"']*["'][^>]*>[\s\S]*<\/div>$/i);i&&(e.align=i[1])}return}if(t.startsWith("```")){e.type="code";let i=t.match(/^```(\w*)\n?([\s\S]*?)\n?```$/);i?(e.language=i[1]||"text",e.code=i[2]||""):(e.language="text",e.code=t.replace(/^```\w*\n?/,"").replace(/\n?```$/,""));return}if(t.startsWith("<img")||/^!\[.*?\]\(.*?\)$/.test(t)){if(e.type="image",t.startsWith("<img")){let i=t.match(/src="([^"]*)"/),o=t.match(/alt="([^"]*)"/),r=t.match(/style="([^"]*)"/);e.src=i?.[1]??"",e.alt=o?.[1]??"",e.style=r?.[1]??null,e.align=We(e.style)}else{let i=t.match(/!\[(.*?)\]\((.*?)\)/);e.src=i?.[2]??"",e.alt=i?.[1]??"",e.style=null,e.align="left"}return}if(t.startsWith("<video")){e.type="video";let i=t.match(/^<video\b[^>]*>/i)?.[0]??t,o=/<video\b[^>]*\sautoplay(?:\s*=\s*(?:"[^"]*"|'[^']*'|[^\s>]+))?/i.test(t),r=At(i,"src");e.src=r||io(t),e.poster=At(i,"poster")??"",e.style=At(i,"style"),e.align=We(e.style),e.autoplay=o;return}if(t.startsWith('<div class="callout"')){e.type="callout";let i=t.match(/<div class="callout"(?:\s+style="([^"]*)")?>([\s\S]*?)<\/div>/);i?(e.align=i[1]?ut(i[1]):"left",e.content=i[2]?.trim()??""):(e.content="",e.align="left");return}if(/^(\*{3,}|-{3,}|_{3,})$/.test(t)){e.type="divider";return}if(t.startsWith("<!-- align:")){e.type="text";let i=t.match(/^<!-- align:(center|right) -->\n?([\s\S]*?)\n?<!-- \/align -->$/);i?(e.align=i[1],e.content=i[2]?.trim()??""):e.align="left";return}if(t.startsWith('<div style="text-align:')||t.startsWith('<div style="text-align :')){e.type="text";let i=t.match(/<div style="([^"]*)">([\s\S]*?)<\/div>/);i?(e.align=ut(i[1]),e.content=i[2]?.trim()??""):e.align="left";return}e.type="text",e.align="left"}function mt(e,t){let n=e.trim(),i={id:Ie(t),content:n},o=no(n);if(o.caption!==null){let r={id:i.id};Rt(r,o.content),Qi(r.type)?Object.assign(i,r,{caption:o.caption}):Rt(i,n)}else Rt(i,n);switch(i.type){case"text":return{id:i.id,type:"text",content:i.content??"",align:i.align??"left"};case"image":return{id:i.id,type:"image",src:i.src??"",alt:i.alt??"",style:i.style??null,caption:i.caption??"",align:i.align??"left"};case"video":return{id:i.id,type:"video",src:i.src??"",poster:i.poster??"",style:i.style??null,caption:i.caption??"",align:i.align??"left",autoplay:i.autoplay??!1};case"code":return{id:i.id,type:"code",code:i.code??"",language:i.language??"text"};case"html":return{id:i.id,type:"html",html:i.html??"",style:i.style??null,caption:i.caption??"",align:i.align??"left"};case"callout":return{id:i.id,type:"callout",content:i.content??"",align:i.align??"left"};case"divider":return{id:i.id,type:"divider"};default:return{id:i.id,type:"text",content:i.content??"",align:"left"}}}function oo(e){if(!e||!e.trim())return[{id:Ie(0),type:"text",content:"",align:"left"}];let n=e.split(new RegExp(`\\n+${Nt}\\n+`)).map((i,o)=>{let r=i.trim();if(r.startsWith(ht)&&r.endsWith(ft)){let l=r.slice(ht.length,-ft.length).trim().split(new RegExp(`\\n*${jt}\\n*`));if(l.length>=2)return{id:Ie(o),type:"row",left:mt(l[0]??"",o*10),right:mt(l[1]??"",o*10+1)}}return mt(i,o)});return n.length?n:[{id:Ie(0),type:"text",content:"",align:"left"}]}function Hn(e){let t=e.style&&(e.style.includes("width")||e.style.includes("max-width")),n=e.align&&e.align!=="left",i=$t(e.caption);if(t||n){let o=ze(e);return`<img src="${e.src}" alt="${e.alt||""}" style="${o}">${i}`}return`![${e.alt||""}](${e.src})${i}`}function Bn(e){let t=[`src="${e.src}"`];e.poster&&t.push(`poster="${e.poster}"`);let n=e.autoplay?"autoplay loop muted playsinline":"controls";t.push(n);let i=e.style&&(e.style.includes("width")||e.style.includes("max-width")),o=e.align&&e.align!=="left",r=$t(e.caption);if(i||o){let s=ze(e);return t.push(`style="${s}"`),`<video ${t.join(" ")}></video>${r}`}return`<video ${t.join(" ")}></video>${r}`}function Pn(e){return"```"+(e.language||"")+`
`+(e.code||"")+"\n```"}function _n(e){return e.align&&e.align!=="left"?`<div class="callout" style="${It(e.align)}">${e.content}</div>`:`<div class="callout">${e.content}</div>`}function In(e){let t=e.html||"",n=!!(e.style&&e.style.trim()),i=!!(e.align&&e.align!=="left"),o=n||i?ze(e):e.style,r=Zi(o),s=$t(e.caption);return`${r}
${t}
${Cn}${s}`}function gt(e){switch(e.type){case"text":{let t=(e.content||"").trim();return e.align&&e.align!=="left"?`<!-- align:${e.align} -->
${t}
<!-- /align -->`:t}case"image":return Hn(e);case"video":return Bn(e);case"code":return Pn(e);case"html":return In(e);case"row":{let t=gt(e.left),n=gt(e.right);return`${ht}
${t}
${jt}
${n}
${ft}`}case"callout":return _n(e);case"divider":return"---";default:return""}}function Ke(e){return e.map(t=>gt(t)).join(`

${Nt}

`)}function ue(e,t={}){let n={id:Ie(Date.now()),type:e};switch(e){case"text":return{...n,content:"",align:"left",...t};case"image":return{...n,src:"",alt:"",style:null,caption:"",align:"left",...t};case"video":return{...n,src:"",poster:"",style:null,caption:"",align:"left",autoplay:!1,...t};case"code":return{...n,language:"javascript",code:"",...t};case"html":return{...n,html:"",style:null,caption:"",align:"left",...t};case"callout":return{...n,content:"",align:"left",...t};case"row":return{...n,left:ue("text"),right:ue("text"),...t};case"divider":return{...n,...t};default:return{...n,content:"",align:"left",...t}}}var ro={BLOCK_SEPARATOR:Nt,ROW_START:ht,ROW_END:ft,COL_SEPARATOR:jt,HTML_START:Mn,HTML_END:Cn,parseIntoBlocks:oo,parseSingleBlock:mt,blockToMarkdown:gt,blocksToMarkdown:Ke,formatImageMarkdown:Hn,formatVideoMarkdown:Bn,formatCodeMarkdown:Pn,formatHtmlBlock:In,formatCalloutHtml:_n,createBlock:ue,generateBlockId:Ie},Ut=ro;var so=/^\s*([0-9]*\.?[0-9]+)\s*px(?:\s*!important)?\s*$/i,Ft=new WeakMap,Dn=!1;function lo(e){return e.dataset.autoHeight!=="false"}function ao(){Dn||(Dn=!0,window.addEventListener("message",e=>{if(!e.source||typeof e.data!="object"||e.data?.type!=="sandbox-resize")return;let t=Ft.get(e.source);t&&e.data.nonce===t.nonce&&lo(t.iframe)&&(t.iframe.style.height=`${e.data.height}px`)}))}function co(){return crypto.randomUUID()}function An(e,t){let n=new RegExp(`(?:^|;)\\s*${t}\\s*:\\s*([^;]+)`,"i"),i=e.match(n);if(!i)return null;let o=i[1]?.match(so);if(!o)return null;let r=Number.parseFloat(o[1]??"");return!Number.isFinite(r)||r<=0?null:r}function uo(e){let t=/(?:^|;)\s*margin-left\s*:\s*auto(?:\s*!important)?\s*(?:;|$)/i.test(e),n=/(?:^|;)\s*margin-right\s*:\s*auto(?:\s*!important)?\s*(?:;|$)/i.test(e);return t&&n?"center":t?"right":null}function po(e,t){if(e.style.marginLeft="",e.style.marginRight="",t==="center"){e.style.marginLeft="auto",e.style.marginRight="auto";return}t==="right"&&(e.style.marginLeft="auto",e.style.marginRight="0")}function Rn(e,t,n){t&&(e.style.cssText+=`; ${t}`);let i=n??(t?uo(t):null)??"left";if(po(e,i),!t)return;let o=An(t,"width"),r=An(t,"height");!o||!r||(e.style.width=`${o}px`,e.style.height="auto",e.style.aspectRatio=`${o} / ${r}`,e.style.maxWidth="100%")}function mo(e,t){return`<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body>
${e}
<script>
(function() {
  var nonce = "${t}";
  function reportHeight() {
    var height = Math.max(
      document.body.scrollHeight,
      document.documentElement.scrollHeight
    );
    window.parent.postMessage({ type: 'sandbox-resize', nonce: nonce, height: height }, '*');
  }
  new ResizeObserver(reportHeight).observe(document.body);
  window.addEventListener('load', reportHeight);
  reportHeight();
})();
<\/script>
</body>
</html>`}function Nn(e,t={}){ao();let n=document.createElement("iframe");n.className="html-block-sandbox";let i=["allow-scripts"];t.allowFullscreen!==!1&&n.setAttribute("allow","fullscreen"),t.allowPointerLock&&i.push("allow-pointer-lock"),n.setAttribute("sandbox",i.join(" "));let o=co();return n.srcdoc=mo(e,o),n.style.minHeight=`${t.minHeight??60}px`,n.dataset.autoHeight="true",n.addEventListener("load",()=>{n.contentWindow&&Ft.set(n.contentWindow,{iframe:n,nonce:o})}),n}function jn(e){e.contentWindow&&Ft.delete(e.contentWindow)}var $n={MENU_WIDTH:240},ve={text:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg>',image:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>',video:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M10 9l5 3-5 3V9z"/></svg>',code:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',html:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/><line x1="12" y1="2" x2="12" y2="22" opacity="0.5"/></svg>',callout:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',divider:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="12" x2="21" y2="12"/><circle cx="8" cy="12" r="1" fill="currentColor"/><circle cx="12" cy="12" r="1" fill="currentColor"/><circle cx="16" cy="12" r="1" fill="currentColor"/></svg>'},Ye=[{id:"text",label:"Text",icon:ve.text,description:"Plain text paragraph"},{id:"image",label:"Image",icon:ve.image,description:"Upload or select an image"},{id:"video",label:"Video",icon:ve.video,description:"Upload a video file"},{id:"code",label:"Code",icon:ve.code,description:"Code block with syntax highlighting"},{id:"html",label:"HTML",icon:ve.html,description:"Raw HTML (scripts, embeds, custom)"},{id:"callout",label:"Callout",icon:ve.callout,description:"Highlighted message box"},{id:"divider",label:"Divider",icon:ve.divider,description:"Section break"}],P=null,ie=!1,Ge=!1,Ae="",V=0,ye=null,we=null,J=null,Xe=null,De=null;function vt(){if(P)return P;let e=document.createElement("div");return e.className="slash-command-menu",e.style.display="none",document.body.appendChild(e),P=e,e}function Ot(e){if(!P)return;P.style.display="block",P.style.width=`${$n.MENU_WIDTH}px`,P.style.left=`${Math.min(e.left,window.innerWidth-$n.MENU_WIDTH-20)}px`;let t=P.offsetHeight||200,n=window.innerHeight-e.bottom-10,i=e.top-10;n<t&&i>n?(P.style.top="auto",P.style.bottom=`${window.innerHeight-e.top+5}px`,P.style.maxHeight=`${Math.min(300,i)}px`):(P.style.top=`${e.bottom+5}px`,P.style.bottom="auto",P.style.maxHeight=`${Math.min(300,n)}px`)}function Fn(e){if(!e)return Ye;let t=e.toLowerCase();return Ye.filter(n=>n.label.toLowerCase().includes(t)||n.id.toLowerCase().includes(t)||n.description.toLowerCase().includes(t))}function Je(e,t=0){P||vt(),P&&(V=Math.max(0,Math.min(t,e.length-1)),P.innerHTML=e.map((n,i)=>`
      <button
        class="slash-menu-item ${i===V?"selected":""}"
        data-command="${n.id}"
      >
        <span class="slash-menu-icon">${n.icon}</span>
        <div class="slash-menu-content">
          <span class="slash-menu-label">${n.label}</span>
          <span class="slash-menu-description">${n.description}</span>
        </div>
      </button>
    `).join(""),P.querySelectorAll(".slash-menu-item").forEach((n,i)=>{n.addEventListener("click",()=>{let o=e[i];o&&Vn(o.id)})}))}function Un(){if(!P)return;let e=P.querySelector(".slash-menu-item.selected");e&&e.scrollIntoView({block:"nearest",behavior:"smooth"})}function On(){qt(),Xe=()=>{!ie||!J||Ot(J.getBoundingClientRect())},window.addEventListener("scroll",Xe,!0),De=e=>{!ie||!P||P.contains(e.target)||J?.contains(e.target)||be()},requestAnimationFrame(()=>{De&&document.addEventListener("mousedown",De,!0)})}function qt(){Xe&&(window.removeEventListener("scroll",Xe,!0),Xe=null),De&&(document.removeEventListener("mousedown",De,!0),De=null)}function qn(e,t){P||vt(),ie=!0,Ge=!0,Ae="",V=0,we=t,J=e,Je(Ye,0),Ot(e.getBoundingClientRect()),On()}function ho(e,t,n){P||vt(),ie=!0,Ge=!1,Ae="",V=0,we=t,J=n??null,Je(Ye,0),Ot(e),On()}function be(){qt(),P&&(P.style.display="none"),ie=!1,Ge=!1,Ae="",V=0,J=null}function Vn(e){let t=we??0,n=Ge,i=!1;if(Ge&&we!==null){let o=J&&J.tagName==="TEXTAREA"?J:document.querySelector(`.block-wrapper[data-block-index="${we}"] .block-textarea`);if(o){let r=o.selectionStart,s=o.value,c=s.substring(0,r).lastIndexOf(`
`)+1;if(s[c]==="/"){let u=c,d=(s.substring(0,u)+s.substring(r)).replace(/\n+$/,"");if(o.value=d,o.classList.contains("text-line-input")){let p=o.closest(".block-wrapper");if(p){let g=p.querySelectorAll(".text-line-input");i=Array.from(g).every(w=>!w.value.trim())}else i=!d.trim();o.dispatchEvent(new Event("input",{bubbles:!0}))}else i=!d.trim(),ye&&ye("updateContent",{index:we,content:d})}}}be(),ye&&(n?ye("execute",{commandId:e,insertIndex:i?t:t+1,replaceBlockIndex:i?t:null}):ye("execute",{commandId:e,insertIndex:t,replaceBlockIndex:null}))}function fo(e){if(!ie)return!1;let t=Fn(Ae);switch(e.key){case"ArrowDown":return e.preventDefault(),e.stopPropagation(),V=(V+1)%t.length,Je(t,V),Un(),!0;case"ArrowUp":return e.preventDefault(),e.stopPropagation(),V=(V-1+t.length)%t.length,Je(t,V),Un(),!0;case"Enter":case"Tab":if(e.preventDefault(),e.stopPropagation(),t.length>0){let n=t[V];n&&Vn(n.id)}return!0;case"Escape":return e.preventDefault(),e.stopPropagation(),be(),!0}return!1}function go(e,t){let n=e.selectionStart,o=e.value.substring(0,n),s=o.lastIndexOf(`
`)+1;if(o.substring(s)==="/"){qn(e,t);return}if(ie){let a=o.lastIndexOf("/");if(a!==-1){let c=o.substring(0,a);if(c===""||c.endsWith(`
`)){Ae=o.substring(a+1);let d=Fn(Ae);d.length===0?be():Je(d,0)}else be()}else be()}}function vo(e){ye=e,vt()}function yo(){qt(),P&&(P.remove(),P=null),ie=!1,J=null,ye=null}function wo(){return ie}function bo(){return we}var Eo={init:vo,cleanup:yo,showFromTextarea:qn,showFromButton:ho,hide:be,handleKeydown:fo,handleTextareaInput:go,isActive:wo,getActiveIndex:bo,COMMANDS:Ye},X=Eo;var R=null,yt=2e3,Xt=.8,So=["image/jpeg","image/png","image/gif","image/webp"],To=["video/mp4","video/quicktime","video/webm"],Se={MIN_WIDTH_PERCENT:20,MAX_WIDTH_PERCENT:100,MIN_HEIGHT_PX:60,CORNER_HANDLE_POSITIONS:["nw","ne","sw","se"],IFRAME_HANDLE_POSITIONS:["nw","ne","sw","se","n","e","s","w"],FULL_WIDTH_THRESHOLD:2},B=null,Ze=[],Te=!1,oe=null,zt=!1,Qe=null,et=null,Vt=null,Wn=null;function Yt(e){if(!R)return null;let t=R.getBlocks();for(let n=0;n<t.length;n+=1){let i=t[n];if(i){if(i.id===e)return{index:n};if(i.type==="row"){if(i.left.id===e)return{index:n,rowSide:"left"};if(i.right.id===e)return{index:n,rowSide:"right"}}}}return null}function Kn(e,t){if(!R)return null;let n=R.getBlocks()[e];return n?t?n.type!=="row"?null:{index:e,rowSide:t}:{index:e}:null}function wt(e,t,n={}){if(!R)return;if(!e.rowSide){R.updateBlock(e.index,t,n);return}let i=R.getBlocks()[e.index];if(!i||i.type!=="row")return;let o={...i[e.rowSide],...t};e.rowSide==="left"?R.updateBlock(e.index,{left:o},n):R.updateBlock(e.index,{right:o},n)}function Lo(e){R=e,xo(),Xn()}function xo(){document.addEventListener("paste",async e=>{if(!R?.isActive())return;let t=Array.from(e.clipboardData?.items??[]);for(let n of t)if(n.type.startsWith("image/")){e.preventDefault();let i=n.getAsFile();if(!i)continue;let o=document.activeElement?.closest(".block-wrapper"),r=o?parseInt(o.getAttribute("data-block-index")??"",10):null,s=document.activeElement?.closest(".row-column-left, .row-column-right"),l=s?.classList.contains("row-column-left")?"left":s?.classList.contains("row-column-right")?"right":void 0;r!==null&&!isNaN(r)&&await tn(i,r,l);break}})}function Xn(){zt||(Qe=e=>Bo(e),et=()=>Jn(),Vt=()=>Jt(),Wn=e=>{if(!R?.isActive()||!B||Te)return;let t=e.target,n=t.closest(".image-block-wrapper, .video-block-wrapper, .html-block-wrapper"),i=t.closest(".resize-handle");n||i||Gt()},document.addEventListener("click",Wn),window.addEventListener("resize",Vt),window.addEventListener("scroll",Vt,!0),zt=!0)}function ko(e,t){!e||!t||(zt||Xn(),!(B&&B.element===e)&&(Gt(),B={element:e,block:t,location:Yt(t.id)},e.classList.add("media-selected"),Mo(e),Jt()))}function Gt(){Te&&Jn(),B&&(B.element.classList.remove("media-selected"),Gn(),B=null)}function Mo(e){Gn();let t=e.getBoundingClientRect();Co().forEach(i=>{let o=document.createElement("div");o.className=`resize-handle ${i}`,o.dataset.position=i,Yn(o,i,t),o.addEventListener("mousedown",r=>Ho(r,i)),document.body.appendChild(o),Ze.push(o)})}function Co(){return B?.block.type==="html"?Se.IFRAME_HANDLE_POSITIONS:Se.CORNER_HANDLE_POSITIONS}function Yn(e,t,n){let o=n.left+n.width/2,r=n.top+n.height/2;switch(e.style.position="fixed",t){case"nw":e.style.top=`${n.top-6}px`,e.style.left=`${n.left-6}px`;break;case"ne":e.style.top=`${n.top-6}px`,e.style.left=`${n.right-6}px`;break;case"sw":e.style.top=`${n.bottom-6}px`,e.style.left=`${n.left-6}px`;break;case"se":e.style.top=`${n.bottom-6}px`,e.style.left=`${n.right-6}px`;break;case"n":e.style.top=`${n.top-6}px`,e.style.left=`${o-6}px`;break;case"e":e.style.top=`${r-6}px`,e.style.left=`${n.right-6}px`;break;case"s":e.style.top=`${n.bottom-6}px`,e.style.left=`${o-6}px`;break;case"w":e.style.top=`${r-6}px`,e.style.left=`${n.left-6}px`;break}}function Jt(){if(!B||Ze.length===0)return;let e=B.element.getBoundingClientRect();Ze.forEach(t=>{let n=t.dataset.position;Yn(t,n,e)})}function Gn(){Ze.forEach(e=>e.remove()),Ze=[]}function Ho(e,t){if(!B)return;e.preventDefault(),e.stopPropagation();let n=B.element,i=n.getBoundingClientRect();if(!i.width)return;let o=n.closest(".row-column")||n.closest(".block-content")||n.closest(".image-block-wrapper")||n.closest(".video-block-wrapper")||n.closest(".html-block-preview-container")||n.parentElement,r=o?o.getBoundingClientRect():i,s=Math.max(80,r.width*Se.MIN_WIDTH_PERCENT/100),l=r.width*Se.MAX_WIDTH_PERCENT/100,a=Se.MIN_HEIGHT_PX,c=Math.max(a,i.height*3,window.innerHeight*.9);Te=!0,n.classList.add("media-resizing"),oe={position:t,startX:e.clientX,startY:e.clientY,startWidth:i.width,startHeight:i.height,minWidth:s,maxWidth:l,minHeight:a,maxHeight:c,lastWidth:i.width,lastHeight:i.height,aspectRatio:i.width>0&&i.height>0?i.width/i.height:16/9},Qe&&et&&(document.addEventListener("mousemove",Qe),document.addEventListener("mouseup",et)),document.body.style.userSelect="none"}function Bo(e){if(!Te||!B||!oe)return;let{position:t,startX:n,startY:i,startWidth:o,startHeight:r,minWidth:s,maxWidth:l,minHeight:a,maxHeight:c,aspectRatio:u}=oe,d=B.element,v=B.block,p=d instanceof HTMLIFrameElement,g=t==="nw"||t==="ne"||t==="sw"||t==="se",w=o,T=r;if(p)if(g){let C=e.clientX-n;(t==="nw"||t==="sw")&&(C=-C),w=Re(o+C,s,l),T=w/u,(T<a||T>c)&&(T=Re(T,a,c),w=Re(T*u,s,l),T=w/u)}else if(t==="e"||t==="w"){let C=e.clientX-n;t==="w"&&(C=-C),w=Re(o+C,s,l),T=r}else{let C=e.clientY-i;t==="n"&&(C=-C),T=Re(r+C,a,c),w=o}else{let C=e.clientX-n;(t==="nw"||t==="sw")&&(C=-C),w=Re(o+C,s,l),T=r}oe.lastWidth=w,oe.lastHeight=T,d.style.width=`${Math.round(w)}px`,p?(d.style.height=`${Math.round(T)}px`,d.dataset.autoHeight="false"):d.style.height="auto";let x=ei(v.style,w,l,{height:p?T:void 0,keepHeight:p}),I=B.location??Yt(v.id);I&&(wt(I,{style:x},{render:!1,markDirty:!1}),B.location=I),B.block={...v,style:x},Jt()}function Jn(){if(Te){if(Te=!1,B){B.element.classList.remove("media-resizing");let e=oe?.lastWidth,t=oe?.lastHeight,n=oe?.maxWidth;if(e&&n){let i=B.element instanceof HTMLIFrameElement,o=ei(B.block.style,e,n,{height:i?t:void 0,keepHeight:i}),r=B.location??Yt(B.block.id);r&&(wt(r,{style:o},{render:!1,markDirty:!1}),B.location=r),!Kt(o)&&!Wt(o)?(B.element.style.width="",B.element.style.height=""):Kt(o)?Wt(o)||(B.element.style.height=""):B.element.style.width="",i&&(B.element.dataset.autoHeight=Wt(o)?"false":"true"),R?.markDirty()}}Qe&&et&&(document.removeEventListener("mousemove",Qe),document.removeEventListener("mouseup",et)),document.body.style.userSelect="",oe=null}}function Zn(e){let t={};return e&&e.split(";").forEach(n=>{let[i,...o]=n.split(":");if(!i)return;let r=o.join(":").trim();r&&(t[i.trim().toLowerCase()]=r)}),t}function Qn(e){return Object.entries(e).filter(([,t])=>t!=null&&t!=="").map(([t,n])=>`${t}: ${n}`).join("; ")}function ei(e,t,n,i={}){let{height:o,keepHeight:r=!1}=i,s=Zn(e);return delete s["margin-left"],delete s["margin-right"],delete s.display,delete s["max-width"],delete s["min-width"],r?(delete s["max-height"],delete s["min-height"],typeof o=="number"&&Number.isFinite(o)&&(s.height=`${Math.round(o)}px`)):(delete s.height,delete s["max-height"],delete s["min-height"]),Math.abs(t-n)<=Se.FULL_WIDTH_THRESHOLD?delete s.width:s.width=`${Math.round(t)}px`,Qn(s)||null}function Kt(e){return e?/(^|;)\s*width\s*:/.test(e):!1}function Wt(e){return e?/(^|;)\s*height\s*:/.test(e):!1}function Re(e,t,n){return Math.max(t,Math.min(n,e))}async function Zt(e){return new Promise((t,n)=>{let i=new Image,o=document.createElement("canvas"),r=o.getContext("2d");if(!r){n(new Error("Could not get canvas context"));return}i.onload=()=>{let s=i.width,l=i.height;s>yt&&(l=Math.round(l*yt/s),s=yt),o.width=s,o.height=l,r.drawImage(i,0,0,s,l),o.toBlob(a=>{a?t(a):n(new Error("Failed to create blob"))},"image/webp",Xt),URL.revokeObjectURL(i.src)},i.onerror=()=>{URL.revokeObjectURL(i.src),n(new Error("Failed to load image"))},i.src=URL.createObjectURL(e)})}async function Ne(e,t,n){if(t==="video")return Po(e,n);let i=new FormData;i.append("file",e),i.append("type","image");let o=await fetch("/api/upload-media",{method:"POST",body:i});if(!o.ok){let s=await o.json().catch(()=>({}));throw new Error(s.detail||`Upload failed: ${o.status}`)}return(await o.json()).url}function zn(e){return(e/(1024*1024)).toFixed(1)}function Ee(e,t){e?.(t)}function Po(e,t){return new Promise((n,i)=>{let o=new XMLHttpRequest,r=new FormData;r.append("file",e),o.upload.addEventListener("progress",s=>{if(!s.lengthComputable||s.total<=0){Ee(t,{stage:"uploading",progress:10,message:"Uploading video..."});return}let l=Math.max(0,Math.min(100,s.loaded/s.total*100)),a=Math.max(1,Math.min(65,Math.round(l*.65)));Ee(t,{stage:"uploading",progress:a,loadedBytes:s.loaded,totalBytes:s.total,message:`Uploading video... ${Math.round(l)}% (${zn(s.loaded)} / ${zn(s.total)} MB)`})}),o.upload.addEventListener("load",()=>{Ee(t,{stage:"processing",progress:72,message:"Upload complete. Processing video..."})}),o.addEventListener("load",()=>{let s={};try{s=JSON.parse(o.responseText||"{}")}catch{s={}}if(o.status>=200&&o.status<300&&typeof s.url=="string"&&s.url){Ee(t,{stage:"complete",progress:100,message:"Video ready!"}),n(s.url);return}let l=s.detail||`Upload failed: ${o.status}`;Ee(t,{stage:"error",progress:100,message:l}),i(new Error(l))}),o.addEventListener("error",()=>{let s="Upload failed: network error";Ee(t,{stage:"error",progress:100,message:s}),i(new Error(s))}),o.addEventListener("abort",()=>{let s="Upload canceled";Ee(t,{stage:"error",progress:100,message:s}),i(new Error(s))}),o.open("POST","/api/process-content-video"),o.send(r)})}function _o(e){return e.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&e.videoWidth>0&&e.videoHeight>0?Promise.resolve():new Promise((t,n)=>{let i=window.setTimeout(()=>{s(),n(new Error("Video frame is not ready. Try playing or scrubbing the video first."))},8e3),o=()=>{e.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&e.videoWidth>0&&e.videoHeight>0&&(s(),t())},r=()=>{s(),n(new Error("Unable to read the video frame."))},s=()=>{window.clearTimeout(i),e.removeEventListener("loadeddata",o),e.removeEventListener("canplay",o),e.removeEventListener("seeked",o),e.removeEventListener("error",r)};e.addEventListener("loadeddata",o),e.addEventListener("canplay",o),e.addEventListener("seeked",o),e.addEventListener("error",r),e.readyState<HTMLMediaElement.HAVE_METADATA&&e.load(),o()})}function Io(e,t,n){return new Promise((i,o)=>{e.toBlob(r=>{r?i(r):o(new Error("Failed to capture video frame."))},t,n)})}async function Qt(e){let t=await Zt(e);return Ne(t,"image")}function Do(e){let t=e.querySelector("source[src]");return(e.currentSrc||e.src||t?.src||"").trim()}async function Ao(e,t){let n=await fetch("/api/content-video-poster",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_url:e,frame_time:t})}),i=await n.json().catch(()=>({}));if(!n.ok||typeof i.url!="string"||!i.url){let o=i.detail||`Poster extraction failed: ${n.status}`;throw new Error(o)}return i.url}async function en(e){let t=Do(e),n=Number.isFinite(e.currentTime)?Math.max(0,e.currentTime):0;try{await _o(e);let i=e.videoWidth,o=e.videoHeight;if(!i||!o)throw new Error("Video dimensions are unavailable.");let r=document.createElement("canvas");r.width=i,r.height=o;let s=r.getContext("2d");if(!s)throw new Error("Could not initialize frame capture.");s.drawImage(e,0,0,i,o);let l=await Io(r,"image/webp",Xt);return await Ne(l,"image")}catch(i){if(t)return Ao(t,n);throw i instanceof Error?i:new Error("Failed to capture frame from video.")}}async function tn(e,t,n){E("Processing image...","info");try{let i=await Zt(e),o=await Ne(i,"image"),r=Kn(t,n);if(!r)throw new Error("Target block not found");wt(r,{src:o,alt:e.name.replace(/\.[^/.]+$/,"")}),E("Image uploaded!","success")}catch(i){console.error("Image upload failed:",i),E(i instanceof Error?i.message:"Image upload failed","error")}}async function ti(e,t,n={}){E("Processing video...","info");try{let i=await Ne(e,"video",n.onProgress),o=Kn(t,n.rowSide);if(!o)throw new Error("Target block not found");wt(o,{src:i}),E("Video processed!","success")}catch(i){console.error("Video upload failed:",i),E(i instanceof Error?i.message:"Video processing failed","error")}}async function Ro(e,t=null){E("Processing image...","info");try{let n=await Zt(e),i=await Ne(n,"image");jo(i,e.name,t),E("Image uploaded!","success")}catch(n){console.error("Image upload failed:",n),E("Image upload failed","error")}}async function No(e,t=null,n={}){E("Processing video...","info");try{let i=await Ne(e,"video",n.onProgress);$o(i,t),E("Video processed!","success")}catch(i){console.error("Video upload failed:",i),E(i instanceof Error?i.message:"Video processing failed","error")}}function jo(e,t="",n=null){let i=t.replace(/\.[^/.]+$/,"");if(n)R?.insertBlockAfter(n,"image",{src:e,alt:i});else{let o=R?.getBlocks().length??0;R?.insertBlock(o,"image",{src:e,alt:i})}}function $o(e,t=null){if(t)R?.insertBlockAfter(t,"video",{src:e});else{let n=R?.getBlocks().length??0;R?.insertBlock(n,"video",{src:e})}}async function Uo(e){let t=document.createElement("input");t.type="file",t.accept="image/*",t.addEventListener("change",async()=>{let n=t.files?.[0];n&&await tn(n,e)}),t.click()}async function Fo(e){let t=document.createElement("input");t.type="file",t.accept="video/*",t.addEventListener("change",async()=>{let n=t.files?.[0];n&&await ti(n,e)}),t.click()}var Oo={MAX_IMAGE_WIDTH:yt,IMAGE_QUALITY:Xt,ALLOWED_IMAGE_TYPES:So,ALLOWED_VIDEO_TYPES:To,RESIZE_CONFIG:Se,get selectedMedia(){return B},get isResizing(){return Te},init:Lo,select:ko,deselect:Gt,handleImageUploadForBlock:tn,handleVideoUploadForBlock:ti,handleImageUpload:Ro,handleVideoUpload:No,replaceImageByIndex:Uo,replaceVideoByIndex:Fo,uploadPosterForVideo:Qt,capturePosterFromVideo:en,parseStyle:Zn,serializeStyle:Qn,styleHasWidth:Kt},U=Oo;var Le=null,$=[],j=-1,ni=50,bt=!1,nn=null,ii=500;function qo(e){Le=e,$=[],j=-1}function Vo(){$=[],j=-1}function Wo(){if(!Le)throw new Error("EditUndo not initialized");return{blocks:pt(Le.getBlocks()),timestamp:Date.now()}}function oi(){let e=Wo();j<$.length-1&&($=$.slice(0,j+1)),$.push(e),j=$.length-1,$.length>ni&&($.shift(),j--)}function zo(){bt||(nn!==null&&clearTimeout(nn),nn=setTimeout(()=>{oi()},ii))}function ri(e){!e||!Le||(bt=!0,Le.setBlocks(pt(e.blocks)),Le.renderBlocks(),Le.markDirty(),bt=!1)}function Ko(){if(j<=0){E("Nothing to undo","info");return}j===$.length-1&&oi(),j--,ri($[j]),E("Undo","info",1e3)}function Xo(){if(j>=$.length-1){E("Nothing to redo","info");return}j++,ri($[j]),E("Redo","info",1e3)}function Yo(){$=[],j=-1}function Go(){return j>0}function Jo(){return j<$.length-1}var Zo={get history(){return $},get currentIndex(){return j},get maxHistory(){return ni},get isUndoing(){return bt},DEBOUNCE_MS:ii,init:qo,reset:Vo,saveState:zo,undo:Ko,redo:Xo,clear:Yo,canUndo:Go,canRedo:Jo},pe=Zo;var tt="bb_edit_scroll_restore_v1";function Qo(e){let t=Math.max(0,document.documentElement.scrollHeight-window.innerHeight);return Math.max(0,Math.min(e,t))}function er(e){let t=document.documentElement,n=t.style.scrollBehavior;t.style.scrollBehavior="auto",e(),requestAnimationFrame(()=>{n?t.style.scrollBehavior=n:t.style.removeProperty("scroll-behavior")})}function si(e=null){let t=[e,".project-item.active .project-content",".about-content",".project-content"].filter(n=>!!n);for(let n of t){let i=document.querySelector(n);if(i)return{element:i,selector:n}}return{element:null,selector:null}}function tr(e){if(document.body.classList.contains("editing")){let i=Array.from(e.querySelectorAll(".block-wrapper[data-block-index]")),o=i.find(s=>s.getBoundingClientRect().bottom>=0)??i[i.length-1]??null;if(!o)return{anchorIndex:null,anchorTop:null};let r=Number.parseInt(o.dataset.blockIndex??"",10);return{anchorIndex:Number.isNaN(r)?null:r,anchorTop:o.getBoundingClientRect().top}}let t=Array.from(e.querySelectorAll(".content-block")),n=t.find(i=>i.getBoundingClientRect().bottom>=0)??t[t.length-1]??null;return n?{anchorIndex:t.indexOf(n),anchorTop:n.getBoundingClientRect().top}:{anchorIndex:null,anchorTop:null}}function nr(e,t){return t.anchorIndex===null?null:document.body.classList.contains("editing")?e.querySelector(`.block-wrapper[data-block-index="${t.anchorIndex}"]`):Array.from(e.querySelectorAll(".content-block"))[t.anchorIndex]??null}function on(e,t){if(t<=0)return;let n=t,i=()=>{e(),n-=1,n>0&&requestAnimationFrame(i)};requestAnimationFrame(i)}function xe(e=window.location.pathname,t=null){let{element:n,selector:i}=si(t),o=null;if(n){let l=window.scrollY+n.getBoundingClientRect().top;o=window.scrollY-l}let r=n?tr(n):{anchorIndex:null,anchorTop:null},s={pathname:e,scrollY:window.scrollY,containerSelector:i,offsetWithinContainer:o,anchorIndex:r.anchorIndex,anchorTop:r.anchorTop,expiresAt:Date.now()+3e4};sessionStorage.setItem(tt,JSON.stringify(s))}function li(){let e=sessionStorage.getItem(tt);if(!e)return;let t;try{t=JSON.parse(e)}catch{sessionStorage.removeItem(tt);return}if(!t||Date.now()>t.expiresAt){sessionStorage.removeItem(tt);return}if(t.pathname!==window.location.pathname)return;let n=()=>{if(window.location.hash)return;let{element:i}=si(t.containerSelector),o=t.scrollY;if(i&&t.anchorTop!==null){let r=nr(i,t);if(r){let s=r.getBoundingClientRect().top-t.anchorTop;o=window.scrollY+s}else t.offsetWithinContainer!==null&&(o=window.scrollY+i.getBoundingClientRect().top+t.offsetWithinContainer)}else i&&t.offsetWithinContainer!==null&&(o=window.scrollY+i.getBoundingClientRect().top+t.offsetWithinContainer);er(()=>{window.scrollTo({top:Qo(o),left:0,behavior:"auto"})})};sessionStorage.removeItem(tt),on(n,4),window.addEventListener("load",()=>{on(n,4)},{once:!0}),setTimeout(()=>{on(n,2)},180)}function Et(e,t="-"){let n=e.normalize("NFKD").replace(/[\u0300-\u036f]/g,"");return n=n.replace(/[^\x00-\x7F]/g,""),n=n.replace(/[^\w\s-]/g,"").trim().toLowerCase(),n.replace(/[\s-]+/g,t)}function St(e,t){if(!t.has(e)&&e)return t.add(e),e;let n=e.match(/^(.+)_(\d+)$/),i=n?.[1]??e,o=n?.[2]?parseInt(n[2],10)+1:1,r=`${i}_${o}`;for(;t.has(r);)o++,r=`${i}_${o}`;return t.add(r),r}var he={dragHandle:'<svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><circle cx="9" cy="6" r="1.5"/><circle cx="15" cy="6" r="1.5"/><circle cx="9" cy="12" r="1.5"/><circle cx="15" cy="12" r="1.5"/><circle cx="9" cy="18" r="1.5"/><circle cx="15" cy="18" r="1.5"/></svg>',delete:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',image:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>',video:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M10 9l5 3-5 3V9z"/></svg>',columns:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"><rect x="3" y="4" width="8" height="16" rx="1.5"/><rect x="13" y="4" width="8" height="16" rx="1.5"/></svg>',split:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"><rect x="4" y="3" width="16" height="7" rx="1.5"/><rect x="4" y="14" width="16" height="7" rx="1.5"/></svg>',swap:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 8 16 13"/><line x1="21" y1="8" x2="3" y2="8"/><polyline points="8 21 3 16 8 11"/><line x1="3" y1="16" x2="21" y2="16"/></svg>',divider:'<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><circle cx="6" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="18" cy="12" r="2"/></svg>'};var M=[],$e=null,W=null,Q=!1,Fe=!1,D=null,F=null,A=null,ke="unchanged",se=null,re=null,ee=null,Z=null,ir=2e3,or=5e3,rr=3e3,dn=3,un=2,le=null,Y=new Set,z={sourceIndex:null,currentDropIndex:null,isDragging:!1},nt=null,rn=0,sn=0,ln=0;function pn(e){let t=(e??"").trim();t&&Y.add(t)}function sr(e){if(!e)return!1;try{let t=new URL(e);return t.protocol!=="http:"&&t.protocol!=="https:"?!1:/\.(webp|png|jpe?g|gif|avif)$/i.test(t.pathname)}catch{return!1}}function Tt(e){if(e){if(e.type==="video"){pn(e.poster);return}e.type==="row"&&(Tt(e.left),Tt(e.right))}}function mn(e){let t=document.documentElement,n=t.style.scrollBehavior;t.style.scrollBehavior="auto",e(),requestAnimationFrame(()=>{n?t.style.scrollBehavior=n:t.style.removeProperty("scroll-behavior")})}function hn(e){let t=Math.max(0,document.documentElement.scrollHeight-window.innerHeight);return Math.max(0,Math.min(e,t))}function lr(){if(!D)return null;let e=Array.from(D.querySelectorAll(".block-wrapper[data-block-id]"));if(e.length===0)return null;let t=e.find(r=>r.getBoundingClientRect().bottom>=0)??e[e.length-1]??null;if(!t)return null;let n=t.dataset.blockId??null,i=Number.parseInt(t.dataset.blockIndex??"",10),o=Number.isNaN(i)?0:i;return{blockId:n,blockIndex:o,blockTop:t.getBoundingClientRect().top}}function Ue(e,t,n,i){if(i<=0)return;let o=i,r=()=>{e===t()&&(n(),o-=1,o>0&&requestAnimationFrame(r))};requestAnimationFrame(r)}function fn(e,t){e.querySelectorAll("img").forEach(n=>{n.complete||(n.addEventListener("load",t,{once:!0}),n.addEventListener("error",t,{once:!0}))}),e.querySelectorAll("video").forEach(n=>{n.readyState>=1||(n.addEventListener("loadedmetadata",t,{once:!0}),n.addEventListener("error",t,{once:!0}))})}function ar(e){if(!e||!D||M.length===0)return;let t=++rn,n=()=>{if(!D||M.length===0)return;let i=null;if(e.blockId&&(i=D.querySelector(`.block-wrapper[data-block-id="${e.blockId}"]`)),!i){let r=Math.max(0,Math.min(e.blockIndex,M.length-1));i=D.querySelector(`.block-wrapper[data-block-index="${r}"]`)}if(!i)return;let o=i.getBoundingClientRect().top-e.blockTop;Math.abs(o)<1||mn(()=>{window.scrollTo({top:hn(window.scrollY+o),left:0,behavior:"auto"})})};Ue(t,()=>rn,n,dn),fn(D,()=>{Ue(t,()=>rn,n,un)})}function cr(e){let t=window.scrollY+e.getBoundingClientRect().top;return{offsetWithinContainer:window.scrollY-t}}function dr(e){let t=Array.from(e.querySelectorAll(".content-block"));if(t.length===0)return null;let n=t.find(o=>o.getBoundingClientRect().bottom>=0)??t[t.length-1]??null;if(!n)return null;let i=t.indexOf(n);return i<0?null:{blockIndex:i,blockTop:n.getBoundingClientRect().top}}function ur(e,t=D??document.body){if(!e||!D||M.length===0)return;let n=++ln,i=()=>{if(!D||M.length===0)return;let o=Math.max(0,Math.min(e.blockIndex,M.length-1)),r=D.querySelector(`.block-wrapper[data-block-index="${o}"]`);if(!r)return;let s=r.getBoundingClientRect().top-e.blockTop;Math.abs(s)<1||mn(()=>{window.scrollTo({top:hn(window.scrollY+s),left:0,behavior:"auto"})})};Ue(n,()=>ln,i,dn),fn(t,()=>{Ue(n,()=>ln,i,un)})}function pr(e,t,n=e){let i=++sn,o=()=>{let s=window.scrollY+e.getBoundingClientRect().top+t.offsetWithinContainer;mn(()=>{window.scrollTo({top:hn(s),left:0,behavior:"auto"})})};Ue(i,()=>sn,o,dn),fn(n,()=>{Ue(i,()=>sn,o,un)})}async function mr(e){if(!Pe()){console.log("Edit mode only available on localhost");return}$e=e,A="project",Fe=!0;try{let t=await K(`/api/project/${e}`);W=t,le=t.revision??null,mi(W);let n=new URL(window.location.href);n.searchParams.set("edit",""),window.history.replaceState({},"",n)}catch(t){console.error("Failed to load project:",t),E("Failed to load project","error")}}async function hr(){if(!Pe()){console.log("Edit mode only available on localhost");return}A="about",$e=null,Fe=!0;try{let e=await K("/api/about");W=e,le=e.revision??null,mi(W);let t=new URL(window.location.href);t.searchParams.set("edit",""),window.history.replaceState({},"",t)}catch(e){console.error("Failed to load about content:",e),E("Failed to load about content","error")}}function mi(e){let t=A==="about"?document.querySelector(".about-content"):document.querySelector(".project-content");if(!t){console.error("Content container not found");return}if(A==="project"){let l=t.closest(".project-item");l&&l.querySelectorAll("video").forEach(c=>{c.pause()});let a=l?.querySelector(".edit-buttons");a&&(a.dataset.originalHtml=a.innerHTML,a.innerHTML=`
        <span class="edit-status"></span>
        <button class="edit-btn-action edit-btn-cancel" data-action="cancel">Cancel</button>
        <button class="edit-btn-action edit-btn-save" data-action="save">Save</button>
      `,F=a,F.querySelector('[data-action="cancel"]')?.addEventListener("click",xt),F.querySelector('[data-action="save"]')?.addEventListener("click",Lt))}let n="markdown"in e?e.markdown:"";M=Ut.parseIntoBlocks(n||""),Y=new Set;let i=cr(t),o=dr(t),r=document.createElement("div");if(r.className="edit-mode-container",A==="about"?(r.innerHTML=`
      <div class="edit-mode-toolbar">
        <div class="edit-toolbar-left">
          <span class="edit-project-name">About Page</span>
          <span class="edit-status"></span>
        </div>
        <div class="edit-toolbar-right">
          <button class="edit-btn edit-btn-secondary" data-action="cancel">Cancel</button>
          <button class="edit-btn edit-btn-primary" data-action="save">Save</button>
        </div>
      </div>
      <div class="edit-blocks-container"></div>
    `,F=r.querySelector(".edit-mode-toolbar"),F?.querySelector('[data-action="cancel"]')?.addEventListener("click",xt),F?.querySelector('[data-action="save"]')?.addEventListener("click",Lt)):r.innerHTML=`
      <div class="edit-blocks-container"></div>
    `,t.innerHTML="",t.appendChild(r),t.classList.add("edit-mode-active"),D=r.querySelector(".edit-blocks-container"),X.init(Gr),U.init({updateBlock:Mi,insertBlock:kt,insertBlockAfter:Li,getBlocks:()=>M,renderBlocks:it,markDirty:me,isActive:()=>Fe}),pe.init({getBlocks:()=>M,setBlocks:l=>{M=l},renderBlocks:it,markDirty:me}),pe.saveState(),document.addEventListener("keydown",ki),document.body.classList.add("editing"),A==="project"&&"video"in e&&e.video?.hls){let a=t.closest(".project-item")?.querySelector(".video-container");a&&(nt=Zr(e),a.after(nt))}it();let s=A==="project"?t.closest(".project-item")??t:t;o?ur(o,s):pr(t,i,s),window.addEventListener("beforeunload",fi)}function gn(e,t={}){if(A!=="project"||!$e||!W)throw new Error("Project data is not loaded");let n=W,i={slug:$e,original_slug:$e,name:n.name,date:n.date,pinned:n.pinned??!1,draft:n.draft??!1,youtube:n.youtube||"",video:n.video??{},markdown:e};return Y.size>0&&(i.cleanup_candidates=Array.from(Y)),t.force?i.force=!0:i.base_revision=le,i}function hi(){document.querySelector(".edit-conflict-banner")?.remove();let e=document.createElement("div");e.className="edit-conflict-banner",e.innerHTML=`
    <span class="edit-conflict-message">Content was modified in another session</span>
    <button class="edit-conflict-btn edit-conflict-keep">Keep mine</button>
    <button class="edit-conflict-btn edit-conflict-reload">Load theirs</button>
  `,e.style.cssText="position:fixed;top:0;left:0;right:0;z-index:10000;display:flex;align-items:center;justify-content:center;gap:12px;padding:12px 20px;background:#7c2d12;color:#fff;font-size:14px;font-family:-apple-system,BlinkMacSystemFont,sans-serif;box-shadow:0 2px 8px rgba(0,0,0,.3)";let t=e.querySelector(".edit-conflict-keep"),n=e.querySelector(".edit-conflict-reload");[t,n].forEach(i=>{i.style.cssText="padding:6px 16px;border:1px solid rgba(255,255,255,.3);border-radius:6px;background:transparent;color:#fff;font-size:13px;cursor:pointer"}),t.addEventListener("click",async()=>{e.remove();let i=Ke(M);try{let o;if(A==="about")o=await fetch("/api/save-about",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({markdown:i,force:!0})});else{let r=gn(i,{force:!0});o=await fetch("/api/save-project",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})}if(o.ok){let r=await o.json();r.revision&&(le=r.revision),A==="project"&&Y.clear(),Q=!1,O({type:"save_ok"}),E("Changes saved (overwritten)","success")}else O({type:"save_error"}),E("Force save failed","error")}catch{O({type:"save_error"}),E("Force save failed","error")}}),n.addEventListener("click",()=>{e.remove(),ot(),window.location.reload()}),document.body.appendChild(e)}function ot(){Fe=!1,se&&(clearTimeout(se),se=null),re&&(clearTimeout(re),re=null),ee&&(clearTimeout(ee),ee=null),Z&&(Z.abort(),Z=null),O({type:"reset"}),le=null,Y.clear(),document.querySelector(".edit-conflict-banner")?.remove(),document.removeEventListener("keydown",ki),window.removeEventListener("beforeunload",fi),X.cleanup(),U.deselect(),document.body.classList.remove("editing");let e=A==="about"?document.querySelector(".about-content"):document.querySelector(".project-content");e&&e.classList.remove("edit-mode-active"),A==="project"&&F&&F.dataset.originalHtml&&(F.innerHTML=F.dataset.originalHtml,delete F.dataset.originalHtml),nt&&(nt.remove(),nt=null);let t=new URL(window.location.href);t.searchParams.delete("edit"),window.history.replaceState({},"",t),A=null}function fi(e){Q&&(e.preventDefault(),e.returnValue="")}function fr(){if(!F)return;let e=F.querySelector(".edit-status"),t=F.querySelector('[data-action="save"]');if(t?.classList.remove("has-changes","is-saving","has-error"),e)switch(ke){case"unchanged":e.textContent="",e.style.color="";break;case"pending":e.textContent="(unsaved)",e.style.color="#eab308",t?.classList.add("has-changes");break;case"saving":e.textContent="Saving...",e.style.color="#3b82f6",t?.classList.add("is-saving");break;case"saved":e.textContent="Saved",e.style.color="#22c55e";break;case"error":e.textContent="Save failed",e.style.color="#ef4444",t?.classList.add("has-error");break;case"conflict":e.textContent="Conflict",e.style.color="#f97316",t?.classList.add("has-error");break}}function gr(e,t){switch(t.type){case"edit":return"pending";case"save_start":return e==="conflict"?e:"saving";case"save_ok":return"saved";case"save_error":return"error";case"conflict":return"conflict";case"fade":return e==="saved"?"unchanged":e;case"reset":return"unchanged";default:return e}}function O(e){let t=gr(ke,e);ke=t,fr(),t!=="saved"&&re&&(clearTimeout(re),re=null),t==="saved"&&(re&&clearTimeout(re),re=setTimeout(()=>{O({type:"fade"})},rr))}function Me(e,t={}){let{render:n=!0,markDirty:i=!0}=t,o=n?lr():null;M=e,i&&me(),n&&(it(),ar(o))}function rt(e,t,n={}){let i=M[e];if(!i)return!1;let o=t(i);if(o===i)return!1;let r=M.slice();return r[e]=o,Me(r,n),!0}function vr(e,t){switch(e.type){case"text":return{...e,...t};case"image":return{...e,...t};case"video":return{...e,...t};case"code":return{...e,...t};case"html":return{...e,...t};case"callout":return{...e,...t};case"row":return{...e,...t};case"divider":default:return{...e}}}function vn(e,t,n={}){let i=e.rowSide;return i?rt(e.index,o=>{if(o.type!=="row")return o;let r=o[i],s=t(r);return s===r?o:i==="left"?{...o,left:s}:{...o,right:s}},n):rt(e.index,t,n)}function ae(e,t,n={}){vn(e,i=>vr(i,t),n)}function yr(e,t={}){return ue(e,t)}function wr(){se&&clearTimeout(se),ee&&(clearTimeout(ee),ee=null),se=setTimeout(()=>{gi()},ir)}async function gi(){if(!(!Q||ke==="saving"||ke==="conflict")){if(A==="project"&&!W){console.warn("Auto-save skipped: project data not loaded");return}Z&&Z.abort(),Z=new AbortController,O({type:"save_start"});try{let e=Ke(M),t;if(A==="about")t=await fetch("/api/save-about",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({markdown:e,base_revision:le}),signal:Z.signal});else{let i=gn(e);t=await fetch("/api/save-project",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),signal:Z.signal})}if(t.status===409){O({type:"conflict"}),hi();return}if(!t.ok)throw new Error(`Save failed: ${t.status}`);let n=await t.json();n.revision&&(le=n.revision),A==="project"&&Y.clear(),Q=!1,O({type:"save_ok"})}catch(e){if(e instanceof Error&&e.name==="AbortError")return;console.error("Auto-save error:",e),O({type:"save_error"}),ee=setTimeout(()=>{ke==="error"&&Q&&gi()},or)}}}function it(){if(!D)return;U.deselect();let e=D;e.innerHTML="",e.appendChild(ui(0,"top")),M.forEach((t,n)=>{n>0&&e.appendChild(Wr(n)),e.appendChild(br(t,n))}),M.length>0&&e.appendChild(ui(M.length,"bottom"))}function br(e,t){let n=document.createElement("div");n.className="block-wrapper",n.dataset.blockIndex=String(t),n.dataset.blockId=e.id,n.dataset.blockType=e.type;let i=document.createElement("div");i.className="block-handle",i.innerHTML=he.dragHandle,i.draggable=!0,i.addEventListener("dragstart",s=>zr(s,t)),i.addEventListener("dragend",Ti),n.appendChild(i);let o=document.createElement("div");o.className="block-content",o.appendChild(cn(e,{index:t})),n.appendChild(o),e.type!=="divider"&&e.type!=="code"&&e.type!=="row"&&n.appendChild(Er(e,{index:t}));let r=document.createElement("button");return r.className="block-delete-btn",r.innerHTML=he.delete,r.title="Delete block",r.addEventListener("click",()=>xi(t)),n.appendChild(r),n.addEventListener("dragover",s=>Kr(s,t)),n.addEventListener("dragleave",Xr),n.addEventListener("drop",s=>Yr(s,t)),n}function Er(e,t){let n=document.createElement("div");n.className="block-align-toolbar";let i=("align"in e?e.align:"left")||"left";return[{value:"left",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg>',title:"Align left"},{value:"center",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/></svg>',title:"Align center"},{value:"right",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="6" y1="18" x2="21" y2="18"/></svg>',title:"Align right"}].forEach(({value:r,icon:s,title:l})=>{let a=document.createElement("button");a.className="block-align-btn"+(i===r?" active":""),a.innerHTML=s,a.title=l,a.type="button",a.addEventListener("click",c=>{c.stopPropagation(),Sr(t,r)}),n.appendChild(a)}),n}function Sr(e,t){vn(e,n=>"align"in n?{...n,align:t}:n)}function cn(e,t){switch(e.type){case"text":return ai(e,t);case"image":return Ar(e,t);case"video":return Rr(e,t);case"code":return Nr(e,t);case"html":return Fr(e,t);case"callout":return jr(e,t);case"row":return $r(e,t.index);case"divider":return Ur();default:return ai(e,t)}}function ai(e,t){let n=document.createElement("div");return n.className="text-block-wrapper",n.appendChild(Tr(e,t)),n}function Tr(e,t){let n=document.createElement("div");n.className="text-block-lines",e.align&&(n.style.textAlign=e.align);let i=(e.content||"").split(`
`);i.length||(i=[""]);let o=null,r=!t.rowSide,s=(h,m)=>{if(m<0)return null;let S=new Set;for(let f=0;f<=m;f+=1){let H=(f===m?h:i[f]??"").match(/^(\s*)(#{1,6})\s+(.*)$/);if(!H)continue;let y=document.createElement("span");y.appendChild(je(H[3]??""));let b=Et(y.textContent?.trim()??"");if(!b)continue;let k=St(b,S);if(f===m)return k}return null},l=(h,m,S)=>Math.max(m,Math.min(S,h)),a=(h,m)=>{let S=[m];for(let f=0;f<h.length;f++)S.push(m+f+1);return S},c=(h,m)=>{m.length&&(h[h.length-1]=m[0]??h[h.length-1]??0,m.length>1&&h.push(...m.slice(1)))},u=(h,m,S=0)=>{let f=[m];if(!h)return f;if(S>=vi)return c(f,a(h,m)),f;let L=0;for(;L<h.length;){let H=h.slice(L),y=wi(H);if(!y){c(f,a(H,m+L));break}if(y.index>0){let lt=H.slice(0,y.index);c(f,a(lt,m+L))}let b=L+y.index,k=m+b,q=H.slice(y.index,y.index+y.length),Oe=q.indexOf(y.content);if(Oe<0){c(f,a(q,k)),L=b+y.length;continue}let ge=k+Oe,Ce=y.tagName==="code"?a(y.content,ge):u(y.content,ge,S+1);c(f,Ce),L=b+y.length}return f},d=(h,m)=>{if(!h)return[0];if(m==="divider")return[h.length];let S=0;if(m?.startsWith("heading-")){let k=h.match(/^(\s*)(#{1,6})\s+/);k&&(S=k[0].length)}else if(m==="quote"){let k=h.match(/^(\s*)>\s+/);k&&(S=k[0].length)}let f=h.slice(S),L=[S],H=/\[([^\]]+)\]\(([^)]+)\)/g,y=0,b;for(;(b=H.exec(f))!==null;){let k=b.index;if(k>y){let Ce=f.slice(y,k);c(L,u(Ce,S+y))}let q=b[0]??"",Oe=b[1]??"",ge=b[2]??"";bi(ge)?c(L,u(Oe,S+k+1)):c(L,a(q,S+k)),y=k+q.length}if(y<f.length){let k=f.slice(y);c(L,u(k,S+y))}return L},v=(h,m)=>{let S=h.ownerDocument,f=m.clientX,L=m.clientY,H=null,y=0;if(typeof S.caretPositionFromPoint=="function"){let k=S.caretPositionFromPoint(f,L);k&&(H=k.offsetNode,y=k.offset)}if(!H&&typeof S.caretRangeFromPoint=="function"){let k=S.caretRangeFromPoint(f,L);k&&(H=k.startContainer,y=k.startOffset)}if(!H||H!==h&&!h.contains(H))return null;let b=S.createRange();b.selectNodeContents(h);try{b.setEnd(H,y)}catch{return null}return b.toString().length},p=(h,m)=>{let S=h.querySelector(".text-line-input"),f=h.querySelector(".text-block-line-preview");if(!S||!f)return null;let L=v(f,m);if(L===null)return null;let H=d(S.value,h.dataset.lineType);if(!H.length)return null;let y=l(L,0,H.length-1);return H[y]??S.value.length},g=()=>{let h=i.join(`
`);vn(t,m=>m.type==="text"?{...m,content:h}:m,{render:!1})},w=(h=null,m=null)=>{n.innerHTML="";let S=new Set;if(i.forEach((f,L)=>{let H=T(f,L,S);n.appendChild(H)}),requestAnimationFrame(()=>{n.querySelectorAll(".text-block-line").forEach(f=>{ne(f)})}),h!==null){let f=n.querySelector(`.text-block-line[data-line-index="${h}"]`);f&&x(f,m)}},T=(h,m,S)=>{let f=document.createElement("div");f.className="text-block-line",f.dataset.lineIndex=String(m);let L=document.createElement("div");if(L.className="text-block-line-preview",i.length===1&&!i[0]?.trim())f.dataset.lineType="empty",L.classList.add("text-block-line-placeholder"),L.textContent="Type something... (type / for commands)";else{let b=ci(h,S);f.dataset.lineType=b.type,L.appendChild(b.node)}let y=document.createElement("textarea");return y.className="text-line-input",y.value=h,y.rows=1,y.placeholder="Type something... (type / for commands)",L.addEventListener("click",b=>{b.preventDefault(),b.stopPropagation(),x(f,p(f,b))}),f.addEventListener("click",b=>{f.classList.contains("is-editing")||(b.preventDefault(),b.stopPropagation(),x(f))}),y.addEventListener("input",()=>{let b=y.value;if(r&&X.handleTextareaInput(y,t.index),b.includes(`
`)){let k=b.split(`
`);i.splice(m,1,...k),g();let q=k[k.length-1]??"";w(m+k.length-1,q.length);return}i[m]=b,g(),ne(f)}),y.addEventListener("keydown",b=>{if(!(r&&X.isActive()&&X.handleKeydown(b))){if((b.metaKey||b.ctrlKey)&&b.key==="k"){b.preventDefault(),dt(y,D,()=>{let k=Number.parseInt(f.dataset.lineIndex??"",10),q=Number.isNaN(k)?m:k;i[q]=y.value,g(),w(),me()});return}if(_t(b,y,me,D)){i[m]=y.value,g(),ne(f);return}if(!Dt(b,y,me)){if(b.key==="Enter"&&!b.shiftKey&&!b.metaKey&&!b.ctrlKey){b.preventDefault(),C(y,m);return}if(b.key==="Backspace"&&y.selectionStart===0&&y.selectionEnd===0){m>0&&(b.preventDefault(),_(m));return}if(b.key==="Delete"&&y.selectionStart===y.value.length&&y.selectionEnd===y.value.length){m<i.length-1&&(b.preventDefault(),N(m));return}if(b.key==="ArrowUp"&&y.selectionStart===0&&y.selectionEnd===0){m>0&&(b.preventDefault(),w(m-1,i[m-1]?.length??0));return}b.key==="ArrowDown"&&y.selectionStart===y.value.length&&y.selectionEnd===y.value.length&&m<i.length-1&&(b.preventDefault(),w(m+1,0))}}}),y.addEventListener("blur",()=>{o===m&&I(f)}),f.appendChild(L),f.appendChild(y),f},x=(h,m=null)=>{let S=Number(h.dataset.lineIndex);if(o!==null&&o!==S){let L=n.querySelector(`.text-block-line[data-line-index="${o}"]`);L&&I(L)}o=S,h.classList.add("is-editing");let f=h.querySelector(".text-line-input");f&&(f.focus({preventScroll:!0}),m&&typeof m=="object"?(f.selectionStart=m.start,f.selectionEnd=m.end??m.start):typeof m=="number"?(f.selectionStart=m,f.selectionEnd=m):f.selectionStart=f.selectionEnd=f.value.length,ne(h))},I=h=>{let m=h.querySelector(".text-line-input"),S=h.querySelector(".text-block-line-preview"),f=Number.parseInt(h.dataset.lineIndex??"",10);h.classList.remove("is-editing");let L=m?.value??"";if(S?.classList.remove("text-block-line-placeholder"),S&&(S.innerHTML=""),i.length===1&&!i[0]?.trim()&&!L.trim())h.dataset.lineType="empty",S?.classList.add("text-block-line-placeholder"),S&&(S.textContent="Type something... (type / for commands)");else if(S){let y=new Set;if(!Number.isNaN(f))for(let q=0;q<f;q+=1){let ge=(i[q]??"").match(/^(\s*)(#{1,6})\s+(.*)$/);if(!ge)continue;let Ce=document.createElement("span");Ce.appendChild(je(ge[3]??""));let lt=Et(Ce.textContent?.trim()??"");lt&&St(lt,y)}let b=ci(L,y),k=Number.isNaN(f)?null:s(L,f);k&&b.node instanceof HTMLElement&&/^H[1-6]$/.test(b.node.tagName)&&(b.node.id=k),h.dataset.lineType=b.type,S.appendChild(b.node)}o=null,ne(h)},C=(h,m)=>{let S=h.value,f=h.selectionStart,L=S.slice(0,f),H=S.slice(f),y=st(L);i[m]=L;let b=y?y+H.replace(/^\s+/,""):H;i.splice(m+1,0,b),g();let k=y?y.length:0;w(m+1,k)},_=h=>{if(h<=0)return;let m=i[h-1]??"",S=i[h]??"",f=m+S;i.splice(h-1,2,f),g(),w(h-1,m.length)},N=h=>{if(h>=i.length-1)return;let m=i[h]??"",S=i[h+1]??"",f=m+S;i.splice(h,2,f),g(),w(h,m.length)},ne=h=>{let m=h.querySelector(".text-block-line-preview"),S=h.querySelector(".text-line-input");requestAnimationFrame(()=>{let f=m?.offsetHeight??0,L=S?.scrollHeight??0,H=Math.max(27,f);h.style.minHeight=`${H}px`,h.classList.contains("is-editing")?h.style.height=`${Math.max(H,L)}px`:h.style.height=""})},st=h=>{let m=h.match(/^(\s*)([-*+])\s+/);if(m)return`${m[1]??""}${m[2]??"-"} `;let S=h.match(/^(\s*)(\d+)\.\s+/);if(S){let f=parseInt(S[2]??"1",10)+1;return`${S[1]??""}${f}. `}return null};return w(),n}function ci(e,t){let n=e.trim();if(!n){let s=document.createElement("span");return s.innerHTML="&nbsp;",{node:s,type:"empty"}}if(/^(\*{3,}|-{3,}|_{3,})$/.test(n)){let s=document.createElement("hr");return s.className="text-line-divider",{node:s,type:"divider"}}let i=e.match(/^(\s*)(#{1,6})\s+(.*)$/);if(i){let s=i[2]?.length??1,l=document.createElement(`h${s}`);l.appendChild(je(i[3]??""));let a=Et(l.textContent?.trim()??"");return a&&(l.id=St(a,t)),{node:l,type:`heading-${s}`}}let o=e.match(/^(\s*)>\s+(.*)$/);if(o){let s=document.createElement("blockquote");return s.appendChild(je(o[2]??"")),{node:s,type:"quote"}}if(/^(\s*)([-*+]|\d+\.)\s+/.test(e)){let s=document.createElement("span");return s.appendChild(je(e)),{node:s,type:"list"}}let r=document.createElement("span");return r.appendChild(je(e)),{node:r,type:"paragraph"}}function je(e){let t=document.createDocumentFragment(),n=/\[([^\]]+)\]\(([^)]+)\)/g,i=0,o;for(;(o=n.exec(e))!==null;){let r=o.index;r>i&&an(t,e.slice(i,r));let s=bi(o[2]??"");if(s){let l=document.createElement("a");l.href=s,s.startsWith("#")||s.startsWith("/")||s.startsWith("./")||s.startsWith("../")||(l.rel="noopener",l.target="_blank"),an(l,o[1]??""),t.appendChild(l)}else t.appendChild(document.createTextNode(o[0]));i=r+o[0].length}return i<e.length&&an(t,e.slice(i)),t}function an(e,t){e.appendChild(Lr(t))}function Lr(e){return yi(e,0)}var vi=8;function yi(e,t){let n=document.createDocumentFragment();if(!e)return n;if(t>=vi)return n.appendChild(document.createTextNode(e)),n;let i=0;for(;i<e.length;){let o=e.slice(i),r=wi(o);if(!r){n.appendChild(document.createTextNode(o));break}r.index>0&&n.appendChild(document.createTextNode(o.slice(0,r.index)));let s=document.createElement(r.tagName);r.tagName==="code"?s.textContent=r.content:s.appendChild(yi(r.content,t+1)),n.appendChild(s),i+=r.index+r.length}return n}function wi(e){let t=[xr,kr,Mr,Cr,Hr,Br,Pr,_r,Ir,Dr],n=null;return t.forEach(i=>{let o=i(e);o&&(!n||o.index<n.index)&&(n=o)}),n}function fe(e,t,n=1){if(!e||typeof e.index!="number")return null;let i=e[n];return i?{index:e.index,length:e[0].length,tagName:t,content:i}:null}function xr(e){return fe(e.match(/`([^`\n]+?)`/),"code")}function kr(e){return fe(e.match(/<u>([\s\S]+?)<\/u>/i),"u")}function Mr(e){let t=e.match(/<(strong|b)>([\s\S]+?)<\/(strong|b)>/i);if(!t||typeof t.index!="number")return null;let n=(t[1]||"").toLowerCase(),i=(t[3]||"").toLowerCase();return!n||n!==i?null:{index:t.index,length:t[0].length,tagName:"strong",content:t[2]??""}}function Cr(e){let t=e.match(/<(em|i)>([\s\S]+?)<\/(em|i)>/i);if(!t||typeof t.index!="number")return null;let n=(t[1]||"").toLowerCase(),i=(t[3]||"").toLowerCase();return!n||n!==i?null:{index:t.index,length:t[0].length,tagName:"em",content:t[2]??""}}function Hr(e){return fe(e.match(/<code>([\s\S]+?)<\/code>/i),"code")}function Br(e){return fe(e.match(/\*\*([^*\n][\s\S]*?)\*\*/),"strong")}function Pr(e){return fe(e.match(/__([^_\n][\s\S]*?)__/),"strong")}function _r(e){return fe(e.match(/~~([^~\n][\s\S]*?)~~/),"s")}function Ir(e){return fe(e.match(/\*([^*\n][^*\n]*?)\*/),"em")}function Dr(e){return fe(e.match(/_([^_\n][^_\n]*?)_/),"em")}function bi(e){let t=(e||"").trim();if(!t)return null;if(t.startsWith("#")||t.startsWith("/")||t.startsWith("./")||t.startsWith("../"))return t;try{let n=new URL(t,window.location.origin);if(["http:","https:","mailto:","tel:"].includes(n.protocol))return n.href}catch{return null}return null}function yn(e,t){let n=document.createElement("input");return n.type="text",n.className="media-caption-input",n.placeholder="Caption (optional)...",n.value=e||"",n.addEventListener("input",()=>{ae(t,{caption:n.value},{render:!1})}),n}function di(e,t){let n=(t??"").trim();if(!n){e.poster="",e.removeAttribute("poster");return}e.poster=n,e.setAttribute("poster",n)}function Ar(e,t){let n=document.createElement("div");if(n.className="image-block-wrapper",e.src){let i=Ht(e,r=>{U.select(r,e)});i.className="block-image",n.appendChild(i);let o=document.createElement("input");o.type="text",o.className="image-alt-input",o.placeholder="Image description...",o.value=e.alt||"",o.addEventListener("input",()=>{ae(t,{alt:o.value},{render:!1})}),n.appendChild(o),n.appendChild(yn(e.caption,t))}else n.appendChild(Si(t,"image"));return n}function Rr(e,t){let n=document.createElement("div");if(n.className="video-block-wrapper",e.src){let i=Bt(e,_=>{U.select(_,e)});i.className="block-video",n.appendChild(i);let o=document.createElement("div");o.className="video-poster-controls";let r=document.createElement("label");r.className="video-option-row";let s=document.createElement("input");s.type="checkbox",s.className="video-option-checkbox",s.checked=!!e.autoplay,r.appendChild(s);let l=document.createElement("span");l.className="video-option-label",l.textContent="Autoplay (muted loop)",r.appendChild(l);let a=document.createElement("input");a.type="url",a.className="video-poster-input",a.placeholder="Poster image URL (optional)...",a.value=e.poster||"";let c=document.createElement("div");c.className="video-poster-actions";let u=document.createElement("button");u.type="button",u.className="edit-btn-small video-poster-action",u.textContent="Upload poster",c.appendChild(u);let d=document.createElement("button");d.type="button",d.className="edit-btn-small video-poster-action",d.textContent="Use current frame",c.appendChild(d);let v=document.createElement("button");v.type="button",v.className="edit-btn-small video-poster-action",v.textContent="Clear",c.appendChild(v);let p=document.createElement("input");p.type="file",p.accept="image/*",p.className="video-poster-upload-input",p.hidden=!0;let g=!1,w=(e.poster||"").trim(),T=()=>{let _=s.checked;o.classList.toggle("poster-fields-hidden",_),a.disabled=_||g,u.disabled=_||g,d.disabled=_||g,v.disabled=_||g};s.addEventListener("change",()=>{let _=s.checked;ct(i,_),ae(t,{autoplay:_},{render:!1}),T()});let x=_=>{let N=_.trim();w&&w!==N&&sr(w)&&pn(w),w=N,di(i,N),ae(t,{poster:N},{render:!1}),v.hidden=N.length===0,a.value!==N&&(a.value=N)},I=_=>{g=_,T()};a.addEventListener("input",()=>{x(a.value)}),u.addEventListener("click",()=>{g||p.click()}),p.addEventListener("change",async()=>{let _=p.files?.[0];if(p.value="",!(!_||g)){I(!0);try{let N=await U.uploadPosterForVideo(_);x(N),E("Poster uploaded!","success")}catch(N){E(N instanceof Error?N.message:"Poster upload failed","error")}finally{I(!1)}}}),d.addEventListener("click",async()=>{if(!g){I(!0);try{let _=await U.capturePosterFromVideo(i);x(_),E("Poster captured from frame!","success")}catch(_){E(_ instanceof Error?_.message:"Frame capture failed","error")}finally{I(!1)}}}),v.addEventListener("click",()=>{g||x("")});let C=(e.poster||"").trim();di(i,C),w=C,v.hidden=C.length===0,a.value!==C&&(a.value=C),T(),o.appendChild(r),o.appendChild(a),o.appendChild(c),o.appendChild(p),n.appendChild(o),n.appendChild(yn(e.caption,t))}else n.appendChild(Si(t,"video"));return n}function Nr(e,t){let n=document.createElement("div");n.className="code-block-wrapper";let i=document.createElement("select");i.className="code-language-select",["javascript","python","html","css","bash","json","sql","go","rust","text"].forEach(s=>{let l=document.createElement("option");l.value=s,l.textContent=s,s===(e.language||"javascript")&&(l.selected=!0),i.appendChild(l)}),i.addEventListener("change",()=>{ae(t,{language:i.value},{render:!1})}),n.appendChild(i);let r=document.createElement("textarea");return r.className="code-textarea",r.value=e.code||"",r.placeholder="Enter code...",r.spellcheck=!1,Ve(r,s=>{ae(t,{code:s},{render:!1})}),r.addEventListener("keydown",s=>{s.key==="Tab"&&(s.preventDefault(),G(r,"    "),r.dispatchEvent(new Event("input",{bubbles:!0})))}),n.appendChild(r),n}function jr(e,t){let n=document.createElement("div");n.className="callout-block-wrapper";let i=document.createElement("textarea");return i.className="callout-textarea",i.value=e.content||"",i.placeholder="Callout content...",e.align&&(i.style.textAlign=e.align),Ve(i,o=>{ae(t,{content:o},{render:!1})}),n.appendChild(i),n}function $r(e,t){let n=document.createElement("div");n.className="row-block-wrapper";let i=document.createElement("div");i.className="row-toolbar";let o=document.createElement("button");o.className="row-action-btn row-action-btn-split",o.type="button",o.innerHTML=he.split,o.title="Split columns into blocks",o.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation(),Vr(t)}),i.appendChild(o);let r=document.createElement("button");r.className="row-action-btn",r.type="button",r.innerHTML=he.swap,r.title="Swap column sides",r.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation(),qr(t)}),i.appendChild(r),n.appendChild(i);let s=document.createElement("div");s.className="row-columns";let l=document.createElement("div");l.className="row-column row-column-left",l.appendChild(cn(e.left,{index:t,rowSide:"left"}));let a=document.createElement("div");return a.className="row-column row-column-right",a.appendChild(cn(e.right,{index:t,rowSide:"right"})),s.appendChild(l),s.appendChild(a),n.appendChild(s),n}function Ur(){let e=document.createElement("div");return e.className="block-divider",e.innerHTML=he.divider,e}function Fr(e,t){let n=document.createElement("div");n.className="html-block-wrapper",e.align&&(n.style.textAlign=e.align);let i=document.createElement("div");i.className="html-block-preview-container",n.appendChild(i);let o=null,r=null,s=!1,l=!1,a=document.createElement("div");a.className="html-block-controls";let c=document.createElement("button");c.className="html-toggle-btn",c.textContent="Edit HTML",c.type="button",a.appendChild(c);let u=document.createElement("button");u.className="html-toggle-btn",u.textContent="Interact",u.type="button",a.appendChild(u);function d(){r&&(r.style.display=l?"none":"block"),u.classList.toggle("is-active",l),u.textContent=l?"Resize":"Interact",u.disabled=s||!o,u.style.display=s?"none":""}function v(w){if(o&&(jn(o),o.remove(),o=null),!w.trim()){o=null,r=null,i.innerHTML='<p class="html-block-empty">Empty HTML block</p>',d();return}i.innerHTML="",o=Nn(w,{allowFullscreen:!0});let T=o,x=!!e.style&&/(^|;)\s*height\s*:/.test(e.style);T.dataset.autoHeight=x?"false":"true",Rn(T,e.style,e.align),i.appendChild(T),r=document.createElement("button"),r.type="button",r.className="html-block-select-overlay",r.setAttribute("aria-label","Select HTML block for resize"),r.addEventListener("click",I=>{I.preventDefault(),I.stopPropagation(),U.select(T,e)}),i.appendChild(r),d()}v(e.html||"");let p=document.createElement("textarea");p.className="html-textarea",p.value=e.html||"",p.placeholder="Enter raw HTML...",p.style.display="none";let g=yn(e.caption,t);return n.appendChild(p),n.appendChild(a),n.appendChild(g),c.addEventListener("click",()=>{s=!s,s?(i.style.display="none",p.style.display="block",c.textContent="Preview",l=!1,U.deselect(),d(),p.focus({preventScroll:!0})):(i.style.display="block",p.style.display="none",c.textContent="Edit HTML",v(p.value))}),u.addEventListener("click",()=>{!o||s||(l=!l,l?U.deselect():U.select(o,e),d())}),Ve(p,w=>{ae(t,{html:w},{render:!1})}),d(),n}function Ei(e){let t=M[e-1],n=M[e];return!t||!n?!1:t.type!=="row"&&n.type!=="row"}function Or(e){if(!Ei(e))return;let t=M[e-1],n=M[e];if(!t||!n)return;let i=ue("row",{left:t,right:n}),o=M.slice();o.splice(e-1,2,i),Me(o)}function qr(e){rt(e,t=>t.type!=="row"?t:{...t,left:t.right,right:t.left})}function Vr(e){let t=M[e];if(!t||t.type!=="row")return;let n=M.slice();n.splice(e,1,t.left,t.right),Me(n)}function Wr(e){let t=document.createElement("div");t.className="merge-divider",t.dataset.afterIndex=String(e);let n=document.createElement("button");if(n.className="merge-add-btn",n.innerHTML="+",n.title="Add block",n.addEventListener("click",()=>{let i=n.getBoundingClientRect();X.showFromButton(i,e,n)}),t.appendChild(n),Ei(e)){let i=document.createElement("button");i.className="merge-columns-btn",i.type="button",i.innerHTML=he.columns,i.title="Turn these two blocks into columns",i.addEventListener("click",()=>{Or(e)}),t.appendChild(i)}return t}function ui(e,t="bottom"){let n=document.createElement("div");n.className=`add-block-wrapper add-block-wrapper-${t}`;let i=document.createElement("button");return i.className="merge-add-btn",i.innerHTML="+",i.title="Add block",i.addEventListener("click",()=>{let o=i.getBoundingClientRect();X.showFromButton(o,e,i)}),n.appendChild(i),n}function Si(e,t){let n=document.createElement("div");n.className="upload-zone";let i=t==="video";n.innerHTML=`
    <div class="upload-icon">${i?he.video:he.image}</div>
    <div class="upload-text">Drop ${t} here or click to upload</div>
    ${i?`<div class="upload-zone-progress" hidden>
        <div class="upload-zone-progress-bar">
          <div class="upload-zone-progress-fill"></div>
        </div>
        <div class="upload-zone-progress-text" aria-live="polite"></div>
      </div>`:""}
    <input type="file" class="upload-input" accept="${i?"video/*":"image/*"}">
  `;let o=n.querySelector(".upload-zone-progress"),r=n.querySelector(".upload-zone-progress-fill"),s=n.querySelector(".upload-zone-progress-text"),l=!1,a=d=>{!o||!r||!s||(o.hidden=!1,r.style.width=`${Math.max(0,Math.min(100,d.progress))}%`,r.classList.toggle("is-indeterminate",d.stage==="processing"),s.textContent=d.message,n.classList.toggle("uploading",d.stage!=="error"&&d.stage!=="complete"),n.classList.toggle("upload-error",d.stage==="error"))},c=async d=>{if(!l){l=!0,n.classList.remove("upload-error");try{t==="image"?await U.handleImageUploadForBlock(d,e.index,e.rowSide):(a({stage:"uploading",progress:0,message:"Starting upload..."}),await U.handleVideoUploadForBlock(d,e.index,{rowSide:e.rowSide,onProgress:a}))}finally{l=!1,u.value="",t==="image"&&n.classList.remove("uploading")}}},u=n.querySelector(".upload-input");return u.addEventListener("change",async()=>{let d=u.files?.[0];d&&await c(d)}),n.addEventListener("click",d=>{l||d.target!==u&&u.click()}),n.addEventListener("dragover",d=>{d.preventDefault(),!l&&n.classList.add("drag-over")}),n.addEventListener("dragleave",()=>{n.classList.remove("drag-over")}),n.addEventListener("drop",async d=>{if(d.preventDefault(),l)return;n.classList.remove("drag-over");let v=d.dataTransfer?.files[0];v&&await c(v)}),n}function zr(e,t){z.sourceIndex=t,z.isDragging=!0;let n=D?.querySelector(`[data-block-index="${t}"]`);n&&n.classList.add("dragging"),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",t.toString()))}function Ti(){z.isDragging=!1,z.sourceIndex=null,z.currentDropIndex=null,D?.querySelectorAll(".dragging, .drag-over-top, .drag-over-bottom").forEach(e=>{e.classList.remove("dragging","drag-over-top","drag-over-bottom")})}function Kr(e,t){if(e.preventDefault(),!z.isDragging)return;let n=e.currentTarget,i=n.getBoundingClientRect(),o=i.top+i.height/2;D?.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(r=>{r.classList.remove("drag-over-top","drag-over-bottom")}),e.clientY<o?(n.classList.add("drag-over-top"),z.currentDropIndex=t):(n.classList.add("drag-over-bottom"),z.currentDropIndex=t+1)}function Xr(e){e.currentTarget.classList.remove("drag-over-top","drag-over-bottom")}function Yr(e,t){if(e.preventDefault(),!z.isDragging||z.sourceIndex===null)return;let n=z.sourceIndex,i=z.currentDropIndex;if(i!==null){if(n<i&&i--,n!==i){let o=M.slice(),[r]=o.splice(n,1);r&&(o.splice(i,0,r),Me(o))}Ti()}}function kt(e,t,n={}){let i=yr(t,n),o=Math.max(0,Math.min(e,M.length)),r=M.slice();r.splice(o,0,i),Me(r),(t==="text"||t==="callout")&&setTimeout(()=>{let s=D?.querySelector(`[data-block-index="${o}"] .text-line-input, [data-block-index="${o}"] .block-textarea, [data-block-index="${o}"] .callout-textarea`);s&&s.focus({preventScroll:!0})},50)}function Li(e,t,n={}){let i=M.findIndex(o=>o.id===e);i!==-1&&kt(i+1,t,n)}function xi(e){let t=M[e];if(t&&Tt(t),M.length<=1)Me([ue("text")]);else{let n=M.slice();n.splice(e,1),Me(n)}}function Gr(e,t){if(e==="execute"){let n=t;if(n.replaceBlockIndex!==null){let i=n.replaceBlockIndex;Tt(M[i]),rt(i,()=>ue(n.commandId)),(n.commandId==="text"||n.commandId==="callout")&&setTimeout(()=>{let o=D?.querySelector(`[data-block-index="${i}"] .text-line-input, [data-block-index="${i}"] .block-textarea, [data-block-index="${i}"] .callout-textarea`);o&&o.focus({preventScroll:!0})},50)}else kt(n.insertIndex,n.commandId)}else if(e==="updateContent"){let n=t;rt(n.index,i=>"content"in i?{...i,content:n.content}:i,{render:!1,markDirty:!1})}}function ki(e){if(Fe&&!(X.isActive()&&X.handleKeydown(e))){if((e.metaKey||e.ctrlKey)&&!e.altKey&&e.key.toLowerCase()==="z"){e.preventDefault(),e.shiftKey?pe.redo():pe.undo();return}if((e.metaKey||e.ctrlKey)&&!e.altKey&&e.key.toLowerCase()==="y"){e.preventDefault(),pe.redo();return}(e.metaKey||e.ctrlKey)&&e.key==="s"&&(e.preventDefault(),Lt()),e.key==="Escape"&&(e.preventDefault(),e.stopPropagation(),xt())}}function me(){Q=!0,pe.saveState(),O({type:"edit"}),wr()}async function Jr(){if(A!=="project"||Y.size===0)return;let e=Array.from(Y);try{(await fetch("/api/cleanup-assets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({urls:e}),keepalive:!0})).ok&&Y.clear()}catch{}}async function Lt(){if(!Q&&ke!=="error"){xe(window.location.pathname),ot(),window.location.reload();return}se&&(clearTimeout(se),se=null),ee&&(clearTimeout(ee),ee=null),Z&&Z.abort(),O({type:"save_start"});try{let e=Ke(M),t;if(A==="about")t=await fetch("/api/save-about",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({markdown:e,base_revision:le})});else{let i=gn(e);t=await fetch("/api/save-project",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})}if(t.status===409){O({type:"conflict"}),hi();return}if(!t.ok)throw new Error(`Save failed: ${t.status}`);let n=await t.json();n.revision&&(le=n.revision),A==="project"&&Y.clear(),Q=!1,O({type:"save_ok"}),xe(window.location.pathname),ot(),window.location.reload()}catch(e){console.error("Save error:",e),O({type:"save_error"}),E("Failed to save","error")}}async function xt(){Q&&!confirm("You have unsaved changes. Discard them?")||(await Jr(),xe(window.location.pathname),ot(),window.location.reload())}function Mi(e,t,n={}){ae({index:e},t,n)}function Zr(e){let t=document.createElement("div");t.className="edit-hero-thumbnail-controls";let n=e.video?.thumbnail||"";t.innerHTML=`
    <div class="edit-hero-thumbnail-header">
      <span class="edit-hero-thumbnail-label">Thumbnail</span>
    </div>
    <div class="edit-hero-thumbnail-content">
      <img class="edit-hero-thumbnail-preview" src="${pi(n)}"
           alt="Thumbnail" style="${n?"":"display:none"}">
      <div class="edit-hero-thumbnail-actions">
        <input type="url" class="edit-hero-thumbnail-input"
               placeholder="Thumbnail image URL..."
               value="${pi(n)}">
        <div class="edit-hero-thumbnail-buttons">
          <button type="button" class="edit-btn-small" data-action="upload">Upload</button>
          <button type="button" class="edit-btn-small" data-action="capture">Use current frame</button>
          <button type="button" class="edit-btn-small" data-action="clear" style="${n?"":"display:none"}">Clear</button>
        </div>
        <input type="file" class="edit-hero-thumbnail-file" accept="image/*" style="display: none;">
      </div>
    </div>
  `;let i=t.querySelector(".edit-hero-thumbnail-input"),o=t.querySelector(".edit-hero-thumbnail-preview"),r=t.querySelector('[data-action="upload"]'),s=t.querySelector('[data-action="capture"]'),l=t.querySelector('[data-action="clear"]'),a=t.querySelector(".edit-hero-thumbnail-file"),c=u=>{if(W&&"video"in W&&W.video){let d=W.video.thumbnail;d&&d!==u&&pn(d),W.video.thumbnail=u||void 0,me()}i&&(i.value=u||""),o&&(u?(o.src=u,o.style.display=""):o.style.display="none"),l&&(l.style.display=u?"":"none")};return i?.addEventListener("change",()=>{c(i.value.trim()||null)}),i?.addEventListener("blur",()=>{c(i.value.trim()||null)}),r?.addEventListener("click",()=>a?.click()),a?.addEventListener("change",async()=>{let u=a.files?.[0];if(u){if(!u.type.startsWith("image/")){E("Please select an image file","error");return}try{r.disabled=!0,r.textContent="Uploading...",E("Uploading thumbnail...","info");let d=await Qt(u);c(d),E("Thumbnail uploaded!","success")}catch(d){E(`Upload failed: ${d.message}`,"error")}finally{r.disabled=!1,r.textContent="Upload",a.value=""}}}),s?.addEventListener("click",async()=>{let d=t.closest(".project-item")?.querySelector(".video-container video");if(!d){E("No video element found","error");return}if(d.readyState<2){E("Video not ready yet. Please wait for it to load.","info");return}try{s.disabled=!0,s.textContent="Capturing...";let v=await en(d);c(v),E("Thumbnail captured!","success")}catch(v){E(`Capture failed: ${v.message}`,"error")}finally{s.disabled=!1,s.textContent="Use current frame"}}),l?.addEventListener("click",()=>{c(null),E("Thumbnail cleared","info")}),t}function pi(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}var Qr={init:mr,initAbout:hr,cleanup:ot,get blocks(){return M},get isActive(){return Fe},get isDirty(){return Q},get projectSlug(){return $e},get editMode(){return A},insertBlock:kt,insertBlockAfter:Li,deleteBlock:xi,updateBlock:Mi,renderBlocks:it,markDirty:me,save:Lt,cancel:xt},Ci=Qr;var Hi="bb_show_drafts";function wn(){return document.body.dataset.isolationMode==="true"}function Mt(e,t={}){let n=new URL(e,window.location.origin);return Object.entries(t).forEach(([i,o])=>{o!=null&&n.searchParams.set(i,o)}),de()&&n.searchParams.set("show_drafts","true"),n.toString()}function bn(){if(document.querySelector('link[href*="edit-mode.css"]'))return;let e=document.createElement("link");e.rel="stylesheet",e.href="/static/css/edit-mode.css",document.head.appendChild(e)}function te(){return new Promise(e=>{bn(),e()})}function Bi(e){let t=e.dataset.slug;if(!t||e.querySelector(".edit-buttons"))return;let n=document.createElement("div");n.className="edit-buttons";let i=document.createElement("button");i.className="edit-btn-action",i.textContent="Edit",i.addEventListener("click",async r=>{if(r.preventDefault(),r.stopPropagation(),!wn()){let s=Mt(`/${t}`,{edit:""});xe(new URL(s).pathname,".project-item.active .project-content"),window.location.href=s;return}window.EditMode||await te(),window.EditMode?.init(t)});let o=document.createElement("button");o.className="edit-btn-action edit-btn-settings",o.innerHTML="&#9881;",o.title="Project Settings",o.addEventListener("click",async r=>{r.preventDefault(),r.stopPropagation(),window.ProjectSettings||await te(),window.ProjectSettings?.show(t)}),n.appendChild(i),n.appendChild(o),e.appendChild(n)}function es(e){let t=e.querySelector(".edit-buttons");t&&t.remove()}function ts(){let e=document.querySelector("#main-header nav");if(!e||e.querySelector(".new-project-btn"))return;let t=window.location.pathname==="/me",n=document.createElement("button");n.className="new-project-btn",n.textContent=t?"Edit":"+ New Project",n.addEventListener("click",async i=>{i.preventDefault(),t?(window.EditMode||await te(),window.EditMode&&window.EditMode.initAbout()):(window.ProjectCreate||await te(),window.ProjectCreate?.show())}),e.insertBefore(n,e.firstChild)}function ns(){if(window.location.pathname!=="/")return;let e=document.querySelector("#main-header nav");if(!e||e.querySelector(".show-drafts-toggle"))return;let t=de(),n=document.createElement("button");n.className="show-drafts-toggle"+(t?" active":""),n.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" style="width:14px;height:14px;vertical-align:-2px;margin-right:5px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Drafts',n.addEventListener("click",o=>{o.preventDefault();let r=new URL(window.location.href);t?(r.searchParams.delete("show_drafts"),sessionStorage.removeItem(Hi)):(r.searchParams.set("show_drafts","true"),sessionStorage.setItem(Hi,"true")),window.location.href=r.toString()});let i=e.querySelector(".new-project-btn");i?e.insertBefore(n,i):e.insertBefore(n,e.firstChild)}function is(){document.addEventListener("keydown",async function(e){if((e.metaKey||e.ctrlKey)&&e.key==="e"){if(document.body.classList.contains("editing"))return;let t=document.activeElement;if(t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"))return;if(e.preventDefault(),window.location.pathname==="/me"){let o=new URL(window.location.href);o.searchParams.set("edit",""),window.history.replaceState({},"",o),window.EditMode||await te(),window.EditMode&&window.EditMode.initAbout();return}let i=document.querySelector(".project-item.active");if(i){let o=i.dataset.slug;if(o){if(!wn()){let r=Mt(`/${o}`,{edit:""});xe(new URL(r).pathname,".project-item.active .project-content"),window.location.href=r;return}window.EditMode||await te(),window.EditMode?.init(o)}}}})}function Pi(){if(li(),de(),window.location.pathname==="/"&&!new URLSearchParams(window.location.search).has("show_drafts")&&de()){let t=new URL(window.location.href);t.searchParams.set("show_drafts","true"),window.location.replace(t.toString());return}if(bn(),ts(),ns(),document.querySelectorAll(".project-item.active").forEach(Bi),document.body.addEventListener("project:afterSwap",e=>{let t=e,{element:n,isOpen:i}=t.detail;if(n?.classList?.contains("project-details")){let o=n.closest(".project-item");o&&(i?setTimeout(()=>Bi(o),50):es(o))}}),wn()){let e=new URLSearchParams(window.location.search),n=document.querySelector(".project-item.active")?.dataset.slug;n&&(e.has("edit")?setTimeout(async()=>{window.EditMode||await te(),window.EditMode?.init(n)},100):e.has("settings")&&(window.history.replaceState({},"",Mt(`/${n}`)),setTimeout(async()=>{window.ProjectSettings||await te(),window.ProjectSettings?.show(n)},100)))}window.location.pathname==="/me"&&new URLSearchParams(window.location.search).has("edit")&&setTimeout(async()=>{window.EditMode||await te(),window.EditMode&&window.EditMode.initAbout()},100),is()}function os(){Pe()&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Pi):Pi())}var rs={init:os,loadEditModeScripts:te,loadEditModeCSS:bn,isShowDraftsActive:de,buildUrlWithShowDrafts:Mt},_i=rs;var En=1,ce=6,Ii=3,ss={modal:null,projectSlug:null,projectData:null,currentView:"settings",videoFile:null,videoFlowMode:"upload",spriteStart:0,spriteDuration:Ii,objectUrl:null,activeXhr:null,videoEl:null,videoDuration:0,escHandler:null,_isDraggingSprite:!1,_mouseMoveHandler:null,_mouseUpHandler:null,_keyHandler:null,_beforeUnloadHandler:null,_spriteLooping:!1,_dragTarget:null,_dragOffset:0,_wasLoopingBeforeDrag:!1,_touchMoveHandler:null,_touchEndHandler:null,_rafId:null,_cachedTrack:null,_cachedRange:null,_cachedDimLeft:null,_cachedDimRight:null,_cachedInfo:null,_tempId:null,_hlsSessionId:null,_hlsComplete:!1,_hlsPollTimer:null,_thumbnailPollTimer:null,_hlsScriptPromise:null,_hlsPreviewUrl:null,_blobPreviewFailed:!1,_previewCodecErrorShown:!1,_hlsPreviewErrorShown:!1,_renderedThumbCount:0,async show(e){this.projectSlug=e;let t=document.querySelector(`#project-${e}`);t&&t.querySelectorAll("video").forEach(n=>n.pause());try{this.projectData=await K(`/api/project/${e}`),this.createModal()}catch(n){console.error("Failed to load project:",n),E("Failed to load project settings","error")}},createModal(){this.currentView="settings",this.modal=document.createElement("div"),this.modal.className="edit-settings-modal",this.modal.innerHTML=`
      <div class="edit-settings-overlay"></div>
      <div class="edit-settings-content"></div>
    `,document.body.appendChild(this.modal),He(),this.renderSettingsView(),this.setupBaseListeners()},setupBaseListeners(){if(!this.modal)return;let e=this.modal.querySelector(".edit-settings-overlay");e&&e.addEventListener("click",()=>{this.currentView==="video"?this.showSettingsView():this.hide()}),this.escHandler=t=>{t.key==="Escape"&&this.modal&&(t.preventDefault(),t.stopPropagation(),this.currentView==="video"?this.cancelUpload():this.hide())},document.addEventListener("keydown",this.escHandler,!0)},renderSettingsView(){this.currentView="settings";let e=this.projectData;if(!this.modal||!e)return;let t=this.modal.querySelector(".edit-settings-content");t&&(t.classList.remove("edit-settings-content--video"),t.innerHTML=`
      <div class="edit-settings-header">
        <h2>Project Settings</h2>
        <button class="edit-settings-close">&times;</button>
      </div>
      <form class="edit-settings-form" id="settings-form">
        <div class="edit-form-group">
          <label for="settings-name">Project Name</label>
          <input type="text" id="settings-name" name="name" value="${this.escAttr(e.name||"")}" required>
        </div>
        <div class="edit-form-group">
          <label for="settings-slug">URL Slug</label>
          <input type="text" id="settings-slug" name="slug" value="${this.escAttr(e.slug||"")}" required pattern="[a-z0-9\\-]+">
        </div>
        <div class="edit-form-group">
          <label for="settings-date">Date</label>
          <input type="date" id="settings-date" name="date" value="${e.date||""}" required>
        </div>
        <div class="edit-form-group">
          <label for="settings-youtube">YouTube Link</label>
          <input type="url" id="settings-youtube" name="youtube" value="${this.escAttr(e.youtube||"")}" placeholder="https://youtube.com/watch?v=...">
        </div>
        <div class="edit-form-row">
          <div class="edit-form-group edit-form-checkbox">
            <label>
              <input type="checkbox" id="settings-draft" name="draft" ${e.draft?"checked":""}>
              Draft
            </label>
          </div>
          <div class="edit-form-group edit-form-checkbox">
            <label>
              <input type="checkbox" id="settings-pinned" name="pinned" ${e.pinned?"checked":""}>
              Pinned
            </label>
          </div>
        </div>

        <div class="edit-form-section">
          <h3>Hero Video</h3>
          <div class="edit-form-group">
            <label>Current Video</label>
            ${e.video?.hls?`<div class="edit-video-info">
                    <span>HLS: ${e.video.hls.split("/").pop()}</span>
                    <div class="edit-video-actions">
                      <button type="button" class="edit-btn-small" id="update-hero-sprite">Update Sprite</button>
                      <button type="button" class="edit-btn-small" id="upload-hero-video">Replace</button>
                    </div>
                   </div>`:'<button type="button" class="edit-btn edit-btn-secondary" id="upload-hero-video">Upload Hero Video</button>'}
            <input type="file" id="hero-video-input" accept="video/*" style="display: none;">
          </div>
        </div>

        <div class="edit-settings-actions">
          <button type="button" class="edit-btn edit-btn-danger" id="delete-project">Delete Project</button>
          <div class="edit-settings-actions-right">
            <button type="button" class="edit-btn edit-btn-secondary" id="settings-cancel">Cancel</button>
            <button type="submit" class="edit-btn edit-btn-primary">Save Settings</button>
          </div>
        </div>
      </form>
    `,this.setupSettingsListeners())},setupSettingsListeners(){if(!this.modal)return;let e=this.modal.querySelector(".edit-settings-content");if(!e)return;let t=e.querySelector(".edit-settings-close");t&&t.addEventListener("click",()=>this.hide());let n=e.querySelector("#settings-cancel");n&&n.addEventListener("click",()=>this.hide());let i=e.querySelector("#settings-form");i&&i.addEventListener("submit",async a=>{a.preventDefault(),await this.saveSettings()});let o=e.querySelector("#delete-project");o&&o.addEventListener("click",async()=>{confirm(`Are you sure you want to delete "${this.projectData?.name}"? This cannot be undone.`)&&await this.deleteProject()});let r=e.querySelector("#upload-hero-video"),s=e.querySelector("#update-hero-sprite"),l=e.querySelector("#hero-video-input");r&&l&&(r.addEventListener("click",()=>l.click()),l.addEventListener("change",a=>{let u=a.target.files?.[0];if(u){if(!u.type.startsWith("video/")){E("Please select a video file","error");return}this.showVideoView(u)}})),s&&s.addEventListener("click",()=>{if(!this.projectData?.video?.hls){E("No existing hero video found for this project.","error");return}this.showVideoView()})},showVideoView(e=null){let t=!!e;if(this.currentView="video",this.videoFile=e,this.videoFlowMode=t?"upload":"existing",this.spriteStart=0,this.spriteDuration=Ii,this.videoDuration=0,this._spriteLooping=!1,this._tempId=null,this._hlsSessionId=null,this._hlsComplete=!1,this._hlsPreviewUrl=null,this._blobPreviewFailed=!1,this._previewCodecErrorShown=!1,this._hlsPreviewErrorShown=!1,this._renderedThumbCount=0,!this.modal)return;let n=this.modal.querySelector(".edit-settings-content");if(!n)return;n.classList.add("edit-settings-content--video");let i=this.getProcessButtonText(),o=t?"Process Hero Video":"Update Hero Sprite",r=t&&e?`${this.escHtml(e.name)} (${(e.size/(1024*1024)).toFixed(1)} MB)`:"Using current hero HLS stream",s=t?"Uploading...":"Loading current video...";n.innerHTML=`
      <div class="edit-settings-header">
        <h2>${o}</h2>
        <button class="edit-settings-close">&times;</button>
      </div>
      <div class="edit-hero-video-preview">
        <video class="edit-hero-video-player" controls playsinline></video>
      </div>
      <div class="edit-hero-file-info">${r}</div>
      <div class="edit-hero-preview-status" hidden></div>
      <div class="edit-hero-timeline">
        <div class="edit-hero-timeline-track">
          <canvas class="edit-hero-timeline-thumbs"></canvas>
          <div class="edit-hero-timeline-dim-left"></div>
          <div class="edit-hero-timeline-dim-right"></div>
          <div class="edit-hero-sprite-range">
            <div class="edit-hero-sprite-handle edit-hero-sprite-handle--start" data-handle="start">
              <div class="edit-hero-sprite-handle-grip"></div>
            </div>
            <div class="edit-hero-sprite-handle edit-hero-sprite-handle--end" data-handle="end">
              <div class="edit-hero-sprite-handle-grip"></div>
            </div>
          </div>
          <div class="edit-hero-playhead"></div>
        </div>
      </div>
      <div class="edit-hero-timeline-loading" hidden>Refining timeline preview...</div>
      <div class="edit-hero-time-display">
        <span class="edit-hero-current-time">0:00</span>
        <span class="edit-hero-sprite-info">Sprite: 0:00 - 0:03 (3.0s)</span>
        <span class="edit-hero-total-time">0:00</span>
      </div>
      <div class="edit-hero-progress" style="display: none;">
        <div class="edit-hero-progress-bar">
          <div class="edit-hero-progress-fill"></div>
        </div>
        <div class="edit-hero-progress-text">${s}</div>
      </div>
      <div class="edit-hero-actions">
        <button type="button" class="edit-btn edit-btn-secondary" id="hero-video-cancel">Cancel</button>
        <button type="button" class="edit-btn edit-btn-primary" id="hero-video-process" disabled>${i}</button>
      </div>
    `,this.videoEl=n.querySelector(".edit-hero-video-player"),this.updatePreviewStatus();let l=n.querySelector(".edit-settings-close");l&&l.addEventListener("click",()=>this.cancelUpload());let a=n.querySelector("#hero-video-cancel");a&&a.addEventListener("click",()=>this.cancelUpload());let c=n.querySelector("#hero-video-process");if(c&&c.addEventListener("click",()=>this.processVideo()),t&&e){this.extractServerThumbnails(e,n);return}this.extractExistingVideoThumbnails(n)},getProcessButtonText(){return this.videoFlowMode==="existing"?"Generate New Sprite":"Confirm & Generate Sprite"},extractServerThumbnails(e,t){let n=t.querySelector("#hero-video-process"),i=t.querySelector(".edit-hero-progress"),o=t.querySelector(".edit-hero-progress-fill"),r=t.querySelector(".edit-hero-progress-text");if(!i||!o||!r)return;i.style.display="block",r.textContent="Uploading video...";let s=new FormData;s.append("file",e),this.projectSlug&&s.append("project_slug",this.projectSlug);let l=new XMLHttpRequest;this.activeXhr=l,l.upload.addEventListener("progress",a=>{if(a.lengthComputable){let c=a.loaded/a.total*50;o.style.width=`${c}%`;let u=(a.loaded/(1024*1024)).toFixed(1),d=(a.total/(1024*1024)).toFixed(1);r.textContent=`Uploading: ${u} / ${d} MB`}}),l.addEventListener("load",()=>{if(this.activeXhr=null,l.status>=200&&l.status<300)try{let a=JSON.parse(l.responseText);if(a.success){this._tempId=a.temp_id,this.videoDuration=a.duration;let c=t.querySelector(".edit-hero-total-time");c&&(c.textContent=this.formatTime(this.videoDuration)),this.updateSpriteRange(),this.renderServerThumbnails(a.frames);let u=t.querySelector(".edit-hero-timeline-loading");u&&(u.hidden=!1),this.pollRemainingThumbnails(),n&&(n.disabled=!1),a.hls_session_id?(this._hlsSessionId=a.hls_session_id,o.style.width="50%",r.textContent="Encoding HLS...",this.pollHlsProgress(o,r,i)):i.style.display="none",this.objectUrl=URL.createObjectURL(e),this.videoEl=t.querySelector(".edit-hero-video-player"),this.videoEl&&(this.videoEl.classList.remove("hls-video-preview"),this.videoEl.dataset.previewSource="blob",this.videoEl.addEventListener("error",()=>{!this.videoEl||!(this.videoEl.currentSrc||this.videoEl.src||"").startsWith("blob:")||this._previewCodecErrorShown||(this._blobPreviewFailed=!0,this._previewCodecErrorShown=!0,this.updatePreviewStatus("Preview unavailable: this upload codec is not supported by your browser yet. It will appear once HLS finishes encoding.","warning"),E("Browser cannot play this upload codec. Preview will switch to HLS when ready.","info",4500))},{once:!0}),this.videoEl.addEventListener("loadedmetadata",()=>{!this.videoEl||!(this.videoEl.currentSrc||this.videoEl.src||"").startsWith("blob:")||(this.videoEl.videoWidth===0&&!this._blobPreviewFailed?(this._blobPreviewFailed=!0,this.updatePreviewStatus("Preview unavailable: browser can only decode audio for this upload. It will appear once HLS finishes encoding.","warning")):this._blobPreviewFailed||this.updatePreviewStatus())},{once:!0}),this.objectUrl&&(this.videoEl.src=this.objectUrl),this.setupVideoListeners(t))}else throw new Error(a.detail||"Thumbnail extraction failed")}catch(a){E(`Thumbnail extraction failed: ${a.message}`,"error"),this.cancelUpload()}else{let a="Thumbnail extraction failed";try{a=JSON.parse(l.responseText).detail||a}catch{}E(a,"error"),this.cancelUpload()}}),l.addEventListener("error",()=>{this.activeXhr=null,E("Network error during thumbnail extraction","error"),this.cancelUpload()}),l.open("POST","/api/video-thumbnails"),l.send(s)},async extractExistingVideoThumbnails(e){let t=e.querySelector("#hero-video-process"),n=e.querySelector(".edit-hero-progress"),i=e.querySelector(".edit-hero-progress-fill"),o=e.querySelector(".edit-hero-progress-text");if(!(!n||!i||!o)){if(!this.projectSlug){E("Project slug missing. Please reload and try again.","error"),this.cancelUpload();return}n.style.display="block",i.style.width="15%",o.textContent="Loading current video...";try{let r=new FormData;r.append("project_slug",this.projectSlug);let s=await fetch("/api/video-thumbnails-existing",{method:"POST",body:r});if(!s.ok){let u=await s.json();throw new Error(u.detail||"Failed to load existing video")}let l=await s.json();if(!l.success)throw new Error(l.detail||"Failed to load existing video");this._tempId=l.temp_id,this.videoDuration=l.duration,this._hlsComplete=!0,this._hlsSessionId=null;let a=e.querySelector(".edit-hero-total-time");a&&(a.textContent=this.formatTime(this.videoDuration)),this.updateSpriteRange(),this.renderServerThumbnails(l.frames||[]);let c=e.querySelector(".edit-hero-timeline-loading");c&&(c.hidden=!1),this.pollRemainingThumbnails(),t&&(t.disabled=!1),this.videoEl=e.querySelector(".edit-hero-video-player"),this.updatePreviewStatus(),this.setupVideoListeners(e),i.style.width="65%",o.textContent="Loading HLS preview...",l.hls_url&&await this.switchPreviewToHls(l.hls_url),i.style.width="100%",o.textContent="Preview ready. Select sprite range and confirm.",setTimeout(()=>{this.currentView==="video"&&(n.style.display="none")},1200)}catch(r){E(`Failed to load existing hero video: ${r.message}`,"error"),this.cancelUpload()}}},pollRemainingThumbnails(){let e=async()=>{if(!(!this._tempId||this.currentView!=="video"))try{let t=await fetch(`/api/video-thumbnails/more/${this._tempId}`);if(!t.ok)return;let n=await t.json(),i=this.modal?.querySelector(".edit-hero-timeline-loading");if(n.frames&&n.frames.length>this._renderedThumbCount&&this.renderServerThumbnails(n.frames),n.complete)i&&(i.hidden=!0);else{if(i){i.hidden=!1;let o=Array.isArray(n.frames)?n.frames.length:this._renderedThumbCount;i.textContent=`Refining timeline preview... (${o} frames)`}this._thumbnailPollTimer=setTimeout(e,500)}}catch{this._thumbnailPollTimer=setTimeout(e,1e3)}};e()},pollHlsProgress(e,t,n){this._hlsSessionId&&(this._hlsPollTimer=setInterval(async()=>{if(!this._hlsSessionId||this.currentView!=="video"){this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null);return}try{let i=await fetch(`/api/hls-progress/${this._hlsSessionId}`);if(!i.ok)return;let o=await i.json();if(o.status==="complete")this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null),this._hlsComplete=!0,o.hls_url&&await this.switchPreviewToHls(o.hls_url),e.style.width="100%",t.textContent="HLS ready! Select sprite range and confirm.",setTimeout(()=>{n&&this.currentView==="video"&&(n.style.display="none")},1500);else if(o.status==="error")this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null),t.textContent="HLS encoding failed - will retry on confirm",e.style.background="#ef4444",setTimeout(()=>{n&&this.currentView==="video"&&(n.style.display="none",e.style.background="")},2e3);else{let r=o.progress||0,s=50+r*.5;e.style.width=`${s}%`,t.textContent=o.stage||`Encoding HLS... ${Math.round(r)}%`}}catch{}},1e3))},loadHlsScript(){if(window.Hls)return Promise.resolve();if(this._hlsScriptPromise)return this._hlsScriptPromise;let e=document.body.dataset.hlsJsSrc||"https://cdn.jsdelivr.net/npm/hls.js@1.5.12";return this._hlsScriptPromise=new Promise((t,n)=>{let i=document.createElement("script");i.src=e,i.async=!0,i.onload=()=>t(),i.onerror=()=>n(new Error("Failed to load HLS.js")),document.head.appendChild(i)}),this._hlsScriptPromise},async switchPreviewToHls(e){if(!e||!this.videoEl||this.currentView!=="video"||this._hlsPreviewUrl===e)return;let t=this.videoEl,n=Number.isFinite(t.currentTime)?t.currentTime:0,i=!t.paused||this._spriteLooping,o=!!t.canPlayType("application/vnd.apple.mpegurl"),r=()=>{if(n>0)try{t.currentTime=n}catch{}i&&t.play().catch(()=>{})},s=()=>{t.hlsInstance&&(t.hlsInstance.destroy(),t.hlsInstance=null)},l=()=>new Promise((u,d)=>{if(!window.Hls||!window.Hls.isSupported()){d(new Error("HLS.js not supported"));return}s();let v=new window.Hls({abrEwmaDefaultEstimate:5e6,capLevelToPlayerSize:!0});t.hlsInstance=v;let p=!1,g=(w,T)=>{p||(p=!0,w?(r(),u()):(s(),d(T||new Error("HLS.js failed to initialize"))))};v.on(window.Hls.Events.MANIFEST_PARSED,()=>g(!0)),v.on(window.Hls.Events.ERROR,(w,T)=>{let x=T;x&&x.fatal&&g(!1,new Error(x.details||"HLS.js fatal error"))}),v.loadSource(e),v.attachMedia(t)}),a=()=>new Promise((u,d)=>{if(!o){d(new Error("Native HLS not supported"));return}let v=()=>{g(),r(),u()},p=()=>{g(),d(new Error("Native HLS failed to load"))},g=()=>{t.removeEventListener("loadedmetadata",v),t.removeEventListener("error",p)};s(),t.addEventListener("loadedmetadata",v),t.addEventListener("error",p),t.src=e,t.load()}),c=!1;try{await l(),c=!0}catch{try{await this.loadHlsScript(),await l(),c=!0}catch{if(o)try{await a(),c=!0}catch{}}}if(!c){t.dataset.previewSource="blob",this._blobPreviewFailed&&!this._hlsPreviewErrorShown?(this._hlsPreviewErrorShown=!0,this.updatePreviewStatus("Preview unavailable: HLS preview could not be initialized.","error"),E("HLS preview could not be initialized. Video will still process, but live preview is unavailable.","error",5e3)):this.updatePreviewStatus();return}this._hlsPreviewUrl=e,t.classList.add("hls-video-preview"),t.dataset.previewSource="hls",this.updatePreviewStatus(),this.objectUrl&&(URL.revokeObjectURL(this.objectUrl),this.objectUrl=null)},updatePreviewStatus(e="",t="info"){if(!this.modal||this.currentView!=="video")return;let n=this.modal.querySelector(".edit-hero-preview-status");if(n){if(!e){n.hidden=!0,n.textContent="",n.classList.remove("is-info","is-warning","is-error","is-success");return}n.hidden=!1,n.textContent=e,n.classList.remove("is-info","is-warning","is-error","is-success"),n.classList.add(`is-${t}`)}},renderServerThumbnails(e){if(!this.modal)return;let t=this.modal.querySelector(".edit-hero-timeline-thumbs");if(!t||!e||e.length===0)return;this._renderedThumbCount=e.length;let n=t.parentElement;if(!n)return;let i=n.clientWidth,o=n.clientHeight,r=window.devicePixelRatio||1;t.width=i*r,t.height=o*r;let s=t.getContext("2d");if(!s)return;s.scale(r,r),s.clearRect(0,0,i,o);let l=e.length,a=new Array(l).fill(null),c=0,u=(v,p)=>{let g=Math.floor(p*i/l),w=p===l-1?i:Math.floor((p+1)*i/l),T=Math.max(1,w-g),x=v.width/v.height,I=T/o,C=0,_=0,N=v.width,ne=v.height;x>I?(N=Math.max(1,Math.round(v.height*I)),C=Math.max(0,Math.floor((v.width-N)/2))):x<I&&(ne=Math.max(1,Math.round(v.width/I)),_=Math.max(0,Math.floor((v.height-ne)/2)));let st=Math.max(0,g-(p>0?1:0)),h=Math.min(i-st,T+(p>0?1:0));s.drawImage(v,C,_,N,ne,st,0,h,o)},d=()=>{if(c++,c!==l)return;s.clearRect(0,0,i,o);let v=null;for(let g=0;g<l;g++){let w=a[g]??null;w?v=w:v&&(a[g]=v)}let p=null;for(let g=l-1;g>=0;g--){let w=a[g]??null;w?p=w:p&&(a[g]=p)}for(let g=0;g<l;g++){let w=a[g];w&&u(w,g)}t.classList.add("loaded")};e.forEach((v,p)=>{let g=new Image;g.onload=()=>{a[p]=g,d()},g.onerror=d,g.src="data:image/jpeg;base64,"+v})},setupVideoListeners(e){if(!this.videoEl)return;this.videoEl.addEventListener("timeupdate",()=>{if(!this.videoEl)return;this.updatePlayhead();let i=e.querySelector(".edit-hero-current-time");i&&(i.textContent=this.formatTime(this.videoEl.currentTime)),this._spriteLooping&&this.videoEl.currentTime>=this.spriteStart+this.spriteDuration&&(this.videoEl.currentTime=this.spriteStart)});let t=e.querySelector(".edit-hero-timeline-track");t&&t.addEventListener("click",i=>{if(this._isDraggingSprite||!this.videoEl)return;let o=t.getBoundingClientRect(),s=(i.clientX-o.left)/o.width*this.videoDuration,l=this.spriteStart+this.spriteDuration;s>=this.spriteStart&&s<=l?(this._spriteLooping=!0,this.videoEl.currentTime=s,this.videoEl.play()):(this._spriteLooping=!1,this.spriteStart=Math.max(0,Math.min(s,this.videoDuration-this.spriteDuration)),this.videoEl.currentTime=this.spriteStart,this.updateSpriteRange()),this.updateSpriteLoopUI()}),this._cachedTrack=e.querySelector(".edit-hero-timeline-track"),this._cachedRange=e.querySelector(".edit-hero-sprite-range"),this._cachedDimLeft=e.querySelector(".edit-hero-timeline-dim-left"),this._cachedDimRight=e.querySelector(".edit-hero-timeline-dim-right"),this._cachedInfo=e.querySelector(".edit-hero-sprite-info");let n=this._cachedRange;if(n){let i=(s,l)=>{if(this._isDraggingSprite=!0,this._dragTarget=l,n.classList.add("is-dragging"),this._wasLoopingBeforeDrag=this._spriteLooping,this.videoEl&&!this.videoEl.paused&&this.videoEl.pause(),l==="range"&&this._cachedTrack){let a=this._cachedTrack.getBoundingClientRect(),u=(s-a.left)/a.width*this.videoDuration;this._dragOffset=u-this.spriteStart}};n.addEventListener("mousedown",s=>{s.target.closest(".edit-hero-sprite-handle")||(i(s.clientX,"range"),s.preventDefault(),s.stopPropagation())}),n.addEventListener("touchstart",s=>{if(s.target.closest(".edit-hero-sprite-handle"))return;let a=s.touches[0];a&&(i(a.clientX,"range"),s.preventDefault(),s.stopPropagation())},{passive:!1});let o=n.querySelector(".edit-hero-sprite-handle--start");o&&(o.addEventListener("mousedown",s=>{i(s.clientX,"start"),s.preventDefault(),s.stopPropagation()}),o.addEventListener("touchstart",s=>{let l=s.touches[0];l&&(i(l.clientX,"start"),s.preventDefault(),s.stopPropagation())},{passive:!1}));let r=n.querySelector(".edit-hero-sprite-handle--end");r&&(r.addEventListener("mousedown",s=>{i(s.clientX,"end"),s.preventDefault(),s.stopPropagation()}),r.addEventListener("touchstart",s=>{let l=s.touches[0];l&&(i(l.clientX,"end"),s.preventDefault(),s.stopPropagation())},{passive:!1})),n.addEventListener("dblclick",s=>{s.preventDefault(),s.stopPropagation(),this._spriteLooping=!this._spriteLooping,this._spriteLooping&&this.videoEl&&(this.videoEl.currentTime=this.spriteStart,this.videoEl.play()),this.updateSpriteLoopUI()})}this._mouseMoveHandler=i=>{this._isDraggingSprite&&this.handleDrag(i.clientX)},document.addEventListener("mousemove",this._mouseMoveHandler),this._mouseUpHandler=()=>{this._isDraggingSprite&&(this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),this._isDraggingSprite=!1,this._dragTarget=null,this._cachedRange?.classList.remove("is-dragging"),this._wasLoopingBeforeDrag&&this.videoEl&&(this.videoEl.currentTime=this.spriteStart,this.videoEl.play()),this._wasLoopingBeforeDrag=!1)},document.addEventListener("mouseup",this._mouseUpHandler),this._touchMoveHandler=i=>{if(!this._isDraggingSprite)return;let o=i.touches[0];o&&this.handleDrag(o.clientX)},document.addEventListener("touchmove",this._touchMoveHandler,{passive:!0}),this._touchEndHandler=()=>{this._isDraggingSprite&&(this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),this._isDraggingSprite=!1,this._dragTarget=null,this._cachedRange?.classList.remove("is-dragging"),this._wasLoopingBeforeDrag&&this.videoEl&&(this.videoEl.currentTime=this.spriteStart,this.videoEl.play()),this._wasLoopingBeforeDrag=!1)},document.addEventListener("touchend",this._touchEndHandler),this._keyHandler=i=>{if(!(this.currentView!=="video"||!this.modal||!this.videoEl)){if(i.key==="ArrowLeft"){if(i.preventDefault(),i.shiftKey){let o=Math.max(En,this.spriteDuration-.5);this.spriteDuration=o}else this.spriteStart=Math.max(0,this.spriteStart-.5);this.videoEl.currentTime=this.spriteStart,this.updateSpriteRange()}if(i.key==="ArrowRight"){if(i.preventDefault(),i.shiftKey){let o=Math.min(ce,this.videoDuration-this.spriteStart),r=Math.min(o,this.spriteDuration+.5);this.spriteDuration=r,this.videoEl.currentTime=this.spriteStart+this.spriteDuration}else this.spriteStart=Math.min(this.videoDuration-this.spriteDuration,this.spriteStart+.5),this.videoEl.currentTime=this.spriteStart;this.updateSpriteRange()}}},document.addEventListener("keydown",this._keyHandler)},updateSpriteLoopUI(){if(!this.modal)return;let e=this.modal.querySelector(".edit-hero-sprite-info");e&&(this._spriteLooping?e.classList.add("looping"):e.classList.remove("looping"))},showSettingsView(){this.cleanupVideoState(),this.renderSettingsView()},cleanupVideoState(){this.videoEl&&this.videoEl.hlsInstance&&(this.videoEl.hlsInstance.destroy(),this.videoEl.hlsInstance=null),this.objectUrl&&(URL.revokeObjectURL(this.objectUrl),this.objectUrl=null),this._mouseMoveHandler&&(document.removeEventListener("mousemove",this._mouseMoveHandler),this._mouseMoveHandler=null),this._mouseUpHandler&&(document.removeEventListener("mouseup",this._mouseUpHandler),this._mouseUpHandler=null),this._keyHandler&&(document.removeEventListener("keydown",this._keyHandler),this._keyHandler=null),this._touchMoveHandler&&(document.removeEventListener("touchmove",this._touchMoveHandler),this._touchMoveHandler=null),this._touchEndHandler&&(document.removeEventListener("touchend",this._touchEndHandler),this._touchEndHandler=null),this._beforeUnloadHandler&&(window.removeEventListener("beforeunload",this._beforeUnloadHandler),this._beforeUnloadHandler=null),this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null),this._thumbnailPollTimer&&(clearTimeout(this._thumbnailPollTimer),this._thumbnailPollTimer=null),this.activeXhr&&(this.activeXhr.abort(),this.activeXhr=null),this.videoEl=null,this.videoFile=null,this.videoFlowMode="upload",this._tempId=null,this._isDraggingSprite=!1,this._spriteLooping=!1,this._hlsSessionId=null,this._hlsComplete=!1,this._hlsPreviewUrl=null,this._blobPreviewFailed=!1,this._previewCodecErrorShown=!1,this._hlsPreviewErrorShown=!1,this._renderedThumbCount=0,this._dragTarget=null,this._dragOffset=0,this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),this._cachedTrack=null,this._cachedRange=null,this._cachedDimLeft=null,this._cachedDimRight=null,this._cachedInfo=null},handleDrag(e){if(!this._dragTarget||!this._cachedTrack||!this.videoEl)return;let t=this._cachedTrack.getBoundingClientRect(),i=Math.max(0,Math.min(1,(e-t.left)/t.width))*this.videoDuration,o=this.spriteStart+this.spriteDuration;if(this._dragTarget==="start"){let r=Math.max(0,Math.min(i,o-En)),s=o,l=s-r;l>ce&&(l=ce,s=r+ce,s>this.videoDuration&&(s=this.videoDuration,r=s-ce)),this.spriteStart=r,this.spriteDuration=l,this.videoEl.currentTime=this.spriteStart}else if(this._dragTarget==="end"){let r=Math.max(this.spriteStart+En,Math.min(i,this.videoDuration)),s=this.spriteStart,l=r-s;l>ce&&(l=ce,s=r-ce,s<0&&(s=0,r=ce)),this.spriteStart=s,this.spriteDuration=l,this.videoEl.currentTime=r}else if(this._dragTarget==="range"){let r=i-this._dragOffset;r=Math.max(0,Math.min(r,this.videoDuration-this.spriteDuration)),this.spriteStart=r,this.videoEl.currentTime=this.spriteStart}this.updateSpriteRange()},updateSpriteRange(){if(!this.videoDuration)return;let e=this._cachedRange||this.modal?.querySelector(".edit-hero-sprite-range"),t=this._cachedInfo||this.modal?.querySelector(".edit-hero-sprite-info"),n=this._cachedDimLeft||this.modal?.querySelector(".edit-hero-timeline-dim-left"),i=this._cachedDimRight||this.modal?.querySelector(".edit-hero-timeline-dim-right");if(!e)return;let o=this.spriteStart/this.videoDuration*100,r=this.spriteDuration/this.videoDuration*100;if(e.style.left=`${o}%`,e.style.width=`${r}%`,n&&(n.style.width=`${o}%`),i&&(i.style.left=`${o+r}%`,i.style.width=`${100-o-r}%`),t){let s=this.spriteStart+this.spriteDuration;t.textContent=`Sprite: ${this.formatTime(this.spriteStart)} - ${this.formatTime(s)} (${this.spriteDuration.toFixed(1)}s)`}},updatePlayhead(){if(!this.modal||!this.videoEl||!this.videoDuration)return;let e=this.modal.querySelector(".edit-hero-playhead");if(!e)return;let t=this.videoEl.currentTime/this.videoDuration*100;e.style.left=`${t}%`},async processVideo(){if(!this.modal)return;let e=this.modal.querySelector("#hero-video-process"),t=this.modal.querySelector(".edit-hero-progress"),n=this.modal.querySelector(".edit-hero-progress-fill"),i=this.modal.querySelector(".edit-hero-progress-text");if(!e||!t||!n||!i)return;e.disabled=!0,e.textContent="Processing...",t.style.display="block",this._thumbnailPollTimer&&(clearTimeout(this._thumbnailPollTimer),this._thumbnailPollTimer=null),this._hlsPollTimer&&(clearInterval(this._hlsPollTimer),this._hlsPollTimer=null),this._hlsSessionId&&!this._hlsComplete?(n.style.width="20%",i.textContent="Encoding video..."):(n.style.width="80%",i.textContent="Generating sprite sheet & thumbnail...");let o=null;this._hlsSessionId&&!this._hlsComplete&&(o=setInterval(async()=>{try{let r=await fetch(`/api/hls-progress/${this._hlsSessionId}`);if(!r.ok)return;let s=await r.json();if(s.status==="complete")o&&(clearInterval(o),o=null),this._hlsComplete=!0,s.hls_url&&await this.switchPreviewToHls(s.hls_url),n.style.width="80%",i.textContent="Generating sprite sheet & thumbnail...";else if(s.status==="error")o&&(clearInterval(o),o=null);else{let l=s.progress||0,a=20+l*.6;n.style.width=`${a}%`;let c=s.stage||`Encoding video... ${Math.round(l)}%`;i.textContent=c}}catch{}},1e3)),this._beforeUnloadHandler=r=>{r.preventDefault(),r.returnValue=""},window.addEventListener("beforeunload",this._beforeUnloadHandler);try{let r=this._tempId;this._tempId=null;let s=new FormData;r&&s.append("temp_id",r),this.projectSlug&&s.append("project_slug",this.projectSlug),s.append("sprite_start",String(this.spriteStart)),s.append("sprite_duration",String(this.spriteDuration)),this._hlsSessionId&&s.append("hls_session_id",this._hlsSessionId);let l=await fetch("/api/generate-sprite-sheet",{method:"POST",body:s});if(o&&(clearInterval(o),o=null),!l.ok){let c=await l.json();throw new Error(c.detail||"Sprite sheet generation failed")}let a=await l.json();if(a.success&&a.video){n.style.width="95%",i.textContent="Saving...",this.projectData&&(this.projectData.video=a.video),await this.saveVideoData(a.video),n.style.width="100%",i.textContent="Complete!";let c=this.videoFlowMode==="existing"?"Hero sprite updated successfully!":"Video processed successfully!";E(c,"success"),setTimeout(()=>this.showSettingsView(),800)}else throw new Error(a.detail||"Processing failed")}catch(r){o&&clearInterval(o),this.handleProcessingError(r.message,e,t)}finally{this._beforeUnloadHandler&&(window.removeEventListener("beforeunload",this._beforeUnloadHandler),this._beforeUnloadHandler=null)}},handleProcessingError(e,t,n){this._beforeUnloadHandler&&(window.removeEventListener("beforeunload",this._beforeUnloadHandler),this._beforeUnloadHandler=null),E(`Video processing failed: ${e}`,"error"),t&&(t.disabled=!1,t.textContent=this.getProcessButtonText()),n&&(n.style.display="none")},cancelUpload(){this.activeXhr&&(this.activeXhr.abort(),this.activeXhr=null),this.showSettingsView()},formatTime(e){let t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n.toString().padStart(2,"0")}`},escAttr(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},escHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},async saveSettings(){if(!this.modal)return;let e=this.modal.querySelector("#settings-form");if(!e)return;let t=new FormData(e),n={name:t.get("name"),slug:t.get("slug"),original_slug:this.projectSlug,date:t.get("date"),youtube:t.get("youtube")||null,draft:t.get("draft")==="on",pinned:t.get("pinned")==="on",video:this.projectData?.video,markdown:this.projectData?.markdown,base_revision:this.projectData?.revision};try{let i=await K("/api/save-project",{method:"POST",body:JSON.stringify(n)});i.revision&&this.projectData&&(this.projectData.revision=i.revision),E("Settings saved!","success"),n.slug!==this.projectSlug?window.location.href=_e(`/${n.slug}`):(this.hide(),window.location.reload())}catch(i){console.error("Save settings error:",i),E("Failed to save settings","error")}},async saveVideoData(e){if(!this.projectData)return;let t={...this.projectData,original_slug:this.projectSlug,video:e,base_revision:this.projectData.revision},n=await K("/api/save-project",{method:"POST",body:JSON.stringify(t)});n.revision&&(this.projectData.revision=n.revision)},async deleteProject(){if(this.projectSlug)try{await K(`/api/project/${this.projectSlug}`,{method:"DELETE"}),E("Project deleted","success"),this.hide(),window.location.href=_e("/")}catch(e){console.error("Delete project error:",e),E("Failed to delete project","error")}},hide(){this.cleanupVideoState(),this.escHandler&&(document.removeEventListener("keydown",this.escHandler,!0),this.escHandler=null),this.modal&&(this.modal.remove(),this.modal=null),Be()}},Di=ss;var ls={modal:null,show(){this.modal=document.createElement("div"),this.modal.className="edit-create-modal",this.modal.innerHTML=`
      <div class="edit-create-overlay"></div>
      <div class="edit-create-content">
        <div class="edit-create-header">
          <h2>Create New Project</h2>
          <button class="edit-create-close">&times;</button>
        </div>
        <form class="edit-create-form" id="create-project-form">
          <div class="edit-form-group">
            <label for="project-name">Project Name</label>
            <input type="text" id="project-name" name="name" required placeholder="My New Project">
          </div>
          <div class="edit-form-group">
            <label for="project-slug">URL Slug</label>
            <input type="text" id="project-slug" name="slug" required placeholder="my-new-project" pattern="[a-z0-9][a-z0-9_\\-]*">
            <span class="edit-form-hint">Must start with letter/number. Lowercase, numbers, hyphens, underscores only.</span>
          </div>
          <div class="edit-form-group">
            <label for="project-date">Date</label>
            <input type="date" id="project-date" name="date" required value="${new Date().toISOString().split("T")[0]}">
          </div>
          <div class="edit-form-row">
            <div class="edit-form-group edit-form-checkbox">
              <label>
                <input type="checkbox" id="project-draft" name="draft" checked>
                Draft
              </label>
            </div>
            <div class="edit-form-group edit-form-checkbox">
              <label>
                <input type="checkbox" id="project-pinned" name="pinned">
                Pinned
              </label>
            </div>
          </div>
          <div class="edit-create-actions">
            <button type="button" class="edit-btn edit-btn-secondary" id="create-cancel">Cancel</button>
            <button type="submit" class="edit-btn edit-btn-primary">Create Project</button>
          </div>
        </form>
      </div>
    `,document.body.appendChild(this.modal),He(),this.setupEventListeners();let e=this.modal.querySelector("#project-name"),t=this.modal.querySelector("#project-slug");e&&t&&(e.addEventListener("input",()=>{t.value=this.generateSlug(e.value)}),e.focus())},generateSlug(e){return e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^[-_]+/,"").replace(/[-_]+$/,"")},setupEventListeners(){if(!this.modal)return;let e=this.modal.querySelector(".edit-create-close");e&&e.addEventListener("click",()=>this.hide());let t=this.modal.querySelector(".edit-create-overlay");t&&t.addEventListener("click",()=>this.hide());let n=this.modal.querySelector("#create-cancel");n&&n.addEventListener("click",()=>this.hide());let i=this.modal.querySelector("#create-project-form");i&&i.addEventListener("submit",async r=>{r.preventDefault(),await this.createProject()});let o=r=>{r.key==="Escape"&&this.modal&&(this.hide(),document.removeEventListener("keydown",o))};document.addEventListener("keydown",o)},async createProject(){if(!this.modal)return;let e=this.modal.querySelector("#create-project-form");if(!e)return;let t=new FormData(e),n={name:t.get("name"),slug:t.get("slug"),date:t.get("date"),draft:t.get("draft")==="on",pinned:t.get("pinned")==="on",markdown:""};try{await K("/api/create-project",{method:"POST",body:JSON.stringify(n)}),E("Project created!","success"),this.hide(),window.location.href=_e(`/${n.slug}`)}catch(i){console.error("Create project error:",i);let o=i instanceof Error?i.message:"Failed to create project";E(o,"error")}},hide(){this.modal&&(this.modal.remove(),this.modal=null),Be()}},Ai=ls;typeof window<"u"&&(window.EditMode=Ci,window.ProjectSettings=Di,window.ProjectCreate=Ai);_i.init();})();
//# sourceMappingURL=edit-bundle.js.map
